<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Provider - Zara Fix</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.card:hover { transform: rotateY(10deg) scale(1.05); transition:0.3s; }
button:hover { transform: scale(1.1); transition:0.3s; }
</style>
</head>
<body class="bg-gradient-to-r from-pink-200 via-purple-200 to-blue-200 min-h-screen">

<div class="container mx-auto p-4">
<h1 class="text-3xl font-bold text-center mb-4">Provider - Add Your Shop</h1>
<div id="providerForm" class="bg-white p-4 rounded-xl shadow-lg max-w-lg mx-auto card">
  <input type="text" id="shopName" placeholder="Shop Name" class="w-full mb-2 p-2 border rounded">
  <input type="text" id="ownerName" placeholder="Owner Name" class="w-full mb-2 p-2 border rounded">
  <textarea id="shopAddress" placeholder="Shop Address" class="w-full mb-2 p-2 border rounded"></textarea>
  <input type="text" id="whatsappNo" placeholder="WhatsApp Number" class="w-full mb-2 p-2 border rounded">
  <input type="file" id="shopImage" class="mb-2">
  <button onclick="addShop()" class="bg-green-500 text-white px-4 py-2 rounded w-full">Submit Shop</button>
</div>

<div id="statusMessage" class="text-center mt-4 text-xl font-semibold hidden"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
  authDomain: "zara-fix-2e35a.firebaseapp.com",
  projectId: "zara-fix-2e35a",
  storageBucket: "zara-fix-2e35a.appspot.com",
  messagingSenderId: "636550144008",
  appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const imgbbAPIKey = "4dc5e5cb7654ffc308d5ca45452b014b";

// Login
async function login() {
  const email = prompt("Email:");
  const pass = prompt("Password:");
  await auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

auth.onAuthStateChanged(async user => {
  if(!user) { login(); return; }

  // Check if user already has active shop
  const query = await db.collection("posts").where("posterEmail", "==", user.email).get();
  if(!query.empty){
    const doc = query.docs[0];
    const post = doc.data();
    const now = new Date();
    if(post.status=="approved" && post.expiryDate.toDate() > now){
      document.getElementById("providerForm").style.display="none";
      document.getElementById("statusMessage").innerText = `You are active! Shop will expire on ${post.expiryDate.toDate().toDateString()}`;
      document.getElementById("statusMessage").classList.remove("hidden");
    } else if(post.status=="approved" && post.expiryDate.toDate() <= now){
      document.getElementById("providerForm").style.display="none";
      document.getElementById("statusMessage").innerText = "You are inactive. Please contact admin to recharge!";
      document.getElementById("statusMessage").classList.remove("hidden");
    } else if(post.status=="pending"){
      document.getElementById("providerForm").style.display="none";
      document.getElementById("statusMessage").innerText = "Your shop is pending admin approval.";
      document.getElementById("statusMessage").classList.remove("hidden");
    }
  }
});

// Upload Image
async function uploadImage(file){
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`,{
    method:"POST",
    body: formData
  });
  const data = await res.json();
  return data.data.url;
}

// Add Shop
async function addShop(){
  const shopName = document.getElementById("shopName").value;
  const ownerName = document.getElementById("ownerName").value;
  const shopAddress = document.getElementById("shopAddress").value;
  const whatsappNo = document.getElementById("whatsappNo").value;
  const shopImage = document.getElementById("shopImage").files[0];

  if(!shopName || !ownerName || !shopAddress || !whatsappNo || !shopImage){
    alert("Please fill all fields!");
    return;
  }

  const imageUrl = await uploadImage(shopImage);
  const now = new Date();
  const expiry = new Date(now.getTime() + 30*24*60*60*1000);

  await db.collection("posts").add({
    shopName,
    ownerName,
    shopAddress,
    whatsappNo,
    posterEmail: auth.currentUser.email,
    imageUrl,
    status: "pending",
    createdAt: firebase.firestore.Timestamp.fromDate(now),
    expiryDate: firebase.firestore.Timestamp.fromDate(expiry)
  });

  document.getElementById("providerForm").style.display="none";
  document.getElementById("statusMessage").innerText = "Your shop is submitted! Waiting for admin approval.";
  document.getElementById("statusMessage").classList.remove("hidden");
}
</script>
</body>
</html>
