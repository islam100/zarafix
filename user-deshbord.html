<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accepted Requests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      margin: 0;
      padding: 10px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .request-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      padding: 15px;
      margin: 15px auto;
      max-width: 500px;
      transition: transform 0.2s;
    }

    .request-card:hover {
      transform: scale(1.01);
    }

    .poster-info {
      background: #eef7ff;
      padding: 10px;
      border-radius: 12px;
      margin-top: 10px;
    }

    .btn {
      padding: 10px 20px;
      margin: 5px 5px 0 0;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 6px 0 #888;
      transition: all 0.2s;
      cursor: pointer;
    }

    .btn:active {
      box-shadow: 0 2px 0 #888;
      transform: translateY(4px);
    }

    .whatsapp { background: #25D366; color: white; }
    .delete   { background: #ff4444; color: white; }
    .reject   { background: #ffaa00; color: white; }

    @media (max-width: 600px) {
      .request-card { margin: 10px; }
      .btn { width: 100%; margin-bottom: 10px; }
    }
  </style>
</head>
<body>
  <h2>Your Accepted Requests</h2>
  <div id="requestsContainer"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:example"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const requestsContainer = document.getElementById("requestsContainer");

    async function loadAcceptedRequests() {
      const requestsSnap = await db.ref("requests").once("value");
      const postersSnap = await db.ref("posters").once("value");
      const requestsData = requestsSnap.val();
      const postersData = postersSnap.val();

      requestsContainer.innerHTML = "";

      if (!requestsData) {
        requestsContainer.innerHTML = "<p>No accepted requests found.</p>";
        return;
      }

      Object.entries(requestsData).forEach(([userId, userRequests]) => {
        Object.entries(userRequests).forEach(([requestId, request]) => {
          if (request.acceptedBy) {
            Object.keys(request.acceptedBy).forEach(posterId => {
              const poster = postersData?.[posterId];
              const card = document.createElement("div");
              card.className = "request-card";
              card.innerHTML = `
                <strong>Category:</strong> ${request.category}<br>
                <strong>Description:</strong> ${request.description}<br>
                <strong>Location:</strong> ${request.location || "-"}<br>
                <div class="poster-info">
                  <strong>Accepted By:</strong><br>
                  Name: ${poster?.name || "Unknown"}<br>
                  Shop: ${poster?.shop || "-"}<br>
                  WhatsApp: ${poster?.whatsapp || "-"}<br>
                  Wallet: â‚¹${poster?.wallet || "0"}
                </div>
                <div style="margin-top:10px">
                  <button class="btn whatsapp" onclick="openWhatsApp('${poster?.whatsapp}')">WhatsApp</button>
                  <button class="btn reject" onclick="rejectRequest('${userId}', '${requestId}', '${posterId}')">Reject</button>
                  <button class="btn delete" onclick="deleteRequest('${userId}', '${requestId}')">Delete</button>
                </div>
              `;
              requestsContainer.appendChild(card);
            });
          }
        });
      });
    }

    function openWhatsApp(number) {
      window.open(`https://wa.me/${number}`, '_blank');
    }

    function rejectRequest(userId, requestId, posterId) {
      const ref = db.ref(`requests/${userId}/${requestId}/acceptedBy/${posterId}`);
      ref.remove().then(() => {
        alert("Rejected!");
        loadAcceptedRequests();
      });
    }

    function deleteRequest(userId, requestId) {
      db.ref(`requests/${userId}/${requestId}`).remove().then(() => {
        alert("Request Deleted!");
        loadAcceptedRequests();
      });
    }

    loadAcceptedRequests();
  </script>
</body>
</html>
