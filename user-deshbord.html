<!-- üëá User Dashboard - Accepted Request Info -->
<div id="userAcceptedRequests" style="padding: 10px; font-family: sans-serif;"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "628241118289",
    appId: "1:628241118289:web:fa8f16e4c6e477365462e3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const userAcceptedRequestsDiv = document.getElementById("userAcceptedRequests");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userId = user.uid;
      const userReqRef = ref(db, `requests/${userId}`);
      const userReqSnap = await get(userReqRef);

      userAcceptedRequestsDiv.innerHTML = `<h3>Your Accepted Requests:</h3>`;

      if (userReqSnap.exists()) {
        const requests = userReqSnap.val();

        for (const requestId in requests) {
          const request = requests[requestId];

          if (request.acceptedBy) {
            for (const posterId in request.acceptedBy) {
              // get poster details
              const posterSnap = await get(ref(db, `posters/${posterId}`));
              const poster = posterSnap.exists() ? posterSnap.val() : null;

              if (poster) {
                const posterInfo = `
                  <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <strong>${poster.name} (${poster.category})</strong><br>
                    Shop: ${poster.shop}<br>
                    Wallet: ‚Çπ${poster.wallet}<br>
                    
                    <button style="background-color:#25D366;color:white;border:none;border-radius:5px;padding:6px 12px;margin:5px;font-weight:bold;box-shadow: 2px 2px 5px #999;"
                      onclick="window.open('https://wa.me/91${poster.whatsapp}', '_blank')">
                      üì± WhatsApp
                    </button>

                    <button style="background-color:#ff4d4d;color:white;border:none;border-radius:5px;padding:6px 12px;margin:5px;font-weight:bold;box-shadow: 2px 2px 5px #999;"
                      onclick="rejectPoster('${userId}', '${requestId}', '${posterId}')">
                      ‚ùå Reject
                    </button>
                  </div>
                `;
                userAcceptedRequestsDiv.innerHTML += posterInfo;
              }
            }
          }
        }
      } else {
        userAcceptedRequestsDiv.innerHTML += `<p>No accepted requests yet.</p>`;
      }
    } else {
      userAcceptedRequestsDiv.innerHTML = `<p>Please login first.</p>`;
    }
  });

  // Reject Button Logic
  window.rejectPoster = async function(userId, requestId, posterId) {
    const acceptedRef = ref(db, `requests/${userId}/${requestId}/acceptedBy/${posterId}`);
    await update(acceptedRef, null);  // remove the poster from accepted list
    alert("Rejected successfully!");
    location.reload();
  };
</script>
