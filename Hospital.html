<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f0f2f5;padding:10px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;}
button{padding:8px 12px;margin:5px 5px 5px 0;border:none;border-radius:12px;cursor:pointer;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,0.3);transition:all .2s;}
button:hover{transform:translateY(-2px);box-shadow:0 6px 8px rgba(0,0,0,0.4);}
.btn-login{background:#2ecc71;color:white;}
.btn-logout{background:#e74c3c;color:white;}
.btn-new{background:#f39c12;color:white;}
.card{background:white;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 15px rgba(0,0,0,0.2);transition:transform .3s;}
.card:hover{transform:scale(1.02);}
.approved{border-left:6px solid green;background:#e6ffe6;}
.waiting{border-left:6px solid orange;background:#fff5e6;}
.rejected{border-left:6px solid red;background:#ffe6e6;}
.highlight{border:2px solid #ff00ff;background:#ffe6ff;}
.btnRow{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;}
.modal-content{background:white;padding:15px;border-radius:16px;width:95%;max-width:500px;position:relative;overflow:auto;}
.close{position:absolute;top:8px;right:12px;cursor:pointer;font-weight:bold;font-size:22px;}
form input, form select{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:8px;font-size:14px;}
form button{width:100%;padding:12px;background:#3498db;color:white;font-weight:bold;border-radius:12px;margin-top:10px;}
form button:hover{background:#2980b9;}
img.hosp-img{width:100%;height:180px;object-fit:cover;border-radius:12px;margin-top:6px;}
@media(max-width:500px){.btnRow button{flex:1 1 48%;}}
</style>
</head>
<body>

<header>
<h2>Hospital Portal</h2>
<div>
<button id="loginBtn" class="btn-login">Login with Google</button>
<button id="logoutBtn" class="btn-logout" style="display:none;">Logout</button>
<button id="newPostBtn" class="btn-new" style="display:none;">+ New Hospital</button>
</div>
</header>

<div id="listings"></div>

<!-- New Hospital Modal -->
<div id="postModal" class="modal">
<div class="modal-content">
<span id="closeForm" class="close">&times;</span>
<h3>Add Hospital</h3>
<form id="hospitalForm">
<input type="text" id="name" placeholder="Hospital Name" required>
<input type="text" id="department" placeholder="Department" required>
<input type="text" id="doctor" placeholder="Doctor Name" required>
<input type="text" id="city" placeholder="City" required>
<input type="number" id="beds" placeholder="Number of Beds" required>
<input type="number" id="icu" placeholder="ICU Beds" required>
<input type="number" id="fees" placeholder="Fees" required>
<input type="tel" id="phone" placeholder="Phone Number" required>
<input type="text" id="address" placeholder="Address" required>
<input type="file" id="image" accept="image/*" required>
<button type="submit">Submit</button>
</form>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDT-D80OSwDetRfDEKHTKNvdRTPJnG8Cs4",
  authDomain: "hospital-dc40b.firebaseapp.com",
  databaseURL: "https://hospital-dc40b-default-rtdb.firebaseio.com",
  projectId: "hospital-dc40b",
  storageBucket: "hospital-dc40b.appspot.com",
  messagingSenderId: "445806713376",
  appId: "1:445806713376:web:77dab96b91f7fc71c07a45"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const newPostBtn=document.getElementById("newPostBtn");
const postModal=document.getElementById("postModal");
const closeForm=document.getElementById("closeForm");
const hospitalForm=document.getElementById("hospitalForm");
const listingsDiv=document.getElementById("listings");

const imgbbKey="636b058a892ade35848bc77878ebf217";
const adminEmail="zarasamajiksevasanstha@gmail.com";
let currentUser=null;

loginBtn.onclick=()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(user=>{
  currentUser=user;
  if(user){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    newPostBtn.style.display="inline-block";
    loadListings();
  } else{
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    newPostBtn.style.display="none";
    loadListings();
  }
});

newPostBtn.onclick=()=>postModal.style.display="flex";
closeForm.onclick=()=>postModal.style.display="none";

async function uploadImage(file){
  const fd=new FormData();
  fd.append("image",file);
  const res=await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`,{method:"POST",body:fd});
  const data=await res.json();
  return data.data.url;
}

hospitalForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser) return alert("Login first!");
  const file=document.getElementById("image").files[0];
  const imgUrl=await uploadImage(file);

  const hospital={
    name:document.getElementById("name").value,
    department:document.getElementById("department").value,
    doctor:document.getElementById("doctor").value,
    city:document.getElementById("city").value,
    beds:document.getElementById("beds").value,
    icu:document.getElementById("icu").value,
    fees:document.getElementById("fees").value,
    phone:document.getElementById("phone").value,
    address:document.getElementById("address").value,
    image:imgUrl,
    status:"pending",
    posterUid:currentUser.uid,
    posterEmail:currentUser.email,
    created:Date.now(),
    highlighted:false
  };

  db.ref("hospitals").push(hospital);
  hospitalForm.reset(); postModal.style.display="none";
};

function loadListings(){
  db.ref("hospitals").orderByChild("created").on("value",snap=>{
    let items=[];
    snap.forEach(ch=>items.push({...ch.val(), key:ch.key}));
    items.sort((a,b)=>b.created-a.created);

    let highlighted=items.filter(i=>i.highlighted);
    let normal=items.filter(i=>!i.highlighted);
    items=[...highlighted,...normal];

    listingsDiv.innerHTML="";
    items.forEach(item=>{
      // Non-logged users see only approved
      if(!currentUser && item.status!=="approved") return;
      // Poster sees his own
      if(currentUser && currentUser.uid!==item.posterUid && currentUser.email!==adminEmail && item.status==="pending") return;

      const card=document.createElement("div");
      card.className="card "+(item.status==="approved"?"approved":item.status==="pending"?"waiting":"rejected");
      if(item.highlighted) card.classList.add("highlight");

      card.innerHTML=`
        <h3>${item.name}</h3>
        <p><b>Department:</b> ${item.department}</p>
        <p><b>Doctor:</b> ${item.doctor}</p>
        <p><b>City:</b> ${item.city}</p>
        <p><b>Beds:</b> ${item.beds} | ICU: ${item.icu}</p>
        <p><b>Fees:</b> ‚Çπ${item.fees}</p>
        <p>üìû ${item.phone}</p>
        <p>${item.address}</p>
        <img src="${item.image}" class="hosp-img">
        <p>Status: <b>${item.status==="approved"?"‚úÖ Approved":item.status==="pending"?"‚è≥ Waiting":"‚ùå Rejected"}</b></p>
      `;

      const btnRow=document.createElement("div"); btnRow.className="btnRow";

      if(currentUser && currentUser.uid===item.posterUid){
        const delBtn=document.createElement("button"); delBtn.className="btn-logout"; delBtn.textContent="Delete";
        delBtn.onclick=()=>{ if(confirm("Delete?")) db.ref("hospitals/"+item.key).remove(); };
        btnRow.appendChild(delBtn);
      }

      if(currentUser && currentUser.email===adminEmail){
        const approveBtn=document.createElement("button"); approveBtn.className="btn-new"; approveBtn.textContent="Approve";
        approveBtn.onclick=()=>db.ref("hospitals/"+item.key).update({status:"approved"});
        const rejectBtn=document.createElement("button"); rejectBtn.className="btn-logout"; rejectBtn.textContent="Reject";
        rejectBtn.onclick=()=>db.ref("hospitals/"+item.key).update({status:"rejected"});
        const highlightBtn=document.createElement("button"); highlightBtn.className="btn-new"; highlightBtn.textContent=item.highlighted?"Unpin":"Pin Top";
        highlightBtn.onclick=()=>db.ref("hospitals/"+item.key).update({highlighted:!item.highlighted});
        const delBtn=document.createElement("button"); delBtn.className="btn-logout"; delBtn.textContent="Delete";
        delBtn.onclick=()=>{ if(confirm("Delete permanently?")) db.ref("hospitals/"+item.key).remove(); };
        btnRow.appendChild(approveBtn); btnRow.appendChild(rejectBtn); btnRow.appendChild(highlightBtn); btnRow.appendChild(delBtn);
      }

      card.appendChild(btnRow);
      listingsDiv.appendChild(card);
    });
  });
}
</script>
</body>
</html>
