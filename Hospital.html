<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f0f2f5;padding:10px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
button{padding:8px 12px;margin:0 5px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
.btn-login{background:#2ecc71;color:white;}
.btn-logout{background:#e74c3c;color:white;}
.btn-new{background:#f39c12;color:white;}
.card{background:white;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:all .3s;}
.approved{border-left:6px solid green;background:#e6ffe6;}
.waiting{border-left:6px solid orange;background:#fff5e6;}
.highlight{border:2px solid red;background:#ffe6e6;}
.btnRow{margin-top:10px;}
.btnRow button{margin-right:6px;}
</style>
</head>
<body>

<header>
<h2>Hospital Listings</h2>
<div>
<button id="loginBtn" class="btn-login">Login with Google</button>
<button id="logoutBtn" class="btn-logout" style="display:none;">Logout</button>
<button id="newPostBtn" class="btn-new" style="display:none;">+ New Hospital</button>
</div>
</header>

<div id="listings"></div>

<!-- New Hospital Modal -->
<div id="postModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
<div style="background:white;padding:15px;border-radius:12px;width:90%;max-width:500px;position:relative;">
<span id="closeForm" style="position:absolute;top:8px;right:12px;cursor:pointer;font-weight:bold;font-size:18px;">&times;</span>
<h3>Add Hospital</h3>
<form id="hospitalForm">
<input type="text" id="title" placeholder="Hospital Name" required><br>
<input type="text" id="description" placeholder="Description" required><br>
<button type="submit">Submit</button>
</form>
</div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDT-D80OSwDetRfDEKHTKNvdRTPJnG8Cs4",
  authDomain: "hospital-dc40b.firebaseapp.com",
  databaseURL: "https://hospital-dc40b-default-rtdb.firebaseio.com",
  projectId: "hospital-dc40b",
  storageBucket: "hospital-dc40b.appspot.com",
  messagingSenderId: "445806713376",
  appId: "1:445806713376:web:77dab96b91f7fc71c07a45"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const newPostBtn=document.getElementById("newPostBtn");
const postModal=document.getElementById("postModal");
const closeForm=document.getElementById("closeForm");
const hospitalForm=document.getElementById("hospitalForm");
const listingsDiv=document.getElementById("listings");

const adminEmail="zarasamajiksevasanstha@gmail.com";
let currentUser=null;

// Login / Logout
loginBtn.onclick=()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick=()=>auth.signOut();

// Auth State
auth.onAuthStateChanged(user=>{
  currentUser=user;
  if(user){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    newPostBtn.style.display="inline-block";
    loadListings();
  } else{
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    newPostBtn.style.display="none";
    listingsDiv.innerHTML="";
  }
});

// New Post Modal
newPostBtn.onclick=()=>postModal.style.display="flex";
closeForm.onclick=()=>postModal.style.display="none";

// Submit New Hospital
hospitalForm.onsubmit=e=>{
  e.preventDefault();
  if(!currentUser) return alert("Login first!");
  const title=document.getElementById("title").value;
  const description=document.getElementById("description").value;
  const post={
    title, description,
    userEmail: currentUser.email,
    timestamp: Date.now(),
    approved:false,
    highlighted:false
  };
  db.ref("listings").push(post);
  hospitalForm.reset(); postModal.style.display="none";
};

// Load Listings
function loadListings(){
  db.ref("listings").on("value",snap=>{
    let items=[];
    snap.forEach(ch=>items.push({...ch.val(), key:ch.key}));
    // Newest first
    items.sort((a,b)=>b.timestamp-a.timestamp);
    // Admin highlight top
    let highlighted=items.filter(i=>i.highlighted);
    let normal=items.filter(i=>!i.highlighted);
    items=[...highlighted,...normal];

    listingsDiv.innerHTML="";
    items.forEach(item=>{
      // Filter view
      if(currentUser.email!==adminEmail && currentUser.email!==item.userEmail && !item.approved) return;

      const card=document.createElement("div");
      card.className="card " + (item.approved?"approved":"waiting");
      if(item.highlighted) card.classList.add("highlight");

      card.innerHTML=`<h3>${item.title}</h3>
      <p>${item.description}</p>
      <p>Status: <b>${item.approved?"Approved":"Waiting Approval"}</b></p>`;

      const btnRow=document.createElement("div"); btnRow.className="btnRow";

      // Poster Delete
      if(currentUser.email===item.userEmail){
        const delBtn=document.createElement("button");
        delBtn.className="btn-logout";
        delBtn.textContent="Delete";
        delBtn.onclick=()=>{ if(confirm("Delete?")) db.ref("listings/"+item.key).remove(); };
        btnRow.appendChild(delBtn);
      }

      // Admin buttons
      if(currentUser.email===adminEmail){
        const approveBtn=document.createElement("button");
        approveBtn.className="btn-new"; approveBtn.textContent="Approve";
        approveBtn.onclick=()=>db.ref("listings/"+item.key).update({approved:true});
        const rejectBtn=document.createElement("button");
        rejectBtn.className="btn-logout"; rejectBtn.textContent="Reject";
        rejectBtn.onclick=()=>db.ref("listings/"+item.key).update({approved:false});
        const highlightBtn=document.createElement("button");
        highlightBtn.className="btn-new"; highlightBtn.textContent=item.highlighted?"Unpin":"Pin to Top";
        highlightBtn.onclick=()=>db.ref("listings/"+item.key).update({highlighted:!item.highlighted});
        const delBtn=document.createElement("button");
        delBtn.className="btn-logout"; delBtn.textContent="Delete";
        delBtn.onclick=()=>{ if(confirm("Delete permanently?")) db.ref("listings/"+item.key).remove(); };
        btnRow.appendChild(approveBtn); btnRow.appendChild(rejectBtn); btnRow.appendChild(highlightBtn); btnRow.appendChild(delBtn);
      }

      card.appendChild(btnRow);
      listingsDiv.appendChild(card);
    });
  });
}
</script>
</body>
</html>
