<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f5f5f5; }
header { background:linear-gradient(135deg,#2196F3,#21CBF3); color:white; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; flex-wrap:wrap; box-shadow:0 3px 8px rgba(0,0,0,0.3);}
header h1 { margin:0; font-size:20px; text-shadow:1px 1px 3px #000; }
button { cursor:pointer; padding:6px 10px; border:none; border-radius:6px; margin:3px; font-weight:bold; font-size:13px; box-shadow:0 3px 5px rgba(0,0,0,0.25);}
.btn3d { background:#4CAF50; color:white; }
.logoutBtn { background:#E53935; color:white; }
.waBtn { background:#25D366; color:white; }
.newPostBtn { background:#FF9800; color:white; }

.searchBar { margin:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.searchBar input, .searchBar select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; min-width:180px; }

.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; padding:12px; }

.card {
    height:220px; /* pehle 280px tha */
}
.card img {
    height:90px;  /* pehle 120px tha */
}
.card h3 { font-size:14px; }  /* title thoda chhota */
.card p { font-size:12px; }   /* details thodi chhoti */

.pending { background:#ffcdd2; border:2px solid #f44336; animation:blinkBorder 1s infinite; }
@keyframes blinkBorder {50%{border-color:#b71c1c;}}

.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
.modal-content { background:white; padding:15px; border-radius:10px; width:90%; max-width:420px; max-height:90%; overflow-y:auto; position:relative; font-size:14px; }
.modal-content img { max-width:100%; max-height:200px; display:block; margin:5px 0; }
.close { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; font-size:18px; }

form label { display:block; font-size:13px; font-weight:bold; margin-top:6px; }
form input, form select { width:100%; padding:5px; margin:3px 0 8px; border-radius:6px; border:1px solid #ccc; font-size:13px; }
.btnRow { margin-top:6px; display:flex; flex-wrap:wrap; gap:5px; }
</style>
</head>
<body>

<header>
<h1>Hospital Portal</h1>
<div>
<a href="index.html"><button style="background:blue;color:white;">üè° Home</button></a>
<button id="loginBtn" style="background:#4ade80;color:white;">üîë Login</button>
<button id="logoutBtn" style="display:none;background:#ef4444;color:white;">Logout</button>
<button id="newPostBtn" style="display:none;background:#2563eb;color:white;">+ New Post</button>
</div>
</header>

<div class="searchBar">
<input type="text" id="searchInput" placeholder="Search by name, type, city...">
<select id="categoryFilter">
<option value="">All Categories</option>
<option value="General">General</option>
<option value="Multi-specialty">Multi-specialty</option>
<option value="Clinic">Clinic</option>
<option value="Trauma Center">Trauma Center</option>
<option value="Cardiology">Cardiology</option>
<option value="Pediatrics">Pediatrics</option>
<option value="Neurology">Neurology</option>
<option value="Orthopedics">Orthopedics</option>
<option value="Gynecology">Gynecology</option>
<option value="Emergency">Emergency</option>
</select>
</div>

<main><div class="grid" id="posts"></div></main>

<div class="modal" id="postModal">
<div class="modal-content">
<span class="close" id="closeForm">&times;</span>
<h2>Post Hospital (WhatsApp 7378342192)</h2>
<form id="postForm">
<label>Hospital Name</label><input type="text" id="hospitalName" required>
<label>Hospital Type</label>
<select id="hospitalType" required>
<option value="">Select Type</option>
<option value="General">General</option>
<option value="Multi-specialty">Multi-specialty</option>
<option value="Clinic">Clinic</option>
<option value="Trauma Center">Trauma Center</option>
</select>
<label>Departments (Ctrl+Click multiple)</label>
<select id="departments" multiple required>
<option value="Cardiology">Cardiology</option>
<option value="Pediatrics">Pediatrics</option>
<option value="Neurology">Neurology</option>
<option value="Orthopedics">Orthopedics</option>
<option value="Gynecology">Gynecology</option>
<option value="Emergency">Emergency</option>
</select>
<label>Address</label><input type="text" id="address" required>
<label>City</label><input type="text" id="city" required>
<label>State</label><input type="text" id="state" required>
<label>PIN Code</label><input type="number" id="pin" required>
<label>Phone</label><input type="tel" id="phone" required>
<label>Email</label><input type="email" id="email">
<label>Website</label><input type="url" id="website">
<label>Emergency Service?</label>
<select id="emergency" required><option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option></select>
<label>Images (max 5)</label><input type="file" id="images" accept="image/*" multiple>
<button type="submit" class="btn3d">Submit Post</button>
</form>
</div>
</div>

<div class="modal" id="cardModal">
<div class="modal-content" id="cardContent">
<span class="close" id="closeCard">&times;</span>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDT-D80OSwDetRfDEKHTKNvdRTPJnG8Cs4",
  authDomain: "hospital-dc40b.firebaseapp.com",
  databaseURL: "https://hospital-dc40b-default-rtdb.firebaseio.com",
  projectId: "hospital-dc40b",
  storageBucket: "hospital-dc40b.appspot.com",
  messagingSenderId: "445806713376",
  appId: "1:445806713376:web:77dab96b91f7fc71c07a45"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const newPostBtn=document.getElementById('newPostBtn');
const postModal=document.getElementById('postModal');
const closeForm=document.getElementById('closeForm');
const postForm=document.getElementById('postForm');
const postsDiv=document.getElementById('posts');
const cardModal=document.getElementById('cardModal');
const cardContent=document.getElementById('cardContent');
const closeCard=document.getElementById('closeCard');
const searchInput=document.getElementById('searchInput');
const categoryFilter=document.getElementById('categoryFilter');

let currentUser=null;
let allPosts=[];

loginBtn.onclick=()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
    currentUser=u;
    if(u){ loginBtn.style.display="none"; logoutBtn.style.display="inline-block"; newPostBtn.style.display="inline-block"; }
    else{ loginBtn.style.display="inline-block"; logoutBtn.style.display="none"; newPostBtn.style.display="none"; }
    loadPosts();
});

newPostBtn.onclick=()=>postModal.style.display="flex";
closeForm.onclick=()=>postModal.style.display="none";
closeCard.onclick=()=>cardModal.style.display="none";

async function uploadImages(files){
    const urls=[];
    for(let i=0;i<Math.min(5,files.length);i++){
        const fd=new FormData(); fd.append("image",files[i]);
        const res=await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5",{method:"POST",body:fd});
        const j=await res.json(); urls.push(j.data.url);
    }
    return urls;
}

postForm.onsubmit=async e=>{
    e.preventDefault();
    if(!currentUser) return alert("Login first");
    const btn=postForm.querySelector("button[type=submit]");
    btn.disabled=true; btn.textContent="‚è≥ Submitting...";
    const post={
        hospitalName: document.getElementById('hospitalName').value,
        hospitalType: document.getElementById('hospitalType').value,
        departments: Array.from(document.getElementById('departments').selectedOptions).map(o=>o.value),
        address: document.getElementById('address').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        pin: document.getElementById('pin').value,
        posterPhone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        website: document.getElementById('website').value,
        emergency: document.getElementById('emergency').value,
        posterName: currentUser.displayName,
        posterUid: currentUser.uid,
        status:"pending",
        highlightedByAdmin:false,
        created:Date.now()
    };
    const files=document.getElementById('images').files;
    if(files.length>0) post.images=await uploadImages(files);
    db.ref("posts").push(post,(err)=>{
        if(err) alert("‚ùå Error"); 
        else{ alert("‚úÖ Post submitted! Waiting for approval."); postForm.reset(); postModal.style.display="none"; }
        btn.disabled=false; btn.textContent="Submit Post";
    });
};

function loadPosts(){
    db.ref("posts").on("value",snap=>{
        allPosts=[]; snap.forEach(ch=>allPosts.push({...ch.val(),id:ch.key})); 
        renderPosts();
    });
}

function renderPosts(){
    postsDiv.innerHTML="";
    const keyword = searchInput.value.toLowerCase();
    const category = categoryFilter.value;

    const sortedPosts = [...allPosts].sort((a,b)=>{
        if(a.highlightedByAdmin && !b.highlightedByAdmin) return -1;
        if(!a.highlightedByAdmin && b.highlightedByAdmin) return 1;
        return b.created - a.created;
    });

    sortedPosts.forEach(p => {
        // === Access control ===
        if(currentUser?.email === "zarasamajiksevasanstha@gmail.com"){
            // Admin sees all
        } else {
            if(p.status !== "approved" && p.posterUid !== currentUser?.uid) return;
        }

        // === Filter by category or keyword ===
        if(category && !p.departments.includes(category) && p.hospitalType !== category) return;
        if(keyword && !(p.hospitalName.toLowerCase().includes(keyword) || p.address.toLowerCase().includes(keyword) || p.city.toLowerCase().includes(keyword))) return;

        const card = document.createElement("div");
        card.className = "card";
        if(p.highlightedByAdmin) card.style.border="3px solid #FFD700";
        if(p.status==="pending") card.classList.add("pending");
        if(p.status==="rejected") card.style.background="#ffe0b2";

        if(p.images && p.images.length){
            const img = document.createElement("img");
            img.src = p.images[0];
            card.appendChild(img);
        }

        card.innerHTML += `
            <h3>${p.hospitalName} (${p.hospitalType})</h3>
            <p>${p.address}, ${p.city}</p>
            <p>üìû ${p.posterPhone}</p>
            <p>üë§ ${p.posterName}</p>
            <p>${p.status==="approved"?"‚úÖ Approved":p.status==="rejected"?"‚ùå Rejected":"‚è≥ Pending"}</p>
        `;

        const btnRow = document.createElement("div");
        btnRow.className = "btnRow";

        const wa = document.createElement("button");
        wa.textContent = "üí¨ WhatsApp";
        wa.className = "waBtn";
        wa.onclick = e => { 
            e.stopPropagation(); 
            window.open(`https://wa.me/${p.posterPhone}?text=${encodeURIComponent(`Hello, I am interested in your Hospital ${p.hospitalName} (${p.hospitalType}) at ${p.address}, ${p.city}.`)}`,"_blank"); 
        };
        btnRow.appendChild(wa);

        if(currentUser && currentUser.uid === p.posterUid && currentUser.email !== "zarasamajiksevasanstha@gmail.com"){
            const del = document.createElement("button");
            del.textContent = "üóë Delete";
            del.className = "logoutBtn";
            del.onclick = async e => { e.stopPropagation(); if(confirm("Delete this post?")) await db.ref("posts/"+p.id).remove(); };
            btnRow.appendChild(del);
        }

        if(currentUser && currentUser.email === "zarasamajiksevasanstha@gmail.com"){
            const ap = document.createElement("button"); ap.textContent = "‚úÖ Approve"; ap.className="btn3d";
            ap.onclick = async e => { e.stopPropagation(); await db.ref("posts/"+p.id).update({status:"approved"}); };
            const rj = document.createElement("button"); rj.textContent = "‚ùå Reject"; rj.className="logoutBtn";
            rj.onclick = async e => { e.stopPropagation(); await db.ref("posts/"+p.id).update({status:"rejected"}); };
            const del = document.createElement("button"); del.textContent = "üóë Delete"; del.className="logoutBtn";
            del.onclick = async e => { e.stopPropagation(); if(confirm("Delete permanently?")) await db.ref("posts/"+p.id).remove(); };

            const hl = document.createElement("button");
            hl.textContent = p.highlightedByAdmin ? "‚≠ê Normal" : "üåü Highlight";
            hl.className = "btn3d";
            hl.onclick = async e => { e.stopPropagation(); await db.ref("posts/"+p.id).update({highlightedByAdmin: !p.highlightedByAdmin}); };

            btnRow.appendChild(ap); btnRow.appendChild(rj); btnRow.appendChild(del); btnRow.appendChild(hl);
        }

        card.appendChild(btnRow);

        card.onclick = () => {
            cardContent.innerHTML = '<span class="close" id="closeCard">&times;</span>';
            cardContent.innerHTML += `
                <h2>${p.hospitalName} (${p.hospitalType})</h2>
                <p><b>Departments:</b> ${p.departments?.join(", ")}</p>
                <p><b>Address:</b> ${p.address}, ${p.city}, ${p.state} - ${p.pin}</p>
                <p><b>Poster:</b> ${p.posterName}</p>
                <p><b>Phone:</b> ${p.posterPhone}</p>
                <p><b>Email:</b> ${p.email}</p>
                <p><b>Website:</b> ${p.website}</p>
                <p><b>Emergency Service:</b> ${p.emergency}</p>
            `;
            if(p.images){ p.images.forEach(u => { cardContent.innerHTML += `<img src="${u}">`; }); }
            cardModal.style.display = "flex";
            document.getElementById("closeCard").onclick = () => cardModal.style.display = "none";
        };

        postsDiv.appendChild(card);
    });
}

searchInput.addEventListener("input",renderPosts);
categoryFilter.addEventListener("change",renderPosts);
</script>
</body>
</html>
