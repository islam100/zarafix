<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hospital Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; }
    header { background:linear-gradient(135deg,#2196F3,#21CBF3); color:white;
             display:flex; align-items:center; justify-content:space-between;
             padding:10px 20px; box-shadow:0 3px 8px rgba(0,0,0,0.3); flex-wrap:wrap; }
    header h1 { margin:0; font-size:20px; text-shadow:1px 1px 3px #000; }
    button { cursor:pointer; padding:6px 10px; border:none; border-radius:6px;
             box-shadow:0 3px 5px rgba(0,0,0,0.25); font-weight:bold; margin:3px; font-size:13px; }
    .btn3d { background:#4CAF50; color:#fff; }
    .logoutBtn { background:#E53935; color:#fff; }
    .waBtn { background:#25D366; color:#fff; }
    .newPostBtn { background:#2563eb; color:#fff; margin-left:10px; }

    /* Search Bar */
    .searchBar { margin:12px; display:flex; justify-content:center; gap:10px; }
    .searchBar input, .searchBar select {
      padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; min-width:180px;
    }

    /* Grid */
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:12px; padding:12px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 3px 5px rgba(0,0,0,0.2);
            padding:10px; cursor:pointer; font-size:13px; transition:transform .2s; }
    .card:hover { transform:scale(1.02); }
    .card img { width:100%; height:150px; object-fit:cover; border-radius:6px; }
    .pending { background:#ffcdd2; border:2px solid #f44336; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
             background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:15px; border-radius:10px; width:90%; max-width:420px;
                     max-height:90%; overflow:auto; position:relative; font-size:14px; }
    .close { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; font-size:18px; }
    form label { font-size:13px; font-weight:bold; margin-top:6px; display:block; }
    form input, form select { width:100%; padding:5px; margin:3px 0 8px;
                              border:1px solid #ccc; border-radius:6px; font-size:13px; }
    .btnRow { margin-top:6px; display:flex; flex-wrap:wrap; gap:5px; }
  </style>
</head>
<body>
<header>
  <h1>Hospital Portal</h1>
  <div>
    <button id="loginBtn" style="background:#4ade80; color:white;">üîë Login</button>
    <button id="logoutBtn" style="display:none; background:#ef4444; color:white;">Logout</button>
    <button id="newPostBtn" style="display:none;" class="newPostBtn">+ New Post</button>
  </div>
</header>

<!-- üîç Search Bar -->
<div class="searchBar">
  <input type="text" id="searchInput" placeholder="Search by hospital name, type, address...">
  <select id="categoryFilter">
    <option value="">All Hospitals</option>
    <option value="Government">Government</option>
    <option value="Private">Private</option>
    <option value="Clinic">Clinic</option>
    <option value="Trust">Trust</option>
  </select>
</div>

<main>
  <div class="grid" id="posts"></div>
</main>

<!-- Post Form Modal -->
<div class="modal" id="postModal">
  <div class="modal-content">
    <span class="close" id="closeForm">&times;</span>
    <h2>Post Hospital Details</h2>
    <form id="postForm">
      <label>Hospital Name</label>
      <input type="text" id="hospitalName" required>
      <label>Hospital Type</label>
      <select id="hospitalType" required>
        <option value="">-- Select Type --</option>
        <option value="Government">Government</option>
        <option value="Private">Private</option>
        <option value="Clinic">Clinic</option>
        <option value="Nursing Home">Nursing Home</option>
        <option value="Speciality">Speciality</option>
        <option value="Super Speciality">Super Speciality</option>
      </select>
      <label>Address</label>
      <input type="text" id="address" required>
      <label>Phone</label>
      <input type="tel" id="phone" required>
      <label>Images (max 5)</label>
      <input type="file" id="images" accept="image/*" multiple>
      <button type="submit" class="btn3d">Submit</button>
    </form>
  </div>
</div>

<!-- Card View Modal -->
<div class="modal" id="cardModal">
  <div class="modal-content" id="cardContent">
    <span class="close" id="closeCard">&times;</span>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDT-D80OSwDetRfDEKHTKNvdRTPJnG8Cs4",
  authDomain: "hospital-dc40b.firebaseapp.com",
  databaseURL: "https://hospital-dc40b-default-rtdb.firebaseio.com",
  projectId: "hospital-dc40b",
  storageBucket: "hospital-dc40b.appspot.com",
  messagingSenderId: "445806713376",
  appId: "1:445806713376:web:77dab96b91f7fc71c07a45"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const newPostBtn=document.getElementById('newPostBtn');
const postModal=document.getElementById('postModal');
const closeForm=document.getElementById('closeForm');
const postForm=document.getElementById('postForm');
const postsDiv=document.getElementById('posts');
const cardModal=document.getElementById('cardModal');
const cardContent=document.getElementById('cardContent');
const closeCard=document.getElementById('closeCard');
const searchInput=document.getElementById('searchInput');
const categoryFilter=document.getElementById('categoryFilter');

let currentUser=null;
let allPosts=[];

loginBtn.onclick=()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick=()=>auth.signOut();
auth.onAuthStateChanged(u=>{
  currentUser=u;
  loginBtn.style.display=u?"none":"inline-block";
  logoutBtn.style.display=u?"inline-block":"none";
  newPostBtn.style.display=u?"inline-block":"none";
  loadPosts();
});

newPostBtn.onclick=()=>postModal.style.display="flex";
closeForm.onclick=()=>postModal.style.display="none";
closeCard.onclick=()=>cardModal.style.display="none";

// Upload images to imgbb
async function uploadImages(files){
  const urls=[];
  for(let i=0;i<Math.min(5,files.length);i++){
    const f=files[i];
    const fd=new FormData();
    fd.append("image",f);
    const r=await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5",{method:"POST",body:fd});
    const j=await r.json();
    urls.push(j.data.url);
  }
  return urls;
}

// Post submit
postForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser) return alert("Login first");
  const btn=postForm.querySelector("button[type=submit]");
  btn.disabled=true; btn.textContent="‚è≥ Submitting...";
  const post={
    hospitalName:document.getElementById('hospitalName').value,
    hospitalType:document.getElementById('hospitalType').value,
    address:document.getElementById('address').value,
    posterPhone:document.getElementById('phone').value,
    posterName:currentUser.displayName||"Anonymous",
    posterUid:currentUser.uid,
    status:"pending",
    created:Date.now()
  };
  const files=document.getElementById('images').files;
  if(files.length>0) post.images=await uploadImages(files);
  await db.ref("hospitals").push(post);
  alert("‚úÖ Hospital submitted!");
  postForm.reset(); postModal.style.display="none";
  btn.disabled=false; btn.textContent="Submit";
};

// Load
function loadPosts(){
  db.ref("hospitals").orderByChild("created").on("value",snap=>{
    allPosts=[]; snap.forEach(ch=>allPosts.push({...ch.val(),id:ch.key}));
    allPosts.reverse(); renderPosts();
  });
}

// Render
function renderPosts(){
  postsDiv.innerHTML="";
  const keyword=searchInput.value.toLowerCase();
  const category=categoryFilter.value;
  allPosts.forEach(p=>{
    if(currentUser?.email!=="zarasamajiksevasanstha@gmail.com"){
      if(p.status!=="approved" && (!currentUser || p.posterUid!==currentUser.uid)) return;
    }
    if(category && p.hospitalType!==category) return;
    if(keyword && !(p.hospitalName?.toLowerCase().includes(keyword)||
                    p.hospitalType?.toLowerCase().includes(keyword)||
                    p.address?.toLowerCase().includes(keyword)||
                    p.posterName?.toLowerCase().includes(keyword))) return;
    const card=document.createElement("div"); card.className="card";
    if(p.status==="pending") card.classList.add("pending");
    if(p.images?.length){ const img=document.createElement("img"); img.src=p.images[0]; card.appendChild(img); }
    card.innerHTML+=`
      <h3>${p.hospitalName} - ${p.hospitalType}</h3>
      <p>üìç ${p.address}</p>
      <p>üìû ${p.posterPhone}</p>
      <p>üë§ ${p.posterName}</p>
      <p>${p.status==="approved"?"‚úÖ Approved":p.status==="rejected"?"‚ùå Rejected":"‚è≥ Pending Approval"}</p>`;
    const btnRow=document.createElement("div"); btnRow.className="btnRow";
    const wa=document.createElement("button"); wa.textContent="üí¨ WhatsApp"; wa.className="waBtn";
    wa.onclick=e=>{ e.stopPropagation();
      const msg=`Hello, I am interested in your hospital: ${p.hospitalName} (${p.hospitalType}) at ${p.address}.`;
      window.open(`https://wa.me/${p.posterPhone}?text=${encodeURIComponent(msg)}`,"_blank"); };
    btnRow.appendChild(wa);
    if(currentUser && currentUser.uid===p.posterUid && currentUser.email!=="zarasamajiksevasanstha@gmail.com"){
      const del=document.createElement("button"); del.textContent="üóë Delete"; del.className="logoutBtn";
      del.onclick=async e=>{ e.stopPropagation(); if(confirm("Delete?")) await db.ref("hospitals/"+p.id).remove(); };
      btnRow.appendChild(del);
    }
    if(currentUser && currentUser.email==="zarasamajiksevasanstha@gmail.com"){
      const ap=document.createElement("button"); ap.textContent="‚úÖ Approve"; ap.className="btn3d";
      ap.onclick=async e=>{ e.stopPropagation(); await db.ref("hospitals/"+p.id).update({status:"approved"}); };
      const rj=document.createElement("button"); rj.textContent="‚ùå Reject"; rj.className="logoutBtn";
      rj.onclick=async e=>{ e.stopPropagation(); await db.ref("hospitals/"+p.id).update({status:"rejected"}); };
      const del=document.createElement("button"); del.textContent="üóë Delete"; del.className="logoutBtn";
      del.onclick=async e=>{ e.stopPropagation(); if(confirm("Delete permanently?")) await db.ref("hospitals/"+p.id).remove(); };
      btnRow.appendChild(ap); btnRow.appendChild(rj); btnRow.appendChild(del);
    }
    card.appendChild(btnRow);
    card.onclick=()=>{
      cardContent.innerHTML='<span class="close" id="closeCard">&times;</span>';
      cardContent.innerHTML+=`
        <h2>${p.hospitalName}</h2>
        <p><b>Type:</b> ${p.hospitalType}</p>
        <p><b>Address:</b> ${p.address}</p>
        <p><b>Posted by:</b> ${p.posterName}</p>
        <p><b>Phone:</b> ${p.posterPhone}</p>
        <a href="https://wa.me/${p.posterPhone}" target="_blank"
           style="display:inline-block;margin-top:10px;padding:10px 15px;background:#25D366;color:#fff;border-radius:5px;text-decoration:none;font-weight:bold;">üì≤ WhatsApp</a>`;
      if(p.images) p.images.forEach(u=>cardContent.innerHTML+=`<img src="${u}" style="width:100%;margin:5px 0;border-radius:8px;">`);
      cardModal.style.display="flex";
      document.getElementById("closeCard").onclick=()=>cardModal.style.display="none";
    };
    postsDiv.appendChild(card);
  });
}

searchInput.addEventListener("input",renderPosts);
categoryFilter.addEventListener("change",renderPosts);
</script>
</body>
</html>
