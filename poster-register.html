<div>
  <h3>💰 Wallet: ₹<span id="walletAmount">Loading...</span></h3>
</div>

<div id="jobsContainer"></div>

<script>
  const posterUid = user.uid;
  const posterRef = ref(db, 'posterUsers/' + posterUid);
  let posterCategory = "";
  let posterName = "";
  let currentWallet = 0;

  // Load poster details and wallet
  get(posterRef).then(snapshot => {
    if (snapshot.exists()) {
      const posterData = snapshot.val();
      posterCategory = posterData.category;
      posterName = posterData.name;
      currentWallet = posterData.wallet || 0;

      // Show wallet amount
      document.getElementById("walletAmount").innerText = currentWallet;

      // Load jobs
      const jobsRef = ref(db, 'serviceRequests');
      onValue(jobsRef, snapshot => {
        const jobs = snapshot.val();
        const container = document.getElementById('jobsContainer');
        container.innerHTML = '';

        for (let jobId in jobs) {
          const job = jobs[jobId];

          if (job.uid === posterUid) continue;
          if (job.category !== posterCategory) continue;

          const accepted = job.acceptedBy && job.acceptedBy[posterUid];

          const card = document.createElement('div');
          card.innerHTML = `
            <div style="border:1px solid #ccc; padding:10px; margin:10px; border-radius:10px; background:#fff;">
              <h3>🛠️ Repair Request (${job.subcategory})</h3>
              <p><strong>👤 Name:</strong> ${job.name}</p>
              <p><strong>📍 Address:</strong> ${job.address}</p>
              <p><strong>📝 Issue:</strong> ${job.description}</p>
              <p><strong>📅 Requested On:</strong> ${new Date(job.timestamp).toLocaleString()}</p>

              ${accepted ? `
                <p><strong>📞 WhatsApp:</strong> <a href="https://wa.me/91${job.phone}" target="_blank">Chat Now</a></p>
              ` : `
                <button onclick="acceptJob('${jobId}', '${job.phone}')" ${currentWallet < 20 ? 'disabled' : ''}>
                  ✅ Accept Job
                </button>
                ${currentWallet < 20 ? '<p style="color:red;">Insufficient wallet balance.</p>' : ''}
              `}
            </div>
          `;
          container.appendChild(card);
        }
      });
    }
  });

  function acceptJob(jobId, phone) {
    if (currentWallet < 20) {
      alert("❌ Insufficient wallet balance. Please recharge.");
      return;
    }

    // Deduct ₹20 and save acceptance
    const walletRef = ref(db, 'posterUsers/' + posterUid + '/wallet');
    const acceptRef = ref(db, `serviceRequests/${jobId}/acceptedBy/${posterUid}`);

    // Step 1: Deduct wallet
    set(walletRef, currentWallet - 20).then(() => {
      currentWallet -= 20;
      document.getElementById("walletAmount").innerText = currentWallet;

      // Step 2: Save accepted info
      return set(acceptRef, {
        name: posterName,
        uid: posterUid,
        timestamp: new Date().toISOString()
      });
    }).then(() => {
      alert("✅ Job accepted. ₹20 deducted from wallet.");
      location.reload(); // Refresh to hide button and show WhatsApp
    });
  }
</script>
