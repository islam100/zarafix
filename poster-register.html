<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family:sans-serif; background:#f0f0f0; padding:10px;">

<h2>üõ†Ô∏è ZaraFix - Poster Dashboard</h2>
<div id="wallet">üí∞ Wallet: ‚ÇπLoading...</div>
<div id="registrationForm" style="display:none;">
  <h3>Register as Service Provider</h3>
  <input id="name" placeholder="Name"><br>
  <input id="address" placeholder="Address"><br>
  <input id="whatsapp" placeholder="WhatsApp Number"><br>
  <input id="shop" placeholder="Shop/Office Name"><br>
  <select id="category">
    <option value="">Select Category</option>
    <option value="Electrician">Electrician</option>
    <option value="Plumber">Plumber</option>
    <option value="AC Repair">AC Repair</option>
    <option value="Carpenter">Carpenter</option>
  </select><br><br>
  <button onclick="submitRegistration()">Submit</button>
</div>

<div id="waitApproval" style="display:none;">‚è≥ Please wait for admin approval...</div>
<div id="jobsContainer" style="display:none;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
  apiKey: "   AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E     ",
  authDomain: "   zara-fix.firebaseapp.com           ",
  databaseURL: "   https://zara-fix-default-rtdb.firebaseio.com     ",
  projectId: "  zara-fix  ",
  storageBucket: "    zara-fix.appspot.com  ", // ‚úÖ ‡§∏‡§π‡•Ä ‡§Ø‡§π ‡§π‡•à
  messagingSenderId: "   476473209200  ",
  appId: "   1:476473209200:web:9f6efe6c32fd4248949fb5  "
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let user, posterUid;

  auth.onAuthStateChanged(u => {
    if (u) {
      user = u;
      posterUid = user.uid;
      checkPoster();
    } else {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }
  });

  function checkPoster() {
    const refPath = `posterUsers/${posterUid}`;
    db.ref(refPath).once('value').then(snapshot => {
      if (snapshot.exists()) {
        const poster = snapshot.val();
        if (!poster.approved) {
          document.getElementById('waitApproval').style.display = 'block';
        } else {
          loadWallet();
          showJobs(poster);
        }
      } else {
        document.getElementById('registrationForm').style.display = 'block';
      }
    });
  }

  function submitRegistration() {
    const name = document.getElementById('name').value;
    const address = document.getElementById('address').value;
    const whatsapp = document.getElementById('whatsapp').value;
    const category = document.getElementById('category').value;
    const shop = document.getElementById('shop').value;

    if (!name || !address || !whatsapp || !category || !shop) {
      alert("Please fill all fields");
      return;
    }

    const newData = {
      name, address, whatsapp, category, shop,
      approved: false,
      wallet: 100,
      timestamp: Date.now()
    };
    db.ref('posterUsers/' + posterUid).set(newData).then(() => {
      document.getElementById('registrationForm').style.display = 'none';
      document.getElementById('waitApproval').style.display = 'block';
    });
  }

  function loadWallet() {
    const walletRef = db.ref('posterUsers/' + posterUid + '/wallet');
    walletRef.on('value', snap => {
      const bal = snap.val();
      document.getElementById('wallet').innerText = `üí∞ Wallet: ‚Çπ${bal ?? 0}`;
    });
  }

  function showJobs(poster) {
    document.getElementById('jobsContainer').style.display = 'block';
    const jobsRef = db.ref('serviceRequests');
    jobsRef.on('value', snapshot => {
      const data = snapshot.val();
      const container = document.getElementById('jobsContainer');
      container.innerHTML = '';

      for (let jobId in data) {
        const job = data[jobId];
        if (job.uid === posterUid || job.category !== poster.category) continue;
        const accepted = job.acceptedBy && job.acceptedBy[posterUid];

        const card = document.createElement('div');
        card.style = 'border:1px solid #ccc; margin:10px; padding:10px; background:#fff; border-radius:10px;';
        card.innerHTML = `
          <h3>${job.subcategory || 'Repair Job'}</h3>
          <p><strong>Name:</strong> ${job.name}</p>
          <p><strong>Address:</strong> ${job.address}</p>
          <p><strong>Issue:</strong> ${job.description}</p>
          <p><strong>Requested:</strong> ${new Date(job.timestamp).toLocaleString()}</p>
          ${accepted ? `<p><a href="https://wa.me/91${job.phone}" target="_blank">üìû Chat on WhatsApp</a></p>`
                    : `<button onclick="acceptJob('${jobId}', '${job.phone}', '${poster.name}')">‚úÖ Accept Job</button>`}
        `;
        container.appendChild(card);
      }
    });
  }

  function acceptJob(jobId, phone, name) {
    const walletRef = db.ref('posterUsers/' + posterUid + '/wallet');
    walletRef.once('value').then(snap => {
      const bal = snap.val();
      if (bal < 20) {
        alert("Insufficient wallet balance. Please recharge.");
        return;
      }

      const updates = {};
      updates[`serviceRequests/${jobId}/acceptedBy/${posterUid}`] = {
        name, uid: posterUid, timestamp: Date.now()
      };
      updates[`posterUsers/${posterUid}/wallet`] = bal - 20;

      db.ref().update(updates).then(() => {
        alert("Job accepted. ‚Çπ20 deducted.");
      });
    });
  }
</script>
</body>
</html>
