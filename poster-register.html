<!DOCTYPE html>
<html>
<head>
  <title>ğŸ› ï¸ ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    .hidden { display: none; }
    button { padding: 10px 20px; border: none; background: #2196F3; color: white; border-radius: 8px; margin: 10px 0; }
    input, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; }
    .card { background: #fafafa; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 0 5px #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginSection">
      <h2>ğŸ” Please Login</h2>
      <button onclick="loginWithGoogle()">Login with Google</button>
    </div>

    <div id="formSection" class="hidden">
      <h2>ğŸ“‹ Poster Registration</h2>
      <input id="name" placeholder="Full Name">
      <input id="address" placeholder="Address">
      <input id="pincode" placeholder="Pin Code">
      <input id="whatsapp" placeholder="WhatsApp Number">
      <input id="shopname" placeholder="Shop/Office Name">
      <select id="category">
        <option value="">Select Category</option>
        <option>Electrician</option>
        <option>Plumber</option>
        <option>Cook</option>
        <option>Clothing</option>
      </select>
      <select id="subcategory">
        <option value="">Select Subcategory</option>
        <option>Men</option>
        <option>Women</option>
        <option>Repair</option>
        <option>Installation</option>
      </select>
      <button onclick="submitForm()">Submit</button>
    </div>

    <div id="waitSection" class="hidden">
      <h3>â³ Please wait for approval...</h3>
    </div>

    <div id="dashboardSection" class="hidden">
      <h3>ğŸ‰ Welcome to Your Poster Dashboard</h3>
      <div id="wallet">ğŸ’° Wallet: â‚¹Loading...</div>
      <div id="jobList"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "476473209200",
      appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUser = null;
    let userData = null;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        checkPosterRegistration();
      } else {
        document.getElementById('loginSection').classList.remove('hidden');
      }
    });

    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider);
    }

    function checkPosterRegistration() {
      const ref = firebase.database().ref('posterUsers/' + currentUser.uid);
      ref.once('value', snap => {
        const data = snap.val();
        if (data) {
          userData = data;
          if (data.approved) {
            showDashboard();
          } else {
            document.getElementById('waitSection').classList.remove('hidden');
          }
        } else {
          document.getElementById('formSection').classList.remove('hidden');
        }
      });
    }

    function submitForm() {
      const name = document.getElementById('name').value;
      const address = document.getElementById('address').value;
      const pincode = document.getElementById('pincode').value;
      const whatsapp = document.getElementById('whatsapp').value;
      const shopname = document.getElementById('shopname').value;
      const category = document.getElementById('category').value;
      const subcategory = document.getElementById('subcategory').value;
      const date = new Date().toLocaleDateString('en-GB');

      const data = {
        name, address, pincode, whatsapp, shopname,
        category, subcategory, date,
        approved: false,
        wallet: 100
      };
      firebase.database().ref('posterUsers/' + currentUser.uid).set(data).then(() => {
        document.getElementById('formSection').classList.add('hidden');
        document.getElementById('waitSection').classList.remove('hidden');
      });
    }

    function showDashboard() {
      document.getElementById('dashboardSection').classList.remove('hidden');
      loadWallet();
      loadJobs();
    }

    function loadWallet() {
      const ref = firebase.database().ref('posterUsers/' + currentUser.uid + '/wallet');
      ref.on('value', snap => {
        const amount = snap.val() || 0;
        document.getElementById('wallet').innerText = 'ğŸ’° Wallet: â‚¹' + amount;
      });
    }

    function loadJobs() {
      firebase.database().ref('requests').once('value', snap => {
        const jobList = document.getElementById('jobList');
        jobList.innerHTML = '';
        snap.forEach(childSnap => {
          const job = childSnap.val();
          const key = childSnap.key;
          if (job.category === userData.category) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <b>ğŸ› ï¸ Repair Request (${job.category})</b><br>
              ğŸ‘¤ Name: ${job.name}<br>
              ğŸ“ Address: ${job.address}<br>
              ğŸ“ Issue: ${job.issue}<br>
              ğŸ“… Requested On: ${job.date}<br>
              <button onclick="acceptJob('${key}')">âœ… Accept Job</button>
            `;
            jobList.appendChild(card);
          }
        });
      });
    }

    function acceptJob(jobId) {
      const posterRef = firebase.database().ref('posterUsers/' + currentUser.uid + '/wallet');
      posterRef.once('value').then(snap => {
        let wallet = snap.val() || 0;
        if (wallet >= 20) {
          wallet -= 20;
          posterRef.set(wallet);
          firebase.database().ref('requests/' + jobId + '/acceptedBy/' + currentUser.uid).set({
            name: userData.name,
            whatsapp: userData.whatsapp,
            shop: userData.shopname,
            timestamp: new Date().toISOString()
          });
          alert("âœ… Job Accepted!");
        } else {
          alert("âŒ Not enough balance in wallet.");
        }
      });
    }
  </script>
</body>
</html>
