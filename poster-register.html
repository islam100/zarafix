<!DOCTYPE html>
<html>
<head>
  <title>ğŸ› ï¸ ZaraFix Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; margin: 0; background: #f2f2f2; padding: 10px; }
    .card {
      background: white;
      margin: 10px auto;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    button {
      background: #6200ea;
      color: white;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .logout-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: red;
    }
    #wallet { font-weight: bold; color: green; }
  </style>
</head>
<body>

<h3>ğŸ› ï¸ Poster Dashboard</h3>
<div id="wallet">ğŸ’° Wallet: â‚¹Loading...</div>
<button class="logout-btn" onclick="logout()">Logout</button>

<div id="registrationForm" class="card">
  <h3>Register as Service Provider</h3>
  <input id="name" placeholder="Your Name"><br><br>
  <input id="address" placeholder="Your Address"><br><br>
  <input id="whatsapp" placeholder="WhatsApp Number"><br><br>
  <input id="shop" placeholder="Shop/Office Name"><br><br>
  <select id="category">
    <option value="">Select Category</option>
    <option>Electrician</option>
    <option>Plumber</option>
    <option>Carpenter</option>
    <option>Repair</option>
    <option>Clothing</option>
  </select><br><br>
  <input id="subcategory" placeholder="Subcategory"><br><br>
  <button onclick="submitRegistration()">Submit</button>
</div>

<div id="approvalMsg" class="card" style="display:none;">
  <h3>ğŸ™ Please wait for admin approval...</h3>
</div>

<div id="dashboard" style="display:none;"></div>

<!-- Firebase + Google Auth -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "476473209200",
    appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
  };
  firebase.initializeApp(firebaseConfig);

  let currentUser;

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      checkRegistration(user.uid);
    } else {
      firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }
  });

  function submitRegistration() {
    const data = {
      name: name.value,
      address: address.value,
      whatsapp: whatsapp.value,
      shop: shop.value,
      category: category.value,
      subcategory: subcategory.value,
      date: new Date().toLocaleDateString(),
      approved: false,
      wallet: 100
    };
    firebase.database().ref("posterUsers/" + currentUser.uid).set(data).then(() => {
      registrationForm.style.display = "none";
      approvalMsg.style.display = "block";
    });
  }

  function checkRegistration(uid) {
    firebase.database().ref("posterUsers/" + uid).once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        registrationForm.style.display = "block";
      } else if (data.approved === true) {
        registrationForm.style.display = "none";
        approvalMsg.style.display = "none";
        loadDashboard(data.category);
        loadWallet(uid);
      } else {
        registrationForm.style.display = "none";
        approvalMsg.style.display = "block";
      }
    });
  }

  function loadWallet(uid) {
    firebase.database().ref("posterUsers/" + uid + "/wallet").on("value", snap => {
      document.getElementById("wallet").innerHTML = "ğŸ’° Wallet: â‚¹" + (snap.val() || 0);
    });
  }

  function loadDashboard(myCategory) {
    document.getElementById("dashboard").style.display = "block";
    firebase.database().ref("requests").once("value").then(snapshot => {
      document.getElementById("dashboard").innerHTML = "";
      snapshot.forEach(userSnap => {
        const userId = userSnap.key;
        userSnap.forEach(reqSnap => {
          const req = reqSnap.val();
          const requestId = reqSnap.key;
          if (req.category === myCategory) {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <h4>${req.title || "ğŸ› ï¸ Repair Request (" + req.category + ")"}</h4>
              <p><b>ğŸ‘¤ Name:</b> ${req.name}<br>
              <b>ğŸ“ Address:</b> ${req.address}<br>
              <b>ğŸ“ Issue:</b> ${req.issue}<br>
              <b>ğŸ“… Requested On:</b> ${req.date || ""}</p>
              <button onclick="acceptJob('${userId}', '${requestId}')">âœ… Accept Job</button>
            `;
            document.getElementById("dashboard").appendChild(div);
          }
        });
      });
    });
  }

  function acceptJob(userId, requestId) {
    const uid = currentUser.uid;
    const ref = firebase.database().ref("posterUsers/" + uid + "/wallet");
    ref.once("value").then(snap => {
      let wallet = snap.val() || 0;
      if (wallet >= 20) {
        ref.set(wallet - 20);
        firebase.database().ref(`requests/${userId}/${requestId}/acceptedBy/${uid}`).set(true);
        alert("Accepted! â‚¹20 deducted.");
      } else {
        alert("Insufficient wallet balance.");
      }
    });
  }

  function logout() {
    firebase.auth().signOut().then(() => location.reload());
  }
</script>

</body>
</html>
