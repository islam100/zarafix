<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - User Request</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h2>ZaraFix - Request Repair</h2>
  <div id="userInfo" class="hidden">
    Logged in as: <span id="userEmail"></span>
    <button onclick="logout()">Logout</button>
  </div>
  <div id="loginDiv">
    <button onclick="login()">Login with Google</button>
  </div>

  <div id="requestForm" class="hidden">
    <h3>Submit Your Request</h3>
    <input id="category" placeholder="Category (e.g., Electrician)" /><br><br>
    <input id="location" placeholder="Location" /><br><br>
    <textarea id="description" placeholder="Describe your issue..."></textarea><br><br>
    <button onclick="submitRequest()">Submit</button>
  </div>

  <div id="myRequests" class="hidden">
    <h3>Your Requests</h3>
    <ul id="requestList"></ul>
  </div>

<script type="module">
  // Firebase Config
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

  const firebaseConfig = {
    apiKey: " AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com  ",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com ",
    messagingSenderId: " 476473209200 ",
    appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("userEmail").innerText = user.email;
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("userInfo").classList.remove("hidden");
      document.getElementById("requestForm").classList.remove("hidden");
      document.getElementById("myRequests").classList.remove("hidden");
      loadMyRequests();
    } else {
      currentUser = null;
      document.getElementById("loginDiv").classList.remove("hidden");
      document.getElementById("userInfo").classList.add("hidden");
      document.getElementById("requestForm").classList.add("hidden");
      document.getElementById("myRequests").classList.add("hidden");
    }
  });

  window.login = () => {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider);
  };

  window.logout = () => {
    signOut(auth);
  };

  window.submitRequest = () => {
    const category = document.getElementById("category").value;
    const location = document.getElementById("location").value;
    const description = document.getElementById("description").value;
    if (!category || !location || !description) {
      alert("Please fill all fields.");
      return;
    }

    const requestRef = ref(db, "requests/" + currentUser.uid);
    const newReqRef = push(requestRef);
    set(newReqRef, {
      category,
      location,
      description,
      acceptedBy: null,
      time: Date.now()
    });

    alert("Request submitted!");
    document.getElementById("category").value = "";
    document.getElementById("location").value = "";
    document.getElementById("description").value = "";
  };

  function loadMyRequests() {
    const userReqRef = ref(db, "requests/" + currentUser.uid);
    onValue(userReqRef, (snapshot) => {
      const list = document.getElementById("requestList");
      list.innerHTML = "";
      const data = snapshot.val();
      for (let key in data) {
        const req = data[key];
        const li = document.createElement("li");
        li.innerText = `ðŸ”§ ${req.category} | ${req.description} | Accepted by: ${req.acceptedBy ? Object.keys(req.acceptedBy)[0] : "Not yet"}`;
        list.appendChild(li);
      }
    });
  }
</script>

</body>
</html>
