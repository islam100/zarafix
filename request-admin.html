<!DOCTYPE html>
<html>
<head>
  <title>User Request Form with Tracking</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <h2>User Request System</h2>

  <!-- Login Button -->
  <button onclick="googleLogin()">Login with Google</button>
  <p id="user-info"></p>

  <!-- Request Form -->
  <div id="request-form" style="display:none;">
    <h3>Submit Request</h3>
    <input id="category" placeholder="Category"><br>
    <textarea id="description" placeholder="Description"></textarea><br>
    <input id="location" placeholder="Location"><br>
    <button onclick="submitRequest()">Submit</button>
  </div>

  <!-- My Requests -->
  <div id="my-requests" style="display:none;">
    <h3>My Requests</h3>
    <ul id="request-list"></ul>
  </div>

  <script>
    let currentUser = null;

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).then(result => {
        currentUser = result.user;
        document.getElementById('user-info').innerText = "Logged in as: " + currentUser.email;
        document.getElementById('request-form').style.display = 'block';
        document.getElementById('my-requests').style.display = 'block';
        loadRequests();
      }).catch(error => {
        alert("Login failed: " + error.message);
      });
    }

    function submitRequest() {
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const location = document.getElementById('location').value;

      if (!category || !description || !location) return alert("Fill all fields!");

      const uid = currentUser.uid;
      const requestId = firebase.database().ref().child('requests').push().key;

      const requestData = {
        category, description, location,
        acceptedBy: null,
        timestamp: Date.now(),
        email: currentUser.email
      };

      firebase.database().ref('requests/' + uid + '/' + requestId).set(requestData).then(() => {
        alert("Request Submitted");
        document.getElementById('category').value = '';
        document.getElementById('description').value = '';
        document.getElementById('location').value = '';
        loadRequests();
      });
    }

    function loadRequests() {
      const uid = currentUser.uid;
      firebase.database().ref('requests/' + uid).once('value', snapshot => {
        const list = document.getElementById('request-list');
        list.innerHTML = '';
        snapshot.forEach(child => {
          const req = child.val();
          const li = document.createElement('li');
          li.innerHTML = `
            <b>${req.category}</b> - ${req.description} (${req.location})<br>
            <small>Accepted By: ${req.acceptedBy || 'Not yet accepted'}</small>
            <hr>
          `;
          list.appendChild(li);
        });
      });
    }
  </script>
</body>
</html>
