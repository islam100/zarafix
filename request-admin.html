<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Requests</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9; }
    .accepted { background-color: #e0ffe0; }
  </style>
</head>
<body>
  <h2>Accepted Requests</h2>
  <div id="requestsContainer">Loading...</div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "476473209200",
      appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function fetchData() {
      const container = document.getElementById("requestsContainer");
      container.innerHTML = "Fetching data...";

      try {
        const [requestsSnap, postersSnap] = await Promise.all([
          get(ref(db, "requests")),
          get(ref(db, "posters"))
        ]);

        const requestsData = requestsSnap.val() || {};
        const postersData = postersSnap.val() || {};

        container.innerHTML = "";

        let found = false;

        for (const userId in requestsData) {
          const userRequests = requestsData[userId];
          for (const requestId in userRequests) {
            const request = userRequests[requestId];
            const acceptedBy = request.acceptedBy || {};

            const acceptedPosters = Object.keys(acceptedBy);
            if (acceptedPosters.length === 0) continue;

            found = true;

            const card = document.createElement("div");
            card.className = "card accepted";
            card.innerHTML = `
              <h4>Category: ${request.category}</h4>
              <p><strong>Description:</strong> ${request.description}</p>
              <p><strong>Location:</strong> ${request.location || "N/A"}</p>
              <h5>Accepted By:</h5>
              ${acceptedPosters.map(pid => {
                const poster = postersData[pid];
                return poster
                  ? `<div style="margin-left: 10px;">
                      <p><strong>Name:</strong> ${poster.name}</p>
                      <p><strong>Shop:</strong> ${poster.shop}</p>
                      <p><strong>WhatsApp:</strong> <a href="https://wa.me/${poster.whatsapp}" target="_blank">${poster.whatsapp}</a></p>
                    </div>`
                  : `<p>Poster ID: ${pid} (Details not found)</p>`;
              }).join("")}
            `;
            container.appendChild(card);
          }
        }

        if (!found) {
          container.innerHTML = "<p>No accepted requests yet.</p>";
        }
      } catch (error) {
        console.error("Error fetching data:", error);
        container.innerHTML = "<p>Error loading data.</p>";
      }
    }

    fetchData();
  </script>
</body>
</html>
