<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix Request Form</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .form-box { max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
    .form-box input, textarea, select { width: 100%; padding: 8px; margin: 8px 0; }
    .request-list { margin-top: 30px; }
  </style>
</head>
<body>

<h2>ZaraFix Repair Request</h2>

<div class="form-box" id="formBox">
  <label>Category</label>
  <select id="category">
    <option>Electrician</option>
    <option>Car Mechanic</option>
    <option>Plumber</option>
  </select>

  <label>Description</label>
  <textarea id="description" placeholder="Issue description"></textarea>

  <label>Location</label>
  <input type="text" id="location" placeholder="Enter your location">

  <button onclick="submitRequest()">Submit Request</button>
</div>

<h3>Your Requests</h3>
<div class="request-list" id="requestList">
  <p>Loading your requests...</p>
</div>

<script>
  let currentUserUID = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUserUID = user.uid;
      loadRequests();
    } else {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }
  });

  function submitRequest() {
    const category = document.getElementById("category").value;
    const description = document.getElementById("description").value.trim();
    const location = document.getElementById("location").value.trim();

    if (!category || !description || !location) {
      alert("Please fill all fields.");
      return;
    }

    const requestId = db.ref().child("requests").push().key;

    const requestData = {
      category,
      description,
      location,
      acceptedBy: {},
      timestamp: Date.now()
    };

    db.ref(`requests/${currentUserUID}/${requestId}`).set(requestData).then(() => {
      alert("Request submitted!");
      document.getElementById("description").value = "";
      document.getElementById("location").value = "";
      loadRequests();
    });
  }

  function loadRequests() {
    db.ref(`requests/${currentUserUID}`).on("value", (snapshot) => {
      const data = snapshot.val();
      const container = document.getElementById("requestList");
      container.innerHTML = "";

      if (!data) {
        container.innerHTML = "<p>No requests yet.</p>";
        return;
      }

      Object.entries(data).forEach(([id, req]) => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ddd";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";
        div.innerHTML = `
          <strong>${req.category}</strong><br/>
          ${req.description}<br/>
          üìç ${req.location}<br/>
          ‚úî Accepted By: ${Object.keys(req.acceptedBy || {}).length || 0} service provider(s)
        `;
        container.appendChild(div);
      });
    });
  }
</script>

</body>
</html>
