<!DOCTYPE html>
<html>
<head>
  <title>🛠️ My Posted Requests</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding:10px; background:#f5f5f5; }
    .card {
      background:white; border-radius:16px;
      padding:15px; margin-bottom:15px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
      transition:transform 0.2s;
    }
    .card:hover { transform:translateY(-2px); }
    .btn3d {
      display:inline-block; margin-top:10px;
      padding:10px 16px; border:none;
      border-radius:8px; font-weight:bold;
      box-shadow:0 4px 0 rgba(0,0,0,0.2);
      cursor:pointer; transition:all .1s;
    }
    .btn3d:active { transform:translateY(2px); box-shadow:0 2px 0 rgba(0,0,0,0.2); }
    .btn-whatsapp { background:linear-gradient(to top, #25D366,#128C7E); color:white; }
    .btn-reject { background:linear-gradient(to top, #FF5252,#FF1744); color:white; }
    .btn-delete { background:linear-gradient(to top, #FFA726,#FB8C00); color:white; }
  </style>
</head>
<body>

<h2>🎯 My Service Requests</h2>
<div id="requestsContainer">Loading...</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "...",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "...",
    appId: "..."
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  auth.onAuthStateChanged(user => {
    if (user) loadRequests(user.uid);
    else location.href = 'index.html';
  });

  function loadRequests(uid) {
    const container = document.getElementById('requestsContainer');
    db.ref(`requests/${uid}`).once('value', snap => {
      const data = snap.val();
      container.innerHTML = '';
      if (!data) {
        container.innerHTML = '<p>No requests found.</p>';
        return;
      }
      Object.entries(data).forEach(([reqId, req]) => {
        const card = document.createElement('div');
        card.className = 'card';
        let html = `
          <p><strong>Category:</strong> ${req.category || 'N/A'}</p>
          <p><strong>Description:</strong> ${req.description || 'N/A'}</p>
          <p><strong>Location:</strong> ${req.location || 'N/A'}</p>
        `;
        if (req.acceptedBy) {
          const posterUID = Object.keys(req.acceptedBy)[0];
          html += `<p><strong>Accepted By:</strong> loading...</p>`;
          card.innerHTML = html;
          db.ref(`posters/${posterUID}`).once('value', pSnap => {
            const p = pSnap.val();
            const wa = p.whatsapp.startsWith('91') ? p.whatsapp : '91'+p.whatsapp;
            const acceptedHtml = `
              <p><strong>Accepted By:</strong></p>
              <p>👨‍🔧 ${p.name}</p>
              <p>🏪 ${p.shop}</p>
            `;
            card.innerHTML = html + acceptedHtml + `
              <div>
                <button class="btn3d btn-whatsapp" onclick="window.open('https://wa.me/${wa}','_blank')">📱 WhatsApp</button>
                <button class="btn3d btn-reject" onclick="reject('${uid}','${reqId}')">❌ Reject</button>
                <button class="btn3d btn-delete" onclick="del('${uid}','${reqId}')">🗑️ Delete</button>
              </div>
            `;
          });
        } else {
          html += `<p><strong>Accepted By:</strong> Not accepted yet</p>`;
          card.innerHTML = html + `
            <div>
              <button class="btn3d btn-delete" onclick="del('${uid}','${reqId}')">🗑️ Delete</button>
            </div>
          `;
        }
        container.appendChild(card);
      });
    });
  }

  function reject(uid, reqId) {
    firebase.database().ref(`requests/${uid}/${reqId}/acceptedBy`).remove()
      .then(() => location.reload());
  }
  function del(uid, reqId) {
    if (confirm('Delete this request?'))
      firebase.database().ref(`requests/${uid}/${reqId}`).remove()
        .then(() => location.reload());
  }
</script>
</body>
</html>
