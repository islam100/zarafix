<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Zara Samajik Seva Sanstha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ==== BASIC STYLES ==== */
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#333;}
    header{background:#00897b;color:#fff;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;}
    header h1{font-size:18px;margin:0;}
    nav button{margin-left:8px;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
    nav button:hover{opacity:.9}
    .hidden{display:none;}
    .container{padding:15px;}
    .tabs{display:flex;margin-bottom:10px;}
    .tab{padding:8px 12px;background:#eee;margin-right:6px;border-radius:6px;cursor:pointer;}
    .tab.active{background:#00897b;color:#fff;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;}
    .card{background:#fff;border-radius:8px;overflow:hidden;position:relative;box-shadow:0 2px 5px rgba(0,0,0,.1);cursor:pointer;}
    .card .media{position:relative;}
    .card img{width:100%;height:180px;object-fit:cover;}
    .nav{position:absolute;top:0;width:100%;display:flex;justify-content:space-between;}
    .icon-btn{background:rgba(0,0,0,.5);color:#fff;padding:4px 8px;margin:6px;border-radius:50%;cursor:pointer;}
    .body{padding:10px;}
    .name{font-weight:bold;font-size:16px;margin-bottom:4px;}
    .meta{font-size:13px;margin:3px 0;color:#555;}
    .price{font-weight:bold;margin-left:5px;}
    .discount{color:#d32f2f;font-weight:bold;margin-left:5px;}
    .badge{position:absolute;top:8px;left:8px;padding:2px 6px;border-radius:4px;font-size:11px;color:#fff;}
    .badge.approved{background:#43a047;}
    .badge.pending{background:#fbc02d;color:#000;}
    .badge.rejected{background:#e53935;}
    .card-actions{margin-top:6px;}
    .btn-3d{background:#00897b;color:#fff;padding:5px 10px;margin:2px;border:none;border-radius:6px;cursor:pointer;display:inline-block;text-decoration:none;}
    .btn-3d:hover{opacity:.9}
    .btn-danger{background:#e53935;}
    .btn-success{background:#43a047;}
    /* Modal */
    #modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;}
    #modal.show{display:flex;}
    #modalCard{background:#fff;border-radius:8px;max-width:480px;width:90%;max-height:90%;overflow:auto;}
    /* Form */
    form input,form textarea,form select{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;}
    form textarea{resize:vertical;}
    #formMsg{font-size:13px;margin-top:4px;color:#d32f2f;}
    .hint{color:#777;text-align:center;}
  </style>
</head>
<body>
  <header>
    <h1>Zara Samajik Seva Sanstha</h1>
    <nav>
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" class="hidden">Logout</button>
    </nav>
  </header>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="publicTab">Offers</div>
      <div class="tab" data-tab="shopTab">My Shop</div>
      <div class="tab hidden" id="adminTabBtn" data-tab="adminTab">Admin</div>
    </div>

    <!-- Public Tab -->
    <div id="publicTab">
      <div>
        <select id="filterCategory">
          <option value="">All Categories</option>
          <option value="fashion">Fashion</option>
          <option value="electronics">Electronics</option>
          <option value="grocery">Grocery</option>
        </select>
        <input type="text" id="searchInput" placeholder="Search...">
      </div>
      <div class="grid" id="publicGrid"></div>
    </div>

    <!-- My Shop -->
    <div id="shopTab" class="hidden">
      <h3>Add New Product</h3>
      <form>
        <input id="pName" placeholder="Name*" required>
        <select id="pCategory">
          <option value="fashion">Fashion</option>
          <option value="electronics">Electronics</option>
          <option value="grocery">Grocery</option>
        </select>
        <input id="pPrice" type="number" placeholder="Price*" required>
        <input id="pDiscount" type="number" placeholder="Discount % (0-95)">
        <input id="pWhats" placeholder="WhatsApp Number*" required>
        <textarea id="pDesc" placeholder="Description"></textarea>
        <input id="pImages" type="file" accept="image/*" multiple>
        <button type="button" id="submitProduct" class="btn-3d">Submit</button>
        <div id="formMsg"></div>
      </form>
      <h3>My Offers</h3>
      <div class="grid" id="myGrid"></div>
    </div>

    <!-- Admin -->
    <div id="adminTab" class="hidden">
      <h3>Admin Panel</h3>
      <div id="aTotal"></div>
      <div id="aApproved"></div>
      <div id="aPending"></div>
      <div id="aRejected"></div>
      <div class="grid" id="adminGrid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal"><div id="modalCard"></div></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Main JS -->
  <script>
    /* ==== JS CODE (Improved Version) ==== */
    const firebaseConfig = { 
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "XXXX"
    };
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';
    const IMGBB_KEY = 'ff05d1b5c3b3e139253856f0ad1123df';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    /* Helpers */
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);
    const rupees = n => '₹' + Number(n||0).toLocaleString('en-IN');
    const toast = (el,msg)=>{ el.textContent = msg; setTimeout(()=> el.textContent='', 3000) };

    /* Tabs */
    document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['publicTab','shopTab','adminTab'].forEach(id=> byId(id).classList.add('hidden'));
      byId(t.dataset.tab).classList.remove('hidden');
    }));

    /* Auth */
    byId('loginBtn').onclick = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    byId('logoutBtn').onclick = ()=> auth.signOut();
    auth.onAuthStateChanged(user=>{
      const logged = !!user;
      byId('loginBtn').classList.toggle('hidden', logged);
      byId('logoutBtn').classList.toggle('hidden', !logged);
      byId('shopTab').classList.toggle('hidden', !logged);
      const isAdmin = user && user.email===ADMIN_EMAIL;
      byId('adminTabBtn').classList.toggle('hidden', !isAdmin);
      renderAll();
    });

    /* DB */
    const offersRef = db.ref('offers');
    let ALL=[];
    offersRef.on('value', snap=>{
      const obj = snap.val()||{};
      ALL = Object.values(obj).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      renderAll();
    });

    /* ImgBB Upload */
    async function uploadToImgBB(file){
      const body = new FormData();
      body.append('key', IMGBB_KEY);
      body.append('image', file);
      const res = await fetch('https://api.imgbb.com/1/upload',{method:'POST', body});
      const data = await res.json();
      return data.data.url;
    }
    async function uploadMultiple(files){
      return Promise.all(Array.from(files).slice(0,5).map(f=> uploadToImgBB(f)));
    }

    /* Submit */
    byId('submitProduct').onclick = async()=>{
      const u=auth.currentUser;
      if(!u) return alert('Login first!');
      const name=byId('pName').value.trim();
      const category=byId('pCategory').value.trim();
      const price=Number(byId('pPrice').value);
      const discount=Number(byId('pDiscount').value||0);
      const whats=byId('pWhats').value.trim();
      const desc=byId('pDesc').value.trim();
      const files=byId('pImages').files;
      if(!name||!category||!price||!whats||!files.length){ toast(byId('formMsg'),'Please fill all * fields'); return; }
      if(discount<0||discount>95){ toast(byId('formMsg'),'Discount 0–95 होना चाहिए'); return; }
      const phone=whats.replace(/\D/g,''); if(phone.length<10){ toast(byId('formMsg'),'Valid WhatsApp डालें'); return; }
      byId('formMsg').textContent='Uploading...';
      try{
        const images=await uploadMultiple(files);
        const id=offersRef.push().key;
        await offersRef.child(id).set({id,name,category,price,discount,desc,images,whats:phone,shopUid:u.uid,status:'pending',createdAt:Date.now()});
        toast(byId('formMsg'),'Submitted! Wait for approval.');
        ['pName','pPrice','pDiscount','pWhats','pDesc'].forEach(i=> byId(i).value='');
        byId('pImages').value='';
      }catch(e){ toast(byId('formMsg'),e.message); }
    };

    /* Rendering (same as improved JS earlier) */
    function waLink(p){return `https://wa.me/${p.whats}?text=${encodeURIComponent('हमें आपका product पसंद आया: '+p.name)}`;}
    function galleryHTML(p){const f=(p.images&&p.images[0])||'';return `<div class="media"><img src="${f}"></div>`}
    function makeCard(p,ctx){
      const el=document.createElement('div');el.className='card';
      const finalPrice=p.discount?(p.price-p.price*p.discount/100):p.price;
      el.innerHTML=`
        <span class="badge ${p.status}">${p.status}</span>
        ${galleryHTML(p)}
        <div class="body">
          <div class="name">${p.name}</div>
          <div class="meta">${p.category} • <span class="price">${rupees(finalPrice)}</span> ${p.discount?`<span style="text-decoration:line-through">${rupees(p.price)}</span> <span class="discount">-${p.discount}%</span>`:''}</div>
          <div class="meta">${p.desc||''}</div>
          <div class="card-actions"><a class="btn-3d" target="_blank" href="${waLink(p)}">WhatsApp</a></div>
        </div>`;
      return el;
    }
    function renderPublic(){const g=byId('publicGrid');g.innerHTML='';ALL.filter(p=>p.status!=='rejected').forEach(p=>g.appendChild(makeCard(p,'public')));}
    function renderMine(){const g=byId('myGrid');g.innerHTML='';const u=auth.currentUser;if(!u)return;ALL.filter(p=>p.shopUid===u.uid).forEach(p=>g.appendChild(makeCard(p,'mine')));}
    function renderAdmin(){const g=byId('adminGrid');g.innerHTML='';const u=auth.currentUser;if(!u||u.email!==ADMIN_EMAIL)return;ALL.forEach(p=>g.appendChild(makeCard(p,'admin')));}
    function renderAll(){renderPublic();renderMine();renderAdmin();}
  </script>
</body>
</html>
