<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #eef2f3; margin:0; padding:10px; }
    .card {
      background: white; border-radius: 20px; padding: 15px; margin: 15px 0;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1); transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.01); }
    button {
      padding: 10px 20px; margin: 10px; border: none; border-radius: 12px;
      background: linear-gradient(to right, #42a5f5, #478ed1); color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 12px rgba(66,165,245,0.3);
    }
    input, select {
      padding: 10px; width: 95%; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>üõ†Ô∏è Poster Dashboard</h2>
  <div id="registrationSection" style="display:none;">
    <h3>üîê Poster Registration</h3>
    <input id="name" placeholder="Your Name" />
    <input id="shop" placeholder="Shop Name" />
    <input id="address" placeholder="Shop Address" />
    <select id="category">
      <option value="">Select Category</option>
      <option>AC Mechanic</option>
      <option>Electrician</option>
      <option>Plumber</option>
      <option>Car Mechanic</option>
    </select>
    <input id="whatsapp" placeholder="WhatsApp Number" />
    <button onclick="registerPoster()">Submit</button>
    <p id="walletError" style="color:red;"></p>
  </div>

  <div id="approvalMsg" style="display:none;">
    <p>‚è≥ Please wait for admin approval...</p>
  </div>

  <div id="dashboardSection" style="display:none;">
    <h3>üîß Matching Jobs</h3>
    <div id="jobList"></div>
    <h4>üí∞ Wallet: ‚Çπ<span id="wallet"></span></h4>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        const posterRef = db.ref("posters/" + user.uid);
        posterRef.once("value").then(snapshot => {
          const poster = snapshot.val();
          if (!poster) {
            document.getElementById("registrationSection").style.display = "block";
          } else if (!poster.approved) {
            document.getElementById("approvalMsg").style.display = "block";
          } else {
            document.getElementById("dashboardSection").style.display = "block";
            document.getElementById("wallet").textContent = poster.wallet || 0;
            loadJobs(poster.category);
          }
        });
      } else {
        window.location.href = "/index.html";
      }
    });

    function registerPoster() {
      const name = document.getElementById("name").value;
      const shop = document.getElementById("shop").value;
      const address = document.getElementById("address").value;
      const category = document.getElementById("category").value;
      const whatsapp = document.getElementById("whatsapp").value;

      if (!name || !shop || !address || !category || !whatsapp) {
        alert("Please fill all fields.");
        return;
      }

      const newPoster = {
        name, shop, address, category, whatsapp,
        wallet: 100,
        approved: false
      };
      db.ref("posters/" + currentUser.uid).set(newPoster).then(() => {
        alert("Submitted! Wait for admin approval.");
        location.reload();
      });
    }

    function loadJobs(category) {
      db.ref("requests").on("value", snapshot => {
        const jobs = snapshot.val();
        const container = document.getElementById("jobList");
        container.innerHTML = "";
        for (let userId in jobs) {
          for (let jobId in jobs[userId]) {
            const job = jobs[userId][jobId];
            if (job.category === category && (!job.acceptedBy || !job.acceptedBy[currentUser.uid])) {
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <b>${job.name}</b><br>
                üìç ${job.address}<br>
                ‚öôÔ∏è ${job.problem}<br>
                <button onclick="acceptJob('${userId}', '${jobId}')">Accept</button>
              `;
              container.appendChild(div);
            }
          }
        }
      });
    }

    function acceptJob(userId, jobId) {
      const walletRef = db.ref("posters/" + currentUser.uid + "/wallet");
      walletRef.once("value").then(snapshot => {
        const wallet = snapshot.val();
        if (wallet < 20) {
          alert("‚ùå Not enough balance. Please recharge.");
          return;
        }

        const updates = {};
        updates["requests/" + userId + "/" + jobId + "/acceptedBy/" + currentUser.uid] = {
          uid: currentUser.uid,
          timestamp: Date.now()
        };
        updates["posters/" + currentUser.uid + "/wallet"] = wallet - 20;

        db.ref().update(updates).then(() => {
          alert("‚úÖ Job accepted! ‚Çπ20 deducted.");
        });
      });
    }
  </script>
</body>
</html>
