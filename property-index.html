<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property Listing</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:20px;
    background:#f9f9f9;
  }
  header {
    display:flex;
    justify-content:flex-end;
    gap:10px;
    flex-wrap: wrap;
    margin-bottom:15px;
  }
  button.btn {
    cursor:pointer;
    background:#007bff;
    border:none;
    color:white;
    padding:8px 14px;
    border-radius:6px;
    font-size:1rem;
  }
  button.btn:hover {
    background:#0056b3;
  }
  #propertyList {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
    gap:15px;
  }
  .property-card {
    background:white;
    border-radius:10px;
    padding:10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    cursor:pointer;
    display:flex;
    flex-direction: column;
    gap:10px;
    transition: box-shadow 0.3s ease;
  }
  .property-card:hover {
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
  .property-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
  }
  .btn-whatsapp {
    background: #25d366;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    text-decoration:none;
    display:inline-block;
    text-align:center;
    font-weight:600;
  }
  @media(max-width:600px) {
    #propertyList {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<header>
  <button id="loginBtn" class="btn">Google Login</button>
  <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
</header>

<section id="propertyList">
  <!-- Properties will be shown here -->
</section>

<script>
  // Firebase Config - अपने Firebase प्रोजेक्ट के हिसाब से अपडेट करें
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const adminEmail = "zarasamajiksevasanstha@gmail.com";
  const adminWhatsAppNumber = "917378342192";

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const propertyList = document.getElementById('propertyList');

  let currentUser = null;
  let isAdmin = false;

  // Login/logout handlers
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert(e.message));
  };
  logoutBtn.onclick = () => auth.signOut();

  // Price formatting
  function formatPrice(num) {
    return num.toLocaleString('en-IN');
  }

  // WhatsApp लिंक: अगर current user ही पोस्ट करने वाला हो तो admin नंबर दिखाओ, वरना पोस्टर का नंबर दिखाओ
  function getWhatsAppLink(post) {
    let phone;
    if (currentUser && post.userId === currentUser.uid) {
      phone = adminWhatsAppNumber;
    } else {
      phone = post.whatsapp.startsWith("91") ? post.whatsapp : "91" + post.whatsapp;
    }
    const message = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\nTitle: ${post.title}\nCity: ${post.city}\nPrice: ₹${formatPrice(post.price)}`;
    return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  }

  // प्रॉपर्टीज़ दिखाएं
  function renderProperties(posts) {
    propertyList.innerHTML = "";
    if(posts.length === 0) {
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>";
      return;
    }
    posts.forEach(({key, post}) => {
      const card = document.createElement('div');
      card.className = 'property-card';

      const img = document.createElement('img');
      img.src = post.imageUrl || 'https://via.placeholder.com/300x180?text=No+Image';
      img.alt = post.title;
      card.appendChild(img);

      const title = document.createElement('h3');
      title.textContent = post.title;
      card.appendChild(title);

      const city = document.createElement('p');
      city.textContent = "City: " + post.city;
      card.appendChild(city);

      const type = document.createElement('p');
      type.textContent = "Type: " + (post.type === "sale" ? "Buy" : "Rent");
      card.appendChild(type);

      const price = document.createElement('p');
      price.textContent = "Price: ₹" + formatPrice(post.price);
      card.appendChild(price);

      const waLink = document.createElement('a');
      waLink.href = getWhatsAppLink(post);
      waLink.target = "_blank";
      waLink.className = "btn-whatsapp";
      waLink.textContent = "WhatsApp पूछें";
      card.appendChild(waLink);

      propertyList.appendChild(card);
    });
  }

  // Firebase से प्रॉपर्टीज़ fetch करें (approved और admin के लिए पूरी लिस्ट)
  async function fetchProperties() {
    try {
      const snapshot = await db.ref('properties').once('value');
      const data = snapshot.val();
      if (!data) {
        renderProperties([]);
        return;
      }
      const posts = Object.entries(data)
        .filter(([key, post]) => {
          // अगर admin है तो सब दिखाओ, वरना केवल approved दिखाओ
          if (!post.approved && !isAdmin) return false;
          return true;
        })
        .map(([key, post]) => ({key, post}));
      renderProperties(posts);
    } catch(e) {
      console.error("Error fetching properties:", e);
      propertyList.innerHTML = "<p style='color:red; text-align:center;'>प्रॉपर्टी लोड करने में त्रुटि।</p>";
    }
  }

  // Auth state change
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      isAdmin = (user.email === adminEmail);
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      isAdmin = false;
    }
    fetchProperties();
  });

  // शुरू में लोड करें
  fetchProperties();
</script>

</body>
</html>
