<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property Listing</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f9f9f9; }
  header { display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
  button.btn { cursor:pointer; background:#007bff; border:none; color:white; padding:8px 14px; border-radius:6px; font-size:1rem; }
  button.btn:hover { background:#0056b3; }
  button.btn-delete { background:#dc3545; }
  button.btn-delete:hover { background:#a71d2a; }
  button.btn-approve { background:#28a745; }
  button.btn-approve:hover { background:#1e7e34; }
  #propertyList { display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:15px; }
  .property-card { background:white; border-radius:10px; padding:10px; box-shadow:0 0 8px rgba(0,0,0,0.1); cursor:pointer; display:flex; flex-direction:column; gap:10px; transition: box-shadow 0.3s ease; }
  .property-card:hover { box-shadow:0 0 15px rgba(0,0,0,0.2); }
  .property-card img { width:100%; height:180px; object-fit:cover; border-radius:8px; }
  .btn-whatsapp { background:#25d366; color:white; padding:6px 12px; border-radius:8px; text-decoration:none; display:inline-block; text-align:center; font-weight:600; }
  .btn-group { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  #modalOverlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; }
  #modalContent { background:white; max-width:90vw; max-height:90vh; overflow-y:auto; border-radius:10px; padding:20px; position:relative; box-sizing:border-box; }
  #modalContent img { max-width:100%; max-height:400px; border-radius:8px; margin-bottom:15px; }
  #modalClose { position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5rem; font-weight:bold; color:#333; }
  #modalContent h3 { margin-top:0; }
  #modalContent p { line-height:1.5; }
  @media(max-width:600px){ #propertyList { grid-template-columns:1fr; } }
</style>
</head>
<body>

<header>
  <button id="loginBtn" class="btn">Google Login</button>
  <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
</header>

<section id="propertyList">
  <!-- Properties listed here -->
</section>

<!-- Modal for full view -->
<div id="modalOverlay">
  <div id="modalContent">
    <span id="modalClose">&times;</span>
    <img id="modalImage" src="" alt="Property Image" />
    <h3 id="modalTitle"></h3>
    <p id="modalCity"></p>
    <p id="modalType"></p>
    <p id="modalPrice"></p>
    <p id="modalDesc"></p>
    <a href="#" target="_blank" id="modalWhatsapp" class="btn-whatsapp">WhatsApp पूछें</a>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
  authDomain: "property-20d6d.firebaseapp.com",
  databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
  projectId: "property-20d6d",
  storageBucket: "property-20d6d.appspot.com",
  messagingSenderId: "916859697394",
  appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const adminEmail = "zarasamajiksevasanstha@gmail.com";
const adminWhatsAppNumber = "917378342192";

const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const propertyList = document.getElementById('propertyList');

const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const modalImage = document.getElementById('modalImage');
const modalTitle = document.getElementById('modalTitle');
const modalCity = document.getElementById('modalCity');
const modalType = document.getElementById('modalType');
const modalPrice = document.getElementById('modalPrice');
const modalDesc = document.getElementById('modalDesc');
const modalWhatsapp = document.getElementById('modalWhatsapp');

let currentUser = null;
let isAdmin = false;

loginBtn.onclick = () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(e=>alert(e.message)); };
logoutBtn.onclick = () => auth.signOut();

function formatPrice(num){ return num.toLocaleString('en-IN'); }

// WhatsApp लिंक: poster को अलग, post करने वाले को admin नंबर
function getWhatsAppLink(post) {
  if(currentUser && post.userId === currentUser.uid){
    // पोस्ट करने वाले को admin नंबर दिखे
    return `https://wa.me/${adminWhatsAppNumber}?text=${encodeURIComponent('नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\nTitle: '+post.title+'\nCity: '+post.city+'\nPrice: ₹'+formatPrice(post.price))}`;
  } else {
    // सभी users को poster का नंबर दिखे
    return `https://wa.me/${post.whatsapp}?text=${encodeURIComponent('नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\nTitle: '+post.title+'\nCity: '+post.city+'\nPrice: ₹'+formatPrice(post.price))}`;
  }
}

function deleteProperty(key){
  if(confirm("क्या आप इस प्रॉपर्टी को हटाना चाहते हैं?")){
    db.ref('properties/'+key).remove();
  }
}

function approveProperty(key){
  db.ref('properties/'+key).update({approved:true});
}

function renderProperties(posts){
  propertyList.innerHTML = "";
  if(posts.length===0){ propertyList.innerHTML="<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>"; return; }
  posts.forEach(({key, post})=>{
    const card=document.createElement('div'); card.className='property-card';

    const img=document.createElement('img'); img.src=post.imageUrl||'https://via.placeholder.com/300x180?text=No+Image'; img.alt=post.title; card.appendChild(img);

    const title=document.createElement('h3'); title.textContent=post.title; card.appendChild(title);
    const city=document.createElement('p'); city.textContent="City: "+post.city; card.appendChild(city);
    const type=document.createElement('p'); type.textContent="Type: "+(post.type==="sale"?"Buy":"Rent"); card.appendChild(type);
    const price=document.createElement('p'); price.textContent="Price: ₹"+formatPrice(post.price); card.appendChild(price);

    const btnGroup=document.createElement('div'); btnGroup.className="btn-group";

    const waBtn=document.createElement('a'); waBtn.href=getWhatsAppLink(post); waBtn.target="_blank"; waBtn.className="btn-whatsapp"; waBtn.textContent="WhatsApp पूछें"; btnGroup.appendChild(waBtn);

    if(isAdmin || (currentUser && currentUser.uid===post.userId)){
      const delBtn=document.createElement('button'); delBtn.textContent="Delete"; delBtn.className="btn btn-delete"; delBtn.onclick=(e)=>{ e.stopPropagation(); deleteProperty(key); }; btnGroup.appendChild(delBtn);
    }

    if(isAdmin && !post.approved){
      const approveBtn=document.createElement('button'); approveBtn.textContent="Approve"; approveBtn.className="btn btn-approve"; approveBtn.onclick=(e)=>{ e.stopPropagation(); approveProperty(key); }; btnGroup.appendChild(approveBtn);
    }

    card.appendChild(btnGroup);

    card.onclick=()=>{
      modalImage.src=post.imageUrl||'https://via.placeholder.com/600x400?text=No+Image';
      modalTitle.textContent=post.title;
      modalCity.textContent="City: "+post.city;
      modalType.textContent="Type: "+(post.type==="sale"?"Buy":"Rent");
      modalPrice.textContent="Price: ₹"+formatPrice(post.price);
      modalDesc.textContent=post.description;
      modalWhatsapp.href=getWhatsAppLink(post);
      modalOverlay.style.display="flex";
    };

    propertyList.appendChild(card);
  });
}

modalClose.onclick=()=>{ modalOverlay.style.display="none"; };
modalOverlay.onclick=(e)=>{ if(e.target===modalOverlay){ modalOverlay.style.display="none"; } };

async function fetchProperties(){
  try{
    const snapshot=await db.ref('properties').once('value');
    const data=snapshot.val();
    if(!data){ renderProperties([]); return; }
    const posts=Object.entries(data).filter(([key,post])=>{
      if(!isAdmin && !post.approved) return false;
      return true;
    }).map(([key,post])=>({key,post}));
    renderProperties(posts);
  }catch(e){
    console.error("Error fetching properties:",e);
    propertyList.innerHTML="<p style='color:red; text-align:center;'>प्रॉपर्टी लोड करने में त्रुटि।</p>";
  }
}

auth.onAuthStateChanged(user=>{
  currentUser=user;
  if(user){ loginBtn.style.display="none"; logoutBtn.style.display="inline-block"; isAdmin=(user.email===adminEmail); }
  else{ loginBtn.style.display="inline-block"; logoutBtn.style.display="none"; isAdmin=false; }
  fetchProperties();
});

// बिना login के भी approved posts दिखाएँ
fetchProperties();
</script>

</body>
</html>
