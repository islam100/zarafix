<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property — Admin + User</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 10px; background: #f9f9f9;
  }
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 10px; border-bottom: 1px solid #ddd;
  }
  h1 {
    margin: 0;
    color: #333;
  }
  #userInfo {
    font-size: 0.9rem;
    color: #555;
    margin-right: 10px;
  }
  button.btn, button.btn-small {
    cursor: pointer;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 1rem;
    transition: background-color 0.3s ease;
  }
  button.btn {
    background-color: #007bff;
    color: white;
    margin-left: 5px;
  }
  button.btn:hover:not(:disabled) {
    background-color: #0056b3;
  }
  button.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  button.btn-small {
    font-size: 0.85rem;
    padding: 5px 10px;
    margin-left: 5px;
  }
  button.btn-delete {
    background-color: #dc3545;
    color: white;
  }
  button.btn-delete:hover {
    background-color: #a71d2a;
  }
  button.btn-approve {
    background-color: #28a745;
    color: white;
  }
  button.btn-approve:hover {
    background-color: #1e7e34;
  }
  .btn-whatsapp {
    background: #25d366;
    color: white;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 4px 8px #128c4a;
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 0.85rem;
  }
  #uploadSection {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    max-width: 500px;
  }
  #uploadSection input, #uploadSection select, #uploadSection textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 8px;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #imagePreview {
    width: 100%;
    max-height: 250px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
    display: none;
  }
  .property-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    margin: 15px 0;
    display: flex;
    gap: 15px;
    padding: 10px;
  }
  .property-card img {
    width: 150px;
    border-radius: 8px;
    object-fit: cover;
  }
  .property-content {
    flex: 1;
  }
  .property-title {
    margin: 0 0 6px 0;
  }
  .property-info p {
    margin: 4px 0;
    color: #555;
  }
  .btn-group {
    margin-top: 10px;
  }
  /* Responsive */
  @media (max-width: 600px) {
    .property-card {
      flex-direction: column;
      align-items: center;
    }
    .property-card img {
      width: 100%;
      max-height: 200px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Zara Property</h1>
  <div style="display:flex; align-items:center;">
    <div id="userInfo"></div>
    <button id="loginBtn" class="btn">Google Login</button>
    <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
    <button id="postBtn" class="btn" style="display:none;">Post Property</button>
  </div>
</header>

<section id="uploadSection" style="display:none;">
  <h2>Post Property</h2>
  <input type="text" id="title" placeholder="Title" />
  <input type="text" id="city" placeholder="City" />
  <select id="type">
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <input type="number" id="price" placeholder="Price (₹)" />
  <textarea id="desc" placeholder="Description"></textarea>
  <input type="file" id="imageFile" accept="image/*" />
  <img id="imagePreview" alt="Image Preview" />
  <button id="submitPost" class="btn">Upload & Post</button>
  <button id="cancelPost" class="btn" style="background:#6c757d; box-shadow:0 4px 6px #4e545a;">Cancel</button>
  <p id="uploadStatus"></p>
</section>

<section class="search-bar" style="margin-top:15px;">
  <input type="text" id="searchInput" placeholder="शीर्षक या शहर से खोजें..." />
  <select id="filterType">
    <option value="">All types</option>
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <button id="searchBtn" class="btn">Search</button>
</section>

<section id="propertyList"></section>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const imgbbApiKey = "52759d17d6011826df915af26466a7ea";
  const adminEmail = "zarasamajiksevasanstha@gmail.com";

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const postBtn = document.getElementById('postBtn');
  const uploadSection = document.getElementById('uploadSection');
  const submitPost = document.getElementById('submitPost');
  const cancelPost = document.getElementById('cancelPost');
  const uploadStatus = document.getElementById('uploadStatus');
  const propertyList = document.getElementById('propertyList');
  const searchInput = document.getElementById('searchInput');
  const filterType = document.getElementById('filterType');
  const searchBtn = document.getElementById('searchBtn');
  const imageFileInput = document.getElementById('imageFile');
  const imagePreview = document.getElementById('imagePreview');
  const userInfo = document.getElementById('userInfo');

  let currentUser = null;
  let isAdmin = false;

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert(err.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  postBtn.onclick = () => {
    uploadSection.style.display = 'block';
    window.scrollTo({ top: uploadSection.offsetTop - 10, behavior: 'smooth' });
  };

  cancelPost.onclick = () => {
    uploadSection.style.display = 'none';
    clearForm();
  };

  imageFileInput.onchange = () => {
    const file = imageFileInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      imagePreview.src = '';
      imagePreview.style.display = 'none';
    }
  };

  submitPost.onclick = async () => {
    uploadStatus.textContent = "";
    submitPost.disabled = true;
    submitPost.textContent = "Uploading...";

    const title = document.getElementById('title').value.trim();
    const city = document.getElementById('city').value.trim();
    const type = document.getElementById('type').value;
    const priceValue = document.getElementById('price').value.trim();
    const price = Number(priceValue);
    const desc = document.getElementById('desc').value.trim();
    const imageFile = imageFileInput.files[0];

    if(!title || !city || !type || !priceValue || isNaN(price) || !desc || !imageFile){
      uploadStatus.textContent = "सभी फील्ड्स सही से भरें और इमेज अपलोड करें।";
      uploadStatus.style.color = "#dc3545";
      submitPost.disabled = false;
      submitPost.textContent = "Upload & Post";
      return;
    }

    uploadStatus.style.color = "black";
    uploadStatus.textContent = "Uploading image...";

    try {
      const imageUrl = await uploadImageToImgbb(imageFile);
      const timestamp = Date.now();

      const newRef = db.ref('properties').push();
      await newRef.set({
        title, city, type, price, description: desc,
        imageUrl, userId: currentUser.uid, userEmail: currentUser.email,
        whatsapp: currentUser.phoneNumber || currentUser.email || "",  
        timestamp, approved: false
      });

      uploadStatus.style.color = "#28a745";
      uploadStatus.textContent = "Property posted! Waiting for admin approval.";
      clearForm();
      uploadSection.style.display = 'none';

    } catch (err) {
      uploadStatus.style.color = "#dc3545";
      uploadStatus.textContent = "Image upload failed: " + err.message;
      console.error(err);
    } finally {
      submitPost.disabled = false;
      submitPost.textContent = "Upload & Post";
    }
  };

  function clearForm(){
    document.getElementById('title').value = "";
    document.getElementById('city').value = "";
    document.getElementById('type').value = "sale";
    document.getElementById('price').value = "";
    document.getElementById('desc').value = "";
    imageFileInput.value = "";
    imagePreview.src = "";
    imagePreview.style.display = 'none';
    uploadStatus.textContent = "";
  }

  async function uploadImageToImgbb(file){
    const formData = new FormData();
    formData.append('image', file);

    const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    if(data.success) return data.data.url;
    else throw new Error('Image upload failed: ' + (data.error?.message || 'Unknown error'));
  }

  function formatPrice(num){
    return num.toLocaleString('en-IN');
  }

  function whatsappLink(post) {
    const adminPhone = "917378342192";
    const phone = isAdmin ? (post.whatsapp || adminPhone) : adminPhone;

    const msg = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\n\nTitle: ${post.title}\nCity: ${post.city}\nPrice: ₹${formatPrice(post.price)}\n\nLink: ${window.location.href}`;
    return `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
  }

  function isExpired(ts){
    const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
    return (Date.now() - ts) > THIRTY_DAYS;
  }

  function deleteProperty(key){
    if(confirm("क्या आप इस प्रॉपर्टी को हटाना चाहते हैं?")){
      db.ref('properties/'+key).remove();
    }
  }

  function approveProperty(key){
    db.ref('properties/'+key).update({approved:true});
  }

  function renderProperties(posts){
    propertyList.innerHTML = "";
    if(posts.length === 0){
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>";
      return;
    }

    posts.forEach(({key, post}) => {
      const div = document.createElement('div');
      div.className =
