<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property — Admin + User</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  /* (उपरोक्त स्टाइल्स ही रहें) */
  /* ... */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    background: #f9f9f9;
  }
  /* बाकी CSS ... */
  header {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  /* ... बाकी CSS जैसा ऊपर है ... */
  #propertyList {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
    gap: 15px;
  }
  .property-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    padding: 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: box-shadow 0.3s ease;
  }
  .property-card:hover {
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
  .property-card img {
    width: 100%;
    max-height: 180px;
    object-fit: cover;
    border-radius: 8px;
  }
  /* बाकी स्टाइल जैसा ऊपर */
</style>
</head>
<body>

<header>
  <button id="loginBtn" class="btn">Google Login</button>
  <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
  <button id="postBtn" class="btn" style="display:none;">Post Property</button>
</header>

<section id="uploadSection" style="display:none;">
  <!-- (फॉर्म जैसा ऊपर है) -->
  <!-- ... -->
</section>

<section style="margin-bottom:20px;">
  <input type="text" id="searchInput" placeholder="Search by title or city..." style="padding:8px; width: 250px; max-width: 80%;" />
  <select id="filterType" style="padding:8px;">
    <option value="">All types</option>
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <button id="searchBtn" class="btn">Search</button>
</section>

<section id="propertyList"></section>

<!-- Modal जैसा ऊपर -->

<script>
  // Firebase Config (अपने config डालें)
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const adminEmail = "zarasamajiksevasanstha@gmail.com";
  const adminWhatsAppNumber = "917378342192";

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const postBtn = document.getElementById('postBtn');

  const propertyList = document.getElementById('propertyList');
  const searchInput = document.getElementById('searchInput');
  const filterType = document.getElementById('filterType');
  const searchBtn = document.getElementById('searchBtn');

  let currentUser = null;
  let isAdmin = false;

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert(err.message));
  };
  logoutBtn.onclick = () => auth.signOut();

  // Format price Indian style
  function formatPrice(num){
    return num.toLocaleString('en-IN');
  }

  // WhatsApp लिंक
  function whatsappLink(post) {
    if (currentUser && post.userId === currentUser.uid) {
      const phone = adminWhatsAppNumber;
      const msg = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\n\nTitle: ${post.title}\nCity: ${post.city}\nPrice: ₹${formatPrice(post.price)}`;
      return `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    } else {
      const phone = post.whatsapp.startsWith("91") ? post.whatsapp : "91" + post.whatsapp;
      const msg = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\n\nTitle: ${post.title}\nCity: ${post.city}\nPrice: ₹${formatPrice(post.price)}`;
      return `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    }
  }

  function renderProperties(posts){
    propertyList.innerHTML = "";
    if(posts.length === 0){
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>";
      return;
    }

    posts.forEach(({key, post}) => {
      const div = document.createElement('div');
      div.className = "property-card";

      const img = document.createElement('img');
      img.src = post.imageUrl;
      img.alt = post.title;
      div.appendChild(img);

      const title = document.createElement('h3');
      title.className = "property-title";
      title.textContent = post.title;
      div.appendChild(title);

      const infoCity = document.createElement('p');
      infoCity.textContent = "City: " + post.city;
      div.appendChild(infoCity);

      const infoType = document.createElement('p');
      infoType.textContent = "Type: " + (post.type === "sale" ? "Buy" : "Rent");
      div.appendChild(infoType);

      const infoPrice = document.createElement('p');
      infoPrice.textContent = "Price: ₹" + formatPrice(post.price);
      div.appendChild(infoPrice);

      // WhatsApp Button
      const waBtn = document.createElement('a');
      waBtn.href = whatsappLink(post);
      waBtn.target = "_blank";
      waBtn.className = "btn-small btn-whatsapp";
      waBtn.textContent = "WhatsApp";
      div.appendChild(waBtn);

      propertyList.appendChild(div);
    });
  }

  async function fetchProperties(){
    try {
      const snapshot = await db.ref('properties').once('value');
      const data = snapshot.val();
      console.log("Fetched data:", data);

      if(!data){
        renderProperties([]);
        return;
      }

      const searchText = searchInput.value.trim().toLowerCase();
      const filter = filterType.value;

      const posts = Object.entries(data)
        .filter(([key, post]) => {
          // केवल approved properties दिखाएं (admin के अलावा)
          if(!post.approved && !isAdmin) return false;

          const matchesSearch = post.title.toLowerCase().includes(searchText) || post.city.toLowerCase().includes(searchText);
          const matchesFilter = filter === "" || post.type === filter;

          return matchesSearch && matchesFilter;
        })
        .map(([key, post]) => ({key, post}));

      renderProperties(posts);

    } catch(err){
      console.error("Error fetching properties:", err);
      propertyList.innerHTML = "<p style='text-align:center; color:#dc3545;'>प्रॉपर्टी लोड करने में त्रुटि।</p>";
    }
  }

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user){
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      postBtn.style.display = 'inline-block';

      isAdmin = (user.email === adminEmail);
    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      postBtn.style.display = 'none';
      isAdmin = false;
    }
    fetchProperties();
  });

  searchBtn.onclick = () => {
    fetchProperties();
  };

  searchInput.onkeydown = (e) => {
    if(e.key === "Enter") fetchProperties();
  };

  fetchProperties();

</script>

</body>
</html>
