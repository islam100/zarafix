<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZaraFix All Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100">

<div class="container mx-auto p-4">

  <!-- Login Button -->
  <div id="loginDiv" class="text-center mb-4">
    <button id="googleLoginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Google Login</button>
  </div>

  <!-- Post Form -->
  <div id="postFormDiv" class="hidden bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-bold mb-2">New Post</h2>
    <input type="text" id="shopName" placeholder="Shop Name" class="border p-2 w-full mb-2 rounded">
    <input type="text" id="address" placeholder="Address" class="border p-2 w-full mb-2 rounded">
    <input type="text" id="category" placeholder="Category" class="border p-2 w-full mb-2 rounded">
    <input type="text" id="whatsapp" placeholder="WhatsApp Number" class="border p-2 w-full mb-2 rounded">
    <input type="file" id="imageFile" class="border p-2 w-full mb-2 rounded">
    <button id="submitPost" class="px-4 py-2 bg-green-600 text-white rounded">Submit Post</button>
  </div>

  <!-- Posts Display -->
  <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Posts will be injected here -->
  </div>

</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  const adminEmails = ["admin@example.com"]; // Admin emails

  // Google login
  document.getElementById("googleLoginBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      currentUser = result.user;
      alert("Logged in as " + currentUser.email);
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("postFormDiv").style.display = "block";
      loadPosts();
    } catch(e) {
      alert("Login failed: " + e.message);
    }
  };

  // Submit Post
  document.getElementById("submitPost").onclick = async () => {
    const shopName = document.getElementById("shopName").value;
    const address = document.getElementById("address").value;
    const category = document.getElementById("category").value;
    const whatsapp = document.getElementById("whatsapp").value;
    const file = document.getElementById("imageFile").files[0];

    if(!shopName || !address || !category || !whatsapp || !file){
      alert("All fields are required");
      return;
    }

    // Upload image to imgbb
    const fd = new FormData();
    fd.append('image', file);
    const r = await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5", {method:"POST", body:fd});
    const data = await r.json();
    const imageUrl = data.data.display_url;

    const newPostRef = db.ref('posts').push();
    await newPostRef.set({
      shopName, address, category, whatsapp, imageUrl,
      status: "Waiting",
      poster: currentUser.email,
      timestamp: Date.now()
    });

    alert("Post submitted, waiting for approval");
    document.getElementById("shopName").value = "";
    document.getElementById("address").value = "";
    document.getElementById("category").value = "";
    document.getElementById("whatsapp").value = "";
    document.getElementById("imageFile").value = "";

    loadPosts();
  };

  // Load posts
  function loadPosts(){
    db.ref('posts').orderByChild('timestamp').on('value', snapshot => {
      const container = document.getElementById('postsContainer');
      container.innerHTML = '';
      const posts = [];
      snapshot.forEach(snap => {
        posts.push({id: snap.key, ...snap.val()});
      });
      posts.reverse(); // New posts on top

      posts.forEach(post => {
        const card = document.createElement('div');
        card.className = "bg-white rounded shadow p-2 flex flex-col";

        // Image
        const img = document.createElement('img');
        img.src = post.imageUrl;
        img.className = "w-full h-48 object-cover rounded mb-2";
        card.appendChild(img);

        // Info
        card.innerHTML += `
          <h3 class="font-bold text-lg">${post.shopName}</h3>
          <p>${post.address}</p>
          <p>${post.category}</p>
          <p>WhatsApp: <a href="https://wa.me/${post.whatsapp}" target="_blank" class="text-blue-600">${post.whatsapp}</a></p>
          <p>Status: <span style="color:${post.status=="Approved"?"green":"orange"}">${post.status}</span></p>
        `;

        // Admin buttons
        if(currentUser && adminEmails.includes(currentUser.email)){
          const btnDiv = document.createElement('div');
          btnDiv.className = "flex gap-2 mt-2";
          
          const approveBtn = document.createElement('button');
          approveBtn.innerText = "Approve";
          approveBtn.className = "px-2 py-1 bg-green-500 text-white rounded";
          approveBtn.onclick = () => db.ref('posts/'+post.id).update({status:"Approved"});
          btnDiv.appendChild(approveBtn);

          const rejectBtn = document.createElement('button');
          rejectBtn.innerText = "Reject";
          rejectBtn.className = "px-2 py-1 bg-orange-500 text-white rounded";
          rejectBtn.onclick = () => db.ref('posts/'+post.id).update({status:"Waiting"});
          btnDiv.appendChild(rejectBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.innerText = "Delete";
          deleteBtn.className = "px-2 py-1 bg-red-500 text-white rounded";
          deleteBtn.onclick = () => db.ref('posts/'+post.id).remove();
          btnDiv.appendChild(deleteBtn);

          card.appendChild(btnDiv);
        }

        container.appendChild(card);
      });
    });
  }

  // Load posts for everyone (without login)
  loadPosts();

</script>
</body>
</html>
