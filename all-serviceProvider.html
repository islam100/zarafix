<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Service Posts</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-5">

<div id="loginDiv" class="mb-5">
    <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Login with Google</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hidden">Logout</button>
</div>

<div id="postFormDiv" class="mb-5 hidden">
    <textarea id="postContent" placeholder="Type your post..." class="border p-2 w-full"></textarea>
    <button id="submitPost" class="bg-green-500 text-white px-4 py-2 rounded mt-2">Submit Post</button>
</div>

<div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

<script>
const firebaseConfig = {
  apiKey: "_FIREBASE_API_KEY",
  authDomain: "_YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://_YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "_YOUR_PROJECT_ID",
  storageBucket: "_YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "_SENDER_ID",
  appId: "_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const postFormDiv = document.getElementById("postFormDiv");
const submitPost = document.getElementById("submitPost");
const postContent = document.getElementById("postContent");
const postsContainer = document.getElementById("postsContainer");

let currentUser = null;
const adminEmail = "zarasamajiksevasanstha@gmail.com";

loginBtn.onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  currentUser = user;
  if(user){
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    postFormDiv.classList.remove("hidden");
  } else {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    postFormDiv.classList.add("hidden");
  }
});

submitPost.onclick = () => {
  if(!postContent.value.trim()) return alert("Post empty!");
  const newPostKey = db.ref("posts").push().key;
  db.ref("posts/"+newPostKey).set({
    content: postContent.value,
    author: currentUser.displayName,
    email: currentUser.email,
    status: "waiting",
    timestamp: Date.now()
  });
  postContent.value = "";
};

// Fetch and display posts
db.ref("posts").on("value", snapshot => {
  postsContainer.innerHTML = "";
  const posts = snapshot.val();
  if(!posts) return;
  
  // Convert object to array and sort by timestamp descending
  const postsArr = Object.entries(posts).sort((a,b)=> b[1].timestamp - a[1].timestamp);

  postsArr.forEach(([key, post]) => {
    const card = document.createElement("div");
    card.className = `p-4 rounded shadow ${
      post.status === "approved" ? "bg-green-100" : "bg-yellow-100"
    }`;
    
    card.innerHTML = `
      <p>${post.content}</p>
      <p class="text-sm mt-1">By: ${post.author} (${post.status === "approved" ? "Approved" : "Waiting"})</p>
    `;

    if(currentUser && currentUser.email === adminEmail){
      const approveBtn = document.createElement("button");
      approveBtn.textContent = "Approve";
      approveBtn.className = "bg-green-500 text-white px-2 py-1 rounded mr-2 mt-2";
      approveBtn.onclick = () => db.ref("posts/"+key+"/status").set("approved");

      const rejectBtn = document.createElement("button");
      rejectBtn.textContent = "Reject";
      rejectBtn.className = "bg-red-500 text-white px-2 py-1 rounded mr-2 mt-2";
      rejectBtn.onclick = () => db.ref("posts/"+key+"/status").set("rejected");

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "bg-gray-500 text-white px-2 py-1 rounded mt-2";
      deleteBtn.onclick = () => db.ref("posts/"+key).remove();

      card.appendChild(approveBtn);
      card.appendChild(rejectBtn);
      card.appendChild(deleteBtn);
    }

    postsContainer.appendChild(card);
  });
});
</script>
</body>
</html>
