<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZaraFix Posts</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="p-4">
    <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Login with Google</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hidden">Logout</button>
</div>

<div id="uploadSection" class="p-4 hidden">
    <input type="text" id="shopName" placeholder="Shop Name" class="border p-2 rounded w-full mb-2">
    <input type="text" id="address" placeholder="Address" class="border p-2 rounded w-full mb-2">
    <input type="text" id="whatsapp" placeholder="WhatsApp Number" class="border p-2 rounded w-full mb-2">
    <input type="file" id="shopImage" class="border p-2 rounded w-full mb-2">
    <button id="postBtn" class="bg-green-500 text-white px-4 py-2 rounded">Post</button>
</div>

<div id="postsContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
  authDomain: "zara-fix-2e35a.firebaseapp.com",
  databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
  projectId: "zara-fix-2e35a",
  storageBucket: "zara-fix-2e35a.appspot.com",
  messagingSenderId: "636550144008",
  appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
};
firebase.initializeApp(firebaseConfig);

// Admin email
const adminEmail = "zarasamajiksevasanstha@gmail.com";
let currentUser = null;

// Login
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const uploadSection = document.getElementById("uploadSection");

loginBtn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await firebase.auth().signInWithPopup(provider);
    currentUser = result.user;
};

logoutBtn.onclick = () => {
    firebase.auth().signOut();
    currentUser = null;
};

// Auth state change
firebase.auth().onAuthStateChanged(user => {
    if(user){
        currentUser = user;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        uploadSection.classList.remove("hidden");
        loadPosts();
    } else {
        currentUser = null;
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        uploadSection.classList.add("hidden");
        document.getElementById("postsContainer").innerHTML = "";
    }
});

// Post
document.getElementById("postBtn").onclick = async () => {
    const shopName = document.getElementById("shopName").value;
    const address = document.getElementById("address").value;
    const whatsapp = document.getElementById("whatsapp").value;
    const file = document.getElementById("shopImage").files[0];

    if(!shopName || !address || !whatsapp || !file){
        alert("सभी fields भरें और image चुनें");
        return;
    }

    const fd = new FormData();
    fd.append("image", file);

    // Upload to imgbb
    const r = await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5", {method:"POST", body:fd});
    const data = await r.json();
    const imageURL = data.data.url;

    // Save to Firebase
    const newPostRef = firebase.database().ref("posts").push();
    await newPostRef.set({
        shopName, address, whatsapp, imageURL,
        status: "Waiting",
        uid: currentUser.uid
    });

    document.getElementById("shopName").value="";
    document.getElementById("address").value="";
    document.getElementById("whatsapp").value="";
    document.getElementById("shopImage").value="";

    loadPosts();
};

// Load posts
async function loadPosts(){
    const snapshot = await firebase.database().ref("posts").once("value");
    const postsContainer = document.getElementById("postsContainer");
    postsContainer.innerHTML = "";

    snapshot.forEach(child => {
        const post = child.val();
        const id = child.key;

        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";

        // Status color
        let statusColor = "yellow";
        if(post.status === "Approved") statusColor = "green";
        if(post.status === "Rejected") statusColor = "red";

        card.innerHTML = `
            <h3 class="font-bold text-lg">${post.shopName}</h3>
            <p>${post.address}</p>
            <p>WhatsApp: ${post.whatsapp}</p>
            <img src="${post.imageURL}" class="w-full h-48 object-cover my-2 rounded">
            <p class="font-bold text-white px-2 py-1 rounded" style="background-color:${statusColor}">${post.status}</p>
        `;

        // Admin buttons
        if(currentUser && currentUser.email === adminEmail){
            const approveBtn = document.createElement("button");
            approveBtn.innerText = "Approve";
            approveBtn.className = "bg-green-500 text-white px-2 py-1 m-1 rounded";
            approveBtn.onclick = () => firebase.database().ref("posts/"+id).update({status:"Approved"}).then(loadPosts);

            const rejectBtn = document.createElement("button");
            rejectBtn.innerText = "Reject";
            rejectBtn.className = "bg-red-500 text-white px-2 py-1 m-1 rounded";
            rejectBtn.onclick = () => firebase.database().ref("posts/"+id).update({status:"Rejected"}).then(loadPosts);

            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "Delete";
            deleteBtn.className = "bg-gray-500 text-white px-2 py-1 m-1 rounded";
            deleteBtn.onclick = () => firebase.database().ref("posts/"+id).remove().then(loadPosts);

            card.append(approveBtn, rejectBtn, deleteBtn);
        }

        postsContainer.appendChild(card);
    });
}
</script>
</body>
</html>
