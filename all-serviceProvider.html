<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZaraFix — Providers, Wallet & Admin (Single Page)</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* ------------------------
       Minimal 3D-ish theme
       ------------------------ */
    :root{
      --bg:#07101a; --card:#0e1720; --muted:#9fb2c7; --glass:rgba(255,255,255,0.03);
      --accent1:#6d28d9; --accent2:#0ea5a4; --accent3:#f97316; --good:#16a34a; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#05070a 0%,#07101a 60%);color:#e6f2fb}
    .wrap{max-width:1100px;margin:18px auto;padding:14px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border-radius:14px;background:linear-gradient(135deg,var(--card),#07101a);box-shadow: 0 8px 30px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:52px;height:52px;border-radius:12px;display:grid;place-items:center;font-weight:800;background:linear-gradient(145deg,#0b1b2b,#1a3a74);box-shadow:8px 8px 20px rgba(0,0,0,0.6);font-size:18px}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;transition:transform .12s, box-shadow .12s;box-shadow: 0 10px 22px rgba(0,0,0,0.5); background:linear-gradient(145deg,#0f1722,#07101a); color:#e6f2fb}
    .btn:hover{transform:translateY(-3px)}
    .pill{border-radius:999px;padding:8px 12px}
    .btn-acc{background:linear-gradient(145deg,var(--accent1),#3b82f6);box-shadow:0 8px 22px rgba(107,70,193,0.18)}
    .btn-good{background:linear-gradient(145deg,#10b981,var(--accent2));}
    .btn-warn{background:linear-gradient(145deg,var(--accent3),#fb923c);}
    .btn-danger{background:linear-gradient(145deg,#ef4444,#c026d3);}

    main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    @media(max-width:980px){ main{grid-template-columns:1fr} }

    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 14px 40px rgba(3,8,20,0.65)}
    .searchbar{display:flex;gap:10px;align-items:center}
    input[type="text"],input[type="tel"],input[type="email"],select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--muted);outline:none}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#081226, #07101a);box-shadow: 0 18px 40px rgba(0,0,0,0.7)}
    .media{height:160px;background:#0b1220;display:block}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .chip{position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:999px;font-size:13px;border:1px solid rgba(255,255,255,0.03)}
    .card-body{padding:12px}
    .hrow{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .pill-sm{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .small{font-size:13px}
    .badge{display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03)}
    .muted-block{padding:10px;color:var(--muted)}
    .file-input{display:block}

    /* colored borders for variety */
    .card[data-hue="1"]{border-left:6px solid #2563eb}
    .card[data-hue="2"]{border-left:6px solid #10b981}
    .card[data-hue="3"]{border-left:6px solid #f97316}
    .card[data-hue="4"]{border-left:6px solid #8b5cf6}
    .card[data-hue="5"]{border-left:6px solid #ef4444}

    /* tiny forms */
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:540px){ .form-row{grid-template-columns:1fr} }

    /* error box */
    #errorBox{position:fixed;right:12px;bottom:12px;z-index:9999;max-width:420px}
    #errorBox .err{background:#2b0d0d;padding:10px;border-radius:10px;border:1px solid #4a1010;color:#ffdede;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.6)}
    /* rating stars */
    .stars{display:inline-flex;gap:4px;align-items:center}
    .star{font-size:18px;cursor:pointer}
    .reviews{margin-top:8px}
    .muted-note{color:#9fb2c7;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ZF</div>
        <div>
          <h1>ZaraFix — Service Providers</h1>
          <div class="muted" style="font-size:13px">Search, Post, Approve — Wallet based WhatsApp unlock</div>
        </div>
      </div>

      <div class="controls">
        <div id="walletBadge" class="badge hidden">Wallet: ₹<span id="walletAmt">0</span></div>
        <button id="rechargeBtn" class="btn btn-warn pill hidden">Recharge ₹100</button>
        <button id="postToggle" class="btn pill">Post Service</button>
        <button id="loginBtn" class="btn btn-acc pill">Google Login</button>
      </div>
    </header>

    <main>
      <!-- Left: Listings -->
      <section>
        <div class="panel">
          <div class="searchbar">
            <input id="searchBox" type="text" placeholder="Search by name, city, category… (dropdown नहीं)" />
            <button id="clearSearch" class="btn btn-ghost">Clear</button>
            <div style="flex:1"></div>
            <div class="muted small">Approved listings public; login only to post/unlock.</div>
          </div>

          <div id="cards" class="grid-cards" style="margin-top:12px"></div>
          <div id="emptyMsg" class="muted-block">कोई approved listing नहीं मिली।</div>
        </div>
      </section>

      <!-- Right: Post form + Admin panel -->
      <aside>
        <div id="postPanel" class="panel hidden">
          <h3>Provider Registration / Post (Login required)</h3>
          <form id="postForm">
            <div style="margin-top:8px">
              <label class="small">Your Name</label>
              <input id="pf_name" type="text" placeholder="Name" required />
            </div>
            <div style="margin-top:8px">
              <label class="small">Business / Service Name</label>
              <input id="pf_bname" type="text" placeholder="Shop or Service name" required />
            </div>
            <div class="form-row" style="margin-top:8px">
              <div>
                <label class="small">Category</label>
                <input id="pf_category" placeholder="Electrician, Plumber, Doctor..." required />
              </div>
              <div>
                <label class="small">City / Area</label>
                <input id="pf_city" placeholder="City" required />
              </div>
            </div>

            <div style="margin-top:8px" class="form-row">
              <div>
                <label class="small">Contact (Mobile)</label>
                <input id="pf_phone" type="tel" placeholder="Mobile" required />
              </div>
              <div>
                <label class="small">WhatsApp</label>
                <input id="pf_whatsapp" type="tel" placeholder="WhatsApp number" required />
              </div>
            </div>

            <div style="margin-top:8px">
              <label class="small">Address</label>
              <input id="pf_address" placeholder="Street, landmark" required />
              <div class="muted-note">Map pin/Live location can be added later</div>
            </div>

            <div style="margin-top:8px" class="form-row">
              <div>
                <label class="small">Hours from</label>
                <input id="pf_from" type="time" value="09:00" />
              </div>
              <div>
                <label class="small">Hours to</label>
                <input id="pf_to" type="time" value="22:00" />
              </div>
            </div>

            <div style="margin-top:8px">
              <label class="small">Profile / Shop Image</label>
              <input id="pf_image" class="file-input" type="file" accept="image/*" required />
              <div class="muted-note">Image uploaded directly (ImgBB). URL not required from you.</div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button class="btn btn-good" type="submit">Submit for Approval</button>
              <button id="cancelPost" type="button" class="btn btn-ghost">Cancel</button>
            </div>
          </form>
        </div>

        <div id="adminPanel" class="panel hidden" style="margin-top:14px">
          <h3>Admin Panel</h3>
          <div class="muted-note">Logged in as admin — approve / reject / delete / manage recharges</div>
          <div id="adminLists" style="margin-top:10px"></div>
        </div>

        <div class="panel" style="margin-top:14px">
          <h3>How it works</h3>
          <div class="muted small">- Anyone can view approved listings. Posting & unlocking WhatsApp require login.<br>- WhatsApp unlock costs ₹20 (deducted from wallet).<br>- Recharge requests are ₹100 fixed and require admin approval.</div>
        </div>
      </aside>
    </main>

    <div id="errorBox"></div>
  </div>

  <script>
  /***********************
   * Configuration
   ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
  };

  const ADMIN_EMAIL = "zarasamajiksevasanstha@gmail.com";
  const IMGBB_API = "cad1f0dbfbd25346460789376cc2d7d5"; // existing key used earlier

  /***********************
   * Defensive error UI
   ***********************/
  (function(){
    function show(msg){
      console.error(msg);
      try{
        const box = document.getElementById('errorBox');
        if(!box) return;
        const el = document.createElement('div'); el.className='err'; el.textContent = String(msg).slice(0,500);
        box.appendChild(el);
        setTimeout(()=>{ try{ box.removeChild(el); }catch(e){} }, 20000);
      }catch(e){ console.error('err show failed', e); }
    }
    window.addEventListener('error', function(e){ show('Error: '+(e.message||e)); });
    window.addEventListener('unhandledrejection', function(e){ show('UnhandledRejection: '+(e.reason && e.reason.message? e.reason.message : JSON.stringify(e.reason))); });
    window._zfShowError = show;
  })();

  /***********************
   * Init Firebase when page loads
   ***********************/
  window.addEventListener('load', async () => {
    try{
      if(typeof firebase === 'undefined') throw new Error('Firebase SDK not loaded.');
      firebase.initializeApp(firebaseConfig);
    }catch(e){
      window._zfShowError('Firebase init failed: ' + e.message);
      return;
    }

    const auth = firebase.auth();
    const db = firebase.database();

    // UI refs
    const loginBtn = document.getElementById('loginBtn');
    const postToggle = document.getElementById('postToggle');
    const postPanel = document.getElementById('postPanel');
    const postForm = document.getElementById('postForm');
    const cancelPost = document.getElementById('cancelPost');
    const cardsWrap = document.getElementById('cards');
    const emptyMsg = document.getElementById('emptyMsg');
    const walletBadge = document.getElementById('walletBadge');
    const walletAmt = document.getElementById('walletAmt');
    const rechargeBtn = document.getElementById('rechargeBtn');
    const adminPanel = document.getElementById('adminPanel');
    const adminLists = document.getElementById('adminLists');
    const searchBox = document.getElementById('searchBox');
    const clearSearch = document.getElementById('clearSearch');

    let providersCache = {}; // local snapshot
    window.__accessCache = {}; // track per-user access nodes

    // Auth button
    loginBtn.addEventListener('click', async ()=>{
      if(auth.currentUser){ await auth.signOut(); return; }
      const provider = new firebase.auth.GoogleAuthProvider();
      try{ await auth.signInWithPopup(provider); } catch(e){ alert('Login failed: '+(e.message||e)); }
    });

    // Toggle post panel
    postToggle.addEventListener('click', ()=> {
      if(postPanel.classList.contains('hidden')) postPanel.classList.remove('hidden');
      else postPanel.classList.add('hidden');
    });
    cancelPost.addEventListener('click', ()=> postPanel.classList.add('hidden'));

    // Search handlers
    searchBox.addEventListener('input', renderCards);
    clearSearch.addEventListener('click', ()=>{ searchBox.value=''; renderCards(); });

    // Auth state
    auth.onAuthStateChanged(user => {
      try{
        if(user){
          loginBtn.textContent = 'Logout';
          walletBadge.classList.remove('hidden');
          rechargeBtn.classList.remove('hidden');
          postPanel.classList.remove('hidden');
          // setup wallet node if missing
          const wref = db.ref('wallet/'+user.uid);
          wref.child('balance').transaction(v => (v===null?0:v));
          wref.child('createdAt').set(firebase.database.ServerValue.TIMESTAMP);
          wref.on('value', snap => { const v = snap.val(); walletAmt.textContent = (v && v.balance) ? v.balance : 0; });

          // subscribe to user's access map
          db.ref('wallet/'+user.uid+'/access').on('value', snap => { window.__accessCache[user.uid] = snap.val() || {}; renderCards(); });

          // admin UI
          if(user.email === ADMIN_EMAIL){
            adminPanel.classList.remove('hidden');
            loadAdminLists();
          } else { adminPanel.classList.add('hidden'); adminLists.innerHTML=''; }
        } else {
          loginBtn.textContent = 'Google Login';
          walletBadge.classList.add('hidden');
          rechargeBtn.classList.add('hidden');
          postPanel.classList.add('hidden');
          adminPanel.classList.add('hidden');
        }
      }catch(e){ window._zfShowError('onAuthStateChanged error: '+ e.message); }
    });

    /***********************
     * Post form submit: upload image -> create provider record (status: waiting)
     ***********************/
    postForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const user = auth.currentUser;
      if(!user){ alert('Login required to post'); return; }

      const name = (document.getElementById('pf_name')||{}).value.trim();
      const bname = (document.getElementById('pf_bname')||{}).value.trim();
      const category = (document.getElementById('pf_category')||{}).value.trim();
      const city = (document.getElementById('pf_city')||{}).value.trim();
      const phone = (document.getElementById('pf_phone')||{}).value.trim();
      const wa = (document.getElementById('pf_whatsapp')||{}).value.trim();
      const address = (document.getElementById('pf_address')||{}).value.trim();
      const from = (document.getElementById('pf_from')||{}).value || '';
      const to = (document.getElementById('pf_to')||{}).value || '';
      const fileInput = document.getElementById('pf_image');
      const file = fileInput && fileInput.files && fileInput.files[0];

      if(!name||!bname||!category||!city||!phone||!wa||!address||!file){
        alert('सभी फ़ील्ड भरें और इमेज अपलोड करें।');
        return;
      }

      try{
        // upload to imgbb
        const fd = new FormData(); fd.append('image', file);
        const res = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_API, { method:'POST', body: fd });
        if(!res.ok) throw new Error('Image upload failed: '+res.status);
        const j = await res.json();
        const imgUrl = j && j.data && j.data.url ? j.data.url : null;
        if(!imgUrl) throw new Error('Image upload returned invalid response');

        // prepare provider object
        const pRef = db.ref('providers').push();
        const payload = {
          id: pRef.key,
          uid: user.uid,
          ownerName: name,
          businessName: bname,
          category,
          city,
          phone,
          whatsapp: wa,
          address,
          hours: {from, to},
          image: imgUrl,
          status: 'waiting', // waiting | approved | rejected
          ratings: { avg:0, count:0 },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        await pRef.set(payload);
        alert('Submitted! Waiting for admin approval.');
        postForm.reset();
        postPanel.classList.add('hidden');
      }catch(err){
        window._zfShowError('Post submit failed: '+ (err && err.message? err.message: String(err)));
        alert('Submit failed: '+ (err && err.message? err.message: String(err)));
      }
    });

    /***********************
     * Realtime: providers snapshot
     ***********************/
    db.ref('providers').on('value', snap => {
      providersCache = snap.val() || {};
      renderCards();
      // if admin logged in, refresh admin lists
      const u = auth.currentUser;
      if(u && u.email === ADMIN_EMAIL) loadAdminLists();
    }, err => { window._zfShowError('Providers listener failed: '+ (err && err.message? err.message: String(err))); });

    /***********************
     * Render cards (approved only visible to public)
     ***********************/
    function renderCards(){
      try{
        const q = (searchBox.value||'').toLowerCase().trim();
        const all = Object.values(providersCache || {});
        const approved = all.filter(p => p && p.status === 'approved');
        const filtered = approved.filter(p => {
          const hay = ((p.businessName||'')+' '+(p.category||'')+' '+(p.city||'')+' '+(p.address||'')).toLowerCase();
          return hay.includes(q);
        });

        cardsWrap.innerHTML = '';
        if(filtered.length === 0){ emptyMsg.style.display = 'block'; return; } else emptyMsg.style.display='none';

        filtered.forEach((p, idx) => {
          const node = createCard(p, (idx%5)+1);
          if(node) cardsWrap.appendChild(node);
        });
      }catch(e){ window._zfShowError('renderCards error: '+ e.message); }
    }

    function createCard(p, hue){
      try{
        const el = document.createElement('div'); el.className='card'; el.setAttribute('data-hue', String(hue));
        const img = p.image || '';
        const hoursFrom = (p.hours && p.hours.from) ? p.hours.from : '';
        const hoursTo = (p.hours && p.hours.to) ? p.hours.to : '';
        // address shown only if current user has unlocked access to this provider
        const user = auth.currentUser;
        const addressText = (!user) ? 'Login to view address & WhatsApp' : (accessGranted(user.uid, p.id) ? (p.address || '') : 'Recharge & unlock to view address');
        const waVisible = user && accessGranted(user.uid, p.id);

        el.innerHTML = `
          <div class="media">${ img? '<img src="'+escapeHtml(img)+'"/>' : '' }</div>
          <div style="position:relative;padding:12px">
            <span class="chip">${escapeHtml(p.category||'')}</span>
            <div class="card-body">
              <div class="hrow"><div><strong>${escapeHtml(p.businessName||'')}</strong><div class="muted small">${escapeHtml(p.city||'')}</div></div>
              <div class="pill-sm">${escapeHtml(p.status||'')}</div></div>

              <div style="margin-top:8px" class="muted">${escapeHtml(addressText)}</div>
              <div style="margin-top:8px" class="row"><span class="pill-sm">Hours: ${escapeHtml(hoursFrom)} - ${escapeHtml(hoursTo)}</span></div>

              <div class="actions">
                <a class="btn btn-ghost" href="tel:${escapeHtml(p.phone||'')}" target="_blank">Call Now</a>
                <button class="btn btn-acc" data-action="wa">${ waVisible ? 'WhatsApp Now' : 'Unlock WhatsApp (₹20)' }</button>
                <button class="btn btn-warn" data-action="rate">Rate</button>
              </div>

              <div class="reviews" data-reviews></div>
            </div>
          </div>
        `;

        // attach handlers
        const waBtn = el.querySelector('[data-action="wa"]');
        if(waBtn) waBtn.addEventListener('click', () => handleWhatsAppClick(p));

        const rateBtn = el.querySelector('[data-action="rate"]');
        if(rateBtn) rateBtn.addEventListener('click', () => openRating(p));

        // if current user is admin, show admin controls inside same card
        const cur = auth.currentUser;
        if(cur && cur.email === ADMIN_EMAIL){
          const adminControls = document.createElement('div'); adminControls.style.marginTop='8px';
          adminControls.innerHTML = `
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-good" data-act="approve">Approve</button>
              <button class="btn btn-warn" data-act="reject">Reject</button>
              <button class="btn btn-danger" data-act="delete">Delete</button>
              <button class="btn btn-ghost" data-act="view">View Details</button>
            </div>`;
          el.querySelector('.card-body').appendChild(adminControls);
          adminControls.querySelector('[data-act="approve"]').addEventListener('click', ()=> updateProviderStatus(p.id,'approved'));
          adminControls.querySelector('[data-act="reject"]').addEventListener('click', ()=> updateProviderStatus(p.id,'rejected'));
          adminControls.querySelector('[data-act="delete"]').addEventListener('click', ()=> deleteProvider(p.id));
        }

        // render any reviews
        const reviewsNode = el.querySelector('[data-reviews]');
        loadAndRenderReviews(p.id, reviewsNode);

        return el;
      }catch(e){ window._zfShowError('createCard error: '+ e.message); return null; }
    }

    /***********************
     * Reviews & Ratings
     ***********************/
    function loadAndRenderReviews(providerId, container){
      container.innerHTML = '';
      db.ref('reviews/'+providerId).once('value').then(snap => {
        const all = snap.val() || {};
        const arr = Object.values(all);
        if(!arr.length){ container.innerHTML = '<div class="muted small">No reviews yet.</div>'; return; }
        const avg = (arr.reduce((a,b)=>a+(b.rating||0),0)/arr.length).toFixed(1);
        container.innerHTML = `<div class="muted small">Average: ${avg} ★ (${arr.length})</div>`;
        arr.slice().reverse().forEach(r => {
          const d = document.createElement('div'); d.style.marginTop='8px';
          d.innerHTML = `<div style="font-weight:600">${escapeHtml(r.userName||'User')} <span class="muted small"> - ${escapeHtml(r.rating||0)} ★</span></div><div class="muted small">${escapeHtml(r.comment||'')}</div>`;
          container.appendChild(d);
        });
      }).catch(e => { console.error('load reviews failed', e); });
    }

    function openRating(provider){
      const user = auth.currentUser;
      const who = user ? (user.displayName || user.email) : null;
      const rating = prompt('Give rating 1-5 (enter a number):');
      if(!rating) return;
      const rnum = Math.max(1, Math.min(5, Math.round(Number(rating)||0)));
      const comment = prompt('Optional feedback / comment:') || '';
      db.ref('reviews/'+provider.id).push({ rating: rnum, comment, userId: user?user.uid:null, userName: who||'Guest', at: firebase.database.ServerValue.TIMESTAMP })
        .then(()=> {
          // update provider aggregate
          db.ref('providers/'+provider.id+'/ratings').transaction(r => {
            if(!r) return { avg: rnum, count: 1, sum: rnum };
            const sum = (r.sum||0)+rnum; const count = (r.count||0)+1; return { sum, count, avg: (sum/count) };
          });
          alert('Thanks for your review!');
          renderCards();
        }).catch(e=> { window._zfShowError('submit review failed: '+ e.message); alert('Review failed'); });
    }

    /***********************
     * Access & Wallet logic
     ***********************/
    function accessPath(uid, pid){ return 'wallet/'+String(uid)+'/access/'+String(pid); }
    function accessGranted(uid, pid){ return !!(window.__accessCache && window.__accessCache[uid] && window.__accessCache[uid][pid]); }

    auth.onAuthStateChanged(u => {
      if(!u) return;
      db.ref('wallet/'+u.uid+'/access').on('value', snap => { window.__accessCache[u.uid] = snap.val() || {}; renderCards(); });
    });

    async function handleWhatsAppClick(provider){
      try{
        const user = auth.currentUser;
        if(!user){ if(confirm('Login required. Login now?')) loginBtn.click(); return; }
        const pid = provider.id;
        const accRef = db.ref(accessPath(user.uid, pid));
        const accSnap = await accRef.once('value'); const already = !!accSnap.val();
        if(!already){
          // attempt to deduct ₹20
          const balRef = db.ref('wallet/'+user.uid+'/balance');
          const trx = await balRef.transaction(curr => {
            if(curr === null) curr = 0;
            if(curr >= 20) return curr - 20;
            return; // abort
          });
          if(!trx || !trx.committed){ alert('Wallet low. Please recharge ₹100 to unlock WhatsApp & Address.'); return; }
          // record transaction
          const t = db.ref('wallet/'+user.uid+'/transactions').push();
          await t.set({ id: t.key, type:'debit', amount:20, for:'whatsapp_access', providerId:pid, at: firebase.database.ServerValue.TIMESTAMP });
          await accRef.set(true);
        }
        // open WhatsApp and show address
        renderCards();
        const wa = provider.whatsapp || '';
        const link = 'https://wa.me/'+encodeURIComponent(wa.replace(/[^0-9]/g,''))+'?text='+encodeURIComponent('Hello '+(provider.businessName||'')+' (via ZaraFix)');
        window.open(link, '_blank');
      }catch(e){ window._zfShowError('WhatsApp click failed: '+ e.message); alert('Action failed: '+ (e.message||e)); }
    }

    /***********************
     * Recharge request flow (user)
     ***********************/
    rechargeBtn.addEventListener('click', async () => {
      try{
        const user = auth.currentUser; if(!user){ alert('Login required'); return; }
        if(!confirm('Create recharge request of ₹100? You will upload payment screenshot. Continue?')) return;
        const input = document.createElement('input'); input.type='file'; input.accept='image/*';
        input.onchange = async ()=> {
          const file = input.files[0]; if(!file) return;
          try{
            const fd = new FormData(); fd.append('image', file);
            const r = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_API, { method:'POST', body: fd });
            if(!r.ok) throw new Error('Image upload failed: '+ r.status);
            const j = await r.json(); const shot = j && j.data && j.data.url ? j.data.url : null;
            if(!shot) throw new Error('Upload returned bad response');
            const rr = db.ref('recharges').push();
            await rr.set({ id: rr.key, uid: user.uid, email: user.email||'', amount:100, screenshot: shot, status: 'pending', at: firebase.database.ServerValue.TIMESTAMP });
            alert('Recharge request sent to admin.');
            // refresh admin view if admin logged
            loadAdminLists();
          }catch(err){ window._zfShowError('Recharge upload failed: '+ (err && err.message? err.message: String(err))); alert('Recharge failed'); }
        };
        input.click();
      }catch(e){ window._zfShowError('recharge flow failed: '+ e.message); alert('Failed'); }
    });

    /***********************
     * Admin: single-card controls (approve/reject/delete), and recharges list
     * Note: admin sees controls inside same cards too — but we also provide lists here.
     ***********************/
    async function updateProviderStatus(id, status){
      try{ if(!id) return; await db.ref('providers/'+id).update({ status, updatedAt: firebase.database.ServerValue.TIMESTAMP }); alert('Status changed to '+status); }catch(e){ window._zfShowError('updateProviderStatus failed: '+ e.message); }
    }
    async function deleteProvider(id){
      try{ if(!id) return; if(!confirm('Delete this listing permanently?')) return; await db.ref('providers/'+id).remove(); alert('Deleted'); }catch(e){ window._zfShowError('deleteProvider failed: '+ e.message); }
    }

    function loadAdminLists(){
      try{
        adminLists.innerHTML = '';
        // providers
        const provWrap = document.createElement('div'); provWrap.className='panel'; provWrap.style.marginBottom='8px';
        provWrap.innerHTML = '<h4>All Providers</h4>';
        adminLists.appendChild(provWrap);
        const all = Object.values(providersCache || {});
        if(!all.length) provWrap.innerHTML += '<div class="muted small">No providers yet.</div>';
        all.slice().reverse().forEach(p=>{
          const row = document.createElement('div'); row.className='card'; row.style.marginTop='8px';
          row.innerHTML = `<div style="display:flex;gap:10px;align-items:center;padding:8px"><img src="${escapeHtml(p.image||'')}" style="width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.03)"/><div style="flex:1"><strong>${escapeHtml(p.businessName||'')}</strong><div class="muted small">${escapeHtml(p.category||'')} • ${escapeHtml(p.city||'')}</div><div class="muted small">Status: ${escapeHtml(p.status||'')}</div></div></div>
          <div style="padding:8px;display:flex;gap:8px"><button class="btn btn-good" data-act="approve">Approve</button><button class="btn btn-warn" data-act="reject">Reject</button><button class="btn btn-danger" data-act="delete">Delete</button></div>`;
          row.querySelector('[data-act="approve"]').addEventListener('click', ()=> updateProviderStatus(p.id,'approved'));
          row.querySelector('[data-act="reject"]').addEventListener('click', ()=> updateProviderStatus(p.id,'rejected'));
          row.querySelector('[data-act="delete"]').addEventListener('click', ()=> deleteProvider(p.id));
          provWrap.appendChild(row);
        });

        // recharges
        const recWrap = document.createElement('div'); recWrap.className='panel';
        recWrap.style.marginTop='10px'; recWrap.innerHTML = '<h4>Recharge Requests</h4>'; adminLists.appendChild(recWrap);
        db.ref('recharges').orderByChild('at').once('value').then(snap=>{
          const all = snap.val() || {};
          const arr = Object.values(all);
          if(!arr.length) recWrap.innerHTML += '<div class="muted small">No recharge requests.</div>';
          arr.slice().reverse().forEach(r => {
            const rr = document.createElement('div'); rr.className='card'; rr.style.marginTop='8px';
            rr.innerHTML = `<div style="display:flex;gap:10px;align-items:center;padding:8px"><img src="${escapeHtml(r.screenshot||'')}" style="width:80px;height:70px;object-fit:cover;border-radius:8px"/><div style="flex:1"><strong>${escapeHtml(r.email||r.uid||'')}</strong><div class="muted small">Amount: ₹${r.amount||100}</div></div></div>
              <div style="padding:8px;display:flex;gap:8px"><button class="btn btn-good" data-act="accept">Accept & Add ₹100</button><button class="btn btn-warn" data-act="reject">Reject</button></div>`;
            rr.querySelector('[data-act="accept"]').addEventListener('click', ()=> approveRecharge(r));
            rr.querySelector('[data-act="reject"]').addEventListener('click', ()=> { db.ref('recharges/'+r.id).update({ status:'rejected' }); alert('Marked rejected'); loadAdminLists(); });
            recWrap.appendChild(rr);
          });
        }).catch(e => window._zfShowError('load recharges failed: '+ e.message));
      }catch(e){ window._zfShowError('loadAdminLists failed: '+ e.message); }
    }

    async function approveRecharge(r){
      try{
        if(!r || !r.uid) return;
        await db.ref('wallet/'+r.uid+'/balance').transaction(v => (v||0)+100);
        await db.ref('wallet/'+r.uid+'/transactions').push({ type:'credit', amount:100, for:'recharge', at: firebase.database.ServerValue.TIMESTAMP });
        await db.ref('recharges/'+r.id).update({ status:'approved' });
        alert('Recharge successful');
        loadAdminLists();
      }catch(e){ window._zfShowError('approveRecharge failed: '+ e.message); }
    }

    /***********************
     * Utility helpers
     ***********************/
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // initial render
    renderCards();
  });
  </script>
</body>
</html>
