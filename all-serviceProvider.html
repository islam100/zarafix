// ========= PROVIDER SUBMIT (fixed reset) =========
btnSubmitProvider.onclick = async (e)=>{
  e.preventDefault();
  if(!currentUser) return toast('Login required');
  const p = {
    uid: currentUser.uid,
    name: qs('#spName').value.trim(),
    businessName: qs('#businessName').value.trim(),
    category: qs('#category').value.trim(),
    mobile: qs('#mobile').value.trim(),
    whatsapp: qs('#whatsapp').value.trim(),
    address: qs('#address').value.trim(),
    hours: qs('#hours').value.trim(),
    lat: null, lng: null, city: '',
    imageUrl: '',
    status: 'waiting',
    createdAt: Date.now()
  };
  const ll = qs('#latlng').value.trim();
  if(ll){ const [la,ln] = ll.split(',').map(s=>parseFloat(s)); p.lat = la; p.lng = ln; }

  const file = qs('#photo').files[0];
  try{
    if(file){ p.imageUrl = await uploadToImgBB(file); }
    if(p.address){ const parts = p.address.split(','); p.city = parts[parts.length-1].trim(); }
    await db.ref('providers').push(p);
    formStatus.textContent = 'Status: waiting';
    toast('Submitted! Waiting for admin approval');
    // reset form
    document.querySelector("#providerFormWrap form")?.reset();
  }catch(e){ console.error(e); toast('Submit failed'); }
}

// ========= ADMIN: Recharge approval list =========
function renderAdminRechargeList(){
  if(!isAdmin) return;
  db.ref('rechargeRequests').on('value', (snap)=>{
    const val = snap.val()||{};
    let html = '';
    Object.entries(val).forEach(([id, r])=>{
      html += `
        <div class="card" data-req="${id}">
          <div class="card-body">
            <div><b>UID:</b> ${r.uid}</div>
            <div><b>Amount:</b> ₹${r.amount}</div>
            <div><img src="${r.imageUrl}" style="max-width:200px;border-radius:8px"/></div>
            <div>Status: ${r.status}</div>
            ${r.status==='pending' ? 
              `<button class="btn-3d ok" onclick="approveRecharge('${id}','${r.uid}',${r.amount})">Approve</button>` 
              : `<span class="pill">Approved</span>`}
          </div>
        </div>`;
    });
    let adminBox = document.getElementById("adminReqs");
    if(!adminBox){
      adminBox = document.createElement("div");
      adminBox.id = "adminReqs";
      adminBox.className = "grid";
      grid.before(adminBox);
    }
    adminBox.innerHTML = html;
  });
}

async function approveRecharge(id, uid, amount){
  await db.ref("wallets/"+uid+"/balance").transaction(bal=> (bal||0)+amount);
  await db.ref("rechargeRequests/"+id+"/status").set("approved");
  toast("Recharge Approved ✅");
}
