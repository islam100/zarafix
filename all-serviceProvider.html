<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZaraFix Posts</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin: 12px; }
    .approved { background-color: #d4edda; }
    .waiting { background-color: #fff3cd; }
    .admin-btn { margin:4px; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; box-shadow: 0 3px 5px rgba(0,0,0,0.2);}
    .approve-btn { background-color: #4caf50; color:white;}
    .reject-btn { background-color: #f39c12; color:white;}
    .delete-btn { background-color: #e74c3c; color:white;}
  </style>
</head>
<body class="bg-gray-100">

<div class="p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">ZaraFix Posts</h1>
  <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Login with Google</button>
  <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded hidden">Logout</button>
</div>

<!-- Post Form -->
<div id="postFormContainer" class="p-4 bg-white rounded shadow m-4 hidden">
  <h2 class="text-xl font-semibold mb-2">New Post</h2>
  <form id="postForm" class="space-y-2">
    <input type="text" id="shopName" placeholder="Shop Name" required class="border p-2 rounded w-full"/>
    <input type="text" id="address" placeholder="Address" required class="border p-2 rounded w-full"/>
    <input type="text" id="category" placeholder="Category" required class="border p-2 rounded w-full"/>
    <input type="text" id="whatsapp" placeholder="WhatsApp No." required class="border p-2 rounded w-full"/>
    <input type="file" id="imageFile" accept="image/*" required class="border p-2 rounded w-full"/>
    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Post</button>
  </form>
</div>

<!-- Posts -->
<div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
  <!-- Cards will appear here -->
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
  authDomain: "zara-fix-2e35a.firebaseapp.com",
  databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
  projectId: "zara-fix-2e35a",
  storageBucket: "zara-fix-2e35a.appspot.com",
  messagingSenderId: "636550144008",
  appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
const adminEmails = ["admin@example.com"]; // Replace with actual admin email(s)

// Login/Logout buttons
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const postFormContainer = document.getElementById("postFormContainer");

loginBtn.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    currentUser = result.user;
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    postFormContainer.classList.remove("hidden");
    loadPosts();
  } catch(err) {
    alert("Login failed: "+err.message);
  }
};

logoutBtn.onclick = async () => {
  await auth.signOut();
  currentUser = null;
  loginBtn.classList.remove("hidden");
  logoutBtn.classList.add("hidden");
  postFormContainer.classList.add("hidden");
};

// Post form submission
document.getElementById("postForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const shopName = document.getElementById("shopName").value;
  const address = document.getElementById("address").value;
  const category = document.getElementById("category").value;
  const whatsapp = document.getElementById("whatsapp").value;
  const imageFile = document.getElementById("imageFile").files[0];
  
  if(!imageFile) return alert("Select image");
  
  // Upload to imgbb
  const fd = new FormData();
  fd.append("image", imageFile);
  const r = await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5", {method:"POST", body:fd});
  const res = await r.json();
  const imageUrl = res.data.url;

  const postRef = db.ref("posts").push();
  await postRef.set({
    shopName, address, category, whatsapp, imageUrl, posterEmail: currentUser.email,
    status: "waiting",
    timestamp: Date.now()
  });

  document.getElementById("postForm").reset();
  loadPosts();
});

// Load posts
async function loadPosts(){
  const snapshot = await db.ref("posts").orderByChild("timestamp").once("value");
  const postsContainer = document.getElementById("postsContainer");
  postsContainer.innerHTML = "";
  const posts = snapshot.val();
  if(!posts) return;

  // Sort by timestamp descending
  const postArray = Object.keys(posts).map(k=>({id:k, ...posts[k]})).sort((a,b)=>b.timestamp-a.timestamp);

  postArray.forEach(post=>{
    const isAdmin = currentUser && adminEmails.includes(currentUser.email);
    const card = document.createElement("div");
    card.className = "card "+(post.status=="approved"?"approved":"waiting");

    card.innerHTML = `
      <img src="${post.imageUrl}" class="w-full h-48 object-cover rounded mb-2"/>
      <h3 class="font-bold text-lg">${post.shopName}</h3>
      <p>${post.address}</p>
      <p>Category: ${post.category}</p>
      <p>WhatsApp: <a href="https://wa.me/${post.whatsapp}" target="_blank" class="text-blue-600">${post.whatsapp}</a></p>
      <p>Status: <strong>${post.status}</strong></p>
      ${isAdmin ? `
        <div class="mt-2">
          <button class="admin-btn approve-btn" onclick="updateStatus('${post.id}','approved')">Approve</button>
          <button class="admin-btn reject-btn" onclick="updateStatus('${post.id}','waiting')">Reject</button>
          <button class="admin-btn delete-btn" onclick="deletePost('${post.id}')">Delete</button>
        </div>` : ""}
    `;
    postsContainer.appendChild(card);
  });
}

// Update status
function updateStatus(id,status){
  db.ref("posts/"+id).update({status}).then(loadPosts);
}

// Delete post
function deletePost(id){
  if(confirm("Are you sure you want to delete this post?")){
    db.ref("posts/"+id).remove().then(loadPosts);
  }
}

// Initial load (no login needed)
auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    postFormContainer.classList.remove("hidden");
  } else {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    postFormContainer.classList.add("hidden");
  }
  loadPosts();
});

</script>

</body>
</html>
