<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZaraFix Posts</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-6xl mx-auto p-4">

  <!-- Google Login / Logout -->
  <div class="flex justify-end mb-4">
    <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:shadow-lg">Login with Google</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:shadow-lg hidden">Logout</button>
  </div>

  <!-- Post Form (only for logged in users) -->
  <div id="postForm" class="bg-white p-4 rounded shadow mb-6 hidden">
    <h2 class="text-lg font-semibold mb-2">New Post</h2>
    <input type="text" id="shopName" placeholder="Shop Name" class="w-full mb-2 p-2 border rounded">
    <input type="text" id="shopAddress" placeholder="Address" class="w-full mb-2 p-2 border rounded">
    <input type="text" id="shopWhatsApp" placeholder="WhatsApp Number" class="w-full mb-2 p-2 border rounded">
    <input type="file" id="shopImage" class="mb-2">
    <button id="submitPost" class="bg-green-500 text-white px-4 py-2 rounded shadow hover:shadow-lg">Submit Post</button>
  </div>

  <!-- Posts Grid -->
  <div id="postsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const adminEmail = "admin@example.com"; // यहाँ अपना admin email डालें

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const postForm = document.getElementById("postForm");
  const submitPost = document.getElementById("submitPost");
  const postsGrid = document.getElementById("postsGrid");

  let currentUser = null;

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user){
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      postForm.classList.remove("hidden");
    } else {
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      postForm.classList.add("hidden");
    }
    loadPosts();
  });

  async function uploadImage(file){
    const fd = new FormData();
    fd.append('image', file);
    const res = await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5", {method: "POST", body: fd});
    const data = await res.json();
    return data.data.url;
  }

  submitPost.onclick = async () => {
    const name = document.getElementById("shopName").value;
    const address = document.getElementById("shopAddress").value;
    const whatsapp = document.getElementById("shopWhatsApp").value;
    const imageFile = document.getElementById("shopImage").files[0];

    if(!name || !address || !whatsapp || !imageFile){
      alert("सभी fields भरें!");
      return;
    }

    const imageUrl = await uploadImage(imageFile);
    const postRef = db.ref("posts").push();
    postRef.set({
      name, address, whatsapp, imageUrl,
      status: "waiting",
      posterEmail: currentUser.email
    });

    alert("Post submitted! Waiting for approval.");
    document.getElementById("shopName").value = "";
    document.getElementById("shopAddress").value = "";
    document.getElementById("shopWhatsApp").value = "";
    document.getElementById("shopImage").value = "";
    loadPosts();
  };

  function renderCard(postKey, postData){
    const isAdmin = currentUser && currentUser.email === adminEmail;
    const statusColor = postData.status === "approved" ? "bg-green-200" : "bg-yellow-200";

    let buttons = "";
    if(isAdmin){
      buttons = `
        <div class="flex justify-between mt-2">
          <button onclick="updateStatus('${postKey}','approved')" class="bg-green-500 text-white px-2 py-1 rounded shadow hover:shadow-lg">Approve</button>
          <button onclick="updateStatus('${postKey}','waiting')" class="bg-yellow-500 text-white px-2 py-1 rounded shadow hover:shadow-lg">Set Waiting</button>
          <button onclick="deletePost('${postKey}')" class="bg-red-500 text-white px-2 py-1 rounded shadow hover:shadow-lg">Delete</button>
        </div>
      `;
    }

    return `
      <div class="bg-white p-3 rounded shadow">
        <img src="${postData.imageUrl}" class="w-full h-48 object-contain rounded mb-2">
        <h3 class="font-semibold">${postData.name}</h3>
        <p>${postData.address}</p>
        <p>WhatsApp: <a href="https://wa.me/${postData.whatsapp}" target="_blank" class="text-blue-500">${postData.whatsapp}</a></p>
        <p class="mt-1 px-2 py-1 rounded ${statusColor} inline-block">${postData.status.toUpperCase()}</p>
        ${buttons}
      </div>
    `;
  }

  function loadPosts(){
    db.ref("posts").once("value", snapshot => {
      const posts = snapshot.val();
      postsGrid.innerHTML = "";
      if(!posts) return;

      Object.keys(posts).forEach(key => {
        let post = posts[key];
        // Non-admin users see only approved posts
        if(!currentUser || currentUser.email !== adminEmail){
          if(post.status !== "approved") return;
        }
        postsGrid.innerHTML += renderCard(key, post);
      });
    });
  }

  window.updateStatus = (key,status) => {
    db.ref("posts/"+key).update({status});
    loadPosts();
  };

  window.deletePost = (key) => {
    if(confirm("क्या आप सच में delete करना चाहते हैं?")){
      db.ref("posts/"+key).remove();
      loadPosts();
    }
  };

</script>
</body>
</html>
