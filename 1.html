<!DOCTYPE html>
<html>
<head>
  <title>üõ†Ô∏è ZaraFix - Poster Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 10px;
    }

    .card, .form, .request {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    h2 {
      margin-top: 0;
    }

    .button {
      background: linear-gradient(to right, #4caf50, #81c784);
      color: white;
      padding: 12px;
      border: none;
      margin: 8px 4px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }

    .button:hover {
      transform: scale(1.05);
    }

    .led {
      height: 16px;
      width: 16px;
      border-radius: 50%;
      display: inline-block;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    @media(max-width: 600px) {
      .form, .card, .request {
        padding: 10px;
      }
      .button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>üõ†Ô∏è ZaraFix - Service Provider Panel</h2>
    <div>üí∞ Wallet: ‚Çπ<span id="wallet">--</span></div>
    <div>Status: <span id="led" class="led" style="background:gray;"></span> <span id="statusText">Checking...</span></div>
  </div>

  <div class="form" id="registrationForm" style="display:none;">
    <h3>üîê Register as Service Provider</h3>
    <input placeholder="Name" id="regName"><br><br>
    <input placeholder="Shop Name" id="regShop"><br><br>
    <select id="regCategory">
      <option value="">Select Category</option>
      <option>AC Mechanic</option>
      <option>Car Mechanic</option>
      <option>Electrician</option>
    </select><br><br>
    <input placeholder="WhatsApp Number" id="regWhatsapp"><br><br>
    <button class="button" onclick="submitRegistration()">Submit Registration</button>
  </div>

  <div class="card" id="requestsCard" style="display:none;">
    <h3>üìã Matching Service Requests</h3>
    <div id="requests"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp({
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    });

    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    onAuthStateChanged(auth, user => {
      if (!user) return signInWithPopup(auth, provider);
      const uid = user.uid;

      get(ref(db, "posters/" + uid)).then(snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('registrationForm').style.display = 'block';
          return;
        }

        const data = snapshot.val();
        document.getElementById("wallet").innerText = data.wallet || 0;
        const cat = data.category;
        document.getElementById("registrationForm").style.display = "none";
        document.getElementById("requestsCard").style.display = "block";

        onValue(ref(db, "requests"), snap => {
          const requests = snap.val();
          let found = false, accepted = false;
          let html = "";
          for (let userId in requests) {
            for (let key in requests[userId]) {
              const r = requests[userId][key];
              if (r.category === cat) {
                found = true;
                if (r.acceptedBy && r.acceptedBy[uid]) accepted = true;
                html += `
                  <div class="request">
                    <b>${r.name}</b> (${r.address})<br>
                    Issue: ${r.problem}<br>
                    <button class="button" onclick="accept('${userId}', '${key}')">Accept</button>
                  </div>`;
              }
            }
          }

          if (!found) {
            document.getElementById("statusText").innerText = "Waiting for work";
            document.getElementById("led").style.background = "green";
            document.getElementById("requests").innerHTML = "No matching work found.";
          } else {
            document.getElementById("statusText").innerText = accepted ? "Work Accepted" : "Work Found";
            document.getElementById("led").style.background = accepted ? "blue" : "yellow";
            document.getElementById("requests").innerHTML = html;
          }
        });
      });

      // Daily ‚Çπ3 deduction
      const today = new Date().toDateString();
      const stampRef = ref(db, "posters/" + uid + "/lastDeduct");
      get(stampRef).then(snap => {
        if (snap.val() !== today) {
          const wRef = ref(db, "posters/" + uid);
          get(wRef).then(snap => {
            if (snap.exists()) {
              const wallet = snap.val().wallet || 0;
              if (wallet >= 3) {
                update(wRef, {
                  wallet: wallet - 3,
                  lastDeduct: today
                });
              }
            }
          });
        }
      });
    });

    window.submitRegistration = function () {
      const uid = auth.currentUser.uid;
      const data = {
        name: regName.value,
        shop: regShop.value,
        category: regCategory.value,
        whatsapp: regWhatsapp.value,
        wallet: 100
      };
      set(ref(db, "posters/" + uid), data).then(() => location.reload());
    }

    window.accept = function (userId, key) {
      const uid = auth.currentUser.uid;
      get(ref(db, "posters/" + uid)).then(snap => {
        const data = snap.val();
        if (data.wallet < 20) {
          alert("Not enough wallet balance to accept (‚Çπ20 needed).");
          return;
        }
        update(ref(db, "requests/" + userId + "/" + key + "/acceptedBy/" + uid), {
          name: data.name,
          whatsapp: data.whatsapp,
          timestamp: Date.now()
        });
        update(ref(db, "posters/" + uid), {
          wallet: data.wallet - 20
        });
      });
    }
  </script>
</body>
</html>
