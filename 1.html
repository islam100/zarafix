<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zara Property — Real Estate</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{
      --bg:#071022;--card:#0b1220;--muted:#9aa4b2;--accent:#2563eb;--glass:rgba(255,255,255,0.06);--white:#fff;
      --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:var(--white);background:linear-gradient(180deg,#061021,#071428);}

    /* Header */
    header{position:sticky;top:0;z-index:30;background:rgba(7,16,34,0.9);backdrop-filter:blur(8px);
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.06)}
    .leftHead{display:flex;align-items:center;gap:12px}
    .logo{
      position:relative; padding:10px 16px;border-radius:12px;
      background:linear-gradient(90deg,#7c3aed,#06b6d4);
      font-weight:900;font-size:22px;letter-spacing:0.6px; color:#fff;
      box-shadow: 0 12px 30px rgba(6,11,20,0.55), 0 4px 0 rgba(0,0,0,0.35);
      transform:skewX(-6deg);
    }
    #search{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.05);
      color:#fff;min-width:240px;outline:none}

    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--glass);border:0;padding:10px 14px;border-radius:12px;color:var(--white);cursor:pointer;
      box-shadow:0 6px 0 rgba(0,0,0,0.45);transition:transform .12s, box-shadow .12s}
    .btn:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(0,0,0,0.45)}
    .btn.primary{background:linear-gradient(180deg,#34d058,#10b981);color:#04201a;font-weight:800}
    .btn.danger{background:linear-gradient(180deg,#fb7185,#ef4444);color:#3d070c;font-weight:800}
    .btn.warn{background:linear-gradient(180deg,#fbbf24,#f59e0b);color:#2b1600;font-weight:800}

    /* Layout */
    .wrap{padding:14px;max-width:1200px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .pager{display:flex;align-items:center;gap:8px}
    .pager .pageInfo{font-size:13px;color:var(--muted)}

    /* Grid Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px}
    .card{position:relative;background:var(--card);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);
      overflow:hidden;cursor:pointer;transition:.15s}
    .card:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.35)}
    .card img.thumb{width:100%;height:140px;object-fit:cover;border-radius:10px}
    .card h4{font-size:15px;margin:8px 0 2px}
    .desc{font-size:12px;color:#d7dee9;line-height:1.35}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .whatsapp-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;
      background:linear-gradient(180deg,#34d058,#10b981);color:#04201a;font-weight:800;text-decoration:none;box-shadow:0 6px 0 rgba(0,0,0,0.45)}
    .whatsapp-btn:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(0,0,0,0.45)}
    .delete-btn{background:#ef4444;padding:8px 10px;border-radius:10px;border:0;color:#fff;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.45)}
    .delete-btn:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(0,0,0,0.45)}
    /* Badge + blink */
    .badge{position:absolute;top:10px;left:10px;padding:6px 10px;border-radius:999px;font-weight:800;
      display:flex;gap:8px;align-items:center;font-size:11px}
    .badge.approved{background:linear-gradient(90deg,#059669,#10b981);color:#022c1b}
    .badge.pending{background:linear-gradient(90deg,#f59e0b,#f97316);color:#2b1600}
    .badge.rejected{background:linear-gradient(90deg,#ef4444,#fb7185);color:#3d070c}
    .blink{width:10px;height:10px;border-radius:50%;background:#ffd54a;box-shadow:0 0 8px #ffd54a;animation:blink 1s linear infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:.15}100%{opacity:1}}

    /* Modal (fullscreen) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.86);z-index:1200;padding:18px}
    .modal.open{display:flex}
    .modal .box{background:var(--card);padding:12px;border-radius:14px;max-width:1100px;width:100%;max-height:92vh;overflow:auto;border:1px solid rgba(255,255,255,0.06)}
    .modal .box h3{margin:8px 0 10px}
    .modal .closeBar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .gallery{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .gallery img{max-width:100%;height:460px;object-fit:contain;border-radius:10px}
    .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}
    .thumbs img{width:120px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;opacity:0.9}
    .thumbs img.active{outline:2px solid #22c55e;opacity:1}
    .detailRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){.detailRow{grid-template-columns:1fr}}
    @media (max-width:900px){header{flex-wrap:wrap}.leftHead{flex:1}.controls{flex-wrap:wrap}.grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}.card img.thumb{height:120px}}

    /* Form Modal */
    .formBox form label{display:block;margin-top:8px;font-size:13px;color:#cdd6e5}
    .formBox input,.formBox select,.formBox textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);color:#fff;outline:none
    }
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="leftHead">
      <div class="logo">Zara</div>
      <input id="search" placeholder="Search title, phone, address..." />
    </div>
    <div class="controls">
      <div id="auth-area"></div>
      <button id="postBtn" class="btn primary" style="display:none">+ Post Property</button>
    </div>
  </header>

  <div class="wrap">
    <div class="topbar">
      <div class="pager">
        <button id="prevPage" class="btn">⬅️ Prev</button>
        <span class="pageInfo" id="pageInfo">Page 1</span>
        <button id="nextPage" class="btn">Next ➡️</button>
      </div>
      <div id="admin-hint" class="hint">zara samajik seva sanstha </div>
    </div>

    <main>
      <div id="cards" class="grid"></div>
    </main>
  </div>

  <!-- Details Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <div class="closeBar">
        <h3 id="modal-title"></h3>
        <button id="modal-close" class="btn">Close ✖</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Post Form Modal -->
  <div id="formModal" class="modal" aria-hidden="true">
    <div class="box formBox">
      <div class="closeBar">
        <h3>+ Post Property</h3>
        <button id="form-close" class="btn">Close ✖</button>
      </div>
      <form id="post-form">
        <div class="detailRow">
          <div>
            <label>Poster Name</label>
            <input id="posterName" placeholder="Your Name" required />
          </div>
          <div>
            <label>WhatsApp Number (with country code)</label>
            <input id="posterPhone" placeholder="+91XXXXXXXXXX" required />
          </div>
        </div>

        <div class="detailRow">
          <div>
            <label>BHK</label>
            <select id="bhk">
              <option value="1 BHK">1 BHK</option>
              <option value="2 BHK">2 BHK</option>
              <option value="3 BHK">3 BHK</option>
              <option value="4+ BHK">4+ BHK</option>
            </select>
          </div>
          <div>
            <label>Property Type</label>
            <select id="propertyType">
              <option value="Flat">Flat</option>
              <option value="Building">Building</option>
              <option value="Bungalow">Bungalow</option>
              <option value="Plot">Plot</option>
              <option value="House">House</option>
            </select>
          </div>
        </div>

        <div class="detailRow">
          <div>
            <label>Price (₹)</label>
            <input id="price" placeholder="5000000" required />
            <div class="hint">केवल number लिखें, commas नहीं</div>
          </div>
          <div>
            <label>Location / Address</label>
            <input id="posterAddress" placeholder="Mira Rd, Mumbai" required />
          </div>
        </div>

        <label>Description</label>
        <textarea id="description" rows="3" placeholder="Short description..."></textarea>

        <label>Images (max 5)</label>
        <input id="images" type="file" accept="image/*" multiple />
        <div class="hint">Images imgbb पर upload होंगी (max 5)</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button type="submit" class="btn primary">Submit</button>
          <button type="button" id="clear-form" class="btn">Clear</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------------- Configs ----------------
    const IMGBB_KEY = 'cad1f0dbfbd25346460789376cc2d7d5';
    const firebaseConfig = {
      apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
      authDomain: "property-20d6d.firebaseapp.com",
      databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
      projectId: "property-20d6d",
      storageBucket: "property-20d6d.appspot.com",
      messagingSenderId: "916859697394",
      appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    // ---------------- State ----------------
    let currentUser = null;
    let isAdmin = false;
    let allPosts = [];       // raw from DB (array of {id,...})
    let filtered = [];       // after search + visibility
    let pageSize = 10;
    let currentPage = 1;

    const cardsEl = document.getElementById('cards');
    const searchEl = document.getElementById('search');
    const pageInfo = document.getElementById('pageInfo');

    // Auth UI
    const authArea = document.getElementById('auth-area');
    function renderAuthArea(){
      authArea.innerHTML = '';
      if(!currentUser){
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Login with Google';
        btn.onclick = () => {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(e=>alert('Login failed: '+e.message));
        };
        authArea.appendChild(btn);
      } else {
        const span = document.createElement('div'); span.style='margin-right:8px'; span.textContent = currentUser.displayName || currentUser.email;
        const out = document.createElement('button'); out.className='btn'; out.textContent='Logout'; out.onclick = ()=>auth.signOut();
        authArea.appendChild(span); authArea.appendChild(out);
      }
    }

    // Post button visibility
    const postBtn = document.getElementById('postBtn');
    const adminHint = document.getElementById('admin-hint');

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      isAdmin = user && user.email === ADMIN_EMAIL;

      renderAuthArea();
      postBtn.style.display = currentUser ? 'inline-block' : 'none';
      adminHint.textContent = isAdmin ? 'Admin: Approve/Reject buttons enabled' : '(Login as admin to approve/reject)';
      // prefill poster name
      const nm = document.getElementById('posterName');
      if(nm) nm.value = currentUser ? (currentUser.displayName || '') : '';

      // re-render because visibility differs
      applyFiltersAndRender();
    });

    // ---------- Realtime DB ----------
    db.ref('posts').on('value', snap=>{
      const v = snap.val() || {};
      allPosts = Object.keys(v).map(k => ({ id:k, ...v[k] }))
        .sort((a,b)=> b.createdAt - a.createdAt);
      applyFiltersAndRender();
    });

    // ---------- Search ----------
    searchEl.addEventListener('input', ()=>{
      currentPage = 1;
      applyFiltersAndRender();
    });

    function applyFiltersAndRender(){
      const q = searchEl.value.trim().toLowerCase();
      filtered = allPosts.filter(p=>{
        // search
        if(q){
          const hay = (
            (p.posterName||'')+' '+(p.address||'')+' '+(p.posterPhone||'')+' '+
            (p.price||'')+' '+(p.bhk||'')+' '+(p.propertyType||'')+' '+(p.description||'')
          ).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        // visibility rules
        if(isAdmin) return true;
        if(currentUser){
          // show approved OR own posts (any status)
          return p.status === 'approved' || p.posterUid === currentUser.uid;
        }
        // public
        return p.status === 'approved';
      });

      renderPage();
    }

    // ---------- Pagination ----------
    function renderPage(){
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if(currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage-1)*pageSize;
      const posts = filtered.slice(start, start + pageSize);

      pageInfo.textContent = `Page ${currentPage} / ${totalPages} — ${total} posts`;

      renderCards(posts);
    }

    document.getElementById('prevPage').onclick = ()=>{ if(currentPage>1){ currentPage--; renderPage(); } };
    document.getElementById('nextPage').onclick = ()=>{
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if(currentPage<totalPages){ currentPage++; renderPage(); }
    };

    // ---------- Cards Render ----------
    function renderCards(posts){
      cardsEl.innerHTML = '';
      if(posts.length === 0){
        cardsEl.innerHTML = '<div style="color:var(--muted);padding:12px">कोई पोस्ट नहीं मिली ।</div>';
        return;
      }

      posts.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        // badge
        const badge = document.createElement('div'); badge.className='badge ' + (p.status || 'pending');
        badge.textContent = (p.status || 'pending').toUpperCase();
        if(p.status !== 'approved'){
          const led = document.createElement('div'); led.className='blink'; badge.appendChild(led);
        }
        card.appendChild(badge);

        // image
        const img = document.createElement('img'); img.className='thumb';
        img.src = (p.images && p.images.length) ? p.images[0] : 'https://via.placeholder.com/600x400?text=No+Image';
        img.alt = p.propertyType || 'property';
        card.appendChild(img);

        // title & desc
        const title = document.createElement('h4'); title.textContent = `${p.bhk||''} ${p.propertyType||''} — ₹${fmtPrice(p.price)}`;
        card.appendChild(title);
        const desc = document.createElement('div'); desc.className='desc';
        desc.innerHTML = `📍 ${p.address || ''}<br>👤 ${p.posterName || p.posterPhone}<br><span style="font-size:11px;color:var(--muted)">Posted: ${formatDate(p.createdAt)}</span>`;
        card.appendChild(desc);

        // meta: actions
        const meta = document.createElement('div'); meta.className='meta';
        const left = document.createElement('div'); left.style.fontSize='12px'; left.style.color='var(--muted)'; left.textContent = '';
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.flexWrap='wrap';

        const wa = document.createElement('a'); wa.className='whatsapp-btn';
        const waNum = (p.posterPhone||'').replace(/\D/g,'');
        wa.href = waNum ? `https://wa.me/${waNum}` : '#';
        wa.target = '_blank'; wa.rel = 'noopener'; wa.innerText='WhatsApp';
        right.appendChild(wa);

        // delete if owner
        if(currentUser && currentUser.uid === p.posterUid){
          const del = document.createElement('button'); del.className='delete-btn'; del.textContent='Delete';
          del.onclick = async (e)=>{ e.stopPropagation(); if(confirm('Delete this post?')) await db.ref('posts/'+p.id).remove(); };
          right.appendChild(del);
        }
        // admin approve/reject
        if(isAdmin){
          const app = document.createElement('button'); app.className='btn primary'; app.textContent='Approve';
          app.onclick = (e)=>{ e.stopPropagation(); db.ref('posts/'+p.id).update({status:'approved'}); };
          const rej = document.createElement('button'); rej.className='btn danger'; rej.textContent='Reject';
          rej.onclick = (e)=>{ e.stopPropagation(); db.ref('posts/'+p.id).update({status:'rejected'}); };
          right.appendChild(app); right.appendChild(rej);
        }
        meta.appendChild(left); meta.appendChild(right);
        card.appendChild(meta);

        // open modal on click
        card.onclick = ()=> openModal(p);
        cardsEl.appendChild(card);
      });
    }

    function fmtPrice(v){
      if(!v && v!==0) return '';
      const num = typeof v==='number' ? v : parseInt(String(v).replace(/[^\d]/g,''))||0;
      return num.toLocaleString('en-IN');
    }
    function formatDate(ts){
      if(!ts) return '';
      try{
        return new Date(ts).toLocaleString('en-IN', { hour12:false });
      }catch(_){ return ''; }
    }

    // ---------- Modal ----------
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    function openModal(post){
      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
      modalTitle.textContent = `${post.bhk} ${post.propertyType} — ₹${fmtPrice(post.price)}`;
      modalBody.innerHTML = '';

      // Gallery
      const gallery = document.createElement('div'); gallery.className='gallery';
      const images = post.images || [];
      let active = 0;

      const mainImg = document.createElement('img');
      mainImg.src = images[0] || 'https://via.placeholder.com/800x500?text=No+Image';
      gallery.appendChild(mainImg);
      modalBody.appendChild(gallery);

      if(images.length){
        const thumbs = document.createElement('div'); thumbs.className='thumbs';
        images.forEach((u,idx)=>{
          const t = document.createElement('img'); t.src=u; if(idx===0) t.classList.add('active');
          t.onclick = ()=>{ active=idx; mainImg.src=u; [...thumbs.children].forEach(x=>x.classList.remove('active')); t.classList.add('active'); };
          thumbs.appendChild(t);
        });
        modalBody.appendChild(thumbs);
      }

      // Info
      const info = document.createElement('div'); info.style.marginTop='10px';
      info.innerHTML = `
        <div class="detailRow">
          <div>
            <p><b>📍 Address:</b> ${post.address || ''}</p>
            <p><b>📝 Description:</b> ${post.description || '-'}</p>
          </div>
          <div>
            <p><b>👤 Owner:</b> ${post.posterName || ''}</p>
            <p><b>📱 WhatsApp:</b> <a href="https://wa.me/${(post.posterPhone||'').replace(/\\D/g,'')}" target="_blank">${post.posterPhone||''}</a></p>
            <p><b>Status:</b> ${post.status}</p>
            <p style="color:var(--muted);font-size:12px"><b>Posted:</b> ${formatDate(post.createdAt)}</p>
          </div>
        </div>`;
      modalBody.appendChild(info);

      // Actions
      const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.display='flex'; actions.style.flexWrap='wrap'; actions.style.gap='10px';
      const wa = document.createElement('a'); wa.className='whatsapp-btn'; wa.href=`https://wa.me/${(post.posterPhone||'').replace(/\D/g,'')}`; wa.target='_blank'; wa.innerText='Chat on WhatsApp';
      actions.appendChild(wa);

      if(currentUser && currentUser.uid === post.posterUid){
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete';
        del.onclick = async ()=>{ if(confirm('Delete this post?')){ await db.ref('posts/'+post.id).remove(); closeModal(); } };
        actions.appendChild(del);
      }
      if(isAdmin){
        const app = document.createElement('button'); app.className='btn primary'; app.textContent='Approve';
        app.onclick = ()=> db.ref('posts/'+post.id).update({status:'approved'});
        const rej = document.createElement('button'); rej.className='btn danger'; rej.textContent='Reject';
        rej.onclick = ()=> db.ref('posts/'+post.id).update({status:'rejected'});
        actions.appendChild(app); actions.appendChild(rej);
      }
      modalBody.appendChild(actions);
    }
    function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
    document.getElementById('modal-close').onclick = ()=> closeModal();
    modal.onclick = (e)=> { if(e.target === modal) closeModal(); };
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

    // ---------- Post Form Modal ----------
    const formModal = document.getElementById('formModal');
    const formClose = document.getElementById('form-close');
    const postForm = document.getElementById('post-form');
    document.getElementById('clear-form').onclick = ()=> postForm.reset();

    postBtn.onclick = ()=> { if(!currentUser){ alert('Please login to post'); return; } formModal.classList.add('open'); formModal.setAttribute('aria-hidden','false'); };
    formClose.onclick = ()=> closeForm();
    formModal.onclick = (e)=>{ if(e.target===formModal) closeForm(); };
    function closeForm(){ formModal.classList.remove('open'); formModal.setAttribute('aria-hidden','true'); }

    // ---------- imgbb upload helpers ----------
    async function uploadImages(files){
      const urls = [];
      for(let i=0;i<Math.min(files.length,5);i++){
        const file = files[i];
        const base64 = await fileToBase64(file);
        try{
          const res = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_KEY, {
            method:'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ image: base64.split(',')[1] })
          });
          const j = await res.json();
          if(j && j.success && j.data && j.data.url) urls.push(j.data.url);
        }catch(err){
          console.error('imgbb upload error', err);
        }
      }
      return urls;
    }
    function fileToBase64(file){
      return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
    }

    // ---------- Submit Post ----------
    postForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ alert('Please login to post'); return; }

      const name = document.getElementById('posterName').value.trim();
      const phone = document.getElementById('posterPhone').value.trim();
      const address = document.getElementById('posterAddress').value.trim();
      const bhk = document.getElementById('bhk').value;
      const propertyType = document.getElementById('propertyType').value;
      const price = document.getElementById('price').value.trim();
      const description = document.getElementById('description').value.trim();
      const files = document.getElementById('images').files;

      if(!name || !phone || !address || !price){ alert('कृपया सभी required फ़ील्ड भरें'); return; }

      // Upload to imgbb
      const imgs = files.length ? await uploadImages(files) : [];

      const payload = {
        posterUid: currentUser.uid,
        posterName: name,
        posterPhone: phone,
        address, bhk, propertyType, price, description,
        images: imgs,
        status: 'pending',
        createdAt: Date.now()
      };

      const ref = db.ref('posts').push();
      await ref.set(payload);
      alert('पोस्ट submit हो गया — admin की approval का इंतज़ार करें');
      postForm.reset();
      closeForm();
    });
  </script>
</body>
</html>
