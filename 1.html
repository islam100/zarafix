<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zara Property Listing</title>
  <style>
    /* Basic reset + pleasant modern look */
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#2563eb;--glass:rgba(255,255,255,0.03);--wh: #fff}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:var(--wh);background:linear-gradient(180deg,#071024 0%, #071824 100%);padding:18px}

    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .logo{font-weight:800;font-size:28px;letter-spacing:1px;transform:skewX(-6deg);padding:10px 18px;border-radius:12px;background:linear-gradient(90deg,#8b5cf6,#06b6d4);box-shadow:0 10px 30px rgba(6,11,20,0.6);color:#fff}
    /* 3D effect for logo */
    .logo::after{content:'';position:absolute;transform:translate(8px,10px) skewX(-6deg);width:100%;height:100%;border-radius:12px;filter:blur(12px);opacity:0.18}

    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--glass);border:0;padding:10px 14px;border-radius:12px;color:var(--wh);cursor:pointer;backdrop-filter:blur(6px);box-shadow: 0 6px 0 rgba(0,0,0,0.45);transform:translateY(0);transition:all .12s}
    .btn:active{transform:translateY(4px);box-shadow:0 2px 0 rgba(0,0,0,0.45)}

    /* 3D whatsapp button style inside card */
    .whatsapp-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,#34d058,#10b981);color:#04201a;font-weight:700;box-shadow:0 6px 0 rgba(0,0,0,0.35);text-decoration:none}

    /* Layout */
    .topbar{display:flex;gap:12px;align-items:center}
    #search{padding:10px 14px;border-radius:12px;border:0;min-width:220px;background:rgba(255,255,255,0.04);color:var(--wh)}

    .main{display:flex;gap:18px}
    .left{flex:1}
    .right{width:360px}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:14px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:10px}
    .card h4{margin-top:8px;font-size:16px}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}

    /* Poster whatsapp/phone + delete */
    .poster-actions{display:flex;gap:8px;align-items:center}
    .delete-btn{background:#ef4444;padding:8px;border-radius:10px;border:0;color:#fff;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.35)}

    /* approve badge */
    .badge{position:absolute;top:12px;left:12px;padding:6px 10px;border-radius:999px;font-weight:700;background:rgba(0,0,0,0.45)}
    .badge.approved{background:linear-gradient(90deg,#059669,#10b981);color:#022c1b}
    .badge.pending{background:linear-gradient(90deg,#f59e0b,#f97316);color:#2b1600;display:flex;align-items:center;gap:8px}
    /* Blinking LED */
    .blink{width:10px;height:10px;border-radius:50%;background:#fff;box-shadow:0 0 8px #ffd54a;animation:blink 1s linear infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:0.15}100%{opacity:1}}

    /* modal fullscreen */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:none;align-items:center;justify-content:center;z-index:1200;padding:18px}
    .modal.open{display:flex}
    .modal .fullscreen{background:var(--card);border-radius:12px;max-width:1100px;width:100%;max-height:90vh;padding:12px;overflow:auto}
    .fullscreen .gallery{display:flex;gap:8px;margin-bottom:8px}
    .fullscreen .gallery img{height:420px;max-width:100%;object-fit:contain;border-radius:8px}

    /* Form */
    form{display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,255,255,0.02);border-radius:12px}
    input[type=text], input[type=tel], textarea{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--wh)}
    input[type=file]{color:var(--wh)}

    /* right column small lists */
    .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px}

    /* pagination */
    .pagination{display:flex;gap:8px;justify-content:center;margin-top:12px}
    .page-btn{padding:8px 10px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);cursor:pointer}

    /* responsive tweaks */
    @media (max-width:900px){.main{flex-direction:column}.right{width:100%}}
  </style>
</head>
<body>
  <header class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">Zara</div>
      <div class="topbar">
        <input id="search" placeholder="Search title, phone, location..." />
      </div>
    </div>
    <div class="controls">
      <div id="auth-area"></div>
      <button id="open-post" class="btn">Post Property</button>
    </div>
  </header>

  <main class="main">
    <section class="left">
      <div id="cards" class="grid"></div>
      <div class="pagination" id="pagination"></div>
    </section>

    <aside class="right">
      <div class="panel">
        <h3>Post Property</h3>
        <form id="post-form">
          <input id="title" placeholder="Title (e.g., 2BHK near market)" required />
          <input id="phone" placeholder="Your WhatsApp number (with country code)" required />
          <textarea id="desc" rows="3" placeholder="Short description"></textarea>
          <input id="images" type="file" accept="image/*" multiple />
          <div style="font-size:12px;color:var(--muted)">Max 5 images. Images will be uploaded to imgbb.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button type="submit" class="btn">Submit</button>
            <button type="button" id="clear-form" class="btn">Clear</button>
          </div>
        </form>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h4>Admin Controls</h4>
        <div id="admin-panel">(Login as admin to see)</div>
      </div>
    </aside>
  </main>

  <!-- fullscreen modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="fullscreen" role="dialog">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modal-title"></h3>
        <div><button id="modal-close" class="btn">Close</button></div>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Firebase SDKs v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ============== Configs (user provided) ==============
    const IMGBB_KEY = 'cad1f0dbfbd25346460789376cc2d7d5';
    const firebaseConfig = {
      apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
      authDomain: "property-20d6d.firebaseapp.com",
      databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
      projectId: "property-20d6d",
      storageBucket: "property-20d6d.appspot.com",
      messagingSenderId: "916859697394",
      appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // admin email as requested
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    // state
    let currentUser = null;
    let allPosts = []; // client side cache
    let currentPage = 1;
    const PAGE_SIZE = 10;

    // helper: format timestamp
    function timeago(ts){const d=new Date(ts);return d.toLocaleString();}

    // ====== Auth UI ======
    const authArea = document.getElementById('auth-area');
    function renderAuthArea(){
      authArea.innerHTML = '';
      if(!currentUser){
        const btn = document.createElement('button');btn.className='btn';btn.textContent='Login with Google';btn.onclick=login;
        authArea.appendChild(btn);
      } else {
        const span = document.createElement('div');span.style='margin-right:8px';span.textContent=currentUser.displayName||currentUser.email;
        const out = document.createElement('button');out.className='btn';out.textContent='Logout';out.onclick=logout;
        authArea.appendChild(span);authArea.appendChild(out);
      }
    }
    function login(){
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e=>alert('Login failed:'+e.message));
    }
    function logout(){auth.signOut();}

    auth.onAuthStateChanged(u=>{
      currentUser = u;renderAuthArea();renderAdminPanel();});

    // ====== Post Form Handling ======
    const postForm = document.getElementById('post-form');
    const openPostBtn = document.getElementById('open-post');
    openPostBtn.onclick = ()=>{
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }

    postForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){alert('Please login first to post.');return}
      const title = document.getElementById('title').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const files = document.getElementById('images').files;
      if(files.length>5){alert('Maximum 5 images allowed');return}
      // upload images to imgbb
      const uploaded = [];
      for(let i=0;i<files.length;i++){
        const data = await fileToBase64(files[i]);
        try{
          const res = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_KEY, {
            method:'POST',headers:{},body:new URLSearchParams({image: data.split(',')[1]})
          });
          const j = await res.json();
          if(j.success){uploaded.push(j.data.url)}
        }catch(err){console.error('imgbb error',err);}
      }
      const postRef = db.ref('posts').push();
      const payload = {
        title,phone,desc,images:uploaded,posterUid:currentUser.uid,posterName:currentUser.displayName||currentUser.email,posterPhone:phone,approved:false,createdAt:Date.now()
      };
      await postRef.set(payload);
      alert('Post submitted for admin approval');
      postForm.reset();
    });
    document.getElementById('clear-form').onclick=()=>postForm.reset();

    function fileToBase64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);})}

    // ====== Listening posts ======
    db.ref('posts').on('value', snap=>{
      const v = snap.val()||{};allPosts = Object.keys(v).map(k=>({id:k,...v[k]})).sort((a,b)=>b.createdAt - a.createdAt);
      renderCards();renderPagination();
    });

    // ====== Render cards with pagination and filters ======
    const cardsEl = document.getElementById('cards');
    const searchEl = document.getElementById('search');
    searchEl.addEventListener('input', ()=>{currentPage=1;renderCards();renderPagination();});

    function filteredPosts(){
      const q = searchEl.value.trim().toLowerCase();
      if(!q) return allPosts;
      return allPosts.filter(p=>((p.title||'')+ ' '+ (p.desc||'') + ' '+ (p.posterPhone||'')).toLowerCase().includes(q));
    }

    function renderCards(){
      const posts = filteredPosts();
      const start = (currentPage-1)*PAGE_SIZE;const pageItems = posts.slice(start,start+PAGE_SIZE);
      cardsEl.innerHTML='';
      pageItems.forEach(p=>{
        const card = document.createElement('div');card.className='card';
        const badge = document.createElement('div');badge.className='badge '+(p.approved? 'approved':'pending');
        badge.textContent = p.approved? 'APPROVED':'PENDING';
        if(!p.approved){const led=document.createElement('div');led.className='blink';badge.appendChild(led)}
        card.appendChild(badge);
        const img = document.createElement('img');img.src = (p.images && p.images[0]) || 'https://via.placeholder.com/600x400?text=No+Image';img.alt='img';
        img.onclick = ()=>openModal(p);
        card.appendChild(img);
        const h = document.createElement('h4');h.textContent = p.title || '(No title)';card.appendChild(h);
        const meta = document.createElement('div');meta.className='meta';
        const left = document.createElement('div');left.innerHTML = `<div style="font-size:12px;color:var(--muted)">Posted: ${timeago(p.createdAt)}</div><div style="font-size:13px">${p.desc||''}</div>`;
        const right = document.createElement('div');right.className='poster-actions';
        // whatsapp button
        const wa = document.createElement('a');wa.className='whatsapp-btn';wa.href = `https://wa.me/${p.posterPhone.replace(/\D/g,'')}`;wa.target='_blank';wa.rel='noopener';wa.innerHTML = 'WhatsApp';
        right.appendChild(wa);
        // delete if owner
        if(currentUser && currentUser.uid === p.posterUid){
          const del = document.createElement('button');del.className='delete-btn';del.textContent='Delete';del.onclick = ()=>{if(confirm('Delete this post?')) db.ref('posts/'+p.id).remove();};right.appendChild(del);
        }
        meta.appendChild(left);meta.appendChild(right);card.appendChild(meta);

        // admin approve/reject buttons visible to admin only
        if(currentUser && currentUser.email === ADMIN_EMAIL){
          const adminBar = document.createElement('div');adminBar.style='display:flex;gap:8px;margin-top:8px';
          const app = document.createElement('button');app.className='btn';app.textContent='Approve';app.onclick=()=>db.ref('posts/'+p.id).update({approved:true});
          const rej = document.createElement('button');rej.className='btn';rej.textContent='Reject';rej.onclick=()=>db.ref('posts/'+p.id).update({approved:false});
          adminBar.appendChild(app);adminBar.appendChild(rej);card.appendChild(adminBar);
        }

        cardsEl.appendChild(card);
      });
    }

    // modal
    const modal = document.getElementById('modal');const modalTitle = document.getElementById('modal-title');const modalBody = document.getElementById('modal-body');
    function openModal(post){
      modal.classList.add('open');modal.setAttribute('aria-hidden','false');modalTitle.textContent = post.title || 'Property';
      modalBody.innerHTML = '';
      const g = document.createElement('div');g.className='gallery';
      (post.images||[]).forEach(url=>{const im=document.createElement('img');im.src=url;g.appendChild(im)});
      modalBody.appendChild(g);
      const info = document.createElement('div');info.innerHTML = `<p>${post.desc||''}</p><p>Posted by: ${post.posterName||post.posterPhone} (${post.posterPhone})</p><p>Posted at: ${timeago(post.createdAt)}</p>`;
      modalBody.appendChild(info);
    }
    document.getElementById('modal-close').onclick = ()=>closeModal();
    modal.onclick = (e)=>{if(e.target === modal){closeModal()}};
    function closeModal(){modal.classList.remove('open');modal.setAttribute('aria-hidden','true');}

    // pagination render
    function renderPagination(){
      const posts = filteredPosts();const total = posts.length;const pages = Math.max(1,Math.ceil(total/PAGE_SIZE));
      const pagEl = document.getElementById('pagination');pagEl.innerHTML='';
      const prev = document.createElement('button');prev.className='page-btn';prev.textContent='« Prev';prev.disabled = currentPage===1;prev.onclick=()=>{currentPage=Math.max(1,currentPage-1);renderCards();renderPagination();};pagEl.appendChild(prev);
      const info = document.createElement('div');info.style='align-self:center;padding:6px 10px;color:var(--muted)';info.textContent=`Page ${currentPage} / ${pages}`;pagEl.appendChild(info);
      const next = document.createElement('button');next.className='page-btn';next.textContent='Next »';next.disabled = currentPage===pages;next.onclick=()=>{currentPage=Math.min(pages,currentPage+1);renderCards();renderPagination();};pagEl.appendChild(next);
    }

    // admin panel rendering
    function renderAdminPanel(){
      const a = document.getElementById('admin-panel');a.innerHTML='(Login as admin to see)';
      if(currentUser && currentUser.email===ADMIN_EMAIL){
        a.innerHTML='You are admin. Pending posts will show orange badge. You can Approve/Reject posts from each card.';
      }
    }

    // initial fetch done by listener

  </script>
</body>
</html>
