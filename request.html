<!DOCTYPE html>
<html>
<head>
  <title>My Service Requests</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>üîê Google Login</h2>
  <button onclick="login()">Login with Google</button>
  <div id="userInfo"></div>
  <h3>üìã My Service Requests</h3>
  <div id="myRequests"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "448989892983",
      appId: "1:448989892983:web:e0636cc603f90b45820cb0"
    };
    firebase.initializeApp(firebaseConfig);

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).then((result) => {
        const user = result.user;
        document.getElementById("userInfo").innerText = `‚úÖ Logged in as: ${user.displayName} (${user.email})`;
        loadMyRequests(user.uid);
      });
    }

    function loadMyRequests(uid) {
      const requestDiv = document.getElementById("myRequests");
      requestDiv.innerHTML = "‚è≥ Loading...";
      firebase.database().ref("requests/" + uid).once("value", snapshot => {
        requestDiv.innerHTML = "";
        if (!snapshot.exists()) {
          requestDiv.innerHTML = "‚ùå No requests found.";
          return;
        }
        snapshot.forEach(reqSnap => {
          const req = reqSnap.val();
          const card = document.createElement("div");
          card.style.border = "1px solid #ccc";
          card.style.padding = "10px";
          card.style.margin = "10px";

          let acceptedInfo = `<b>Accepted By:</b> Not accepted yet`;

          if (req.acceptedBy) {
            const accepterUid = Object.keys(req.acceptedBy)[0];
            firebase.database().ref("users/" + accepterUid).once("value", accepterSnap => {
              const accepter = accepterSnap.val();
              if (accepter) {
                acceptedInfo = `
                  <b>Accepted By:</b><br>
                  ‚Ä¢ Name: ${accepter.name}<br>
                  ‚Ä¢ Phone: ${accepter.phone}<br>
                  ‚Ä¢ Address: ${accepter.address}<br>
                  <a href="https://wa.me/${accepter.phone}" target="_blank">üì≤ WhatsApp</a>
                `;
              }
              card.innerHTML = `
                <b>Service:</b> ${req.category}<br>
                <b>Issue:</b> ${req.description}<br>
                ${acceptedInfo}
              `;
            });
          } else {
            card.innerHTML = `
              <b>Service:</b> ${req.category}<br>
              <b>Issue:</b> ${req.description}<br>
              ${acceptedInfo}
            `;
          }
          requestDiv.appendChild(card);
        });
      });
    }
  </script>
</body>
</html>
