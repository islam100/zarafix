<!DOCTYPE html>
<html>
<head>
  <title>📋 Admin Panel - All Requests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .request-card {
      background: white;
      padding: 15px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    button {
      margin: 5px 5px 0 0;
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.9;
    }
    .accept-btn { background-color: #4CAF50; color: white; }
    .reject-btn { background-color: #f44336; color: white; }
    .delete-btn { background-color: #555; color: white; }
    .loading { text-align: center; font-size: 18px; }
  </style>
</head>
<body>
  <h2>📋 Admin Panel - All Requests</h2>
  <div id="requestsContainer">
    <p class="loading">Loading requests...</p>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "348122303475",
      appId: "1:348122303475:web:168c7e5a83969b38e2b612"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadRequests() {
      const container = document.getElementById("requestsContainer");
      container.innerHTML = "<p class='loading'>Loading requests...</p>";

      db.ref("requests").once("value", (snapshot) => {
        const requests = snapshot.val();
        if (!requests) return (container.innerHTML = "No requests found.");

        // Load posters also
        db.ref("posters").once("value", (posterSnap) => {
          const posters = posterSnap.val() || {};
          const requestList = [];

          Object.entries(requests).forEach(([userId, userRequests]) => {
            Object.entries(userRequests).forEach(([requestId, req]) => {
              requestList.push({ ...req, requestId, userId });
            });
          });

          // Sort by timestamp DESC (latest first)
          requestList.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

          container.innerHTML = "";
          requestList.forEach((request) => {
            const div = document.createElement("div");
            div.className = "request-card";
            div.innerHTML = `
              <p>📂 Category: ${request.category || ''}</p>
              <p>📍 Location: ${request.location || ''}</p>
              <p>📝 Problem: ${request.description || ''}</p>
              <p>📌 Status: ${request.status || 'pending'}</p>
              ${request.acceptedBy
                ? Object.entries(request.acceptedBy).map(([posterId, val]) => {
                    const poster = posters[posterId] || {};
                    return `
                      <p>✔ Accepted By:</p>
                      <p>👤 ${poster.name || 'Unknown'}</p>
                      <p>📱 ${poster.whatsapp || ''}</p>
                      <p>🏪 ${poster.shop || ''}</p>
                      <p>🧰 ${poster.category || ''}</p>
                    `;
                  }).join("")
                : `
                  <button class="accept-btn" onclick="acceptRequest('${request.userId}', '${request.requestId}')">✅ Accept</button>
                  <button class="reject-btn" onclick="rejectRequest('${request.userId}', '${request.requestId}')">❌ Reject</button>
                  <button class="delete-btn" onclick="deleteRequest('${request.userId}', '${request.requestId}')">🗑️ Delete</button>
                `}
            `;
            container.appendChild(div);
          });
        });
      });
    }

    function acceptRequest(userId, requestId) {
      const posterId = localStorage.getItem("posterId") || prompt("Enter Poster ID:");
      if (!posterId) return alert("Poster ID is required.");
      db.ref(`requests/${userId}/${requestId}/acceptedBy`).set({ [posterId]: true });
      alert("Accepted!");
      loadRequests();
    }

    function rejectRequest(userId, requestId) {
      db.ref(`requests/${userId}/${requestId}/status`).set("rejected");
      alert("Rejected!");
      loadRequests();
    }

    function deleteRequest(userId, requestId) {
      if (confirm("Are you sure to delete this request?")) {
        db.ref(`requests/${userId}/${requestId}`).remove();
        alert("Deleted!");
        loadRequests();
      }
    }

    // Auto-refresh every 10 sec
    setInterval(loadRequests, 10000);
    loadRequests();
  </script>
</body>
</html>
