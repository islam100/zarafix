<!DOCTYPE html>
<html>
<head>
  <title>My Service Requests</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ğŸ” Google Login</h2>
  <button onclick="login()">Login with Google</button>
  <p id="userInfo"></p>

  <h3>ğŸ“‹ My Service Requests</h3>
  <div id="myRequests"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "410690883299",
      appId: "1:410690883299:web:646fda87933b7d4acff761"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(result => {
        const user = result.user;
        document.getElementById("userInfo").innerText = `âœ… Logged in as: ${user.displayName} (${user.email})`;
        loadRequests(user.uid);
      });
    }

    function loadRequests(uid) {
      db.ref('requests/' + uid).once('value', snap => {
        const data = snap.val();
        const container = document.getElementById("myRequests");
        container.innerHTML = "";

        if (!data) {
          container.innerHTML = "<p>No requests found.</p>";
          return;
        }

        Object.entries(data).forEach(([reqID, req]) => {
          const div = document.createElement("div");
          div.style.border = "1px solid #999";
          div.style.padding = "10px";
          div.style.margin = "10px";

          let acceptInfo = "Not accepted yet";
          let phone = "-";
          let address = "-";
          let whatsappBtn = "";

          if (req.acceptedBy) {
            const acceptedKeys = Object.keys(req.acceptedBy).filter(key => key !== 'name' && key !== 'phone' && key !== 'address');
            if (acceptedKeys.length > 0) {
              acceptInfo = req.acceptedBy.name || "N/A";
              phone = req.acceptedBy.phone || "N/A";
              address = req.acceptedBy.address || "N/A";

              whatsappBtn = `<a href="https://wa.me/${phone}" target="_blank">
                <button>ğŸ“± WhatsApp</button>
              </a>`;
            }
          }

          div.innerHTML = `
            <strong>ğŸ“Œ Category:</strong> ${req.category}<br>
            <strong>ğŸ“ Issue:</strong> ${req.description}<br>
            <strong>ğŸ“… Date:</strong> ${req.datetime}<br>
            <strong>ğŸ“ Location:</strong> ${req.location}<br><br>
            <strong>âœ… Accepted By:</strong><br>
            â€¢ Name: ${acceptInfo}<br>
            â€¢ Phone: ${phone}<br>
            â€¢ Address: ${address}<br><br>
            ${whatsappBtn}
          `;
          container.appendChild(div);
        });
      });
    }
  </script>
</body>
</html>
