<!DOCTYPE html>
<html>
<head>
  <title>Service Request Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>üîê Google Login</h2>
  <button onclick="googleLogin()">Login with Google</button>
  <div id="userInfo" style="margin-top:20px;"></div>

  <h2>üìã My Service Requests</h2>
  <div id="myRequests"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "401425088870",
      appId: "1:401425088870:web:7518f21c8e7df379491f69"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUID = "";

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(result => {
        const user = result.user;
        currentUID = user.uid;
        document.getElementById("userInfo").innerHTML = `‚úÖ Logged in as: ${user.displayName} (${user.email})`;
        loadMyRequests();
      }).catch(error => {
        console.error("Login Failed", error);
      });
    }

    function loadMyRequests() {
      const myRequestsDiv = document.getElementById("myRequests");
      myRequestsDiv.innerHTML = "<p>Loading...</p>";

      db.ref("requests").once("value", snap => {
        myRequestsDiv.innerHTML = "";
        const allRequests = snap.val();
        for (let userId in allRequests) {
          for (let reqId in allRequests[userId]) {
            const req = allRequests[userId][reqId];

            // Show only requests created by current user
            if (userId === currentUID) {
              const acceptedBy = req.acceptedBy;
              let acceptedInfo = `<p><b>Accepted By:</b> Not accepted yet</p>`;
              let whatsappBtn = "";

              if (acceptedBy) {
                const acceptedUID = Object.keys(acceptedBy)[0];
                // Now get user info from "users"
                db.ref("users/" + acceptedUID).once("value", userSnap => {
                  const acceptor = userSnap.val();
                  acceptedInfo = `
                    <p><b>Accepted By:</b></p>
                    <ul>
                      <li><b>Name:</b> ${acceptor.name || '-'}</li>
                      <li><b>Phone:</b> ${acceptor.phone || '-'}</li>
                      <li><b>Address:</b> ${acceptor.address || '-'}</li>
                    </ul>
                  `;
                  if (acceptor.phone) {
                    whatsappBtn = `<a href="https://wa.me/${acceptor.phone}" target="_blank">
                      üìû Chat on WhatsApp
                    </a>`;
                  }

                  myRequestsDiv.innerHTML += `
                    <hr>
                    <p><b>Service:</b> ${req.category}</p>
                    <p><b>Issue:</b> ${req.description}</p>
                    ${acceptedInfo}
                    ${whatsappBtn}
                  `;
                });
              } else {
                myRequestsDiv.innerHTML += `
                  <hr>
                  <p><b>Service:</b> ${req.category}</p>
                  <p><b>Issue:</b> ${req.description}</p>
                  ${acceptedInfo}
                `;
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
