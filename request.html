<div id="requestsSection">
  <h2>üìã Service Requests</h2>
</div>

<style>
  .card {
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    padding: 15px;
    margin: 10px 0;
    background: #f0f8ff;
  }
  .btn-3d {
    padding: 6px 14px;
    margin-right: 5px;
    background: linear-gradient(to right, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 8px;
    box-shadow: 0 5px 0 #004080;
    cursor: pointer;
  }
  .btn-3d:hover {
    background: linear-gradient(to right, #0056b3, #003d80);
  }
</style>

<script>
  const db = firebase.database();
  const requestsSection = document.getElementById('requestsSection');

  db.ref('requests').on('value', (snapshot) => {
    requestsSection.innerHTML = '<h2>üìã Service Requests</h2>';
    const requests = snapshot.val();
    if (!requests) {
      requestsSection.innerHTML += '<p>No requests found.</p>';
      return;
    }

    Object.entries(requests).forEach(([userId, userRequests]) => {
      Object.entries(userRequests).forEach(([reqId, req]) => {
        const description = req.description || 'N/A';
        const category = req.category || 'N/A';
        const date = req.date || 'N/A';
        const acceptedBy = req.acceptedBy || {};

        Object.entries(acceptedBy).forEach(([posterId, accepted]) => {
          if (accepted) {
            db.ref('posters/' + posterId).once('value', (posterSnap) => {
              const poster = posterSnap.val();
              if (!poster) return;

              const name = poster.name || 'Unknown';
              const phone = poster.whatsapp || '';
              const card = document.createElement('div');
              card.className = 'card';

              card.innerHTML = `
                <b>‡§ï‡§æ‡§Æ:</b> ${category}<br>
                <b>‡§µ‡§ø‡§µ‡§∞‡§£:</b> ${description}<br>
                <b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> ${date}<br>
                <b>Accept ‡§ï‡§ø‡§Ø‡§æ:</b> ‚úÖ ${name} (${phone})<br>
                <button class="btn-3d" onclick="window.open('https://wa.me/${phone}', '_blank')">WhatsApp ${name}</button>
                <button class="btn-3d" onclick="deleteRequest('${userId}', '${reqId}', '${posterId}')">‚ùå Delete</button>
                <button class="btn-3d" onclick="rejectRequest('${userId}', '${reqId}', '${posterId}')">üö´ Reject</button>
              `;

              requestsSection.appendChild(card);
            });
          }
        });
      });
    });
  });

  function deleteRequest(userId, requestId, posterId) {
    if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ request ‡§ï‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
      firebase.database().ref(`requests/${userId}/${requestId}/acceptedBy/${posterId}`).remove();
      alert("Request Deleted");
    }
  }

  function rejectRequest(userId, requestId, posterId) {
    if (confirm('Reject ‡§ï‡§∞‡•á‡§Ç?')) {
      firebase.database().ref(`requests/${userId}/${requestId}/acceptedBy/${posterId}`).set(false);
      alert("Request Rejected");
    }
  }
</script>
