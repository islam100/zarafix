<!DOCTYPE html>
<html>
<head>
  <title>üìã Service Requests</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f5f5f5;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .request {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      margin: 15px 0;
      padding: 15px;
    }
    button {
      margin: 5px;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 2px 2px 5px #999;
    }
    .accept { background: #28a745; color: white; }
    .whatsapp { background: #25D366; color: white; }
    .delete { background: #dc3545; color: white; }
    .accepted-list { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üìã Service Requests</h2>
  <div id="requestList"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "686146002834",
      appId: "1:686146002834:web:e663eec68b35d2ddc3d301"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentPosterId = "posterId1"; // ‡§Ø‡•á login ‡§µ‡§æ‡§≤‡•á provider ‡§ï‡§æ ID ‡§π‡•à

    function loadRequests() {
      db.ref("requests").once("value", (snapshot) => {
        const requests = snapshot.val();
        document.getElementById("requestList").innerHTML = "";

        for (let userId in requests) {
          for (let reqId in requests[userId]) {
            const req = requests[userId][reqId];
            const div = document.createElement("div");
            div.className = "request";
            div.innerHTML = `
              <p><strong>‡§ï‡§æ‡§Æ:</strong> ${req.category || 'N/A'}</p>
              <p><strong>‡§µ‡§ø‡§µ‡§∞‡§£:</strong> ${req.description || 'N/A'}</p>
              <p><strong>‡§∏‡•ç‡§•‡§æ‡§®:</strong> ${req.location || 'N/A'}</p>
              <button class="accept" onclick="acceptRequest('${userId}', '${reqId}')">‚úÖ Accept</button>
              <div class="accepted-list" id="accepted-${userId}-${reqId}"></div>
              <button class="delete" onclick="deleteRequest('${userId}', '${reqId}')">‚ùå Reject</button>
            `;
            document.getElementById("requestList").appendChild(div);
            showAcceptedList(userId, reqId, req.acceptedBy);
          }
        }
      });
    }

    function acceptRequest(userId, reqId) {
      const acceptedPath = `requests/${userId}/${reqId}/acceptedBy/${currentPosterId}`;
      db.ref(acceptedPath).set(true).then(() => {
        alert("‡§Ü‡§™‡§®‡•á ‡§á‡§∏ request ‡§ï‡•ã Accept ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à!");
        loadRequests();
      });
    }

    function deleteRequest(userId, reqId) {
      if (confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ request ‡§ï‡•ã delete ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
        db.ref(`requests/${userId}/${reqId}`).remove().then(() => {
          loadRequests();
        });
      }
    }

    function showAcceptedList(userId, reqId, acceptedBy) {
      const acceptedDiv = document.getElementById(`accepted-${userId}-${reqId}`);
      acceptedDiv.innerHTML = "";
      if (!acceptedBy) return;

      for (let posterId in acceptedBy) {
        db.ref("posters/" + posterId).once("value", (snap) => {
          const poster = snap.val();
          if (poster) {
            const name = poster.name || "Unknown";
            const phone = poster.whatsapp || "";
            const whatsBtn = phone ? `<a class="whatsapp" target="_blank" href="https://wa.me/${phone}">WhatsApp ${name}</a>` : '';
            acceptedDiv.innerHTML += `
              <p>‚úÖ <strong>${name}</strong> (${poster.category || ''})<br>
              ${whatsBtn}</p>
            `;
          }
        });
      }
    }

    loadRequests();
  </script>
</body>
</html>
