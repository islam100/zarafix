<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZaraFix Admin Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f0f0;
  }
  #loginBtn, #logoutBtn {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    color: white;
    background-color: #4285F4;
    display: block;
    margin: 10px auto;
  }
  #logoutBtn {
    background-color: #db4437;
  }
  #adminPanel {
    max-width: 800px;
    margin: auto;
    display: none;
  }
</style>
</head>
<body>

<h1 style="text-align:center;">ZaraFix Admin Dashboard</h1>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<div id="adminPanel">
  <p>Welcome, Admin! Your requests will appear here.</p>
  <div id="requestsContainer">Loading requests...</div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "476473209200",
    appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminPanel = document.getElementById('adminPanel');
  const requestsContainer = document.getElementById('requestsContainer');

  // Login button click
  loginBtn.addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert('Login failed: ' + err.message));
  });

  // Logout button click
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Check if user is admin
  function checkIsAdmin(uid) {
    return db.ref('admins/' + uid).once('value').then(snap => {
      return snap.exists() && snap.val() === true;
    });
  }

  // Show requests in admin panel
  function renderRequests(requests) {
    requestsContainer.innerHTML = '';
    if (!requests) {
      requestsContainer.textContent = 'No requests found.';
      return;
    }

    // Flatten all requests
    let allRequests = [];
    for (const userId in requests) {
      for (const requestId in requests[userId]) {
        allRequests.push({ userId, requestId, data: requests[userId][requestId] });
      }
    }

    // Sort descending by requestId (assuming it's timestamp or sortable)
    allRequests.sort((a, b) => b.requestId.localeCompare(a.requestId));

    allRequests.forEach(({ userId, requestId, data }) => {
      const card = document.createElement('div');
      card.style.background = 'white';
      card.style.padding = '10px';
      card.style.marginBottom = '10px';
      card.style.borderRadius = '6px';
      card.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

      card.innerHTML = `
        <b>Category:</b> ${data.category || 'N/A'}<br>
        <b>Description:</b> ${data.description || 'N/A'}<br>
        <b>Location:</b> ${data.location || 'N/A'}<br>
        <b>User ID:</b> ${userId}<br>
        <b>Request ID:</b> ${requestId}<br>
        <b>Status:</b> ${data.acceptedBy ? 'Accepted' : 'Pending'}
      `;

      requestsContainer.appendChild(card);
    });
  }

  // Listen auth state change
  auth.onAuthStateChanged(async user => {
    if (user) {
      // Check admin
      const isAdmin = await checkIsAdmin(user.uid);
      if (!isAdmin) {
        alert('You are not authorized as admin.');
        auth.signOut();
        return;
      }
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'block';
      adminPanel.style.display = 'block';

      // Listen to requests realtime
      db.ref('requests').on('value', snapshot => {
        renderRequests(snapshot.val());
      });
    } else {
      loginBtn.style.display = 'block';
      logoutBtn.style.display = 'none';
      adminPanel.style.display = 'none';
    }
  });
</script>

</body>
</html>
