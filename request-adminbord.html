<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZaraFix Admin Panel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #fafafa;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    color: white;
  }
  #loginBtn {
    background-color: #4285F4;
  }
  #logoutBtn {
    background-color: #db4437;
    display: none;
  }
  #adminPanel {
    max-width: 700px;
    margin: 20px auto;
    display: none;
  }
  .request-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
</style>
</head>
<body>

<h1 style="text-align:center;">ZaraFix Admin Panel</h1>

<div style="text-align:center;">
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn">Logout</button>
</div>

<div id="adminPanel">
  <h2>All Requests (Newest First)</h2>
  <div id="requestsContainer">Loading requests...</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // अपने Firebase config डालें यहाँ:
  const firebaseConfig = {
    apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "476473209200",
    appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminPanel = document.getElementById('adminPanel');
  const requestsContainer = document.getElementById('requestsContainer');

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert("Login failed: " + err.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // एडमिन चेक (UID Firebase console में admins node में होना चाहिए)
  async function isAdmin(uid) {
    const snapshot = await db.ref('admins/' + uid).once('value');
    return snapshot.exists() && snapshot.val() === true;
  }

  // Requests को रेंडर करना
  function renderRequests(requests) {
    if (!requests) {
      requestsContainer.innerHTML = "No requests found.";
      return;
    }

    // सभी requests को एक लिस्ट में ले लो
    let allRequests = [];
    for (const userId in requests) {
      for (const reqId in requests[userId]) {
        const req = requests[userId][reqId];
        allRequests.push({ userId, reqId, ...req });
      }
    }

    // नया सबसे ऊपर दिखाने के लिए sort कर लो (Request ID से, assume timestamp जैसा है)
    allRequests.sort((a, b) => b.reqId.localeCompare(a.reqId));

    requestsContainer.innerHTML = "";
    allRequests.forEach(req => {
      const card = document.createElement('div');
      card.className = 'request-card';

      card.innerHTML = `
        <b>Category:</b> ${req.category || 'N/A'}<br>
        <b>Description:</b> ${req.description || 'N/A'}<br>
        <b>Location:</b> ${req.location || 'N/A'}<br>
        <b>User ID:</b> ${req.userId}<br>
        <b>Request ID:</b> ${req.reqId}<br>
        <b>Status:</b> ${req.acceptedBy ? 'Accepted' : 'Pending'}
      `;

      requestsContainer.appendChild(card);
    });
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      const admin = await isAdmin(user.uid);
      if (!admin) {
        alert("You are not authorized as admin.");
        auth.signOut();
        return;
      }
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      adminPanel.style.display = "block";

      // Firebase से requests सुनो (live update)
      db.ref('requests').on('value', snapshot => {
        renderRequests(snapshot.val());
      });

    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      adminPanel.style.display = "none";
      requestsContainer.innerHTML = "";
    }
  });
</script>

</body>
</html>
