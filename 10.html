<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZARA FIX – Coupons (Firebase Realtime DB)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-dark:#15803d; --danger:#ef4444; --ring:#334155; --gold:#fbbf24;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 70% -10%, #1e293b 0, var(--bg) 55%);color:var(--text);min-height:100vh;}

    /* ======= HEADER ======= */
    header{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:10px 14px;position:sticky;top:0;background:rgba(2,6,23,.7);backdrop-filter: blur(10px);border-bottom:1px solid #1f2937;z-index:60}

    /* 3D colorful logo */
    .logo{
      font-weight:900; letter-spacing:1px; line-height:1; user-select:none; cursor:pointer;
      font-size:34px;
      background: conic-gradient(from 180deg, #22d3ee, #a78bfa, #f472b6, #f97316, #22c55e, #22d3ee);
      background-clip:text; -webkit-background-clip:text; color:transparent;
      text-shadow: 0 2px 0 rgba(255,255,255,.12), 0 6px 0 #0a0f1a, 0 14px 20px rgba(0,0,0,.6);
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.45));
    }
    @media(min-width:900px){ .logo{ font-size:46px } }

    .menus{display:flex;gap:10px;align-items:center}
    .menu-wrap{position:relative}
    .menu-btn{padding:10px 12px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;cursor:pointer;box-shadow:inset 0 0 0 1px #0e1627, 0 8px 0 #0a0f1a;font-weight:800}
    .menu-list{display:none;position:absolute;top:110%;left:0;background:#0b1220;border:1px solid #1f2937;border-radius:12px;min-width:200px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.45);z-index:70}
    .menu-wrap:hover .menu-list{display:block}
    .menu-item{display:block;padding:10px 12px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid #1f2937}
    .menu-item:hover{background:#111826}

    .header-actions{display:flex;align-items:center;gap:10px}
    .tab{padding:9px 12px;border-radius:999px;border:1px solid #1f2937;background:#0b1220;color:#cbd5e1;font-weight:600;cursor:pointer}
    .tab.active{border-color:#14532d;background:#052e16;color:#bbf7d0}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;border-radius:12px;border:1px solid #14532d;background:#052e16;color:#bbf7d0;font-weight:800;cursor:pointer;box-shadow:0 6px 0 #0c2c19;transition:transform .06s ease, box-shadow .06s ease}
    .btn:active{transform:translateY(3px);box-shadow:0 2px 0 #0c2c19}
    .btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
    .btn-danger{border-color:#7f1d1d;background:#450a0a;color:#fecaca;box-shadow:0 6px 0 #2a0a0a}
    .btn-ghost{border:1px dashed #334155;background:transparent;color:#cbd5e1;box-shadow:none}

    main{max-width:1100px;margin:0 auto;padding:16px;}

    /* Grid: mobile में 2 cards/row */
    .grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:1040px){.grid{grid-template-columns:repeat(4,1fr)}}

    /* 3D Cards */
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,0.03);padding:10px;transition:transform .2s ease, box-shadow .2s ease;position:relative;overflow:hidden;cursor:pointer}
    .card:hover{transform:translateY(-4px)}
    .card img{width:100%;height:120px;object-fit:cover;border-radius:12px;margin-bottom:8px; box-shadow:0 10px 18px rgba(0,0,0,.25)}
    .title{font-weight:800;font-size:15px}
    .muted{color:var(--muted);font-size:12px}
    .info{font-size:12px;margin:6px 0}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;margin:6px 0}
    .badge{position:absolute;top:8px;right:8px;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid #1f2937;background:#0b1220}
    .sold::after{content:"SOLD";position:absolute;inset:auto;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--danger);color:white;padding:8px 12px;border-radius:10px;font-weight:900;letter-spacing:.5px;box-shadow:0 12px 26px rgba(239,68,68,.45)}

    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:80}
    .overlay.show{display:block}
    .card.expanded{position:fixed;z-index:100;top:50%;left:50%;transform:translate(-50%,-50%) scale(1.02);width:min(92vw,460px)}

    .panel{display:none}
    .panel.active{display:block}

    form{display:grid;gap:10px}
    input,select{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0a0f1a;color:#e5e7eb}
    label{font-size:12px;color:#a3b3cf}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}

    .whats-btn{position:fixed;right:16px;bottom:16px}

    /* Modal for editing menu links (admin only) */
    .modal{display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.55);align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px;min-width:min(92vw,680px)}
  </style>
</head>
<body>
  <header>
    <!-- Left: Logo -->
    <div class="logo" onclick="document.querySelector('[data-target=public]').click()">ZARA FIX</div>

    <!-- Center: Menus -->
    <div class="menus">
      <div class="menu-wrap">
        <button class="menu-btn">Services ▾</button>
        <div class="menu-list" id="menuServices">
          <a class="menu-item" id="lnkProperty"   target="_blank">Property</a>
          <a class="menu-item" id="lnkAmbulance"  target="_blank">Ambulance</a>
          <a class="menu-item" id="lnkAllService" target="_blank">All Services</a>
        </div>
      </div>
      <div class="menu-wrap">
        <button class="menu-btn">Info ▾</button>
        <div class="menu-list" id="menuInfo">
          <a class="menu-item" id="lnkProvider" target="_blank">Provider</a>
          <a class="menu-item" id="lnkAbout"    target="_blank">About</a>
          <a class="menu-item" id="lnkContact"  target="_blank">Contact</a>
          <a class="menu-item" id="lnkPrivacy"  target="_blank">Privacy Policy</a>
        </div>
      </div>
      <!-- small gear for admin to edit links -->
      <button id="editMenusBtn" class="btn btn-ghost" style="display:none">✦ Edit Links</button>
    </div>

    <!-- Right: Tabs + Login -->
    <div class="header-actions">
      <button class="tab active" data-target="public">Public</button>
      <button class="tab" data-target="shop">Shopkeeper</button>
      <button class="tab" data-target="admin">Admin</button>
      <button class="btn" id="loginBtn">Login with Google</button>
      <button class="btn btn-danger" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </header>

  <main>
    <!-- PUBLIC -->
    <section id="public" class="panel active">
      <p class="muted">ग्राहक बिना login सभी cards देख सकते हैं। "Submit Code" के बाद भी card SOLD नहीं होगा — केवल shopkeeper Accept करने पर SOLD दिखेगा। Card पर क्लिक करने पर बड़ा, बाहर क्लिक पर छोटा।</p>
      <div id="publicGrid" class="grid"></div>
    </section>

    <!-- SHOPKEEPER -->
    <section id="shop" class="panel">
      <div id="shopGuard" class="muted">Shopkeeper panel देखने के लिए Google से login करें और आपका email shopkeepers में होना चाहिए।</div>
      <div id="shopPanel" style="display:none;margin-top:12px">
        <div class="row stats">
          <div class="stat">Pending: <span id="shopPending">0</span></div>
          <div class="stat">Accepted: <span id="shopAccepted">0</span></div>
        </div>
        <h3>मेरे Coupons</h3>
        <div id="shopGrid" class="grid"></div>
        <button class="btn whats-btn" id="whatsBtn">WhatsApp Admin</button>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="panel">
      <p class="muted">Admin: केवल <b>zarasamajiksevasanstha@gmail.com</b> Google login से। यहाँ से shops और coupons manage करें। (Header menus अब fixed हैं; links edit करने का छोटा popup ऊपर gear से.)</p>
      <div id="adminPanel" style="display:none;margin-top:14px">
        <div class="row stats">
          <div class="stat">Total Cards: <span id="statTotal">0</span></div>
          <div class="stat">SOLD: <span id="statSold">0</span></div>
          <div class="stat">Available: <span id="statAvail">0</span></div>
        </div>

        <h3>Shopkeeper जोड़ें</h3>
        <form id="shopForm">
          <div class="row">
            <input id="sEmail" placeholder="Email" required>
            <input id="sName" placeholder="Shop Name" required>
          </div>
          <div class="row">
            <input id="sAddr" placeholder="Shop Address" required>
            <input id="sExpiry" type="date" required>
          </div>
          <button class="btn" type="submit">Add Shop</button>
        </form>

        <h3 style="margin-top:16px">Card (Coupon) जोड़ें</h3>
        <form id="cardForm">
          <div class="row">
            <input id="pName" placeholder="Product Name" required>
            <input id="pValue" type="number" placeholder="Value (₹)" required>
            <input id="pDiscount" placeholder="Discount (10% / ₹200)" required>
          </div>
          <div class="row">
            <input id="pExpiry" type="date" required>
            <select id="pShop" required></select>
          </div>
          <div class="row">
            <label>Image:</label>
            <input id="imgFile" type="file" accept="image/*" required>
          </div>
          <button class="btn" type="submit">Create Card</button>
        </form>

        <h3 style="margin-top:16px">All Cards</h3>
        <table class="table" id="adminTable">
          <thead><tr><th>Code</th><th>Product</th><th>Value</th><th>Discount</th><th>Expiry</th><th>Shop</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="adminGuard" class="muted">Admin panel देखने के लिए Google से login करें (fixed admin email).</div>
    </section>
  </main>

  <div id="overlay" class="overlay"></div>

  <!-- Edit Menus Modal (admin only) -->
  <div id="menusModal" class="modal">
    <div class="modal-card">
      <h3>Header Links Edit करें</h3>
      <p class="muted">दो dropdown (Services / Info) के links यहाँ बदलें:</p>
      <form id="menusForm" style="margin-top:8px">
        <div class="row">
          <label style="width:120px">Property URL</label>
          <input id="uProperty" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">Ambulance URL</label>
          <input id="uAmbulance" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">All Services URL</label>
          <input id="uAll" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">Provider URL</label>
          <input id="uProvider" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">About URL</label>
          <input id="uAbout" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">Contact URL</label>
          <input id="uContact" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row">
          <label style="width:120px">Privacy URL</label>
          <input id="uPrivacy" placeholder="https://..." required style="flex:1">
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button type="button" class="btn btn-ghost" id="closeMenus">Close</button>
          <button class="btn" type="submit">Save Links</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /***********************
     * 1) Firebase Init
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAa8htkfGK-4D3cIQVyxT3o_8WMvghkr-8",
      authDomain: "loot-lo-15328.firebaseapp.com",
      databaseURL: "https://loot-lo-15328-default-rtdb.firebaseio.com",
      projectId: "loot-lo-15328",
      storageBucket: "loot-lo-15328.appspot.com",
      messagingSenderId: "677769861892",
      appId: "1:677769861892:web:bb235cb8479aeee9b58e51"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.database();

    const FIXED_ADMIN = 'zarasamajiksevasanstha@gmail.com';
    const IMGBB_API_KEY = 'ff05d1b5c3b3e139253856f0ad1123df';

    /***********************
     * 2) Tabs
     ***********************/
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
      })
    })

    /***********************
     * 3) Auth (Google)
     ***********************/
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    loginBtn.onclick = ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e=>alert(e.message));
    }
    logoutBtn.onclick = ()=> auth.signOut();

    let currentUser = null; // {email, uid, isAdmin, isShop, shopRecord}

    auth.onAuthStateChanged(async user=>{
      currentUser = null;
      if(user){
        const email = user.email.toLowerCase();
        const isAdmin = (email === FIXED_ADMIN.toLowerCase());
        let shopRecord = null; let isShop=false;
        const snap = await db.ref('shopkeepers').get();
        snap.forEach(ch=>{ const v=ch.val(); if(v.email && v.email.toLowerCase()===email){ shopRecord={id:ch.key,...v}; isShop=true } });
        currentUser = { email, uid:user.uid, isAdmin, isShop, shopRecord };
      }
      updateGuards();
      subscribePublic();
      subscribeShop();
      subscribeAdmin();
      setupMenus();
    });

    function updateGuards(){
      const loggedIn = !!currentUser;
      document.getElementById('logoutBtn').style.display = loggedIn? 'inline-flex':'none';
      document.getElementById('loginBtn').style.display  = loggedIn? 'none':'inline-flex';

      document.getElementById('shopPanel').style.display = (currentUser && currentUser.isShop)? 'block':'none';
      document.getElementById('shopGuard').style.display = (currentUser && currentUser.isShop)? 'none':'block';

      document.getElementById('adminPanel').style.display = (currentUser && currentUser.isAdmin)? 'block':'none';
      document.getElementById('adminGuard').style.display = (currentUser && currentUser.isAdmin)? 'none':'block';

      document.getElementById('editMenusBtn').style.display = (currentUser && currentUser.isAdmin)? 'inline-flex':'none';
    }

    /***********************
     * 4) PUBLIC (Realtime list)
     ***********************/
    const overlay = document.getElementById('overlay');
    let publicUnsub = null;
    function subscribePublic(){
      if(publicUnsub){ db.ref('coupons').off('value', publicUnsub); publicUnsub=null }
      publicUnsub = db.ref('coupons').on('value', (snapshot)=>{
        const list=[]; snapshot.forEach(ch=> list.push({id:ch.key, ...ch.val()}));
        list.sort((a,b)=> (Number(a.accepted) - Number(b.accepted)) || (Number(b.createdAt||0) - Number(a.createdAt||0)) );
        renderPublic(list);
        syncAdminStats(list);
      });
    }

    function renderPublic(items){
      const grid = document.getElementById('publicGrid');
      grid.innerHTML='';
      items.forEach(c=>{
        const card = document.createElement('div');
        card.className = 'card' + (c.accepted? ' sold':'');
        const status = c.accepted? 'SOLD' : (c.submitted? 'SUBMITTED':'AVAILABLE');
        card.innerHTML = `
          <span class=\"badge\">${status}</span>
          <img src=\"${c.img||''}\" alt=\"${c.product||''}\">
          <div class=\"title\">${c.product||''}</div>
          <div class=\"info\">Value: ₹${c.value||0} • Discount: ${c.discount||''}</div>
          <div class=\"info\">Expiry: ${c.expiry||''}</div>
          <div class=\"code\">Code: ${c.code||''}</div>
          <button class=\"btn\" ${c.accepted? 'disabled':''}>${c.submitted? 'Submitted':'Submit Code'}</button>
        `;
        card.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()==='button') return; card.classList.add('expanded'); overlay.classList.add('show') })
        overlay.addEventListener('click', ()=>{ card.classList.remove('expanded'); overlay.classList.remove('show') }, {once:true});
        card.querySelector('button').addEventListener('click', async (e)=>{
          e.stopPropagation(); if(c.accepted) return;
          // Expiry check client-side
          if(isExpired(c.expiry)) return alert('Coupon expired.');
          if(c.submitted){ alert('Already submitted. Shopkeeper will verify.'); return }
          const user = auth.currentUser;
          const uid = user? user.uid : 'guest';
          const email = user? user.email : 'guest';
          await db.ref('coupons/'+c.id).update({ submitted:true, submittedBy: email, submittedAt: Date.now() });
          await db.ref('coupons/'+c.id+'/submissions/'+uid).set({ by:email, at: Date.now() });
        })
        grid.appendChild(card);
      })
    }

    /***********************
     * 5) SHOPKEEPER view (Realtime)
     ***********************/
    let shopUnsub = null;
    function subscribeShop(){
      if(shopUnsub){ db.ref('coupons').off('value', shopUnsub); shopUnsub=null }
      if(!(currentUser && currentUser.isShop)) return;
      const myEmail = currentUser.shopRecord.email.toLowerCase();
      shopUnsub = db.ref('coupons').on('value', (snapshot)=>{
        const mine=[]; snapshot.forEach(ch=>{ const v={id:ch.key, ...ch.val()}; if((v.shopEmail||'').toLowerCase()===myEmail) mine.push(v) });
        mine.sort((a,b)=> (Number(a.accepted)-Number(b.accepted)) || (Number(b.createdAt||0)-Number(a.createdAt||0)) );
        renderShop(mine);
      })
    }

    function renderShop(mine){
      const grid = document.getElementById('shopGrid'); grid.innerHTML='';
      let pending=0, accepted=0;
      mine.forEach(c=>{ if(c.accepted) accepted++; else if(c.submitted) pending++; })
      document.getElementById('shopPending').textContent = pending;
      document.getElementById('shopAccepted').textContent = accepted;

      mine.forEach(c=>{
        const card = document.createElement('div');
        card.className = 'card' + (c.accepted? ' sold':'');
        card.innerHTML = `
          <img src=\"${c.img||''}\">
          <div class=\"title\">${c.product||''}</div>
          <div class=\"info\">Value: ₹${c.value||0} • Discount: ${c.discount||''}</div>
          <div class=\"info\">Expiry: ${c.expiry||''}</div>
          <div class=\"code\">${c.code||''}</div>
          <div class=\"row\">
            <button class=\"btn\" data-act=\"verify\" ${c.accepted? 'disabled':''}>Verify</button>
            <button class=\"btn\" data-act=\"accept\" ${c.accepted||!c.submitted? 'disabled':''}>Accept</button>
            <button class=\"btn btn-danger\" data-act=\"reject\" ${c.accepted||!c.submitted? 'disabled':''}>Reject</button>
          </div>
        `;
        card.addEventListener('click', (e)=>{ if(e.target.closest('button')) return; card.classList.add('expanded'); overlay.classList.add('show') })
        overlay.addEventListener('click', ()=>{ card.classList.remove('expanded'); overlay.classList.remove('show') }, {once:true});

        card.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if(btn.dataset.act==='verify'){
              if(c.accepted) return alert('Already SOLD');
              if(isExpired(c.expiry)) return alert('Coupon expired');
              if(!c.submitted) return alert('Not submitted yet');
              const subsSnap = await db.ref('coupons/'+c.id+'/submissions').get();
              if(!subsSnap.exists()) return alert('No submission record');
              let msg='Submissions:\n'; subsSnap.forEach(s=>{ const v=s.val(); msg += `• ${v.by||s.key} at ${new Date(v.at).toLocaleString()}\n`; });
              alert(msg);
            }
            if(btn.dataset.act==='accept'){
              if(isExpired(c.expiry)) return alert('Coupon expired, cannot accept');
              await db.ref('coupons/'+c.id).update({ accepted:true, acceptedAt: Date.now(), acceptedBy: currentUser.email });
            }
            if(btn.dataset.act==='reject'){
              await db.ref('coupons/'+c.id).update({ submitted:false, submittedBy:null, submittedAt:null });
              await db.ref('coupons/'+c.id+'/submissions').remove();
            }
          })
        })
        grid.appendChild(card);
      })

      document.getElementById('whatsBtn').onclick = ()=>{
        const msg = encodeURIComponent(`Shop: ${currentUser.shopRecord.name} (${currentUser.email})\nPending: ${pending}, Accepted: ${accepted}`);
        window.open(`https://wa.me/917378342192?text=${msg}`, '_blank');
      }
    }

    /***********************
     * 6) ADMIN view (Realtime)
     ***********************/
    let adminCouponsUnsub = null, adminShopsUnsub = null;
    function subscribeAdmin(){
      if(adminCouponsUnsub){ db.ref('coupons').off('value', adminCouponsUnsub); adminCouponsUnsub=null }
      if(adminShopsUnsub){ db.ref('shopkeepers').off('value', adminShopsUnsub); adminShopsUnsub=null }
      if(!(currentUser && currentUser.isAdmin)) return;

      adminShopsUnsub = db.ref('shopkeepers').on('value', snap=>{
        const sel=document.getElementById('pShop'); sel.innerHTML='';
        snap.forEach(ch=>{ const v=ch.val(); const opt=document.createElement('option'); opt.value=v.email; opt.textContent=`${v.name} (${v.email})`; sel.appendChild(opt) })
      })

      adminCouponsUnsub = db.ref('coupons').on('value', snap=>{
        const list=[]; snap.forEach(ch=> list.push({id:ch.key, ...ch.val()}));
        list.sort((a,b)=> Number(b.createdAt||0)-Number(a.createdAt||0));
        renderAdminTable(list); syncAdminStats(list);
      })
    }

    function renderAdminTable(list){
      const tbody=document.querySelector('#adminTable tbody'); tbody.innerHTML='';
      list.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c.code||''}</td><td>${c.product||''}</td><td>₹${c.value||0}</td><td>${c.discount||''}</td><td>${c.expiry||''}</td><td>${c.shopEmail||''}</td><td>${c.accepted? 'SOLD' : (c.submitted? 'SUBMITTED':'AVAILABLE')}</td>`;
        tbody.appendChild(tr);
      })
    }
    function syncAdminStats(list){
      const total=list.length, sold=list.filter(x=>x.accepted).length, avail=total-sold;
      document.getElementById('statTotal').textContent=total;
      document.getElementById('statSold').textContent=sold;
      document.getElementById('statAvail').textContent=avail;
    }

    // Add shopkeeper
    document.getElementById('shopForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!(currentUser && currentUser.isAdmin)) return alert('Admin only');
      const s={ email: sEmail.value.trim(), name:sName.value.trim(), address:sAddr.value.trim(), expiry:sExpiry.value };
      db.ref('shopkeepers').push(s).then(()=>{ alert('Shop added'); e.target.reset(); })
    })

    // Create card (ImgBB upload + duplicate code check + expiry validation)
    document.getElementById('cardForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!(currentUser && currentUser.isAdmin)) return alert('Admin only');
      const file = document.getElementById('imgFile').files[0];
      if(!file) return alert('Select image');
      if(isExpired(pExpiry.value)) return alert('Expiry must be today or later');
      try{
        const fd = new FormData(); fd.append('image', file);
        const url = `https://api.imgbb.com/1/upload?key=${encodeURIComponent(IMGBB_API_KEY)}`;
        const res = await fetch(url, { method:'POST', body: fd });
        const data = await res.json();
        if(!data.success) throw new Error('ImgBB upload failed');
        const img = data.data.display_url;

        // unique code loop
        let code; let exists=true;
        const allSnap = await db.ref('coupons').get();
        const all = allSnap.val()||{};
        do{
          code = genCode();
          exists = Object.values(all).some(x=> x.code===code);
        }while(exists);

        const coupon = {
          code, product: pName.value.trim(), value: Number(pValue.value), discount: pDiscount.value.trim(),
          expiry: pExpiry.value, shopEmail: pShop.value, img, submitted:false, accepted:false, createdAt: Date.now()
        };
        await db.ref('coupons').push(coupon);
        alert('Card created'); e.target.reset();
      }catch(err){ alert(err.message) }
    })

    function genCode(){ return Math.random().toString(36).slice(2,10).toUpperCase() }
    function isExpired(dateStr){ const d=new Date(dateStr); d.setHours(23,59,59,999); return d.getTime()<Date.now(); }

    /***********************
     * 7) Header Menus Links (stored in DB, edit popup only for admin)
     ***********************/
    const linkIds = {
      property:'uProperty', ambulance:'uAmbulance', all:'uAll', provider:'uProvider', about:'uAbout', contact:'uContact', privacy:'uPrivacy'
    };
    const linkNodes = {
      property: document.getElementById('lnkProperty'),
      ambulance: document.getElementById('lnkAmbulance'),
      all: document.getElementById('lnkAllService'),
      provider: document.getElementById('lnkProvider'),
      about: document.getElementById('lnkAbout'),
      contact: document.getElementById('lnkContact'),
      privacy: document.getElementById('lnkPrivacy'),
    };

    function setupMenus(){
      // load from DB
      db.ref('menuLinks').on('value', snap=>{
        const d = snap.val() || defaultLinks();
        applyMenuLinks(d);
      });
      // admin edit
      const btn = document.getElementById('editMenusBtn');
      const modal = document.getElementById('menusModal');
      const closeBtn = document.getElementById('closeMenus');
      btn.onclick = ()=>{ if(!(currentUser && currentUser.isAdmin)) return; openLinksEditor(); modal.classList.add('show') };
      closeBtn.onclick = ()=> modal.classList.remove('show');
      document.getElementById('menusForm').onsubmit = (e)=>{
        e.preventDefault(); if(!(currentUser && currentUser.isAdmin)) return;
        const payload = readLinksFromForm();
        db.ref('menuLinks').set(payload).then(()=>{ modal.classList.remove('show') })
      }
    }

    function defaultLinks(){
      return {
        property:'https://example.com/property',
        ambulance:'https://example.com/ambulance',
        all:'https://example.com/all-services',
        provider:'https://example.com/provider',
        about:'https://example.com/about',
        contact:'https://example.com/contact',
        privacy:'https://example.com/privacy-policy'
      }
    }

    function applyMenuLinks(d){
      linkNodes.property.href = d.property; linkNodes.ambulance.href=d.ambulance; linkNodes.all.href=d.all;
      linkNodes.provider.href = d.provider; linkNodes.about.href=d.about; linkNodes.contact.href=d.contact; linkNodes.privacy.href=d.privacy;
    }

    function openLinksEditor(){
      db.ref('menuLinks').get().then(s=>{
        const d = s.val() || defaultLinks();
        document.getElementById('uProperty').value = d.property;
        document.getElementById('uAmbulance').value= d.ambulance;
        document.getElementById('uAll').value      = d.all;
        document.getElementById('uProvider').value = d.provider;
        document.getElementById('uAbout').value    = d.about;
        document.getElementById('uContact').value  = d.contact;
        document.getElementById('uPrivacy').value  = d.privacy;
      })
    }

    function readLinksFromForm(){
      return {
        property: document.getElementById('uProperty').value.trim(),
        ambulance:document.getElementById('uAmbulance').value.trim(),
        all:      document.getElementById('uAll').value.trim(),
        provider: document.getElementById('uProvider').value.trim(),
        about:    document.getElementById('uAbout').value.trim(),
        contact:  document.getElementById('uContact').value.trim(),
        privacy:  document.getElementById('uPrivacy').value.trim(),
      }
    }

    /***********************
     * 8) Notes (Security Rules Suggestion)
     * Realtime Database rules में expiry, admin-only writes, shop-only accept enforce करें.
     * Example rules आप मुझसे अलग से मांग सकते हैं।
     ***********************/
  </script>
</body>
</html>
