<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè° Real Estate</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <style>
    body{margin:0;font-family:sans-serif;background:#f0f2f5;color:#333;}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#2563eb;color:white;box-shadow:0 2px 6px rgba(0,0,0,.2);}
    header h2{margin:0;font-size:20px;text-shadow:1px 1px 2px #000;}
    .btn-3d {
      padding:8px 14px;margin:4px;border:none;border-radius:8px;
      font-weight:600;color:white;cursor:pointer;
      box-shadow:2px 2px 6px rgba(0,0,0,.3),-2px -2px 6px rgba(255,255,255,.2);
      transition:all .2s ease-in-out;
    }
    .btn-3d:hover{transform:translateY(-2px);}
    .btn-login{background:linear-gradient(145deg,#3b82f6,#1e40af);}
    .btn-logout{background:linear-gradient(145deg,#ef4444,#991b1b);}
    .btn-approve{background:linear-gradient(145deg,#22c55e,#15803d);}
    .btn-reject{background:linear-gradient(145deg,#ef4444,#991b1b);}
    .btn-delete{background:linear-gradient(145deg,#3b82f6,#1e40af);}
    .wa-btn{display:inline-block;margin:5px 0;padding:6px 12px;border-radius:8px;background:linear-gradient(145deg,#25d366,#128c7e);color:#fff;text-decoration:none;font-weight:600;box-shadow:2px 2px 6px rgba(0,0,0,.3);}
    .wa-btn:hover{transform:translateY(-2px);}
    .tabs{display:flex;gap:10px;justify-content:center;margin:10px;}
    .tab-btn{padding:8px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:white;background:linear-gradient(145deg,#3b82f6,#2563eb);box-shadow:2px 2px 6px #1e40af,-2px -2px 6px #60a5fa;}
    .tab-btn.active{background:linear-gradient(145deg,#22c55e,#15803d);box-shadow:2px 2px 6px #166534,-2px -2px 6px #4ade80;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:10px;}
    .card{background:#fff;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.1);overflow:hidden;cursor:pointer;transition:.2s;padding:10px;}
    .card:hover{transform:translateY(-4px);}
    .thumb{width:100%;height:180px;object-fit:cover;border-radius:10px;}
    h4{margin:8px 0 4px;}
    .desc{font-size:14px;color:#555;}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;margin:6px 0;}
    .approved{background:#bbf7d0;color:#166534;}
    .rejected{background:#fecaca;color:#991b1b;}
    .pending{background:#fef08a;color:#854d0e;animation:blink 1s infinite;}
    @keyframes blink{50%{opacity:0.5;}}
    form{display:none;flex-direction:column;gap:10px;padding:10px;max-width:500px;margin:10px auto;background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    form input,form select,form textarea{padding:8px;border-radius:6px;border:1px solid #ccc;}
    .pagination{text-align:center;margin:10px;}
    .pagination button{margin:0 5px;}
    @media(max-width:600px){
      .thumb{height:150px;}
      h4{font-size:14px;}
      .desc{font-size:12px;}
    }
  </style>
</head>
<body>
<header>
  <h2>üè° Real Estate</h2>
  <div id="authBtns">
    <button id="loginBtn" class="btn-3d btn-login">Login</button>
    <button id="logoutBtn" class="btn-3d btn-logout" style="display:none;">Logout</button>
  </div>
</header>

<div class="tabs">
  <button id="tabAll" class="tab-btn active">All Posts</button>
  <button id="tabMine" class="tab-btn">My Posts</button>
</div>

<div style="text-align:center;margin:10px;">
  <input id="searchBox" type="text" placeholder="üîç Search address, type..." style="padding:8px;width:60%;max-width:300px;">
  <select id="priceFilter" style="padding:8px;">
    <option value="">Sort by Price</option>
    <option value="low">Low ‚Üí High</option>
    <option value="high">High ‚Üí Low</option>
  </select>
</div>

<div class="grid" id="cards"></div>
<div class="grid" id="myPosts" style="display:none;"></div>
<div class="pagination"><button id="prevBtn">‚¨Ö Prev</button><span id="pageNum"></span><button id="nextBtn">Next ‚û°</button></div>

<form id="postForm">
  <h3>üìù New Property Post</h3>
  <input id="price" placeholder="Price" required>
  <input id="bhk" placeholder="BHK / Size" required>
  <input id="ptype" placeholder="Property Type" required>
  <input id="address" placeholder="Address" required>
  <input id="phone" placeholder="WhatsApp Number" required>
  <select id="posterType" required>
    <option value="">Select Poster Type</option>
    <option>Builder</option>
    <option>Agent</option>
    <option>Owner</option>
  </select>
  <input id="images" type="file" accept="image/*" multiple>
  <button type="submit" class="btn-3d btn-login">Submit Post</button>
</form>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
  authDomain:"property-20d6d.firebaseapp.com",
  databaseURL:"https://property-20d6d-default-rtdb.firebaseio.com",
  projectId:"property-20d6d",
  storageBucket:"property-20d6d.appspot.com",
  messagingSenderId:"916859697394",
  appId:"1:916859697394:web:2a8f9ad2d62f8306dcb86b"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const postForm=document.getElementById('postForm');
const cardsEl=document.getElementById('cards');
const myPostsEl=document.getElementById('myPosts');
const tabAll=document.getElementById('tabAll');
const tabMine=document.getElementById('tabMine');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const pageNum=document.getElementById('pageNum');
const searchBox=document.getElementById('searchBox');
const priceFilter=document.getElementById('priceFilter');

let currentUser=null,isAdmin=false,allPosts=[],activeTab='all',page=1,perPage=10;

loginBtn.onclick=()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    loginBtn.style.display='none';logoutBtn.style.display='inline-block';
    postForm.style.display='flex';
    isAdmin=(user.email==="zarasamajiksevasanstha@gmail.com");
  } else {
    currentUser=null;isAdmin=false;
    loginBtn.style.display='inline-block';logoutBtn.style.display='none';
    postForm.style.display='none';
  }
  renderCards();
});

db.ref('posts').on('value',snap=>{
  allPosts=[];
  snap.forEach(child=>allPosts.push({...child.val(),id:child.key}));
  renderCards();
});

tabAll.onclick=()=>{activeTab='all';tabAll.classList.add('active');tabMine.classList.remove('active');cardsEl.style.display='grid';myPostsEl.style.display='none';renderCards();};
tabMine.onclick=()=>{activeTab='mine';tabMine.classList.add('active');tabAll.classList.remove('active');cardsEl.style.display='none';myPostsEl.style.display='grid';renderCards();};
prevBtn.onclick=()=>{if(page>1){page--;renderCards();}};
nextBtn.onclick=()=>{if(page<Math.ceil(allPosts.length/perPage)){page++;renderCards();}};

searchBox.oninput=()=>renderCards();
priceFilter.onchange=()=>renderCards();

async function uploadImages(files){
  const urls=[];
  for(let i=0;i<Math.min(files.length,5);i++){
    const fd=new FormData();
    fd.append('image',files[i]);
    const r=await fetch("https://api.imgbb.com/1/upload?key=cad1f0dbfbd25346460789376cc2d7d5",{method:"POST",body:fd});
    const j=await r.json();
    if(j.data) urls.push(j.data.url);
  }
  return urls;
}

postForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser)return alert("Login first");
  loginBtn.disabled=true;
  const post={
    price:document.getElementById('price').value,
    bhk:document.getElementById('bhk').value,
    propertyType:document.getElementById('ptype').value,
    address:document.getElementById('address').value,
    posterPhone:document.getElementById('phone').value,
    posterType:document.getElementById('posterType').value,
    posterName:currentUser.displayName,
    posterUid:currentUser.uid,
    status:"pending",
    created:Date.now()
  };
  const files=document.getElementById('images').files;
  if(files.length>0) post.images=await uploadImages(files);
  db.ref('posts').push(post);
  postForm.reset();
  loginBtn.disabled=false;
  alert("Post submitted! Waiting approval.");
};

function renderCards(){
  cardsEl.innerHTML='';myPostsEl.innerHTML='';
  let posts=[...allPosts];

  // search
  const q=searchBox.value.toLowerCase();
  if(q) posts=posts.filter(p=>(p.address||'').toLowerCase().includes(q)||(p.propertyType||'').toLowerCase().includes(q));

  // price sort
  if(priceFilter.value==='low') posts.sort((a,b)=>parseFloat(a.price)-parseFloat(b.price));
  if(priceFilter.value==='high') posts.sort((a,b)=>parseFloat(b.price)-parseFloat(a.price));

  if(activeTab==='all'){
    const start=(page-1)*perPage;
    const paginated=posts.slice(start,start+perPage);
    pageNum.textContent=`Page ${page}/${Math.ceil(posts.length/perPage)||1}`;
    paginated.forEach(p=>{
      if(!isAdmin){
        if(!currentUser && p.status!=='approved')return;
        if(currentUser && p.posterUid!==currentUser.uid && p.status!=='approved')return;
      }
      cardsEl.appendChild(makeCard(p));
    });
  }
  if(activeTab==='mine'&&currentUser){
    const my=allPosts.filter(p=>p.posterUid===currentUser.uid);
    if(my.length===0) myPostsEl.innerHTML='<p>No posts yet.</p>';
    my.forEach(p=>myPostsEl.appendChild(makeCard(p,true)));
  }
}

function makeCard(p,isMine=false){
  const card=document.createElement('div');
  card.className='card';

  const img=document.createElement('img');
  img.className='thumb';
  img.src=(p.images&&p.images[0])||'https://via.placeholder.com/400';
  card.appendChild(img);

  const h=document.createElement('h4');
  h.textContent=`${p.price} ‚Äî ${p.bhk} ${p.propertyType}`;
  card.appendChild(h);

  const d=document.createElement('div');
  d.className='desc';
  d.innerHTML=`üìç ${p.address}<br>üë§ ${p.posterName||''} (${p.posterType||''})`;
  card.appendChild(d);

  const badge=document.createElement('div');
  if(isMine){
    if(p.status==='approved'){badge.className='badge approved';badge.textContent='‚úÖ Approved';}
    else{badge.className='badge rejected';badge.textContent='‚ùå Not Approved';}
  } else {badge.className='badge '+(p.status||'pending');badge.textContent=p.status||'pending';}
  card.appendChild(badge);

  const wa=document.createElement('a');
  wa.className='wa-btn';
  wa.href=`https://wa.me/${(p.posterPhone||'').replace(/\D/g,'')}`;
  wa.target='_blank';
  wa.textContent='WhatsApp';
  card.appendChild(wa);

  if(isAdmin){
    const actions=document.createElement('div');
    const approveBtn=document.createElement('button');
    approveBtn.className='btn-3d btn-approve';
    approveBtn.textContent='Approve';
    approveBtn.onclick=(e)=>{e.stopPropagation();updateStatus(p.id,'approved');};
    const rejectBtn=document.createElement('button');
    rejectBtn.className='btn-3d btn-reject';
    rejectBtn.textContent='Reject';
    rejectBtn.onclick=(e)=>{e.stopPropagation();updateStatus(p.id,'rejected');};
    actions.appendChild(approveBtn);
    actions.appendChild(rejectBtn);
    card.appendChild(actions);
  }

  if(currentUser && currentUser.uid===p.posterUid){
    const del=document.createElement('button');
    del.className='btn-3d btn-delete';
    del.textContent='Delete';
    del.onclick=(e)=>{e.stopPropagation();deletePost(p.id);};
    card.appendChild(del);
  }
  return card;
}

function updateStatus(id,status){db.ref('posts/'+id+'/status').set(status);}
function deletePost(id){if(confirm("Delete this post?"))db.ref('posts/'+id).remove();}
</script>
</body>
</html>
