<!DOCTYPE html>
<html>
<head>
  <title>🛠️ ZaraFix Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 10px; }
    #loginBtn { padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; display: none; }
    #adminContent { display: none; }
    .card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin: 15px 0;
      padding: 20px;
      transition: 0.3s;
    }
    .card:hover { transform: scale(1.03); }
    .btn {
      padding: 8px 14px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .approve { background: #2196F3; color: white; }
    .delete { background: #f44336; color: white; }
    .approved { color: green; font-weight: bold; }
    .pending { color: orange; font-weight: bold; animation: blink 1s infinite; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .searchBox, .sortBox {
      padding: 10px; margin: 5px; width: 45%;
    }
    .center { text-align: center; }
    #pagination { margin-top: 10px; }
    #pagination button {
      margin: 3px;
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background-color: #ddd;
      cursor: pointer;
    }
    #pagination button.active {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <div class="center">
    <button id="loginBtn">🔐 Login with Google</button>
  </div>
  <div id="adminContent">
    <div class="center">
      <input id="search" class="searchBox" type="text" placeholder="🔍 Search by name/category">
      <select id="sortDate" class="sortBox">
        <option value="new">🕒 Newest First</option>
        <option value="old">📅 Oldest First</option>
      </select>
    </div>
    <div id="loader" class="center">⏳ Loading...</div>
    <div id="dataList"></div>
    <div class="center" id="pagination"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "476473209200",
      appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const adminContent = document.getElementById("adminContent");
    const dataList = document.getElementById("dataList");
    const loader = document.getElementById("loader");
    const search = document.getElementById("search");
    const sortDate = document.getElementById("sortDate");
    const pagination = document.getElementById("pagination");

    const ADMIN_UID = "wjbEIAEF5jWgJKb2LlfWoIv4EqO2"; // ✅ your admin UID here

    let allData = [], currentPage = 1, itemsPerPage = 10;

    loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider);
    });

    onAuthStateChanged(auth, user => {
      if (user && user.uid === ADMIN_UID) {
        loginBtn.style.display = "none";
        adminContent.style.display = "block";
        loadData();
      } else if (user) {
        loginBtn.style.display = "none";
        document.body.innerHTML = "<h2 style='color:red;text-align:center;'>❌ Access Denied. Admins Only.</h2>";
      } else {
        loginBtn.style.display = "block";
        adminContent.style.display = "none";
      }
    });

    function loadData() {
      const requestsRef = ref(db, "requests");
      onValue(requestsRef, snap => {
        allData = [];
        snap.forEach(user => {
          user.forEach(req => {
            allData.push({ key: req.key, ...req.val() });
          });
        });
        applyFilters();
      });
    }

    function applyFilters() {
      let filtered = [...allData];
      const query = search.value.toLowerCase();
      if (query) {
        filtered = filtered.filter(d => 
          (d.name || '').toLowerCase().includes(query) ||
          (d.category || '').toLowerCase().includes(query)
        );
      }
      if (sortDate.value === "new") {
        filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      } else {
        filtered.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      }
      renderData(filtered);
    }

    function renderData(data) {
      const start = (currentPage - 1) * itemsPerPage;
      const paginated = data.slice(start, start + itemsPerPage);
      dataList.innerHTML = "";
      loader.style.display = "none";
      paginated.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <b>👤 Name:</b> ${item.name || "N/A"}<br>
          <b>📍 Address:</b> ${item.address || "N/A"}<br>
          <b>📱 WhatsApp:</b> <a href="https://wa.me/${item.whatsapp}" target="_blank">${item.whatsapp}</a><br>
          <b>🔧 Category:</b> ${item.category || "-"} / ${item.subcategory || "-"}<br>
          <b>Status:</b> <span class="${item.approved ? 'approved' : 'pending'}">${item.approved ? 'Approved' : 'Pending'}</span><br>
          <button class="btn approve" onclick="approveReq('${item.key}', '${item.uid}')">Approve</button>
          <button class="btn delete" onclick="deleteReq('${item.key}', '${item.uid}')">Delete</button>
        `;
        dataList.appendChild(card);
      });
      renderPagination(data.length);
    }

    function renderPagination(total) {
      const totalPages = Math.ceil(total / itemsPerPage);
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = i;
          applyFilters();
        };
        pagination.appendChild(btn);
      }
    }

    window.approveReq = (key, uid) => {
      update(ref(db, `requests/${uid}/${key}`), { approved: true });
    };

    window.deleteReq = (key, uid) => {
      if (confirm("Are you sure to delete this request?")) {
        remove(ref(db, `requests/${uid}/${key}`));
      }
    };

    search.addEventListener("input", () => { currentPage = 1; applyFilters(); });
    sortDate.addEventListener("change", () => { currentPage = 1; applyFilters(); });

  </script>
</body>
</html>
