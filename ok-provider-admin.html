<!DOCTYPE html>
<html>
<head>
  <title>🛠️ ZaraFix Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #e9f5ff; margin: 0; padding: 10px; }
    .container { max-width: 1000px; margin: auto; padding: 20px; }
    h2 { text-align: center; color: #0b5394; }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      padding: 15px;
      margin: 15px 0;
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.02); }
    .btn {
      background: #0b5394; color: white; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; margin-top: 10px;
    }
    .btn:hover { background: #073763; }
    .section-title { font-size: 18px; margin-top: 30px; color: #073763; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
<div class="container">
  <h2>📊 ZaraFix Admin Dashboard</h2>

  <div id="admins"></div>
  <div id="posters"></div>
  <div id="requests"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
  authDomain: "zara-fix-2e35a.firebaseapp.com",
  projectId: "zara-fix-2e35a",
  storageBucket: "zara-fix-2e35a.appspot.com",
  messagingSenderId: "636550144008",
  appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase();
const auth = getAuth();

onAuthStateChanged(auth, user => {
  if (user) {
    const uid = user.uid;
    onValue(ref(db, 'admins/' + uid), snap => {
      if (!snap.exists()) {
        document.body.innerHTML = '<h3 style="color:red">Access denied. Admins only.</h3>';
        return;
      }
      loadDashboard();
    });
  } else {
    window.location.href = '/index.html';
  }
});

function loadDashboard() {
  const postersRef = ref(db, 'posters');
  const requestsRef = ref(db, 'requests');

  onValue(postersRef, snap => {
    const posters = snap.val();
    let html = '<h3 class="section-title">👨‍💼 All Service Providers</h3>';
    for (let uid in posters) {
      const p = posters[uid];
      html += `<div class="card">
        <b>🏠 Shop:</b> ${p.shop || ''}<br>
        <b>👤 Name:</b> ${p.name || ''}<br>
        <b>🏡 Address:</b> ${p.address || ''}<br>
        <b>🏫 Category:</b> ${p.category || ''}<br>
        <b>📞 WhatsApp:</b> ${p.whatsapp || ''}<br>
        <b>💳 Wallet:</b> ₹${p.wallet || 0}<br>
        <button class="btn" onclick="recharge('${uid}')">💵 Recharge ₹100</button>
      </div>`;
    }
    document.getElementById('posters').innerHTML = html;
  });

  onValue(requestsRef, snap => {
    const data = snap.val();
    let html = '<h3 class="section-title">📝 Service Requests</h3>';
    for (let userId in data) {
      const userRequests = data[userId];
      for (let reqId in userRequests) {
        const r = userRequests[reqId];
        html += `<div class="card">
          <b>👤 Name:</b> ${r.name}<br>
          <b>📞 WhatsApp:</b> ${r.whatsapp}<br>
          <b>🏠 Address:</b> ${r.address}<br>
          <b>🏫 Category:</b> ${r.category}<br>
          <b>❓ Problem:</b> ${r.problem}<br>
          <b>✅ Accepted By:</b> <pre>${JSON.stringify(r.acceptedBy || {}, null, 2)}</pre>
        </div>`;
      }
    }
    document.getElementById('requests').innerHTML = html;
  });
}

window.recharge = function(uid) {
  update(ref(db, 'posters/' + uid), { wallet: 100 });
  alert("Wallet recharged for UID: " + uid);
};
</script>
</body>
</html>
