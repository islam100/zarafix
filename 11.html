<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZaraFix All Services Listing</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
  body {background: #f0f4f8;}
  .card {transition: transform 0.3s;}
  .card:hover {transform: scale(1.05);}
  .unapproved {background-color: #fee2e2;}
  .approved {background-color: #dcfce7;}
</style>
</head>
<body class="p-4">

<h1 class="text-3xl font-bold text-center mb-4">ZaraFix Services</h1>
<div class="flex justify-center mb-4">
  <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded-xl mr-2">Login with Google</button>
  <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl hidden">Logout</button>
</div>

<div id="providerForm" class="max-w-md mx-auto p-4 bg-white rounded-2xl shadow-lg mb-6 hidden">
  <h2 class="text-xl font-semibold mb-2">Add Service</h2>
  <input type="text" id="serviceName" placeholder="Service Name" class="w-full px-3 py-2 mb-2 rounded-xl border">
  <input type="text" id="contactNumber" placeholder="Contact Number" class="w-full px-3 py-2 mb-2 rounded-xl border">
  <input type="file" id="serviceImage" class="mb-2">
  <textarea id="serviceDesc" placeholder="Description" class="w-full px-3 py-2 mb-2 rounded-xl border"></textarea>
  <button id="submitService" class="bg-green-500 text-white px-4 py-2 rounded-xl w-full">Submit</button>
</div>

<div id="listing" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
  authDomain: "zara-fix-2e35a.firebaseapp.com",
  projectId: "zara-fix-2e35a",
  storageBucket: "zara-fix-2e35a.appspot.com",
  messagingSenderId: "636550144008",
  appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let currentUser = null;
const adminEmail = "zarasamajiksevasanstha@gmail.com";

// Login
document.getElementById('loginBtn').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

document.getElementById('logoutBtn').onclick = () => {
  auth.signOut();
};

auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    document.getElementById('loginBtn').classList.add('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');
    if(user.email === adminEmail){
      document.getElementById('providerForm').classList.add('hidden');
    } else {
      document.getElementById('providerForm').classList.remove('hidden');
    }
    loadListings();
  } else {
    currentUser = null;
    document.getElementById('loginBtn').classList.remove('hidden');
    document.getElementById('logoutBtn').classList.add('hidden');
    document.getElementById('providerForm').classList.add('hidden');
  }
});

// Submit Service
document.getElementById('submitService').onclick = async () => {
  const name = document.getElementById('serviceName').value;
  const contact = document.getElementById('contactNumber').value;
  const desc = document.getElementById('serviceDesc').value;
  const file = document.getElementById('serviceImage').files[0];
  if(!name || !contact || !desc || !file){alert('Fill all fields'); return;}

  const formData = new FormData();
  formData.append('image', file);
  formData.append('key','4dc5e5cb7654ffc308d5ca45452b014b');

  const res = await fetch('https://api.imgbb.com/1/upload',{
    method:'POST',
    body: formData
  });
  const data = await res.json();
  const imgUrl = data.data.url;

  const newRef = db.ref('services').push();
  newRef.set({
    name, contact, desc, imgUrl, approved:false, uid: currentUser.uid, timestamp: Date.now()
  });

  alert('Service submitted for approval');
  document.getElementById('serviceName').value='';
  document.getElementById('contactNumber').value='';
  document.getElementById('serviceDesc').value='';
  document.getElementById('serviceImage').value='';
};

// Load Listings
function loadListings(){
  db.ref('services').orderByChild('timestamp').on('value', snap => {
    const listing = document.getElementById('listing');
    listing.innerHTML='';
    const services = [];
    snap.forEach(child => services.push({key: child.key, ...child.val()}));
    services.reverse(); // newest first

    services.forEach(s => {
      const isAdmin = currentUser.email === adminEmail;
      const isOwner = currentUser.uid === s.uid;
      const card = document.createElement('div');
      card.className = 'card p-3 rounded-2xl shadow-lg ' + (s.approved?'approved':'unapproved');
      card.innerHTML = `
        <img src='${s.imgUrl}' class='rounded-xl mb-2 w-full h-40 object-cover cursor-pointer' onclick="window.open('${s.imgUrl}','_blank')">
        <h3 class='font-semibold text-lg'>${s.name}</h3>
        <p>${s.desc}</p>
        <p class='font-bold'>Contact: ${s.contact}</p>
        <div class='mt-2 flex gap-2'>
          ${isAdmin?`<button onclick='approveService("${s.key}")' class='bg-green-500 text-white px-2 py-1 rounded'>Approve</button>
                     <button onclick='rejectService("${s.key}")' class='bg-red-500 text-white px-2 py-1 rounded'>Reject</button>
                     <button onclick='deleteService("${s.key}")' class='bg-gray-500 text-white px-2 py-1 rounded'>Delete</button>`:''}
          ${isOwner && !isAdmin?`<button onclick='deleteService("${s.key}")' class='bg-gray-500 text-white px-2 py-1 rounded'>Delete</button>`:''}
          <a href='https://wa.me/${s.contact}?text=Zara%20Fix%20ने%20आपको%20customer%20दिया%20है' target='_blank' class='bg-green-600 text-white px-2 py-1 rounded'>WhatsApp</a>
        </div>
        ${!s.approved?'<p class="text-red-600 font-bold mt-1">Not Approved</p>':''}
      `;
      listing.appendChild(card);
    });
  });
}

function approveService(key){
  db.ref('services/'+key).update({approved:true});
}
function rejectService(key){
  db.ref('services/'+key).update({approved:false});
}
function deleteService(key){
  db.ref('services/'+key).remove();
}
</script>
</body>
</html>
