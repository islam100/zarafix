<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #e3f2fd, #ffffff);
      padding: 20px;
    }
    h1 { text-align: center; }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      margin: 20px;
      padding: 20px;
      transition: transform 0.3s;
    }
    .card:hover { transform: scale(1.02); }
    .flex { display: flex; flex-wrap: wrap; justify-content: center; }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      background: #2196F3;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #1976D2; }
    img { max-width: 100px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ ZaraFix - Admin Dashboard</h1>
  <div id="posterList" class="flex"></div>
  <div id="userRequests" class="flex"></div>
  <div id="rechargeRequests" class="flex"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const ADMIN_UID = "wjbEIAEF5jWgJKb2LlfWoIv4EqO2";

    onAuthStateChanged(auth, (user) => {
      if (user && user.uid === ADMIN_UID) {
        loadPosters();
        loadRequests();
        loadRechargeRequests();
      } else {
        alert("Access Denied. Admins only.");
        window.location.href = "index.html";
      }
    });

    function loadPosters() {
      const posterRef = ref(db, "posters");
      get(posterRef).then(snapshot => {
        const posters = snapshot.val();
        for (let uid in posters) {
          const p = posters[uid];
          document.getElementById("posterList").innerHTML += `
            <div class="card">
              <h3>ğŸ‘¤ ${p.name}</h3>
              <p>ğŸ“ ${p.address} | ğŸ› ï¸ ${p.category}</p>
              <p>ğŸª ${p.shopName}</p>
              <p>ğŸ“ ${p.whatsapp}</p>
              <p>ğŸ’° Wallet: â‚¹${p.wallet || 0}</p>
              <p>âœ… Approved: ${p.approved ? 'Yes' : 'No'}</p>
              <button onclick="updateApproval('${uid}', ${!p.approved})">Toggle Approval</button>
              <button onclick="addWallet('${uid}')">Recharge â‚¹100</button>
            </div>
          `;
        }
      });
    }

    function loadRequests() {
      const userRef = ref(db, "requests");
      get(userRef).then(snapshot => {
        const users = snapshot.val();
        for (let uid in users) {
          for (let rid in users[uid]) {
            const r = users[uid][rid];
            document.getElementById("userRequests").innerHTML += `
              <div class="card">
                <h3>ğŸ“‹ ${r.name}</h3>
                <p>âš™ï¸ ${r.problem}</p>
                <p>ğŸ“ ${r.address} - ${r.pincode}</p>
                <p>ğŸ“… ${new Date(r.timestamp).toLocaleString()}</p>
                <p>ğŸ“ ${r.whatsapp}</p>
                <p>âœ… Accepted by: ${r.acceptedBy ? Object.keys(r.acceptedBy).join(", ") : 'None'}</p>
              </div>
            `;
          }
        }
      });
    }

    function loadRechargeRequests() {
      const refReq = ref(db, "rechargeRequests");
      get(refReq).then(snapshot => {
        const reqs = snapshot.val();
        for (let id in reqs) {
          const r = reqs[id];
          document.getElementById("rechargeRequests").innerHTML += `
            <div class="card">
              <p>ğŸ†” ${id}</p>
              <p>ğŸ“· <img src="${r.screenshot}" /></p>
              <p>Status: ${r.status || 'Pending'}</p>
              <button onclick="approveRecharge('${id}', '${r.uid}')">Approve â‚¹100</button>
            </div>
          `;
        }
      });
    }

    window.updateApproval = function(uid, status) {
      update(ref(db, `posters/${uid}`), { approved: status });
      alert("Approval status updated.");
      location.reload();
    }

    window.addWallet = function(uid) {
      const walletRef = ref(db, `posters/${uid}`);
      get(walletRef).then(snapshot => {
        const current = snapshot.val().wallet || 0;
        update(walletRef, { wallet: current + 100 });
        alert("Wallet recharged.");
        location.reload();
      });
    }

    window.approveRecharge = function(rechargeId, uid) {
      const posterRef = ref(db, `posters/${uid}`);
      get(posterRef).then(snapshot => {
        const curr = snapshot.val().wallet || 0;
        update(posterRef, { wallet: curr + 100 });
        update(ref(db, `rechargeRequests/${rechargeId}`), { status: "Approved" });
        alert("Recharge approved.");
        location.reload();
      });
    }
  </script>
</body>
</html>
