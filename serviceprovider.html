<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #f0f8ff, #ffffff);
      margin: 0;
      padding: 20px;
    }
    .form-section, .dashboard-section {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 20px;
    }
    .hidden { display: none; }
    input, select {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      box-shadow: 3px 3px 0px #0056b3;
      font-size: 16px;
    }
    .card {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 15px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    }
    .btn-3d {
      margin-top: 10px;
      display: inline-block;
      background: linear-gradient(145deg, #00c6ff, #0072ff);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 4px 4px 0 #0044cc;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-red {
      background: red;
      box-shadow: 4px 4px 0 darkred;
    }
    .timestamp {
      font-size: 12px;
      color: gray;
    }
  </style>
</head>
<body>
  <div id="posterForm" class="form-section">
    <h2>üß∞ Poster Registration</h2>
    <input id="name" placeholder="Your Name" required />
    <input id="shop" placeholder="Shop Name" required />
    <input id="address" placeholder="Address" required />
    <input id="aadhar" placeholder="Aadhar Number" required />
    <select id="category">
      <option value="">Select Category</option>
      <option>Electrician</option>
      <option>Plumber</option>
      <option>Car Mechanic</option>
      <option>Mobile Repair</option>
    </select>
    <input id="whatsapp" placeholder="WhatsApp Number" required />
    <button class="btn" onclick="submitPosterForm()">Submit</button>
  </div>

  <div id="waitMsg" class="form-section hidden">
    <h3>‚è≥ Please wait for admin approval...</h3>
  </div>

  <div id="posterDashboard" class="dashboard-section hidden">
    <h2>üéØ Your Job Dashboard</h2>
    <div id="walletBalance">Wallet: ‚Çπ0</div>
    <div id="jobsList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userId = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        checkPosterStatus();
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
      }
    });

    function submitPosterForm() {
      const data = {
        name: name.value,
        shop: shop.value,
        address: address.value,
        aadhar: aadhar.value,
        category: category.value,
        whatsapp: whatsapp.value,
        status: "pending",
        wallet: 0,
        timestamp: Date.now()
      };
      db.ref("posters/" + userId).set(data);
      posterForm.classList.add("hidden");
      waitMsg.classList.remove("hidden");
    }

    function checkPosterStatus() {
      db.ref("posters/" + userId).once("value", snap => {
        if (snap.exists()) {
          const poster = snap.val();
          if (poster.status === "approved") {
            loadDashboard(poster);
          } else {
            posterForm.classList.add("hidden");
            waitMsg.classList.remove("hidden");
          }
        }
      });
    }

    function loadDashboard(poster) {
      waitMsg.classList.add("hidden");
      posterForm.classList.add("hidden");
      posterDashboard.classList.remove("hidden");
      document.getElementById("walletBalance").innerText = "Wallet: ‚Çπ" + poster.wallet;

      db.ref("requests").once("value", snap => {
        const allJobs = snap.val();
        jobsList.innerHTML = "";
        for (let userKey in allJobs) {
          for (let jobId in allJobs[userKey]) {
            const job = allJobs[userKey][jobId];
            if (job.category === poster.category) {
              const timeStr = new Date(job.timestamp).toLocaleString();
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <b>${job.name}</b><br>
                üìç ${job.address}<br>
                üîß ${job.problem}<br>
                <div class='timestamp'>üïí ${timeStr}</div>
                <button class="btn-3d" onclick="acceptJob('${userKey}','${jobId}')">Accept</button>
                <button class="btn-3d btn-red" onclick="rejectJob('${userKey}','${jobId}')">Reject</button>
              `;
              jobsList.appendChild(div);
            }
          }
        }
      });
    }

    function acceptJob(userKey, jobId) {
      const jobRef = db.ref(`requests/${userKey}/${jobId}`);
      db.ref(`posters/${userId}`).once("value", snap => {
        const poster = snap.val();
        if (poster.wallet >= 20) {
          jobRef.child("acceptedBy").push({ posterId: userId });
          db.ref(`posters/${userId}/wallet`).set(poster.wallet - 20);
          alert("‚úÖ Job accepted! You can now contact on WhatsApp.");
        } else {
          alert("‚ùå Wallet balance low! Please recharge.");
        }
      });
    }

    function rejectJob(userKey, jobId) {
      db.ref(`requests/${userKey}/${jobId}/rejectedBy`).push({ posterId: userId });
      alert("‚ùå Job rejected.");
    }
  </script>
</body>
</html>
