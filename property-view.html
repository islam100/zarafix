<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Property Listing</title>
<style>
  body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0;}
  header { background:#007bff; color:#fff; padding:15px; text-align:center; }
  button { cursor:pointer; padding:10px 15px; margin:5px; border:none; border-radius:5px; font-weight:bold; }
  #loginBtn { background:#28a745; color:#fff; }
  #logoutBtn { background:#dc3545; color:#fff; display:none; }
  #postBtn { background:#17a2b8; color:#fff; display:none; }
  #adminToggleBtn { background:#ffc107; color:#000; display:none; }
  #propertyList { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:15px; padding:15px; }
  .property-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.15); overflow:hidden; transition:transform 0.3s; cursor:pointer; display:flex; flex-direction: column;}
  .property-card:hover { transform: scale(1.03); }
  .property-image { width:100%; height:180px; object-fit: cover; }
  .property-content { padding:10px; flex-grow: 1; display:flex; flex-direction: column; }
  .property-title { font-size:18px; margin:0 0 8px 0; font-weight:bold; }
  .property-info { font-size:14px; margin:3px 0; color:#555; }
  .btn-group { margin-top:auto; display:flex; gap:10px; }
  .btn-whatsapp { background:#25d366; color:#fff; text-decoration:none; padding:8px 12px; border-radius:6px; text-align:center; flex:1; user-select:none; }
  .btn-delete { background:#dc3545; color:#fff; border:none; padding:8px 12px; border-radius:6px; flex:1; }
  .btn-approve { background:#007bff; color:#fff; border:none; padding:8px 12px; border-radius:6px; flex:1; }
  #uploadSection { display:none; background:#fff; padding:15px; margin:15px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); max-width:500px; }
  #uploadSection input, #uploadSection select, #uploadSection textarea { width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:5px; font-size:14px; }
  #uploadSection button { width:auto; }
  /* Modal */
  #modalOverlay { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  #modalContent { background:#fff; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; position:relative; }
  #modalClose { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>Property Listing</h1>
  <button id="loginBtn">Google Login</button>
  <button id="logoutBtn">Logout</button>
  <button id="postBtn">Post Property</button>
</header>

<section id="uploadSection">
  <h2>Post New Property</h2>
  <input type="text" id="title" placeholder="Title (e.g. 2 BHK Flat)" required />
  <input type="text" id="city" placeholder="City" required />
  <select id="type">
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <input type="number" id="price" placeholder="Price (in ₹)" required />
  <textarea id="desc" rows="3" placeholder="Description"></textarea>
  <input type="file" id="imageFile" accept="image/*" required />
  <div>
    <button id="submitPost">Submit</button>
    <button id="cancelPost">Cancel</button>
  </div>
  <p id="uploadStatus"></p>
</section>

<section id="propertyList"></section>

<!-- Modal -->
<div id="modalOverlay">
  <div id="modalContent">
    <span id="modalClose">&times;</span>
    <img id="modalImage" src="" alt="Property Image" style="width:100%;border-radius:10px;margin-bottom:10px;" />
    <h3 id="modalTitle"></h3>
    <p id="modalCity"></p>
    <p id="modalType"></p>
    <p id="modalPrice"></p>
    <p id="modalDesc"></p>
    <a href="#" target="_blank" id="modalWhatsapp" class="btn-whatsapp" style="display:inline-block;margin-top:10px;">WhatsApp</a>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  const adminEmail = "zarasamajiksevasanstha@gmail.com";
  const adminWhatsapp = "917378342192";

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const postBtn = document.getElementById("postBtn");
  const uploadSection = document.getElementById("uploadSection");
  const submitPost = document.getElementById("submitPost");
  const cancelPost = document.getElementById("cancelPost");
  const uploadStatus = document.getElementById("uploadStatus");
  const propertyList = document.getElementById("propertyList");

  const modalOverlay = document.getElementById("modalOverlay");
  const modalClose = document.getElementById("modalClose");
  const modalImage = document.getElementById("modalImage");
  const modalTitle = document.getElementById("modalTitle");
  const modalCity = document.getElementById("modalCity");
  const modalType = document.getElementById("modalType");
  const modalPrice = document.getElementById("modalPrice");
  const modalDesc = document.getElementById("modalDesc");
  const modalWhatsapp = document.getElementById("modalWhatsapp");

  let currentUser = null;
  let isAdmin = false;

  function formatPrice(num) {
    if(!num) return "N/A";
    return "₹" + Number(num).toLocaleString("en-IN");
  }

  function createWhatsappLink(number, property) {
    const msg = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\n\nTitle: ${property.title}\nCity: ${property.city}\nPrice: ${formatPrice(property.price)}`;
    return `https://wa.me/${number}?text=${encodeURIComponent(msg)}`;
  }

  // Render properties
  function renderProperties(properties) {
    propertyList.innerHTML = "";
    if(properties.length === 0) {
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी उपलब्ध नहीं है।</p>";
      return;
    }
    properties.forEach(({ key, data }) => {
      const isOwner = currentUser && currentUser.uid === data.userId;
      // Admin को Poster का नंबर दिखाएं, बाकी को admin का नंबर
      const showWhatsapp = isAdmin ? (data.whatsapp || adminWhatsapp) : adminWhatsapp;

      const card = document.createElement("div");
      card.className = "property-card";

      card.innerHTML = `
        <img src="${data.imageUrl}" alt="Property Image" class="property-image" />
        <div class="property-content">
          <h3 class="property-title">${data.title}</h3>
          <p class="property-info"><b>City:</b> ${data.city}</p>
          <p class="property-info"><b>Type:</b> ${data.type === 'sale' ? 'Buy' : 'Rent'}</p>
          <p class="property-info"><b>Price:</b> ${formatPrice(data.price)}</p>
          <p class="property-info">${data.description || ''}</p>
          <div class="btn-group">
            <a href="${createWhatsappLink(showWhatsapp, data)}" target="_blank" class="btn-whatsapp">WhatsApp</a>
            ${ (isAdmin || isOwner) ? `<button class="btn-delete">Delete</button>` : `` }
            ${ (isAdmin && !data.approved) ? `<button class="btn-approve">Approve</button>` : `` }
          </div>
        </div>
      `;

      // कार्ड क्लिक पर मोडल खुलेगा
      card.addEventListener("click", (e) => {
        if(e.target.tagName.toLowerCase() === "button" || e.target.tagName.toLowerCase() === "a") return;
        modalImage.src = data.imageUrl;
        modalTitle.textContent = data.title;
        modalCity.textContent = `City: ${data.city}`;
        modalType.textContent = `Type: ${data.type === 'sale' ? 'Buy' : 'Rent'}`;
        modalPrice.textContent = `Price: ${formatPrice(data.price)}`;
        modalDesc.textContent = data.description || '';
        modalWhatsapp.href = createWhatsappLink(showWhatsapp, data);
        modalOverlay.style.display = "flex";
      });

      // डिलीट बटन
      const delBtn = card.querySelector(".btn-delete");
      if(delBtn) {
        delBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if(confirm("क्या आप इस प्रॉपर्टी को हटाना चाहते हैं?")) {
            db.ref(`properties/${key}`).remove()
              .then(() => alert("प्रॉपर्टी हटाई गई"))
              .catch(err => alert("Error: " + err.message));
          }
        });
      }

      // अप्रूव बटन
      const approveBtn = card.querySelector(".btn-approve");
      if(approveBtn) {
        approveBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          db.ref(`properties/${key}`).update({approved: true})
            .then(() => alert("प्रॉपर्टी अप्रूव हो गई!"))
            .catch(err => alert("Error: " + err.message));
        });
      }

      propertyList.appendChild(card);
    });
  }

  // प्रॉपर्टी लोड करें
  function loadProperties() {
    db.ref("properties").once("value").then(snapshot => {
      const props = [];
      snapshot.forEach(childSnap => {
        const data = childSnap.val();
        // केवल अप्रूव्ड या owner की प्रॉपर्टी दिखाएं
        if(data.approved || (currentUser && currentUser.uid === data.userId)) {
          props.push({ key: childSnap.key, data });
        }
      });
      renderProperties(props);
    });
  }

  // इमेज अपलोड
  function uploadImage(file) {
    return new Promise((resolve, reject) => {
      const storageRef = storage.ref('property_images/' + Date.now() + '_' + file.name);
      const uploadTask = storageRef.put(file);
      uploadTask.on('state_changed',
        null,
        error => reject(error),
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
            resolve(downloadURL);
          });
        }
      );
    });
  }

  // साफ करें फॉर्म
  function clearForm() {
    document.getElementById("title").value = "";
    document.getElementById("city").value = "";
    document.getElementById("type").value = "sale";
    document.getElementById("price").value = "";
    document.getElementById("desc").value = "";
    document.getElementById("imageFile").value = "";
    uploadStatus.textContent = "";
    submitPost.disabled = false;
  }

  // ऑथ चेंज को हैंडल करें
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user){
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      postBtn.style.display = "inline-block";
      isAdmin = (user.email === adminEmail);
      loadProperties();
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      postBtn.style.display = "none";
      isAdmin = false;
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कृपया लॉगिन करें।</p>";
      uploadSection.style.display = "none";
    }
  });

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert("Login failed: " + err.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  postBtn.onclick = () => {
    uploadSection.style.display = "block";
  };

  cancelPost.onclick = () => {
    clearForm();
    uploadSection.style.display = "none";
  };

  submitPost.onclick = async () => {
    const title = document.getElementById("title").value.trim();
    const city = document.getElementById("city").value.trim();
    const type = document.getElementById("type").value;
    const price = parseInt(document.getElementById("price").value.trim());
    const desc = document.getElementById("desc").value.trim();
    const imageFile = document.getElementById("imageFile").files[0];

    if(!title || !city || !price || !imageFile) {
      alert("सभी आवश्यक फ़ील्ड भरें और इमेज चुनें।");
      return;
    }

    submitPost.disabled = true;
    uploadStatus.textContent = "Uploading image...";

    try {
      const imageUrl = await uploadImage(imageFile);
      const newPropRef = db.ref("properties").push();
      await newPropRef.set({
        title,
        city,
        type,
        price,
        description: desc,
        imageUrl,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        whatsapp: adminWhatsapp,
        approved: false,
        timestamp: Date.now()
      });
      uploadStatus.textContent = "Property posted! Admin approval pending.";
      clearForm();
      uploadSection.style.display = "none";
      loadProperties();
    } catch(err) {
      alert("Error: " + err.message);
      submitPost.disabled = false;
      uploadStatus.textContent = "";
    }
  };

  // Modal close logic
  modalClose.onclick = () => { modalOverlay.style.display = "none"; };
  modalOverlay.onclick = e => { if(e.target === modalOverlay) modalOverlay.style.display = "none"; };

</script>

</body>
</html>
