<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property — Admin + User</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  /* बेसिक और 3D बटन स्टाइल्स (पहले जैसा) */
  /* ... */
</style>
</head>
<body>

<header>
  <h1>Zara Property</h1>
  <div id="btnGroup">
    <button id="loginBtn">Google Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <button id="postBtn" style="display:none;">Post Property</button>
    <button id="adminToggleBtn" style="display:none;">Show Admin Panel</button>
  </div>
</header>

<section id="uploadSection" style="display:none;">
  <!-- पोस्टिंग फॉर्म -->
  <!-- ... -->
</section>

<section id="searchSection">
  <input type="text" id="searchInput" placeholder="Search by title or city..." />
  <select id="filterType">
    <option value="">All types</option>
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <button id="searchBtn">Search</button>
</section>

<section id="propertyList">
  <!-- प्रॉपर्टी कार्ड्स यहाँ दिखेंगे -->
</section>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script>
  // Firebase config (आपका कॉन्फिग यहाँ)
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const imgbbApiKey = "52759d17d6011826df915af26466a7ea";
  const adminEmail = "zarasamajiksevasanstha@gmail.com";
  const whatsappPhone = "917378342192";

  // DOM Elements
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const postBtn = document.getElementById('postBtn');
  const adminToggleBtn = document.getElementById('adminToggleBtn');
  const uploadSection = document.getElementById('uploadSection');
  const submitPost = document.getElementById('submitPost');
  const cancelPost = document.getElementById('cancelPost');
  const uploadStatus = document.getElementById('uploadStatus');
  const propertyList = document.getElementById('propertyList');
  const searchInput = document.getElementById('searchInput');
  const filterType = document.getElementById('filterType');
  const searchBtn = document.getElementById('searchBtn');

  let currentUser = null;
  let isAdmin = false;
  let showAdminPanel = false;

  // Safe formatPrice function
  function formatPrice(num) {
    if (num === undefined || num === null) return "N/A";
    const n = Number(num);
    if (isNaN(n)) return "N/A";
    return n.toLocaleString('en-IN');
  }

  // WhatsApp लिंक बनाए (सभी कार्ड्स के लिए, admin या user कोई फर्क नहीं)
  function whatsappLink(post, key){
    const msg = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\n\nTitle: ${post.title}\nCity: ${post.city}\nPrice: ₹${formatPrice(post.price)}\n\nLink: ${window.location.origin + window.location.pathname}#property=${key}`;
    return `https://wa.me/${whatsappPhone}?text=${encodeURIComponent(msg)}`;
  }

  // प्रॉपर्टी रेंडर करें
  function renderProperties(posts){
    propertyList.innerHTML = "";
    if(posts.length === 0){
      propertyList.innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>";
      return;
    }

    posts.forEach(({key, post}) => {
      const card = document.createElement('div');
      card.className = "property-card";

      const img = document.createElement('img');
      img.src = post.imageUrl;
      img.alt = post.title || "Property Image";
      card.appendChild(img);

      const content = document.createElement('div');
      content.className = "property-content";

      const title = document.createElement('h3');
      title.textContent = post.title || "No Title";
      content.appendChild(title);

      const city = document.createElement('p');
      city.textContent = `City: ${post.city || "N/A"}`;
      content.appendChild(city);

      const type = document.createElement('p');
      type.textContent = `Type: ${post.type === "sale" ? "Buy" : (post.type === "rent" ? "Rent" : "N/A")}`;
      content.appendChild(type);

      const price = document.createElement('p');
      price.textContent = `Price: ₹${formatPrice(post.price)}`;
      content.appendChild(price);

      const desc = document.createElement('p');
      desc.textContent = post.description || "No Description";
      content.appendChild(desc);

      const btnGroup = document.createElement('div');
      btnGroup.className = "btn-group";

      // WhatsApp button सभी को दिखे
      const waBtn = document.createElement('a');
      waBtn.href = whatsappLink(post, key);
      waBtn.target = "_blank";
      waBtn.textContent = "WhatsApp";
      waBtn.style.backgroundColor = "#25d366";
      waBtn.style.color = "white";
      waBtn.style.padding = "8px 12px";
      waBtn.style.borderRadius = "6px";
      waBtn.style.textDecoration = "none";
      waBtn.style.userSelect = "none";
      btnGroup.appendChild(waBtn);

      // Delete button: केवल admin या पोस्ट का मालिक देखे
      if(isAdmin || (currentUser && currentUser.uid === post.userId)){
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.style.backgroundColor = "#dc3545";
        delBtn.style.color = "white";
        delBtn.style.border = "none";
        delBtn.style.padding = "8px 12px";
        delBtn.style.borderRadius = "6px";
        delBtn.style.cursor = "pointer";
        delBtn.style.userSelect = "none";
        delBtn.onclick = () => {
          if(confirm("क्या आप इस प्रॉपर्टी को हटाना चाहते हैं?")){
            db.ref('properties/' + key).remove()
              .catch(err => alert("Delete failed: " + err.message));
          }
        };
        btnGroup.appendChild(delBtn);
      }

      // Approve button: admin के लिए और अगर approved नहीं है
      if(isAdmin && !post.approved){
        const approveBtn = document.createElement('button');
        approveBtn.textContent = "Approve";
        approveBtn.style.backgroundColor = "#007bff";
        approveBtn.style.color = "white";
        approveBtn.style.border = "none";
        approveBtn.style.padding = "8px 12px";
        approveBtn.style.borderRadius = "6px";
        approveBtn.style.cursor = "pointer";
        approveBtn.style.marginLeft = "10px";
        approveBtn.style.userSelect = "none";
        approveBtn.onclick = () => {
          db.ref('properties/' + key).update({approved: true})
            .catch(err => alert("Approve failed: " + err.message));
        };
        btnGroup.appendChild(approveBtn);
      }

      content.appendChild(btnGroup);
      card.appendChild(content);
      propertyList.appendChild(card);
    });
  }

  // Firebase से प्रॉपर्टीज़ लोड करें
  function loadProperties(){
    db.ref('properties').on('value', snapshot => {
      const data = snapshot.val();
      if(!data) {
        renderProperties([]);
        return;
      }
      let posts = Object.entries(data).map(([key, post]) => ({key, post}));

      // 30 दिन से पुराने पोस्ट हटा दें
      posts.forEach(({key, post}) => {
        if(Date.now() - post.timestamp > 30*24*60*60*1000){
          db.ref('properties/' + key).remove();
        }
      });

      // फिल्टरिंग लॉजिक
      posts = posts.filter(({post}) => {
        // अगर admin और admin panel खुला है तो सब दिखाओ
        if(isAdmin && showAdminPanel) return true;

        // अन्यथा केवल approved पोस्ट या खुद के पोस्ट दिखाओ
        if(!post.approved && !(currentUser && post.userId === currentUser.uid)) return false;

        return true;
      });

      // सर्च और टाइप फिल्टर
      const q = searchInput.value.trim().toLowerCase();
      const typeFilter = filterType.value;

      posts = posts.filter(({post}) => {
        if(q && !(post.title?.toLowerCase().includes(q) || post.city?.toLowerCase().includes(q))) return false;
        if(typeFilter && post.type !== typeFilter) return false;
        return true;
      });

      renderProperties(posts);
    });
  }

  // ऑथ स्टेट चेंज हैंडलर
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user){
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      postBtn.style.display = "inline-block";

      isAdmin = (user.email === adminEmail);
      adminToggleBtn.style.display = isAdmin ? "inline-block" : "none";

      if(isAdmin){
        adminToggleBtn.textContent = showAdminPanel ? "Hide Admin Panel" : "Show Admin Panel";
        alert("आप Admin के रूप में लॉगिन हैं।");
      } else {
        showAdminPanel = false;
      }
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      postBtn.style.display = "none";
      uploadSection.style.display = "none";
      adminToggleBtn.style.display = "none";

      isAdmin = false;
      showAdminPanel = false;
    }
    loadProperties();
  });

  // बटन इवेंट्स
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert("Login failed: " + err.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  postBtn.onclick = () => {
    uploadSection.style.display = 'block';
  };

  cancelPost.onclick = () => {
    uploadSection.style.display = 'none';
    clearForm();
  };

  searchBtn.onclick = loadProperties;
  searchInput.onkeyup = e => { if(e.key === "Enter") loadProperties(); };
  filterType.onchange = loadProperties;

  // फॉर्म क्लियर फंक्शन
  function clearForm(){
    document.getElementById('title').value = "";
    document.getElementById('city').value = "";
    document.getElementById('type').value = "sale";
    document.getElementById('price').value = "";
    document.getElementById('desc').value = "";
    document.getElementById('imageFile').value = "";
    uploadStatus.textContent = "";
    submitPost.disabled = false;
  }

  // इमेज अपलोडिंग
  async function uploadImageToImgbb(file){
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if(data.success){
      return data.data.url;
    } else {
      throw new Error("Image upload failed");
    }
  }

  // प्रॉपर्टी पोस्ट करें
  submitPost.onclick = async () => {
    const title = document.getElementById('title').value.trim();
    const city = document.getElementById('city').value.trim();
    const type = document.getElementById('type').value;
    const price = document.getElementById('price').value.trim();
    const description = document.getElementById('desc').value.trim();
    const imageFile = document.getElementById('imageFile').files[0];

    if(!title || !city || !price || !imageFile){
      alert("कृपया आवश्यक सभी फील्ड भरें और इमेज चुनें।");
      return;
    }

    submitPost.disabled = true;
    uploadStatus.textContent = "Uploading image...";

    try {
      const imageUrl = await uploadImageToImgbb(imageFile);

      const postData = {
        title,
        city,
        type,
        price: Number(price),
        description,
        imageUrl,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: Date.now(),
        approved: false
      };

      await db.ref('properties').push(postData);

      uploadStatus.textContent = "Property posted successfully! Admin approval needed.";
      clearForm();
      uploadSection.style.display = 'none';
      loadProperties();

    } catch(err){
      alert("Error: " + err.message);
      submitPost.disabled = false;
      uploadStatus.textContent = "";
    }
  };

  // Admin panel टॉगल
  adminToggleBtn.onclick = () => {
    showAdminPanel = !showAdminPanel;
    adminToggleBtn.textContent = showAdminPanel ? "Hide Admin Panel" : "Show Admin Panel";
    loadProperties();
  };

  // पेज लोड पर प्रॉपर्टी लोड करें
  window.onload = loadProperties;

</script>

</body>
</html>
