<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property - Upload & List</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:20px; }
  header { text-align:center; margin-bottom:20px; }
  #propertyList { display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
  .card { background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15); overflow:hidden; }
  .card img { width:100%; height:180px; object-fit:cover; }
  .card-content { padding:15px; }
  .card-content h3 { margin:0 0 10px; }
  .btn { display:inline-block; padding:8px 14px; border:none; border-radius:5px; cursor:pointer; user-select:none; text-decoration:none; }
  .btn-whatsapp { background:#25D366; color:#fff; }
  .btn-delete { background:#dc3545; color:#fff; margin-left:10px; }
  form { max-width:400px; margin:0 auto 30px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  form input, form textarea, form select { width:100%; margin-bottom:15px; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:4px; }
  form label { font-weight:bold; margin-bottom:5px; display:block; }
  #loginBtn, #logoutBtn { margin-bottom:20px; cursor:pointer; padding:10px 20px; border:none; border-radius:5px; }
  #loginBtn { background:#4285F4; color:#fff; }
  #logoutBtn { background:#555; color:#fff; display:none; }
  #uploadStatus { text-align:center; margin-bottom:15px; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>Zara Property</h1>
  <button id="loginBtn">Google Login</button>
  <button id="logoutBtn">Logout</button>
</header>

<form id="postForm" style="display:none;">
  <div id="uploadStatus"></div>
  <label for="title">Title *</label>
  <input type="text" id="title" required />
  <label for="city">City *</label>
  <input type="text" id="city" required />
  <label for="type">Type *</label>
  <select id="type" required>
    <option value="sale">Buy</option>
    <option value="rent">Rent</option>
  </select>
  <label for="price">Price (Number) *</label>
  <input type="number" id="price" required />
  <label for="desc">Description</label>
  <textarea id="desc"></textarea>
  <label for="imageFile">Image *</label>
  <input type="file" id="imageFile" accept="image/*" required />
  <button type="submit">Post Property</button>
</form>

<div id="propertyList"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  // Firebase config यहाँ लगाएं
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Admin details
  const adminEmail = "admin@example.com"; // अपना admin email यहाँ डालें
  const adminWhatsapp = "919876543210";   // admin का WhatsApp नंबर

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const postForm = document.getElementById('postForm');
  const uploadStatus = document.getElementById('uploadStatus');
  const propertyList = document.getElementById('propertyList');

  let currentUser = null;
  let isAdmin = false;

  // Google Login
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert(e.message));
  };

  // Logout
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // On auth state change
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user){
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      postForm.style.display = 'block';
      isAdmin = (user.email === adminEmail);
    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      postForm.style.display = 'none';
      isAdmin = false;
    }
    loadProperties();
  });

  // Image upload function
  function uploadImage(file) {
    return new Promise((resolve, reject) => {
      const fileName = Date.now() + '_' + file.name;
      const storageRef = storage.ref('property_images/' + fileName);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          uploadStatus.textContent = 'Uploading Image: ' + progress.toFixed(0) + '%';
        },
        error => {
          uploadStatus.textContent = '';
          reject(error);
        },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
            uploadStatus.textContent = '';
            resolve(downloadURL);
          });
        }
      );
    });
  }

  // Form submit handler
  postForm.onsubmit = async (e) => {
    e.preventDefault();

    if(!currentUser){
      alert("Please login first!");
      return;
    }

    const title = document.getElementById('title').value.trim();
    const city = document.getElementById('city').value.trim();
    const type = document.getElementById('type').value;
    const price = Number(document.getElementById('price').value);
    const desc = document.getElementById('desc').value.trim();
    const imageFile = document.getElementById('imageFile').files[0];

    if(!title || !city || !type || !price || !imageFile){
      alert("Please fill all required fields and select an image.");
      return;
    }

    try {
      const imageUrl = await uploadImage(imageFile);

      const newPost = {
        title,
        city,
        type,
        price,
        description: desc,
        imageUrl,
        whatsapp: currentUser.email === adminEmail ? adminWhatsapp : "", // खाली रखें, DB में बचाएंगे
        userId: currentUser.uid,
        userEmail: currentUser.email,
        approved: true,  // आप चाहें तो admin approval जोड़ सकते हैं
        timestamp: Date.now()
      };

      await db.ref('properties').push(newPost);

      alert("Property posted successfully!");
      postForm.reset();
      loadProperties();

    } catch (error) {
      alert("Error uploading image: " + error.message);
    }
  };

  // WhatsApp लिंक जनरेशन
  function getWhatsappLink(post) {
    // admin को पोस्टर का नंबर दिखाएं, बाकी को admin का नंबर
    if(currentUser && currentUser.email === adminEmail && post.userEmail !== adminEmail && post.whatsapp){
      return `https://wa.me/${post.whatsapp}?text=${encodeURIComponent(`नमस्ते, मैं आपकी प्रॉपर्टी "${post.title}" के बारे में जानना चाहता हूँ।`)}`;
    } else {
      return `https://wa.me/${adminWhatsapp}?text=${encodeURIComponent(`नमस्ते, मैं प्रॉपर्टी "${post.title}" के बारे में जानना चाहता हूँ।`)}`;
    }
  }

  // प्रॉपर्टी लोड और दिखाएं
  function loadProperties() {
    propertyList.innerHTML = "Loading properties...";
    db.ref('properties').orderByChild('approved').equalTo(true).on('value', snapshot => {
      propertyList.innerHTML = '';
      if(!snapshot.exists()){
        propertyList.innerHTML = "<p style='text-align:center'>कोई प्रॉपर्टी नहीं मिली।</p>";
        return;
      }

      snapshot.forEach(childSnapshot => {
        const post = childSnapshot.val();

        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.src = post.imageUrl;
        img.alt = post.title;
        card.appendChild(img);

        const content = document.createElement('div');
        content.className = 'card-content';

        const title = document.createElement('h3');
        title.textContent = post.title;
        content.appendChild(title);

        const city = document.createElement('p');
        city.textContent = `City: ${post.city}`;
        content.appendChild(city);

        const type = document.createElement('p');
        type.textContent = `Type: ${post.type === "sale" ? "Buy" : "Rent"}`;
        content.appendChild(type);

        const price = document.createElement('p');
        price.textContent = `Price: ₹${post.price.toLocaleString('en-IN')}`;
        content.appendChild(price);

        if(post.description){
          const desc = document.createElement('p');
          desc.textContent = post.description;
          content.appendChild(desc);
        }

        const waBtn = document.createElement('a');
        waBtn.href = getWhatsappLink(post);
        waBtn.target = "_blank";
        waBtn.textContent = "WhatsApp";
        waBtn.className = 'btn btn-whatsapp';
        content.appendChild(waBtn);

        card.appendChild(content);
        propertyList.appendChild(card);
      });
    });
  }

</script>

</body>
</html>
