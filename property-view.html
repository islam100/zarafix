<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Property - Free Secure App</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<style>
  body {
    font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; display:flex; flex-direction:column; min-height:100vh;
  }
  header {
    background:#004aad; color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center;
  }
  header h1 { margin:0; font-size:1.6rem; }
  button {
    background: linear-gradient(145deg, #1c60d9, #004aad);
    border:none; border-radius:8px; color:#fff; padding:8px 16px; cursor:pointer; box-shadow: 3px 3px 6px #003580, -3px -3px 6px #0056d4;
    transition: box-shadow 0.2s ease;
    user-select:none;
  }
  button:active {
    box-shadow: inset 3px 3px 6px #003580, inset -3px -3px 6px #0056d4;
  }
  button:disabled {
    background: #888; cursor:not-allowed; box-shadow:none;
  }
  main {
    flex-grow:1;
    padding:20px;
    max-width:900px;
    margin: auto;
  }
  #loginBtn, #logoutBtn, #postBtn, #adminToggleBtn {
    margin-left:10px;
  }
  #propertyList {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap:16px;
  }
  .property-card {
    background:white; border-radius:12px; box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
    cursor:pointer; display:flex; flex-direction:column;
    transition: transform 0.2s ease;
  }
  .property-card:hover {
    transform: scale(1.02);
  }
  .property-card img {
    width:100%; height:180px; object-fit:cover; border-top-left-radius:12px; border-top-right-radius:12px;
  }
  .property-info {
    padding:12px 16px; flex-grow:1; display:flex; flex-direction: column;
  }
  .property-info h3 {
    margin:0 0 8px 0; color:#004aad;
  }
  .property-info p {
    margin: 4px 0;
    flex-grow:0;
  }
  .btn-group {
    margin-top:auto;
    display:flex; gap:8px;
  }
  .btn-group a, .btn-group button {
    flex:1;
    text-align:center;
    padding:8px 0;
    border-radius: 6px;
    font-weight:600;
    color:white;
    text-decoration:none;
    user-select:none;
  }
  .btn-whatsapp {
    background:#25d366;
  }
  .btn-delete {
    background:#dc3545;
  }
  .btn-approve {
    background:#007bff;
  }
  /* Modal Styles */
  #detailModal {
    display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    justify-content:center; align-items:center;
    z-index:9999;
  }
  #detailContent {
    background:#fff; border-radius:12px; max-width:600px; width:90%;
    max-height:80vh; overflow-y:auto; padding:20px; position:relative;
  }
  #detailContent img {
    width:100%; height:300px; object-fit:cover; border-radius: 12px;
  }
  #detailContent h2 {
    margin-top: 12px;
  }
  #closeModal {
    position:absolute; top:12px; right:12px;
    background:#dc3545; border:none; color:#fff;
    border-radius:50%; width:32px; height:32px;
    font-weight:bold; cursor:pointer;
  }

  /* Responsive */
  @media(max-width:600px) {
    .property-card img {
      height:140px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Zara Property</h1>
  <div>
    <button id="loginBtn">Google Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <button id="postBtn" style="display:none;">Post Property</button>
    <button id="adminToggleBtn" style="display:none;">Show Admin Panel</button>
  </div>
</header>

<main>
  <section id="postSection" style="display:none; margin-bottom:20px; background:#fff; padding:20px; border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 450px;">
    <h2>नई प्रॉपर्टी पोस्ट करें</h2>
    <input type="text" id="title" placeholder="शीर्षक" /><br/>
    <input type="text" id="city" placeholder="शहर" /><br/>
    <select id="type">
      <option value="sale">खरीदें</option>
      <option value="rent">किराए पर</option>
    </select><br/>
    <input type="number" id="price" placeholder="कीमत (₹)" min="1" /><br/>
    <textarea id="description" placeholder="विवरण"></textarea><br/>
    <input type="file" id="imageFile" accept="image/*" /><br/>
    <button id="submitPost">पोस्ट करें</button>
    <button id="cancelPost">रद्द करें</button>
    <p id="postStatus" style="color:red;"></p>
  </section>

  <section>
    <input type="text" id="searchInput" placeholder="शहर या शीर्षक से खोजें..." style="width:100%; max-width: 400px; padding:8px; border-radius:8px; border:1px solid #ccc; margin-bottom:16px;" />
  </section>

  <section id="propertyList">
    <!-- प्रॉपर्टी कार्ड यहाँ लोड होंगे -->
  </section>
</main>

<!-- Detail Modal -->
<div id="detailModal">
  <div id="detailContent">
    <button id="closeModal">×</button>
    <img src="" alt="Property Image" id="modalImage" />
    <h2 id="modalTitle"></h2>
    <p id="modalCity"></p>
    <p id="modalType"></p>
    <p id="modalPrice"></p>
    <p id="modalDescription"></p>
  </div>
</div>

<script>
  // Firebase config - अपनी Firebase config डालें यहाँ
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Admin UID - Firebase Authentication में admin user का UID डालें
  const adminUID = "ADMIN_USER_UID";  // इसे अपने admin uid से बदलें

  // WhatsApp नंबर
  const whatsappNumber = "917378342192";

  // DOM Elements
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const postBtn = document.getElementById("postBtn");
  const adminToggleBtn = document.getElementById("adminToggleBtn");
  const postSection = document.getElementById("postSection");
  const submitPost = document.getElementById("submitPost");
  const cancelPost = document.getElementById("cancelPost");
  const postStatus = document.getElementById("postStatus");
  const propertyList = document.getElementById("propertyList");
  const searchInput = document.getElementById("searchInput");

  // Modal elements
  const detailModal = document.getElementById("detailModal");
  const closeModal = document.getElementById("closeModal");
  const modalImage = document.getElementById("modalImage");
  const modalTitle = document.getElementById("modalTitle");
  const modalCity = document.getElementById("modalCity");
  const modalType = document.getElementById("modalType");
  const modalPrice = document.getElementById("modalPrice");
  const modalDescription = document.getElementById("modalDescription");

  let currentUser = null;
  let isAdmin = false;
  let showAdminPanel = false;

  // Login
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert("Login failed: " + e.message));
  };

  // Logout
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // Show post form
  postBtn.onclick = () => {
    postSection.style.display = "block";
  };

  // Cancel post
  cancelPost.onclick = () => {
    clearForm();
    postSection.style.display = "none";
  };

  // Clear form fields
  function clearForm() {
    document.getElementById("title").value = "";
    document.getElementById("city").value = "";
    document.getElementById("type").value = "sale";
    document.getElementById("price").value = "";
    document.getElementById("description").value = "";
    document.getElementById("imageFile").value = "";
    postStatus.textContent = "";
  }

  // Upload image to Firebase Storage and return URL
  async function uploadImage(file) {
    const storageRef = storage.ref();
    const fileRef = storageRef.child(`property_images/${Date.now()}_${file.name}`);
    await fileRef.put(file);
    return await fileRef.getDownloadURL();
  }

  // Format price to Indian format
  function formatPrice(n) {
    return n.toLocaleString('en-IN');
  }

  // Create WhatsApp message link
  function createWhatsAppLink(postKey, post) {
    const text = `नमस्ते, मैं इस प्रॉपर्टी के बारे में जानना चाहता हूँ:\nशीर्षक: ${post.title}\nशहर: ${post.city}\nकीमत: ₹${formatPrice(post.price)}\n\nयह लिंक देखें: ${window.location.href}#property=${postKey}`;
    return `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(text)}`;
  }

  // Render properties list
  function renderProperties(properties) {
    propertyList.innerHTML = "";
    if (!properties.length) {
      propertyList.innerHTML = "<p style='text-align:center; color:#666;'>कोई प्रॉपर्टी नहीं मिली।</p>";
      return;
    }
    properties.forEach(({ key, post }) => {
      const card = document.createElement("div");
      card.className = "property-card";

      card.onclick = () => showDetailModal(key, post);

      const img = document.createElement("img");
      img.src = post.imageUrl;
      img.alt = post.title;

      const info = document.createElement("div");
      info.className = "property-info";

      const h3 = document.createElement("h3");
      h3.textContent = post.title;

      const cityP = document.createElement("p");
      cityP.textContent = `शहर: ${post.city}`;

      const typeP = document.createElement("p");
      typeP.textContent = `प्रकार: ${post.type === "sale" ? "खरीदें" : "किराए पर"}`;

      const priceP = document.createElement("p");
      priceP.textContent = `कीमत: ₹${formatPrice(post.price)}`;

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group";

      // WhatsApp button सभी को दिखाएं
      const waBtn = document.createElement("a");
      waBtn.href = createWhatsAppLink(key, post);
      waBtn.target = "_blank";
      waBtn.textContent = "WhatsApp संपर्क करें";
      waBtn.className = "btn-whatsapp";
      btnGroup.appendChild(waBtn);

      // Delete button - admin और post वाले को दिखाएं
      if (isAdmin || (currentUser && currentUser.uid === post.userId)) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "डिलीट करें";
        delBtn.className = "btn-delete";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("क्या आप इस प्रॉपर्टी को हटाना चाहते हैं?")) {
            db.ref('properties/' + key).remove();
          }
        };
        btnGroup.appendChild(delBtn);
      }

      // Approve बटन - केवल admin को दिखाएं
      if (isAdmin && !post.approved) {
        const appBtn = document.createElement("button");
        appBtn.textContent = "स्वीकृत करें";
        appBtn.className = "btn-approve";
        appBtn.onclick = (e) => {
          e.stopPropagation();
          db.ref('properties/' + key).update({ approved: true });
        };
        btnGroup.appendChild(appBtn);
      }

      info.appendChild(h3);
      info.appendChild(cityP);
      info.appendChild(typeP);
      info.appendChild(priceP);
      info.appendChild(btnGroup);

      card.appendChild(img);
      card.appendChild(info);

      propertyList.appendChild(card);
    });
  }

  // Show detail modal
  function showDetailModal(key, post) {
    modalImage.src = post.imageUrl;
    modalTitle.textContent = post.title;
    modalCity.textContent = `शहर: ${post.city}`;
    modalType.textContent = `प्रकार: ${post.type === "sale" ? "खरीदें" : "किराए पर"}`;
    modalPrice.textContent = `कीमत: ₹${formatPrice(post.price)}`;
    modalDescription.textContent = post.description;
    detailModal.style.display = "flex";
  }

  closeModal.onclick = () => {
    detailModal.style.display = "none";
  };

  window.onclick = (e) => {
    if (e.target === detailModal) {
      detailModal.style.display = "none";
    }
  };

  // Load properties with filters and approval logic
  function loadProperties() {
    db.ref('properties').on('value', snapshot => {
      const data = snapshot.val();
      if (!data) {
        renderProperties([]);
        return;
      }
      let posts = Object.entries(data).map(([key, post]) => ({ key, post }));

      // Filter expired posts (older than 30 दिन)
      const now = Date.now();
      posts.forEach(({ key, post }) => {
        if (now - post.timestamp > 30 * 24 * 60 * 60 * 1000) {
          db.ref('properties/' + key).remove();
        }
      });

      // फिल्टरिंग: admin और user के लिए अलग नियम
      posts = posts.filter(({ post }) => {
        if (isAdmin) return true; // admin सभी देख सकता है

        // user केवल approved या अपनी posts देखे
        if (!post.approved && !(currentUser && post.userId === currentUser.uid)) return false;

        return true;
      });

      // सर्च फिल्टर
      const q = searchInput.value.trim().toLowerCase();
      if (q) {
        posts = posts.filter(({ post }) => {
          return post.title.toLowerCase().includes(q) || post.city.toLowerCase().includes(q);
        });
      }

      renderProperties(posts);
    });
  }

  // Post property handler
  submitPost.onclick = async () => {
    postStatus.textContent = "";
    const title = document.getElementById("title").value.trim();
    const city = document.getElementById("city").value.trim();
    const type = document.getElementById("type").value;
    const price = Number(document.getElementById("price").value);
    const description = document.getElementById("description").value.trim();
    const imageFile = document.getElementById("imageFile").files[0];

    if (!title || !city || !price || !description || !imageFile) {
      postStatus.textContent = "सभी फ़ील्ड सही से भरें।";
      return;
    }
    if (price <= 0) {
      postStatus.textContent = "कीमत 0 से बड़ी होनी चाहिए।";
      return;
    }

    postStatus.textContent = "इमेज अपलोड हो रही है, कृपया प्रतीक्षा करें...";

    try {
      const imageUrl = await uploadImage(imageFile);

      const newPostRef = db.ref('properties').push();
      await newPostRef.set({
        userId: currentUser.uid,
        title,
        city,
        type,
        price,
        description,
        imageUrl,
        approved: false, // admin को अप्रूवल के लिए
        timestamp: Date.now()
      });

      postStatus.style.color = "green";
      postStatus.textContent = "प्रॉपर्टी पोस्ट सफलतापूर्वक भेजी गई है। कृपया admin की मंजूरी का इंतजार करें।";
      clearForm();
      postSection.style.display = "none";
    } catch (error) {
      postStatus.style.color = "red";
      postStatus.textContent = "त्रुटि: " + error.message;
    }
  };

  // Search input event
  searchInput.addEventListener("input", loadProperties);

  // Auth state changed
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      postBtn.style.display = "inline-block";

      isAdmin = user.uid === adminUID;
      adminToggleBtn.style.display = isAdmin ? "inline-block" : "none";
      if (!isAdmin) {
        adminToggleBtn.style.display = "none";
        showAdminPanel = false;
      }

      loadProperties();
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      postBtn.style.display = "none";
      adminToggleBtn.style.display = "none";
      postSection.style.display = "none";
      propertyList.innerHTML = "<p style='text-align:center;'>कृपया लॉगिन करें।</p>";
    }
  });

  // Admin panel toggle - अभी बस placeholder
  adminToggleBtn.onclick = () => {
    alert("यहाँ admin panel functionality डाली जा सकती है।");
  };

  // Initial load message
  propertyList.innerHTML = "<p style='text-align:center;'>कृपया लॉगिन करें।</p>";

</script>

</body>
</html>
