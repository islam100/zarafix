<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZaraFix – Sale Offers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0d12; --card:#11141b; --card2:#151a24; --text:#e7ecf5; --muted:#9fb0cc;
      --b1:#7c6cff; --b2:#00e5ff; --ok:#24d26b; --warn:#ffb02e; --err:#ff3b3b;
      --shadow: 0 18px 35px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.02);
      --r2xl:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Poppins,system-ui,Segoe UI,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(124,108,255,.15), transparent 50%),
        radial-gradient(900px 500px at 110% -20%, rgba(0,229,255,.12), transparent 50%),
        var(--bg);
    }
    a{color:inherit; text-decoration:none}
    img{user-drag:none; -webkit-user-drag:none}

    /* Header / Appbar */
    .appbar{position:sticky; top:0; z-index:50; backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(15,17,24,.8), rgba(15,17,24,.4));
      border-bottom:1px solid rgba(255,255,255,.06)}
    .appbar-inner{max-width:1200px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; gap:12px}

    .logo{display:flex; align-items:center; gap:12px; user-select:none}
    .logo-badge{width:46px; height:46px; border-radius:16px;
      background:conic-gradient(from 200deg,var(--b1),var(--b2),#86ffcc,#ffa8a8,var(--b1));
      box-shadow:0 12px 26px rgba(0,229,255,.28), inset 0 -8px 20px rgba(0,0,0,.35)}
    .logo-text{font-weight:900; letter-spacing:.6px; font-size:30px; line-height:1;
      background:linear-gradient(90deg,#fff,#b0dfff,#86a0ff,#7cffc6);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 8px 34px rgba(0,229,255,.35), 0 2px 0 rgba(255,255,255,.06)}

    .pill{display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow)}
    .menus{flex:1; display:flex; justify-content:center}
    .dropdown{position:relative}
    .dropdown>button{font-weight:700; border:none; cursor:pointer; color:var(--text);
      background:transparent; padding:10px 14px; border-radius:12px}
    .dropdown-list{position:absolute; top:100%; left:0; min-width:220px; margin-top:8px;
      display:none; flex-direction:column; background:var(--card2);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; z-index:60}
    .dropdown.open .dropdown-list{display:flex}
    .dropdown-list a{padding:12px 14px}
    .dropdown-list a:hover{background:rgba(255,255,255,.06)}

    .auth-area{display:flex; align-items:center; gap:8px}
    .btn-3d{appearance:none; border:none; cursor:pointer; color:#091019; font-weight:900; letter-spacing:.2px;
      padding:10px 14px; border-radius:14px;
      background:linear-gradient(180deg,#8ef6ff,#44d2ff);
      box-shadow:0 12px 22px rgba(0,229,255,.35), inset 0 -8px 16px rgba(0,0,0,.28);
      transition:transform .08s ease, box-shadow .2s ease, filter .2s}
    .btn-3d:active{transform:translateY(2px); box-shadow:0 7px 14px rgba(0,229,255,.3), inset 0 -6px 14px rgba(0,0,0,.28)}
    .btn-ghost{background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05)); color:var(--text)}
    .btn-danger{background:linear-gradient(180deg,#ff9a9a,#ff5252)}
    .btn-success{background:linear-gradient(180deg,#86ffcc,#24d26b)}
    .btn-warn{background:linear-gradient(180deg,#ffe08a,#ffb02e)}

    .roles{display:flex; gap:6px}
    .tab{padding:8px 12px; border-radius:12px; font-weight:800; font-size:12px; opacity:.9; border:1px solid rgba(255,255,255,.08); cursor:pointer}
    .tab.active{background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05)); opacity:1}

    .wrap{max-width:1200px; margin:18px auto; padding:0 14px}

    /* Filters row */
    .info{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 14px; flex-wrap:wrap}
    .chip{padding:8px 12px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); font-weight:700; font-size:12px}
    .chip input,.chip select{border:none; background:transparent; color:var(--text); outline:none}

    /* Grid – mobile 2 cols, desktop 4 */
    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    @media(min-width:820px){.grid{grid-template-columns:repeat(4,1fr)}}

    /* Card */
    .card{position:relative; border-radius:var(--r2xl);
      background:linear-gradient(160deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow); overflow:hidden; user-select:none}
    .card.pending{outline:2px dashed rgba(255,59,59,.7);
      background:linear-gradient(160deg, rgba(255,59,59,.14), rgba(255,255,255,.03))}
    .card.rejected{outline:2px dashed rgba(255,59,59,.9); filter:saturate(.7)}

    .badge{position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:999px; font-size:11px; font-weight:900; letter-spacing:.3px; color:#081018}
    .badge.pending{background:linear-gradient(180deg,#ffd0d0,#ff7373)}
    .badge.approved{background:linear-gradient(180deg,#b8ffd9,#49e28c)}
    .badge.rejected{background:linear-gradient(180deg,#ffc2c2,#ff3b3b)}

    .media{position:relative; height:170px; background:#0d1117}
    .media img{width:100%; height:100%; object-fit:cover; display:block; pointer-events:none}
    .media .nav{position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; padding:0 6px}
    .icon-btn{width:34px; height:34px; border-radius:999px; display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.35); backdrop-filter:blur(4px); cursor:pointer; font-weight:900}

    .body{padding:12px}
    .name{font-weight:900; font-size:15px; line-height:1.3}
    .meta{font-size:12px; color:var(--muted); display:flex; gap:8px; margin:6px 0 10px; flex-wrap:wrap}
    .price{font-weight:900; font-size:16px}
    .discount{font-size:12px; font-weight:900; color:#ffe08a}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row .grow{flex:1}
    .card-actions{display:flex; gap:8px; margin-top:10px}

    /* Panels / Forms */
    .panel{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--r2xl); box-shadow:var(--shadow); padding:14px; margin:12px 0}
    .panel h3{margin:0 0 10px; font-size:16px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field input,.field select,.field textarea{background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; outline:none}
    .hint{font-size:12px; color:var(--muted)}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:70}
    .modal.show{display:flex}
    .modal-card{width:min(96vw,900px); border-radius:22px; overflow:hidden; background:var(--card2); border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow)}

    .hidden{display:none!important}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-inner">
      <!-- Left: 3D Logo -->
      <div class="logo">
        <div class="logo-badge"></div>
        <div class="logo-text">ZARA FIX</div>
      </div>

      <!-- Center: Menus + (Admin) Edit Links -->
      <div class="menus">
        <div class="pill">
          <div class="dropdown" id="dd-services">
            <button>Services ▾</button>
            <div class="dropdown-list" id="servicesList">
              <!-- Links will be filled from DB or default placeholders -->
              <a href="#" target="_blank" data-key="all">All Services</a>
              <a href="#" target="_blank" data-key="property">Property</a>
              <a href="#" target="_blank" data-key="ambulance">Ambulance</a>
              <a href="#" target="_blank" data-key="home">Home</a>
            </div>
          </div>
          <div class="dropdown" id="dd-info" style="margin-left:8px">
            <button>Info ▾</button>
            <div class="dropdown-list" id="infoList">
              <a href="#" target="_blank" data-key="provider">Provider</a>
              <a href="#" target="_blank" data-key="about">About</a>
              <a href="#" target="_blank" data-key="contact">Contact</a>
              <a href="#" target="_blank" data-key="privacy">Privacy Policy</a>
            </div>
          </div>
          <button id="editLinksBtn" class="btn-3d btn-warn hidden" style="margin-left:8px">⚙ Edit Links</button>
        </div>
      </div>

      <!-- Right: Tabs + Auth -->
      <div class="auth-area">
        <div class="pill" style="gap:6px; margin-right:8px">
          <span class="tab active" data-tab="publicTab">Public</span>
          <span class="tab" data-tab="shopTab">Shopkeeper</span>
          <span class="tab hidden" id="adminTabBtn" data-tab="adminTab">Admin</span>
        </div>
        <button class="btn-3d btn-ghost" id="loginBtn">Login with Google</button>
        <button class="btn-3d btn-danger hidden" id="logoutBtn">Logout</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- Filters -->
    <div class="info">
      <div class="pill" style="gap:8px; flex:1; flex-wrap:wrap">
        <select id="filterCategory" class="chip" style="background:transparent; color:var(--text); border:none">
          <option value="">All Categories</option>
          <option>bike</option>
          <option>car</option>
          <option>cloth</option>
          <option>watch</option>
          <option>mobile</option>
          <option>pc</option>
        </select>
        <input id="searchInput" class="chip" placeholder="Search product name..." style="background:transparent; color:var(--text); border:none" />
      </div>
    </div>

    <!-- PUBLIC LIST -->
    <section id="publicTab">
      <div class="grid" id="publicGrid"></div>
    </section>

    <!-- SHOPKEEPER -->
    <section id="shopTab" class="hidden">
      <div class="panel" style="max-width:760px">
        <h3>Sale Offer Add Karein</h3>
        <div class="hint">1–5 images • * required</div>
        <div class="row">
          <div class="field" style="flex:1">
            <label>Product Name *</label>
            <input id="pName" maxlength="80" placeholder="eg. iPhone 13" />
          </div>
          <div class="field">
            <label>Category *</label>
            <select id="pCategory">
              <option value="">Select...</option>
              <option>bike</option>
              <option>car</option>
              <option>cloth</option>
              <option>watch</option>
              <option>mobile</option>
              <option>pc</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>Price (₹) *</label><input id="pPrice" type="number" min="1" placeholder="999" /></div>
          <div class="field"><label>Discount (%)</label><input id="pDiscount" type="number" min="0" max="95" placeholder="10" /></div>
          <div class="field" style="flex:1"><label>Shop WhatsApp Number *</label><input id="pWhats" type="tel" maxlength="15" placeholder="91xxxxxxxxxx" /></div>
        </div>
        <div class="field"><label>Description</label><textarea id="pDesc" rows="3" placeholder="Short details..."></textarea></div>
        <div class="field">
          <label>Images (1–5) via ImgBB *</label>
          <input id="pImages" type="file" accept="image/*" multiple />
          <div class="hint">We will upload to ImgBB automatically. Max 5 images.</div>
        </div>
        <div class="row">
          <button id="submitProduct" class="btn-3d">Submit Offer</button>
          <span id="formMsg" class="hint"></span>
        </div>
      </div>

      <div class="panel">
        <h3>Your Offers</h3>
        <div class="grid" id="myGrid"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="adminTab" class="hidden">
      <div class="panel">
        <h3>Admin Dashboard</h3>
        <div class="row" style="margin-bottom:10px">
          <div class="chip" id="aTotal">Total: 0</div>
          <div class="chip" id="aApproved">Approved: 0</div>
          <div class="chip" id="aPending">Pending: 0</div>
          <div class="chip" id="aRejected">Rejected: 0</div>
          <div class="chip" id="aSold">Sold: 0</div>
        </div>
        <div class="grid" id="adminGrid"></div>
      </div>
    </section>
  </div>

  <!-- Modal (Product enlarge + Edit Links) -->
  <div class="modal" id="modal"><div class="modal-card" id="modalCard"></div></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ====== CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyAa8htkfGK-4D3cIQVyxT3o_8WMvghkr-8",
      authDomain: "loot-lo-15328.firebaseapp.com",
      databaseURL: "https://loot-lo-15328-default-rtdb.firebaseio.com",
      projectId: "loot-lo-15328",
      storageBucket: "loot-lo-15328.appspot.com",
      messagingSenderId: "677769861892",
      appId: "1:677769861892:web:bb235cb8479aeee9b58e51"
    };
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';
    const IMGBB_KEY = 'ff05d1b5c3b3e139253856f0ad1123df';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const byId = id => document.getElementById(id);
    const rupees = n => '₹' + Number(n||0).toLocaleString('en-IN');
    const toast = (el,msg)=>{ el.textContent = msg; setTimeout(()=> el.textContent='', 4000) };
    const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));

    // Dropdowns (click outside to close)
    $$('#dd-services, #dd-info').forEach(dd=>{
      const btn=dd.querySelector('button');
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('open')});
      document.addEventListener('click', e=>{ if(!dd.contains(e.target)) dd.classList.remove('open')});
    });

    // Tabs
    $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['publicTab','shopTab','adminTab'].forEach(id=> byId(id).classList.add('hidden'));
      byId(t.dataset.tab).classList.remove('hidden');
    }));

    // ====== AUTH ======
    byId('loginBtn').onclick = async()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); }
      catch(e){ alert('Login failed: '+ e.message); }
    };
    byId('logoutBtn').onclick = ()=> auth.signOut();

    auth.onAuthStateChanged(user=>{
      const logged = !!user;
      byId('loginBtn').classList.toggle('hidden', logged);
      byId('logoutBtn').classList.toggle('hidden', !logged);
      byId('shopTab').classList.toggle('hidden', !logged);

      // Admin
      const isAdmin = user && user.email === ADMIN_EMAIL;
      byId('adminTabBtn').classList.toggle('hidden', !isAdmin);
      byId('editLinksBtn').classList.toggle('hidden', !isAdmin);

      // refresh
      renderAll(); loadMine(); renderAdmin();
    });

    // ====== DB STRUCTURE ======
    // offers/{id}: { id, name, category, price, discount, desc, images[], whats, shopUid, status, createdAt }
    // links: { services:{all,property,ambulance,home}, info:{provider,about,contact,privacy} }
    const offersRef = db.ref('offers');
    const linksRef  = db.ref('links');

    // ====== LINKS (admin editable) ======
    let LINKS = {
      services: { all:'#', property:'#', ambulance:'#', home:'#' },
      info:     { provider:'#', about:'#', contact:'#', privacy:'#' }
    };
    linksRef.on('value', snap=>{
      LINKS = Object.assign(LINKS, snap.val()||{});
      applyMenuLinks();
    });
    function applyMenuLinks(){
      $('#servicesList a[data-key="all"]').href = LINKS.services?.all || '#';
      $('#servicesList a[data-key="property"]').href = LINKS.services?.property || '#';
      $('#servicesList a[data-key="ambulance"]').href = LINKS.services?.ambulance || '#';
      $('#servicesList a[data-key="home"]').href = LINKS.services?.home || '#';

      $('#infoList a[data-key="provider"]').href = LINKS.info?.provider || '#';
      $('#infoList a[data-key="about"]').href = LINKS.info?.about || '#';
      $('#infoList a[data-key="contact"]').href = LINKS.info?.contact || '#';
      $('#infoList a[data-key="privacy"]').href = LINKS.info?.privacy || '#';
    }

    // Edit Links (Admin)
    byId('editLinksBtn').addEventListener('click', ()=>{
      const isAdmin = auth.currentUser && auth.currentUser.email === ADMIN_EMAIL;
      if(!isAdmin) return;
      openLinksEditor();
    });

    function openLinksEditor(){
      const s = LINKS.services || {}, i = LINKS.info || {};
      const html = `
        <div class="body" style="padding:16px 16px 10px">
          <div class="name" style="font-size:18px; margin-bottom:8px">Edit Dropdown Links</div>
          <div class="row">
            <div class="field grow"><label>All Services</label><input id="lk_all" value="${s.all||''}"></div>
            <div class="field grow"><label>Property</label><input id="lk_property" value="${s.property||''}"></div>
          </div>
          <div class="row">
            <div class="field grow"><label>Ambulance</label><input id="lk_ambulance" value="${s.ambulance||''}"></div>
            <div class="field grow"><label>Home</label><input id="lk_home" value="${s.home||''}"></div>
          </div>
          <div class="row">
            <div class="field grow"><label>Provider</label><input id="lk_provider" value="${i.provider||''}"></div>
            <div class="field grow"><label>About</label><input id="lk_about" value="${i.about||''}"></div>
          </div>
          <div class="row">
            <div class="field grow"><label>Contact</label><input id="lk_contact" value="${i.contact||''}"></div>
            <div class="field grow"><label>Privacy Policy</label><input id="lk_privacy" value="${i.privacy||''}"></div>
          </div>
          <div class="row">
            <button class="btn-3d btn-success" id="saveLinksBtn">Save Links</button>
            <button class="btn-3d btn-danger" id="closeLinksBtn">Close</button>
          </div>
        </div>`;
      modalCard.innerHTML = html;
      modal.classList.add('show');
      byId('closeLinksBtn').onclick = ()=> modal.classList.remove('show');
      byId('saveLinksBtn').onclick = async ()=>{
        const payload = {
          services:{
            all: byId('lk_all').value.trim(), property: byId('lk_property').value.trim(),
            ambulance: byId('lk_ambulance').value.trim(), home: byId('lk_home').value.trim()
          },
          info:{
            provider: byId('lk_provider').value.trim(), about: byId('lk_about').value.trim(),
            contact: byId('lk_contact').value.trim(), privacy: byId('lk_privacy').value.trim()
          }
        };
        await linksRef.set(payload);
        modal.classList.remove('show');
      };
    }

    // ====== LIVE LISTENER (OFFERS) ======
    let ALL = [];
    offersRef.on('value', snap=>{
      const obj = snap.val()||{};
      ALL = Object.values(obj).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); // newest first
      updateStats(); renderAll(); loadMine(); renderAdmin();
    });

    function updateStats(){
      const t = ALL.length;
      const a = ALL.filter(p=>p.status==='approved').length;
      const p = ALL.filter(p=>p.status==='pending').length;
      const r = ALL.filter(p=>p.status==='rejected').length;
      const s = ALL.filter(p=>p.status==='sold').length;
      byId('aTotal').textContent    = `Total: ${t}`;
      byId('aApproved').textContent = `Approved: ${a}`;
      byId('aPending').textContent  = `Pending: ${p}`;
      byId('aRejected').textContent = `Rejected: ${r}`;
      byId('aSold').textContent     = `Sold: ${s}`;
    }

    // Filters
    byId('filterCategory').addEventListener('change', renderAll);
    byId('searchInput').addEventListener('input', ()=>{ clearTimeout(window.__s); window.__s=setTimeout(renderAll,160); });
    function applyFilters(list){
      const cat = byId('filterCategory').value;
      const q = byId('searchInput').value.trim().toLowerCase();
      return list.filter(p=>{
        if(p.status==='rejected') return false; // never show to public
        if(cat && p.category!==cat) return false;
        if(q && !(p.name||'').toLowerCase().includes(q)) return false;
        return true;
      });
    }

    // ====== ImgBB Upload ======
    async function uploadToImgBB(file){
      const body = new FormData();
      body.append('key', IMGBB_KEY);
      body.append('image', file);
      const res = await fetch('https://api.imgbb.com/1/upload',{method:'POST', body});
      const data = await res.json();
      if(!data || !data.data || !data.data.url) throw new Error('ImgBB upload failed');
      return data.data.url;
    }
    async function uploadMultiple(files){
      const list = Array.from(files).slice(0,5);
      const out=[];
      for(const f of list){ out.push(await uploadToImgBB(f)); }
      return out;
    }

    // ====== Submit Offer (Shopkeeper) ======
    byId('submitProduct').onclick = async()=>{
      const u = auth.currentUser; if(!u){ alert('Please login first'); return; }
      const name = byId('pName').value.trim();
      const category = byId('pCategory').value.trim();
      const price = clamp(Number(byId('pPrice').value), 1, 1e9);
      const discount = clamp(Number(byId('pDiscount').value||0), 0, 95);
      const whats = byId('pWhats').value.trim();
      const desc = byId('pDesc').value.trim();
      const files = byId('pImages').files;

      if(!name || !category || !price || !whats || !files.length){
        toast(byId('formMsg'),'Please fill all required fields*');
        return;
      }
      byId('formMsg').textContent = 'Uploading images…';
      try{
        const images = await uploadMultiple(files);
        byId('formMsg').textContent='Saving…';
        const id = offersRef.push().key;
        const offer = { id, name, category, price, discount, desc, images, whats, shopUid:u.uid, status:'pending', createdAt: Date.now() };
        await offersRef.child(id).set(offer);
        byId('formMsg').textContent='Submitted! WAIT FOR APPROVAL';
        ['pName','pCategory','pPrice','pDiscount','pWhats','pDesc'].forEach(i=> byId(i).value='');
        byId('pImages').value='';
      } catch(e){
        console.error(e);
        toast(byId('formMsg'),'Error: '+e.message);
      }
    };

    // ===== Card / Gallery / WhatsApp =====
    function badge(p){
      if(p.status==='approved') return '<span class="badge approved">APPROVED</span>';
      if(p.status==='pending')  return '<span class="badge pending">WAIT FOR APPROVAL</span>';
      if(p.status==='rejected') return '<span class="badge rejected">REJECTED</span>';
      return '';
    }
    function waLink(p){
      const msg = `हमें आपका product पसंद आया है: ${p.name} (${rupees(p.price)}). कृपया पूरी जानकारी दें।`;
      const phone = (p.whats||'').replace(/\D/g,'');
      return `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    }
    function galleryHTML(p){
      const first = (p.images&&p.images[0])||'';
      const cnt=(p.images||[]).length;
      return `
        <div class="media" data-idx="0">
          <img src="${first}" alt="${p.name}" draggable="false"/>
          ${cnt>1?`<div class="nav"><div class="icon-btn prev">‹</div><div class="icon-btn next">›</div></div>`:''}
        </div>`;
    }
    function attachGalleryHandlers(cardEl,p){
      const media=cardEl.querySelector('.media'); if(!media) return;
      const img=media.querySelector('img'); const total=(p.images||[]).length;
      function setIdx(i){ media.dataset.idx=String(i); img.src=p.images[i]; }
      cardEl.querySelector('.prev')?.addEventListener('click',e=>{
        e.stopPropagation(); const i=(+media.dataset.idx||0); setIdx((i-1+total)%total);
      });
      cardEl.querySelector('.next')?.addEventListener('click',e=>{
        e.stopPropagation(); const i=(+media.dataset.idx||0); setIdx((i+1)%total);
      });
    }

    function makeCard(p, ctx){ // ctx: 'public'|'mine'|'admin'
      const statusClass = p.status==='pending' ? 'pending' : (p.status==='rejected'?'rejected':'');
      const el = document.createElement('div'); el.className = `card ${statusClass}`;
      const discountTxt = p.discount ? `<span class="discount">-${p.discount}%</span>` : '';
      let actions='';
      if(ctx==='mine' && auth.currentUser && p.shopUid===auth.currentUser.uid){
        actions += `<button class="btn-3d btn-danger del">Delete</button>`;
      }
      if(ctx==='admin'){
        actions += `<button class="btn-3d btn-success approve">Approve</button>`;
        actions += `<button class="btn-3d btn-danger reject">Reject</button>`;
        actions += `<button class="btn-3d btn-danger del">Delete</button>`;
      }
      el.innerHTML =
        `${badge(p)}${galleryHTML(p)}
        <div class="body">
          <div class="name">${p.name||''}</div>
          <div class="meta">
            <span>${(p.category||'').toUpperCase()}</span><span>•</span>
            <span class="price">${rupees(p.price||0)}</span>${discountTxt}
          </div>
          <div class="meta">${p.desc? p.desc.replace(/</g,'&lt;'):''}</div>
          <div class="card-actions">
            <a class="btn-3d" target="_blank" href="${waLink(p)}">WhatsApp</a>
            ${actions}
          </div>
        </div>`;

      // Enlarge on card click
      el.addEventListener('click', e=>{
        if(e.target.closest('.btn-3d') || e.target.classList.contains('icon-btn')) return;
        openProductModal(p);
      });

      // Handlers
      if(ctx==='mine' || ctx==='admin'){
        el.querySelector('.del')?.addEventListener('click', async e=>{
          e.stopPropagation(); if(confirm('Delete this offer?')) await offersRef.child(p.id).remove();
        });
      }
      if(ctx==='admin'){
        el.querySelector('.approve')?.addEventListener('click', async e=>{
          e.stopPropagation(); await offersRef.child(p.id).update({status:'approved'});
        });
        el.querySelector('.reject')?.addEventListener('click', async e=>{
          e.stopPropagation(); await offersRef.child(p.id).update({status:'rejected'});
        });
      }
      attachGalleryHandlers(el,p); return el;
    }

    // Public render (approved + pending; rejected hidden)
    function renderPublic(){
      const grid = byId('publicGrid'); grid.innerHTML='';
      const list = applyFilters(ALL.filter(p=>p.status!=='rejected'));
      for(const p of list){ grid.appendChild(makeCard(p,'public')); }
      if(!list.length){ grid.innerHTML='<div class="hint" style="grid-column:1/-1; padding:20px">No offers found.</div>'; }
    }

    function loadMine(){
      const grid=byId('myGrid'); if(!grid) return; grid.innerHTML='';
      const u=auth.currentUser;
      if(!u){ grid.innerHTML='<div class="hint">Login to manage your offers.</div>'; return }
      const mine = ALL.filter(p=>p.shopUid===u.uid);
      for(const p of mine){ grid.appendChild(makeCard(p,'mine')); }
      if(!mine.length){ grid.innerHTML='<div class="hint" style="grid-column:1/-1; padding:20px">No offers yet. Add your first one!</div>'; }
    }

    function renderAdmin(){
      const grid=byId('adminGrid'); if(!grid) return; grid.innerHTML='';
      const u=auth.currentUser; const isAdmin = u && u.email===ADMIN_EMAIL;
      if(!isAdmin){ grid.innerHTML='<div class="hint" style="grid-column:1/-1; padding:20px">Admin only.</div>'; return }
      for(const p of ALL){ grid.appendChild(makeCard(p,'admin')); }
      if(!ALL.length){ grid.innerHTML='<div class="hint" style="grid-column:1/-1; padding:20px">No offers in database.</div>'; }
    }

    function renderAll(){ renderPublic(); }

    // ===== Modal (Product enlarge) =====
    const modal = byId('modal');
    const modalCard = byId('modalCard');

    function openProductModal(p){
      modalCard.innerHTML =
        `${galleryHTML(p)}
         <div class="body">
           <div class="name" style="font-size:18px">${p.name}</div>
           <div class="meta"><strong>${(p.category||'').toUpperCase()}</strong> • ${rupees(p.price)} ${p.discount?`<span class='discount'>-${p.discount}%</span>`:''}</div>
           <div class="meta">${p.desc? p.desc.replace(/</g,'&lt;'):''}</div>
           <div class="row">
             <a class="btn-3d" target="_blank" href="${waLink(p)}">WhatsApp Shop</a>
           </div>
         </div>`;
      modal.classList.add('show');
      attachGalleryHandlers(modalCard,p);
    }

    modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') modal.classList.remove('show'); });
  </script>
</body>
</html>
