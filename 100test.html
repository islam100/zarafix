import React, { useState, useEffect } from "react";
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "firebase/auth";
import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, doc, deleteDoc, orderBy } from "firebase/firestore";

// 🔥 Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAa8htkfGK-4D3cIQVyxT3o_8WMvghkr-8",
  authDomain: "loot-lo-15328.firebaseapp.com",
  databaseURL: "https://loot-lo-15328-default-rtdb.firebaseio.com",
  projectId: "loot-lo-15328",
  storageBucket: "loot-lo-15328.appspot.com",
  messagingSenderId: "677769861892",
  appId: "1:677769861892:web:bb235cb8479aeee9b58e51"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [products, setProducts] = useState([]);
  const [newProduct, setNewProduct] = useState({ name: "", price: "", discount: "", whatsapp: "", images: [] });

  // 🟢 Real-time Products
  useEffect(() => {
    const q = query(collection(db, "products"), orderBy("timestamp", "desc"));
    const unsub = onSnapshot(q, (snap) => {
      setProducts(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
    });
    return unsub;
  }, []);

  // 🔐 Google Login
  const login = async () => {
    try {
      const res = await signInWithPopup(auth, provider);
      setUser(res.user);
    } catch (e) {
      console.error(e);
    }
  };

  const logout = () => {
    signOut(auth);
    setUser(null);
  };

  // 🛒 Add Product (Shopkeeper)
  const addProduct = async () => {
    if (!newProduct.name || !newProduct.price) return alert("Fill all details");
    await addDoc(collection(db, "products"), {
      ...newProduct,
      status: "pending",
      shop: user.email,
      timestamp: Date.now()
    });
    setNewProduct({ name: "", price: "", discount: "", whatsapp: "", images: [] });
    alert("Product submitted. Wait for approval.");
  };

  // ✅ Admin Approve / ❌ Reject
  const updateStatus = async (id, status) => {
    await updateDoc(doc(db, "products", id), { status });
  };

  return (
    <div className="bg-gray-900 text-white min-h-screen">
      {/* Header */}
      <header className="flex justify-between items-center p-4 bg-black shadow-xl sticky top-0 z-50">
        <h1 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-yellow-500 to-green-500 drop-shadow-lg">
          ZARA FIX
        </h1>
        <nav className="flex gap-6">
          <select className="bg-gray-800 p-2 rounded-xl">
            <option>All Services</option>
            <option>Property</option>
            <option>Ambulance</option>
            <option>Home</option>
          </select>
          <select className="bg-gray-800 p-2 rounded-xl">
            <option>Provider</option>
            <option>About</option>
            <option>Contact</option>
            <option>Privacy Policy</option>
          </select>
        </nav>
        {user ? (
          <button onClick={logout} className="px-4 py-2 rounded-2xl shadow-lg bg-gradient-to-r from-red-500 to-pink-600 font-bold">Logout</button>
        ) : (
          <button onClick={login} className="px-4 py-2 rounded-2xl shadow-lg bg-gradient-to-r from-green-500 to-blue-600 font-bold">Login with Google</button>
        )}
      </header>

      {/* Add Product Form (Shopkeeper) */}
      {user && user.email !== "zarasamajiksevasanstha@gmail.com" && (
        <div className="p-4">
          <h2 className="text-xl mb-2 font-bold">Add Product</h2>
          <input placeholder="Name" value={newProduct.name} onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })} className="p-2 m-1 bg-gray-800 rounded-xl" />
          <input placeholder="Price" value={newProduct.price} onChange={(e) => setNewProduct({ ...newProduct, price: e.target.value })} className="p-2 m-1 bg-gray-800 rounded-xl" />
          <input placeholder="Discount" value={newProduct.discount} onChange={(e) => setNewProduct({ ...newProduct, discount: e.target.value })} className="p-2 m-1 bg-gray-800 rounded-xl" />
          <input placeholder="WhatsApp Number" value={newProduct.whatsapp} onChange={(e) => setNewProduct({ ...newProduct, whatsapp: e.target.value })} className="p-2 m-1 bg-gray-800 rounded-xl" />
          <button onClick={addProduct} className="block mt-2 px-4 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-pink-600 shadow-xl">Submit</button>
        </div>
      )}

      {/* Product List */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        {products.map((p) => (
          <div key={p.id} className={`p-4 rounded-2xl shadow-2xl transform transition hover:scale-105 ${p.status === "pending" ? "bg-red-700" : "bg-gray-800"}`}>
            <h3 className="text-lg font-bold">{p.name}</h3>
            <p>Price: ₹{p.price}</p>
            <p>Discount: {p.discount}%</p>
            <a href={`https://wa.me/${p.whatsapp}?text=Hame%20apka%20product%20pasand%20aaya%20hai:%20${p.name}%20Price:%20${p.price}`} target="_blank" rel="noreferrer">
              <button className="mt-2 px-3 py-1 bg-green-600 rounded-xl shadow-lg">WhatsApp Shop</button>
            </a>

            {/* Admin Actions */}
            {user?.email === "zarasamajiksevasanstha@gmail.com" && (
              <div className="mt-2 flex gap-2">
                <button onClick={() => updateStatus(p.id, "approved")} className="px-3 py-1 bg-blue-600 rounded-xl">Approve</button>
                <button onClick={() => updateStatus(p.id, "rejected")} className="px-3 py-1 bg-red-800 rounded-xl">Reject</button>
              </div>
            )}

            {/* Status */}
            <p className="text-sm mt-1">Status: {p.status}</p>
          </div>
        ))}
      </div>
    </div>
  );
}
