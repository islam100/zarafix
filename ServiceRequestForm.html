<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Service Request Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f0f0f0; text-align: center; }
    h2 { background: #333; color: #fff; padding: 15px; margin: 0; }
    .button { padding: 15px 30px; margin: 10px; font-size: 18px; border: none; border-radius: 12px; background: #2196f3; color: #fff; box-shadow: 0 4px #0d47a1; }
    .button:hover { background: #0d8bf2; }
    #formSection, #dashboardSection { display: none; padding: 20px; }
    .card {
      background: #fff; border-radius: 12px; padding: 15px; margin: 10px auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); max-width: 400px; text-align: left;
    }
    input, select, textarea {
      width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc;
    }
    .delete-btn { background: red; color: #fff; padding: 8px 12px; border: none; border-radius: 8px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<h2>üìã ZaraFix - Service Request</h2>
<button class="button" onclick="showSection('form')">Form</button>
<button class="button" onclick="showSection('dashboard')">Dashboard</button>

<div id="formSection">
  <div class="card">
    <h3>Submit Your Service Request</h3>
    <input type="text" id="name" placeholder="Your Name" required>
    <input type="text" id="whatsapp" placeholder="WhatsApp Number" required>
    <input type="text" id="address" placeholder="Address (or auto-filled)">
    <select id="category">
      <option value="">Select Category</option>
      <option value="AC Mechanic">AC Mechanic</option>
      <option value="Electrician">Electrician</option>
      <option value="Plumber">Plumber</option>
      <option value="Car Mechanic">Car Mechanic</option>
    </select>
    <textarea id="problem" placeholder="Describe your problem" required></textarea>
    <button class="button" onclick="submitRequest()">Submit</button>
  </div>
</div>

<div id="dashboardSection">
  <div id="requestsList"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  let userId = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      loadRequests();
    } else {
      window.location.href = "index.html";
    }
  });

  function showSection(section) {
    document.getElementById('formSection').style.display = section === 'form' ? 'block' : 'none';
    document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
    if (section === 'dashboard') loadRequests();
  }

  function submitRequest() {
    const name = document.getElementById('name').value;
    const whatsapp = document.getElementById('whatsapp').value;
    const address = document.getElementById('address').value;
    const category = document.getElementById('category').value;
    const problem = document.getElementById('problem').value;

    if (!name || !whatsapp || !category || !problem) {
      alert("Please fill all fields.");
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      saveRequest(name, whatsapp, address, category, problem, `https://maps.google.com?q=${lat},${lng}`);
    }, () => {
      saveRequest(name, whatsapp, address || "Manual address", category, problem, "");
    });
  }

  function saveRequest(name, whatsapp, address, category, problem, location) {
    const reqId = db.ref().child("requests").push().key;
    const data = {
      name, whatsapp, address, category, problem,
      status: "pending",
      timestamp: Date.now(),
      location,
      acceptedBy: {}
    };
    db.ref("requests/" + userId + "/" + reqId).set(data).then(() => {
      alert("Request submitted!");
      document.getElementById("formSection").reset;
    });
  }

  function loadRequests() {
    db.ref("requests/" + userId).on("value", snapshot => {
      const list = document.getElementById("requestsList");
      list.innerHTML = "";
      const data = snapshot.val();
      if (!data) {
        list.innerHTML = "<p>No requests found.</p>";
        return;
      }
      Object.entries(data).forEach(([reqId, req]) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <strong>Name:</strong> ${req.name}<br>
          <strong>Problem:</strong> ${req.problem}<br>
          <strong>Status:</strong> ${req.status}<br>
          <strong>Category:</strong> ${req.category}<br>
          <strong>Address:</strong> ${req.address}<br>
          <strong>WhatsApp:</strong> ${req.whatsapp}<br>
          <a href="${req.location}" target="_blank">üìç View Location</a><br>
          <strong>Accepted By:</strong> ${Object.keys(req.acceptedBy || {}).length}<br>
          <button class="delete-btn" onclick="deleteRequest('${reqId}')">Delete</button>
        `;
        list.appendChild(card);
      });
    });
  }

  function deleteRequest(reqId) {
    if (confirm("Are you sure you want to delete this request?")) {
      db.ref("requests/" + userId + "/" + reqId).remove();
    }
  }
</script>
</body>
</html>
