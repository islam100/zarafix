<!DOCTYPE html>
<html>
<head>
  <title>üõ†Ô∏è ZaraFix Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; padding: 10px; }
    h2 { text-align: center; }
    .card {
      background: #fff;
      margin: 10px auto;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    button {
      margin: 5px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .approve { background-color: green; color: white; }
    .delete { background-color: red; color: white; }
    .wallet-log, .recharge-log, .job-log { font-size: 14px; margin-top: 5px; background: #eef; padding: 5px; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>üõ†Ô∏è ZaraFix Admin Dashboard</h2>
  <div id="posterList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_RUU2PZtzauGfD7Z9SSRYHfJzlmK9FZg",
      authDomain: "zarafix.firebaseapp.com",
      databaseURL: "https://zarafix-default-rtdb.firebaseio.com",
      projectId: "zarafix",
      storageBucket: "zarafix.appspot.com",
      messagingSenderId: "356980956940",
      appId: "1:356980956940:web:b21b93b789b1517e74e364"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const posterRef = ref(db, 'posterUsers');

    get(posterRef).then(async (snapshot) => {
      if (snapshot.exists()) {
        const posters = snapshot.val();
        const posterList = document.getElementById("posterList");
        posterList.innerHTML = '';

        for (const uid in posters) {
          const p = posters[uid];
          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <b>${p.name}</b> (${p.shopname})<br>
            ${p.category} - ${p.subcategory}<br>
            üìû ${p.whatsapp}<br>
            üìç ${p.address} (${p.pincode})<br>
            ‚úÖ Approved: <b>${p.approved}</b><br>
            <button class="approve" onclick="updateApproval('${uid}', true)">Approve</button>
            <button class="delete" onclick="updateApproval('${uid}', false)">Delete</button>
            <div id="logs-${uid}"></div>
          `;
          posterList.appendChild(card);

          // Load recharge and deduction log
          const logsContainer = card.querySelector(`#logs-${uid}`);

          // Recharge History
          const rechargesSnap = await get(ref(db, `recharges/${uid}`));
          if (rechargesSnap.exists()) {
            logsContainer.innerHTML += `<div class='recharge-log'><b>Recharge History:</b><br>`;
            const recharges = rechargesSnap.val();
            for (const r in recharges) {
              const d = recharges[r];
              logsContainer.innerHTML += `üìÖ ${d.timestamp} ‚Çπ${d.amount} (${d.approved ? '‚úÖ' : '‚è≥'})<br>`;
            }
            logsContainer.innerHTML += `</div>`;
          }

          // ‚Çπ3 Daily Deduction
          const walletLogSnap = await get(ref(db, `walletLogs/${uid}`));
          if (walletLogSnap.exists()) {
            logsContainer.innerHTML += `<div class='wallet-log'><b>‚Çπ3 Deduction Logs:</b><br>`;
            const logs = walletLogSnap.val();
            for (const l in logs) {
              const log = logs[l];
              if (log.amount == 3) {
                logsContainer.innerHTML += `üìÖ ${log.date} - ‚Çπ3<br>`;
              }
            }
            logsContainer.innerHTML += `</div>`;
          }

          // Job Accepted Log
          const requestsSnap = await get(ref(db, `requests`));
          let acceptedJobs = '';
          if (requestsSnap.exists()) {
            const allUsers = requestsSnap.val();
            for (const userId in allUsers) {
              const reqs = allUsers[userId];
              for (const reqId in reqs) {
                const req = reqs[reqId];
                if (req.acceptedBy && req.acceptedBy[uid]) {
                  acceptedJobs += `JobID: ${reqId} by User: ${userId}<br>`;
                }
              }
            }
          }
          if (acceptedJobs) {
            logsContainer.innerHTML += `<div class='job-log'><b>Accepted Jobs:</b><br>${acceptedJobs}</div>`;
          }
        }
      }
    });

    window.updateApproval = function(uid, status) {
      update(ref(db, `posterUsers/${uid}`), { approved: status });
      alert('Updated! Please refresh.');
    }
  </script>
</body>
</html>
