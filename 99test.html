<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZaraFix — Property Portal (Admin + Approve)</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#ffecd2; --bg2:#fcb69f; --card:#fff; --muted:#64748b;
    --accent1:#06b6d4; --accent2:#7c3aed; --accent3:#22c55e;
    --btn-shadow: 6px 8px 24px rgba(0,0,0,0.12);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));margin:0;color:#0f172a}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,#0ea5e9,#7c3aed);color:#fff;position:sticky;top:0;z-index:30;box-shadow:0 8px 30px rgba(12,18,22,.12)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#fff,#a78bfa);display:grid;place-items:center;font-weight:800;color:#0b1220}
  .actions{display:flex;gap:8px;align-items:center}
  button.app-btn{border:0;padding:10px 14px;border-radius:12px;font-weight:700;color:#fff;cursor:pointer;box-shadow:var(--btn-shadow)}
  .btn-login{background:linear-gradient(135deg,var(--accent1),var(--accent2))}
  .btn-logout{background:linear-gradient(135deg,#ef4444,#dc2626)}
  .btn-post{background:linear-gradient(135deg,#22c55e,#16a34a)}
  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  .topbar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:14px}
  .search{display:flex;gap:8px;align-items:center}
  input.search-in{padding:10px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.08);min-width:220px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(2,6,23,.08);cursor:pointer;transition:transform .25s}
  .card:hover{transform:translateY(-6px)}
  .card .thumb{height:160px;border-radius:10px;overflow:hidden;background:#f1f5f9}
  .card img{width:100%;height:100%;object-fit:cover;display:block}
  .title{font-weight:700;margin:10px 0 6px}
  .meta{color:var(--muted);font-size:13px}
  .foot{display:flex;gap:8px;align-items:center;margin-top:10px}
  .wa-btn{background:#25D366;color:#fff;padding:8px 10px;border-radius:9px;text-decoration:none;font-weight:700}
  .expand{grid-column:span 3}
  /* Post Modal / Panel */
  .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.5);z-index:60;padding:16px}
  .panel.open{display:flex}
  .sheet{width:min(920px,98vw);background:#fff;border-radius:12px;overflow:auto;box-shadow:0 30px 60px rgba(2,6,23,.25)}
  .sheet header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef2ff}
  .sheet .content{padding:16px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .field{grid-column:span 6}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6edf3}
  textarea{min-height:120px}
  .admin-panel{margin-top:18px;background:rgba(255,255,255,.6);padding:12px;border-radius:10px}
  /* responsive */
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .field{grid-column:span 12} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} header{flex-direction:column;gap:8px;align-items:flex-start} }
  /* colorful tags */
  .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fef3c7,#fecaca);font-weight:700}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ZF</div>
    <div>
      <div style="font-weight:800">ZaraFix — Property Portal</div>
      <div style="font-size:12px;opacity:.9">Post → Admin Approve → Live</div>
    </div>
  </div>

  <div class="actions">
    <div id="userEmail" style="color:rgba(255,255,255,.95);font-weight:700"></div>
    <button id="btnPostOpen" class="app-btn btn-post" style="display:none">Post Property</button>
    <button id="btnAdmin" class="app-btn" style="background:linear-gradient(135deg,#f97316,#fb7185);display:none">Admin</button>
    <button id="btnLogin" class="app-btn btn-login">Login</button>
    <button id="btnLogout" class="app-btn btn-logout" style="display:none">Logout</button>
  </div>
</header>

<main class="container">
  <div class="topbar">
    <div class="search">
      <input id="q" class="search-in" placeholder="Search title, city..." />
      <select id="filterCity" style="padding:10px;border-radius:12px;border:1px solid #e6edf3">
        <option value="">All Cities</option>
      </select>
      <button id="btnSearch" class="app-btn" style="background:linear-gradient(135deg,#06b6d4,#7c3aed)">Search</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div style="color: #0f172a;font-weight:700" id="countTxt">Loading…</div>
    </div>
  </div>

  <section id="listSection">
    <div id="grid" class="grid"></div>
  </section>

  <section class="admin-panel" id="adminPanel" style="display:none">
    <h3 style="margin:0 0 8px">Admin — Approvals</h3>
    <div id="pendingList"></div>
  </section>
</main>

<!-- Post / Edit Sheet -->
<div id="postPanel" class="panel">
  <div class="sheet" role="dialog" aria-modal="true">
    <header>
      <strong id="panelTitle">Post Property</strong>
      <div><button id="closePanel" class="app-btn" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Close</button></div>
    </header>
    <div class="content">
      <div class="row">
        <div class="field"><label>Title</label><input id="pTitle" /></div>
        <div class="field"><label>City</label><input id="pCity" /></div>
        <div class="field"><label>Type</label><select id="pType"><option>Flat</option><option>House</option><option>Plot</option><option>Shop</option></select></div>
        <div class="field"><label>Price (₹)</label><input id="pPrice" type="number" /></div>
        <div class="field"><label>WhatsApp (without +)</label><input id="pWA" placeholder="919876543210"/></div>
        <div class="field"><label>Image URL</label><input id="pImg" placeholder="https://..." /></div>
        <div class="field" style="grid-column:span 12"><label>Description</label><textarea id="pDesc"></textarea></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="submitPost" class="app-btn btn-post">Submit</button>
        <button id="submitUpdate" class="app-btn" style="display:none;background:linear-gradient(135deg,#f59e0b,#ef4444)">Update</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // ====== YOUR Firebase config (you provided) ======
  const firebaseConfig = {
    apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
    authDomain: "property-20d6d.firebaseapp.com",
    databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
    projectId: "property-20d6d",
    storageBucket: "property-20d6d.appspot.com",
    messagingSenderId: "916859697394",
    appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ====== Admin email ======
  const ADMIN_EMAIL = "zarasamajiksevasanstha@gmail.com";

  // ====== Elements ======
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnPostOpen = document.getElementById('btnPostOpen');
  const btnAdmin = document.getElementById('btnAdmin');
  const userEmailEl = document.getElementById('userEmail');
  const postPanel = document.getElementById('postPanel');
  const panelTitle = document.getElementById('panelTitle');
  const closePanel = document.getElementById('closePanel');
  const submitPostBtn = document.getElementById('submitPost');
  const submitUpdateBtn = document.getElementById('submitUpdate');
  const grid = document.getElementById('grid');
  const countTxt = document.getElementById('countTxt');
  const pendingList = document.getElementById('pendingList');
  const filterCity = document.getElementById('filterCity');
  const qInput = document.getElementById('q');

  let currentUser = null;
  let editingId = null;

  // ====== Auth handlers ======
  btnLogin.addEventListener('click', ()=> {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e=>alert(e.message));
  });
  btnLogout.addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{
    currentUser = user;
    if(user){
      userEmailEl.textContent = user.email;
      btnLogin.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      // show post button for logged-in users
      btnPostOpen.style.display = 'inline-block';
      // show admin controls if admin
      if(user.email === ADMIN_EMAIL){
        btnAdmin.style.display = 'inline-block';
        document.getElementById('adminPanel').style.display = 'block';
      } else {
        btnAdmin.style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
      }
    } else {
      userEmailEl.textContent = '';
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      btnPostOpen.style.display = 'none';
      btnAdmin.style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
    }
  });

  // ====== Open/Close post panel ======
  btnPostOpen.addEventListener('click', ()=> {
    panelTitle.textContent = 'Post Property';
    submitPostBtn.style.display = 'inline-block';
    submitUpdateBtn.style.display = 'none';
    postPanel.classList.add('open');
  });
  closePanel.addEventListener('click', ()=> postPanel.classList.remove('open'));

  // ====== Helper: reset form ======
  function resetForm(){
    editingId = null;
    document.getElementById('pTitle').value='';
    document.getElementById('pCity').value='';
    document.getElementById('pType').value='Flat';
    document.getElementById('pPrice').value='';
    document.getElementById('pWA').value='';
    document.getElementById('pImg').value='';
    document.getElementById('pDesc').value='';
  }

  // ====== Submit new post (pending approval) ======
  submitPostBtn.addEventListener('click', async ()=>{
    if(!currentUser){ alert('Please login to post'); return; }
    const title = document.getElementById('pTitle').value.trim();
    const city = document.getElementById('pCity').value.trim();
    const type = document.getElementById('pType').value;
    const price = Number(document.getElementById('pPrice').value||0);
    const wa = document.getElementById('pWA').value.trim();
    const img = document.getElementById('pImg').value.trim();
    const desc = document.getElementById('pDesc').value.trim();

    if(!title || !city || !price || !wa){ alert('Please fill Title, City, Price, WhatsApp'); return; }

    const newRef = db.ref('properties').push();
    await newRef.set({
      title, city, type, price, whatsapp: wa, imageUrl: img, description: desc,
      postedBy: currentUser.email, approved: false, time: Date.now()
    });
    alert('Posted — waiting for admin approval');
    postPanel.classList.remove('open');
    resetForm();
  });

  // ====== Update existing (admin or original poster if allowed) ======
  submitUpdateBtn.addEventListener('click', async ()=>{
    if(!editingId) return;
    const title = document.getElementById('pTitle').value.trim();
    const city = document.getElementById('pCity').value.trim();
    const type = document.getElementById('pType').value;
    const price = Number(document.getElementById('pPrice').value||0);
    const wa = document.getElementById('pWA').value.trim();
    const img = document.getElementById('pImg').value.trim();
    const desc = document.getElementById('pDesc').value.trim();
    if(!title || !city || !price || !wa){ alert('Please fill Title, City, Price, WhatsApp'); return; }
    await db.ref('properties/'+editingId).update({ title, city, type, price, whatsapp:wa, imageUrl:img, description:desc, time:Date.now() });
    alert('Updated');
    postPanel.classList.remove('open');
    resetForm();
  });

  // ====== Render grid of approved properties ======
  function renderGrid(items){
    grid.innerHTML = '';
    const cities = new Set();
    items.forEach(item=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.id = item.id;
      div.innerHTML = `
        <div class="thumb"><img src="${item.imageUrl||'https://via.placeholder.com/800x500?text=No+Image'}" alt="img" /></div>
        <div class="title">${escapeHtml(item.title)}</div>
        <div class="meta">${escapeHtml(item.city)} • ${escapeHtml(item.type)} • ₹${Number(item.price).toLocaleString('en-IN')}</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">${escapeHtml(item.description||'')}</div>
        <div class="foot">
          <a class="wa-btn" href="https://wa.me/${item.whatsapp}" target="_blank">WhatsApp</a>
        </div>
      `;
      // expand on click
      div.addEventListener('click', ()=> div.classList.toggle('expand'));
      grid.appendChild(div);
      if(item.city) cities.add(item.city);
    });
    countTxt.textContent = `${items.length} properties live`;
    // populate city filter
    filterCity.innerHTML = '<option value="">All Cities</option>' + Array.from(cities).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  // ====== Subscribe approved items ======
  db.ref('properties').on('value', snap=>{
    const arr = [];
    snap.forEach(ch=>{
      const v = ch.val();
      arr.push({ id: ch.key, ...v });
    });
    // filter approved
    const approved = arr.filter(x=>x.approved===true).sort((a,b)=> (b.time||0)-(a.time||0));
    renderGrid(approved);
    renderPending(arr.filter(x=>!x.approved));
  });

  // ====== Admin: render pending and actions ======
  function renderPending(pending){
    pendingList.innerHTML = '';
    if(!pending.length){ pendingList.innerHTML = '<p style="color:var(--muted)">No pending posts.</p>'; return; }
    pending.forEach(p=>{
      const el = document.createElement('div');
      el.style = 'background:#fff;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 6px 20px rgba(2,6,23,.06)';
      el.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
        <img src="${p.imageUrl||'https://via.placeholder.com/120'}" style="width:90px;height:70px;object-fit:cover;border-radius:8px"/>
        <div style="flex:1">
          <div style="font-weight:800">${escapeHtml(p.title)}</div>
          <div style="color:var(--muted);font-size:13px">${escapeHtml(p.city)} • ₹${Number(p.price||0).toLocaleString('en-IN')}</div>
          <div style="color:var(--muted);font-size:13px">By: ${escapeHtml(p.postedBy||'')}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="app-btn" style="background:linear-gradient(135deg,#10b981,#059669)" data-act="approve" data-id="${p.id}">Approve</button>
          <button class="app-btn" style="background:linear-gradient(135deg,#f97316,#ef4444)" data-act="reject" data-id="${p.id}">Reject</button>
          <button class="app-btn" style="background:linear-gradient(135deg,#06b6d4,#7c3aed)" data-act="edit" data-id="${p.id}">Edit</button>
        </div>
      </div>`;
      pendingList.appendChild(el);
    });
    // bind actions
    pendingList.querySelectorAll('button[data-act]').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        const act = e.currentTarget.dataset.act;
        const id = e.currentTarget.dataset.id;
        if(act === 'approve'){ await db.ref('properties/'+id).update({ approved:true }); alert('Approved'); }
        if(act === 'reject'){ if(confirm('Reject & delete?')){ await db.ref('properties/'+id).remove(); alert('Deleted'); } }
        if(act === 'edit'){
          // load to panel for editing
          const snap = await db.ref('properties/'+id).once('value'); const v = snap.val();
          panelTitle.textContent = 'Edit Property';
          document.getElementById('pTitle').value = v.title||'';
          document.getElementById('pCity').value = v.city||'';
          document.getElementById('pType').value = v.type||'Flat';
          document.getElementById('pPrice').value = v.price||'';
          document.getElementById('pWA').value = v.whatsapp||'';
          document.getElementById('pImg').value = v.imageUrl||'';
          document.getElementById('pDesc').value = v.description||'';
          submitPostBtn.style.display = 'none'; submitUpdateBtn.style.display = 'inline-block';
          editingId = id;
          postPanel.classList.add('open');
        }
      });
    });
  }

  // ====== Admin button to open pending panel ======
  btnAdmin.addEventListener('click', ()=> {
    window.scrollTo({top: document.getElementById('adminPanel').offsetTop-80, behavior:'smooth'});
  });

  // ====== Search/filter ======
  document.getElementById('btnSearch').addEventListener('click', ()=>{
    const q = qInput.value.trim().toLowerCase();
    const city = filterCity.value;
    // fetch all approved from current grid (we already have through DB subscription) then filter
    db.ref('properties').once('value').then(snap=>{
      const arr = [];
      snap.forEach(ch=> arr.push({id:ch.key,...ch.val()}));
      let list = arr.filter(x=>x.approved===true);
      if(q) list = list.filter(it=> (it.title||'').toLowerCase().includes(q) || (it.city||'').toLowerCase().includes(q));
      if(city) list = list.filter(it=> (it.city||'')===city);
      renderGrid(list);
    });
  });

  // ====== util escape ======
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }

  // init: reset form
  resetForm();
</script>
</body>
</html>
