<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZaraFix – Services</title>
  <style>
    body{font-family:sans-serif;background:#f2f2f2;margin:0;padding:0}
    header{background:#333;color:#fff;padding:10px;text-align:center}
    .btn{padding:8px 14px;margin:4px;border:none;border-radius:6px;cursor:pointer}
    .btn-good{background:#4CAF50;color:#fff}
    .btn-bad{background:#f44336;color:#fff}
    .btn-neutral{background:#2196F3;color:#fff}
    .card{background:#fff;margin:10px;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;padding:10px}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:500px;max-height:90%;overflow:auto}
    img.preview{max-width:100%;border-radius:8px;margin:5px 0}
  </style>
</head>
<body>
  <header>
    <h2>ZaraFix – All Services</h2>
    <button id="loginBtn" class="btn btn-neutral">Login</button>
    <button id="logoutBtn" class="btn btn-bad" style="display:none;">Logout</button>
    <button id="newPostBtn" class="btn btn-good">➕ New Post</button>
  </header>

  <section id="posts" class="grid"></section>

  <!-- Post Modal -->
  <div id="postModal" class="modal">
    <div class="modal-content">
      <h3>New Post</h3>
      <form id="postForm">
        <input type="text" id="price" placeholder="Price" required><br>
        <input type="text" id="bhk" placeholder="BHK / Service Detail" required><br>
        <select id="ptype" required>
          <option value="">-- Select Category --</option>
          <option>Car</option>
          <option>Bike</option>
          <option>AC</option>
          <option>Electrician</option>
          <option>Plumber</option>
          <option>Painter</option>
          <option>Carpenter</option>
        </select><br>
        <input type="text" id="address" placeholder="Address" required><br>
        <input type="text" id="phone" placeholder="Phone" required><br>
        <select id="posterType" required>
          <option value="Driver">Driver</option>
          <option value="Shopkeeper">Shopkeeper</option>
        </select><br>
        <input type="file" id="images" multiple><br>
        <button type="submit" class="btn btn-good">Submit Post</button>
        <button type="button" onclick="postModal.style.display='none'" class="btn btn-bad">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script>
    const firebaseConfig={
      apiKey:"YOUR_API_KEY",
      authDomain:"YOUR_PROJECT.firebaseapp.com",
      databaseURL:"https://YOUR_PROJECT.firebaseio.com",
      projectId:"YOUR_PROJECT",
      storageBucket:"YOUR_PROJECT.appspot.com",
      messagingSenderId:"SENDER_ID",
      appId:"APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database(), auth=firebase.auth(), storage=firebase.storage();

    const postsEl=document.getElementById('posts'),
          postModal=document.getElementById('postModal'),
          postForm=document.getElementById('postForm'),
          newPostBtn=document.getElementById('newPostBtn'),
          loginBtn=document.getElementById('loginBtn'),
          logoutBtn=document.getElementById('logoutBtn');

    let currentUser=null;

    auth.onAuthStateChanged(user=>{
      currentUser=user;
      if(user){
        loginBtn.style.display='none';
        logoutBtn.style.display='inline-block';
      } else {
        loginBtn.style.display='inline-block';
        logoutBtn.style.display='none';
      }
    });

    loginBtn.onclick=()=>{auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());};
    logoutBtn.onclick=()=>{auth.signOut();};

    // ✅ New Post Button Login Check
    newPostBtn.onclick=()=>{
      if(!currentUser){
        alert("⚠️ Please login first to create a post.");
        return;
      }
      postModal.style.display="flex";
    };

    // Upload images
    async function uploadImages(files){
      let urls=[];
      for(let f of files){
        let ref=storage.ref('images/'+Date.now()+'_'+f.name);
        await ref.put(f);
        urls.push(await ref.getDownloadURL());
      }
      return urls;
    }

    // ✅ Submit Post with Login Check
    postForm.onsubmit=async e=>{
      e.preventDefault();
      if(!currentUser){
        alert("⚠️ You must login before submitting a post.");
        return;
      }
      const submitBtn=postForm.querySelector("button[type=submit]");
      submitBtn.disabled=true; submitBtn.textContent="⏳ Submitting...";

      const post={
        price:document.getElementById('price').value,
        bhk:document.getElementById('bhk').value,
        propertyType:document.getElementById('ptype').value,
        address:document.getElementById('address').value,
        posterPhone:document.getElementById('phone').value,
        posterType:document.getElementById('posterType').value,
        posterName:currentUser.displayName,
        posterUid:currentUser.uid,
        status:"pending",
        created:Date.now()
      };

      const files=document.getElementById('images').files;
      if(files.length>0) post.images=await uploadImages(files);

      db.ref("posts").push(post,(err)=>{
        if(err){ alert("❌ Error"); }
        else{ 
          alert("✅ Post submitted! Waiting for approval."); 
          postForm.reset(); 
          postModal.style.display="none"; 
        }
        submitBtn.disabled=false; submitBtn.textContent="Submit Post";
      });
    };

    // Load posts
    db.ref("posts").on("value",snap=>{
      postsEl.innerHTML='';
      snap.forEach(cs=>{
        const p=cs.val(); p.id=cs.key;
        const card=document.createElement('div'); card.className='card';

        if(p.images && p.images.length>0){
          let img=document.createElement('img');
          img.src=p.images[0]; img.className='preview';
          card.appendChild(img);
        }

        card.innerHTML+=`
          <h3>${p.propertyType} - ${p.bhk}</h3>
          <p><b>₹${p.price}</b></p>
          <p>${p.address}</p>
          <p>📞 ${p.posterPhone}</p>
          <p>👤 ${p.posterName} (${p.posterType})</p>
          <p>Status: ${p.status}</p>
        `;

        const row=document.createElement('div');

        // ✅ Delete Button only if login
        if(currentUser && (currentUser.uid===p.posterUid || currentUser.email==="zarasamajiksevasansth@gmail.com")){
          const del=document.createElement('button');
          del.className='btn btn-bad'; del.textContent='🗑 Delete';
          del.onclick=()=>{if(confirm("Delete this post?")) db.ref("posts/"+p.id).remove();};
          row.appendChild(del);
        }

        card.appendChild(row);
        postsEl.appendChild(card);
      });
    });
  </script>
</body>
</html>
