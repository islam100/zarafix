<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ambulance Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; }
    header { background:linear-gradient(135deg,#ff1744,#ff5252); color:white;
             display:flex; align-items:center; justify-content:space-between;
             padding:10px 20px; box-shadow:0 3px 8px rgba(0,0,0,0.3); }
    header h1 { margin:0; font-size:20px; text-shadow:1px 1px 3px #000; }
    button { cursor:pointer; padding:8px 12px; border:none; border-radius:6px;
             box-shadow:0 3px 5px rgba(0,0,0,0.25); font-weight:bold; margin:3px; font-size:14px; }
    .btn3d { background:#4CAF50; color:#fff; }
    .btn3d:disabled { background:#999; box-shadow:none; }
    .logoutBtn { background:#E53935; color:#fff; }
    .newPostBtn { background:#FF9800; color:#fff; margin-left:10px; }
    .waBtn { background:#25D366; color:#fff; }

    /* Grid */
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
            gap:12px; padding:12px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 3px 5px rgba(0,0,0,0.2);
            padding:12px; position:relative; transition:transform .2s; cursor:pointer; font-size:14px; }
    .card:hover { transform:scale(1.02); }
    .card h3 { margin:6px 0 3px; font-size:16px; color:#d32f2f; }
    .card p { margin:3px 0; font-size:13px; }

    /* Pending Highlight (Red blinking) */
    .pending { background:#ffcdd2; border:2px solid #f44336;
               animation: blinkBorder 1s infinite; }
    @keyframes blinkBorder { 50% { border-color: #b71c1c; } }

    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
             background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:15px; border-radius:10px; width:90%; max-width:420px;
                     max-height:90%; overflow:auto; position:relative; font-size:14px; }
    .close { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; font-size:18px; }

    form label { font-size:13px; font-weight:bold; margin-top:6px; display:block; }
    form input, form select { width:100%; padding:7px; margin:4px 0 10px;
                              border:1px solid #ccc; border-radius:6px; font-size:14px; }
    .btnRow { margin-top:8px; display:flex; flex-wrap:wrap; }
  </style>
</head>
<body>
<header>
  <h1>ðŸš‘ Ambulance Booking</h1>
  <div>
    <button id="loginBtn" class="btn3d">Login</button>
    <button id="logoutBtn" class="logoutBtn" style="display:none;">Logout</button>
    <button id="newPostBtn" class="newPostBtn" style="display:none;">+ Book Ambulance</button>
  </div>
</header>

<main>
  <div class="grid" id="posts"></div>
</main>

<!-- Booking Form Modal -->
<div class="modal" id="postModal">
  <div class="modal-content">
    <span class="close" id="closeForm">&times;</span>
    <h2>Book Ambulance</h2>
    <form id="postForm">
      <label>Patient Name</label>
      <input type="text" id="pname" required>
      <label>Phone</label>
      <input type="tel" id="phone" required>
      <label>Pickup Address</label>
      <input type="text" id="pickup" required>
      <label>Drop Address</label>
      <input type="text" id="drop" required>
      <label>Ambulance Type</label>
      <select id="atype" required>
        <option value="Basic">Basic</option>
        <option value="ICU">ICU</option>
        <option value="Ventilator">Ventilator</option>
      </select>
      <label>Fare (â‚¹)</label>
      <input type="number" id="fare" required>
      <button type="submit" class="btn3d">Submit Booking</button>
    </form>
  </div>
</div>

<!-- Card View Modal -->
<div class="modal" id="cardModal">
  <div class="modal-content" id="cardContent">
    <span class="close" id="closeCard">&times;</span>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTj2n1yhr1sFmuyBZ-jUwOmx1YqAN5QjA",
  authDomain: "property-20d6d.firebaseapp.com",
  databaseURL: "https://property-20d6d-default-rtdb.firebaseio.com",
  projectId: "property-20d6d",
  storageBucket: "property-20d6d.appspot.com",
  messagingSenderId: "916859697394",
  appId: "1:916859697394:web:2a8f9ad2d62f8306dcb86b"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const newPostBtn=document.getElementById('newPostBtn');
const postModal=document.getElementById('postModal');
const closeForm=document.getElementById('closeForm');
const postForm=document.getElementById('postForm');
const postsDiv=document.getElementById('posts');
const cardModal=document.getElementById('cardModal');
const cardContent=document.getElementById('cardContent');
const closeCard=document.getElementById('closeCard');

let currentUser=null;

loginBtn.onclick=()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  currentUser=u;
  if(u){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    newPostBtn.style.display="inline-block";
  } else {
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    newPostBtn.style.display="none";
  }
  loadPosts();
});

newPostBtn.onclick=()=>postModal.style.display="flex";
closeForm.onclick=()=>postModal.style.display="none";
closeCard.onclick=()=>cardModal.style.display="none";

// Post submit
postForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser) return alert("Login first");
  const submitBtn=postForm.querySelector("button[type=submit]");
  submitBtn.disabled=true; submitBtn.textContent="â³ Submitting...";

  const post={
    patientName:document.getElementById('pname').value,
    posterPhone:document.getElementById('phone').value,
    pickup:document.getElementById('pickup').value,
    drop:document.getElementById('drop').value,
    ambulanceType:document.getElementById('atype').value,
    fare:document.getElementById('fare').value,
    posterName:currentUser.displayName,
    posterUid:currentUser.uid,
    status:"pending",
    created:Date.now()
  };

  db.ref("ambulance").push(post,(err)=>{
    if(err){ alert("âŒ Error"); }
    else{ alert("âœ… Booking submitted! Waiting for approval."); postForm.reset(); postModal.style.display="none"; }
    submitBtn.disabled=false; submitBtn.textContent="Submit Booking";
  });
};

// Load posts (latest first)
function loadPosts(){
  db.ref("ambulance").orderByChild("created").on("value",snap=>{
    postsDiv.innerHTML="";
    const arr=[];
    snap.forEach(ch=>{ arr.push({...ch.val(), id:ch.key}); });
    arr.reverse();

    arr.forEach(p=>{
      if(currentUser?.email==="zarasamajiksevasanstha@gmail.com"){
        // admin sees all
      } else {
        if(p.status!=="approved" && (!currentUser || p.posterUid!==currentUser.uid)) return;
      }

      const card=document.createElement("div"); 
      card.className="card";
      if(p.status==="pending") card.classList.add("pending");
      if(p.status==="rejected") card.style.background="#ffe0b2";

      const h3=document.createElement("h3"); h3.textContent=p.ambulanceType+" Ambulance"; card.appendChild(h3);
      const pname=document.createElement("p"); pname.textContent="ðŸ‘¤ Patient: "+p.patientName; card.appendChild(pname);
      const price=document.createElement("p"); price.textContent="ðŸ’° Fare: â‚¹"+p.fare; card.appendChild(price);
      const addr=document.createElement("p"); addr.textContent="ðŸ“ "+p.pickup+" âž "+p.drop; card.appendChild(addr);
      const ph=document.createElement("p"); ph.textContent="ðŸ“ž "+p.posterPhone; card.appendChild(ph);

      const st=document.createElement("p");
      if(p.status==="approved") st.textContent="âœ… Approved";
      else if(p.status==="rejected") st.textContent="âŒ Rejected";
      else st.textContent="â³ Pending Approval";
      card.appendChild(st);

      const btnRow=document.createElement("div"); btnRow.className="btnRow";

      // WhatsApp button
      const wa=document.createElement("button");
      wa.textContent="ðŸ’¬ WhatsApp";
      wa.className="waBtn";
      wa.onclick=(e)=>{
        e.stopPropagation();
        const msg=`Hello, I need details about Ambulance booking.\nPatient: ${p.patientName}\nType: ${p.ambulanceType}\nPickup: ${p.pickup}\nDrop: ${p.drop}\nFare: â‚¹${p.fare}`;
        window.open(`https://wa.me/${p.posterPhone}?text=${encodeURIComponent(msg)}`,"_blank");
      };
      btnRow.appendChild(wa);

      if(currentUser && currentUser.uid===p.posterUid && currentUser.email!=="zarasamajiksevasanstha@gmail.com"){
        const del=document.createElement("button");
        del.textContent="ðŸ—‘ Delete"; del.className="logoutBtn";
        del.onclick=async e=>{ e.stopPropagation(); if(confirm("Delete this booking?")) await db.ref("ambulance/"+p.id).remove(); };
        btnRow.appendChild(del);
      }

      if(currentUser && currentUser.email==="zarasamajiksevasanstha@gmail.com"){
        const ap=document.createElement("button");
        ap.textContent="âœ… Approve"; ap.className="btn3d";
        ap.onclick=async e=>{ e.stopPropagation(); await db.ref("ambulance/"+p.id).update({status:"approved"}); };

        const rj=document.createElement("button");
        rj.textContent="âŒ Reject"; rj.className="logoutBtn";
        rj.onclick=async e=>{ e.stopPropagation(); await db.ref("ambulance/"+p.id).update({status:"rejected"}); };

        const del=document.createElement("button");
        del.textContent="ðŸ—‘ Delete"; del.className="logoutBtn";
        del.onclick=async e=>{ e.stopPropagation(); if(confirm("Delete permanently?")) await db.ref("ambulance/"+p.id).remove(); };

        btnRow.appendChild(ap); btnRow.appendChild(rj); btnRow.appendChild(del);
      }

      card.appendChild(btnRow);

      card.onclick=()=>{ 
        cardContent.innerHTML='<span class="close" id="closeCard">&times;</span>';
        cardContent.innerHTML+=`<h2>${p.ambulanceType} Ambulance</h2>
          <p><b>Patient:</b> ${p.patientName}</p>
          <p><b>Fare:</b> â‚¹${p.fare}</p>
          <p><b>Pickup:</b> ${p.pickup}</p>
          <p><b>Drop:</b> ${p.drop}</p>
          <p><b>Phone:</b> ${p.posterPhone}</p>`;
        cardModal.style.display="flex";
        document.getElementById("closeCard").onclick=()=>cardModal.style.display="none";
      };

      postsDiv.appendChild(card);
    });
  });
}
</script>
</body>
</html>
