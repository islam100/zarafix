<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZaraFix â€“ Ambulance Service</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <div class="p-4 flex justify-between bg-blue-600 text-white">
    <h1 class="text-xl font-bold">ğŸš‘ ZaraFix Ambulance</h1>
    <div>
      <button id="loginBtn" class="px-3 py-1 bg-green-500 rounded">Login with Google</button>
      <button id="logoutBtn" class="px-3 py-1 bg-red-500 rounded hidden">Logout</button>
    </div>
  </div>

  <!-- New Post -->
  <div class="p-4 text-center">
    <button id="newPostBtn" class="px-4 py-2 bg-blue-500 text-white rounded">+ New Post</button>
  </div>

  <!-- Posts -->
  <div id="postsContainer" class="p-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>

  <!-- Modal -->
  <div id="newPostModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded w-96 relative">
      <h2 class="text-lg font-bold mb-4">Create New Post</h2>
      <input id="ambulanceName" placeholder="Ambulance Name" class="border p-2 w-full mb-2"/>
      <input id="ambulanceNumber" placeholder="Ambulance Number" class="border p-2 w-full mb-2"/>
      <input id="driverName" placeholder="Driver Name" class="border p-2 w-full mb-2"/>
      <input id="driverPhone" placeholder="Driver Phone" class="border p-2 w-full mb-2"/>
      <input id="driverWhatsApp" placeholder="Driver WhatsApp" class="border p-2 w-full mb-2"/>
      <input id="charges" placeholder="Charges" class="border p-2 w-full mb-2"/>
      <input id="coverageArea" placeholder="Coverage Area" class="border p-2 w-full mb-2"/>
      <input type="file" id="image" accept="image/*" class="mb-2"/>
      <div class="flex justify-end gap-2">
        <button id="closeModalBtn" class="px-3 py-1 bg-gray-400 rounded">Cancel</button>
        <button id="submitPostBtn" class="px-3 py-1 bg-blue-600 text-white rounded">Submit</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyDuWPxtnSumumis8PJsrwo8BXZl8W_q7w0",
  authDomain: "ambulence-410c0.firebaseapp.com",
  projectId: "ambulence-410c0",
  storageBucket: "ambulence-410c0.appspot.com",
  messagingSenderId: "970590198679",
  appId: "1:970590198679:web:21b1acb30d2a7c09dec2d2"
};


    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const ADMIN_EMAIL = "zarasamajiksevasansth@gmail.com";
    let currentUser = null;

    // Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const newPostBtn = document.getElementById("newPostBtn");
    const newPostModal = document.getElementById("newPostModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const submitPostBtn = document.getElementById("submitPostBtn");
    const postsContainer = document.getElementById("postsContainer");

    // Auth
    loginBtn.onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }
    });

    // Modal
    newPostBtn.onclick = () => {
      if (!currentUser) {
        alert("âš ï¸ Please login first to create a post!");
        return;
      }
      newPostModal.classList.remove("hidden");
    };
    closeModalBtn.onclick = () => newPostModal.classList.add("hidden");

    // Submit post
    submitPostBtn.onclick = async () => {
      if (!currentUser) {
        alert("âš ï¸ You must login before submitting a post.");
        return;
      }

      const ambulanceName = document.getElementById("ambulanceName").value;
      const ambulanceNumber = document.getElementById("ambulanceNumber").value;
      const driverName = document.getElementById("driverName").value;
      const driverPhone = document.getElementById("driverPhone").value;
      const driverWhatsApp = document.getElementById("driverWhatsApp").value;
      const charges = document.getElementById("charges").value;
      const coverageArea = document.getElementById("coverageArea").value;
      const file = document.getElementById("image").files[0];

      let imgUrl = "";
      if (file) {
        const storageRef = storage.ref("ambulance_images/" + Date.now() + "-" + file.name);
        await storageRef.put(file);
        imgUrl = await storageRef.getDownloadURL();
      }

      const postId = db.ref("ambulances").push().key;
      const newPost = {
        ambulanceName,
        ambulanceNumber,
        driverName,
        driverPhone,
        driverWhatsApp,
        charges,
        coverageArea,
        imgUrl,
        status: "pending",
        ownerUid: currentUser.uid,  // âœ… save owner id
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };

      await db.ref("ambulances/" + postId).set(newPost);
      alert("âœ… Post submitted! Waiting for approval.");
      newPostModal.classList.add("hidden");
    };

    // Load posts
    db.ref("ambulances").on("value", snap => {
      postsContainer.innerHTML = "";
      snap.forEach(child => {
        const id = child.key;
        const post = child.val();

        const card = document.createElement("div");
        card.className = "bg-white shadow rounded p-4";

        card.innerHTML = `
          ${post.imgUrl ? `<img src="${post.imgUrl}" class="w-full h-40 object-cover rounded mb-2"/>` : ""}
          <h3 class="font-bold text-lg">${post.ambulanceName} - ${post.ambulanceNumber}</h3>
          <p>ğŸ‘¤ ${post.driverName} (${post.driverPhone})</p>
          <p>ğŸ’¬ WhatsApp: ${post.driverWhatsApp}</p>
          <p>â‚¹ ${post.charges}</p>
          <p>ğŸ“ ${post.coverageArea}</p>
          <p>Status: ${post.status}</p>
        `;

        // âœ… Delete button (only owner or admin)
        if (
          (currentUser && post.ownerUid === currentUser.uid) || 
          (currentUser && currentUser.email === ADMIN_EMAIL)
        ) {
          const delBtn = document.createElement("button");
          delBtn.innerHTML = "ğŸ—‘ Delete";
          delBtn.className = "mt-2 px-3 py-1 bg-red-500 text-white rounded";
          delBtn.onclick = () => {
            if (confirm("Are you sure you want to delete this post?")) {
              db.ref("ambulances/" + id).remove();
            }
          };
          card.appendChild(delBtn);
        }

        // âœ… Approve/Reject buttons (only admin)
        if (currentUser && currentUser.email === ADMIN_EMAIL) {
          const approveBtn = document.createElement("button");
          approveBtn.innerHTML = "âœ… Approve";
          approveBtn.className = "ml-2 px-3 py-1 bg-green-500 text-white rounded";
          approveBtn.onclick = () => db.ref("ambulances/" + id + "/status").set("approved");

          const rejectBtn = document.createElement("button");
          rejectBtn.innerHTML = "âŒ Reject";
          rejectBtn.className = "ml-2 px-3 py-1 bg-yellow-500 text-white rounded";
          rejectBtn.onclick = () => db.ref("ambulances/" + id + "/status").set("rejected");

          card.appendChild(approveBtn);
          card.appendChild(rejectBtn);
        }

        postsContainer.appendChild(card);
      });
    });
  </script>
</body>
</html>
