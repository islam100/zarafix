<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy & Sell Vehicles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ðŸš— ZaraFix Auto Market</h1>
    <div>
      <button id="loginBtn" class="bg-white text-blue-600 px-4 py-1 rounded">Login with Google</button>
      <button id="logoutBtn" class="hidden bg-red-500 px-4 py-1 rounded">Logout</button>
    </div>
  </header>

  <!-- Post Button -->
  <div class="p-4 text-center">
    <button id="postBtn" class="hidden bg-green-600 text-white px-6 py-2 rounded">+ Post Your Vehicle</button>
  </div>

  <!-- Post Modal -->
  <div id="postModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-screen">
      <h2 class="text-lg font-bold mb-4">Post Your Vehicle for Sale</h2>
      <form id="postForm" class="space-y-3">

        <label>Category</label>
        <select id="category" class="w-full border p-2 rounded" required>
          <option value="">Select Category</option>
          <option value="Bike">Bike</option>
          <option value="Car">Car</option>
          <option value="Scooter">Scooter</option>
        </select>

        <label>Subcategory</label>
        <select id="subcategory" class="w-full border p-2 rounded" required>
          <option value="">Select Subcategory</option>
          <option value="New">New</option>
          <option value="Used">Used</option>
          <option value="Electric">Electric</option>
        </select>

        <label>Brand</label>
        <input type="text" id="brand" class="w-full border p-2 rounded" placeholder="e.g. Hero, Honda" required>

        <label>Model</label>
        <input type="text" id="model" class="w-full border p-2 rounded" placeholder="e.g. Splendor+, Swift" required>

        <label>Year</label>
        <input type="number" id="year" class="w-full border p-2 rounded" placeholder="e.g. 2020" required>

        <label>Condition</label>
        <select id="condition" class="w-full border p-2 rounded" required>
          <option value="Excellent">Excellent</option>
          <option value="Good">Good</option>
          <option value="Average">Average</option>
          <option value="Needs Repair">Needs Repair</option>
        </select>

        <label>Price (â‚¹)</label>
        <input type="number" id="price" class="w-full border p-2 rounded" required>

        <label>City / Location</label>
        <input type="text" id="location" class="w-full border p-2 rounded" required>

        <label>Contact Number</label>
        <input type="tel" id="contact" class="w-full border p-2 rounded" required>

        <label>Upload Images (Max 5)</label>
        <input type="file" id="images" class="w-full border p-2 rounded" accept="image/*" multiple required>

        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded w-full">Submit</button>
      </form>
      <button id="closeModal" class="mt-3 w-full bg-gray-400 text-white py-2 rounded">Cancel</button>
    </div>
  </div>

  <!-- Vehicle List -->
  <main class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="vehicleList">
    <!-- Cards will load here -->
  </main>

  <script>
    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAAOYtvC0kiu_vZTYuQ8phPyMqTEFJj9O0",
      authDomain: "new-bike-59133.firebaseapp.com",
      projectId: "new-bike-59133",
      storageBucket: "new-bike-59133.appspot.com",
      messagingSenderId: "966945954091",
      appId: "1:966945954091:web:c1387e3a27af68aef3cd6e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postBtn = document.getElementById("postBtn");
    const postModal = document.getElementById("postModal");
    const closeModal = document.getElementById("closeModal");
    const postForm = document.getElementById("postForm");
    const vehicleList = document.getElementById("vehicleList");

    // ðŸ”¹ Google Login
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        postBtn.classList.remove("hidden");
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        postBtn.classList.add("hidden");
      }
    });

    // ðŸ”¹ Modal Toggle
    postBtn.onclick = () => postModal.classList.remove("hidden");
    closeModal.onclick = () => postModal.classList.add("hidden");

    // ðŸ”¹ ImgBB API Key
    const imgbbApiKey = "4dc5e5cb7654ffc308d5ca45452b014b";

    // ðŸ”¹ Submit Form
    postForm.onsubmit = async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("Login required!");

      const files = document.getElementById("images").files;
      if (files.length > 5) return alert("Max 5 images allowed!");

      // Upload images to ImgBB
      let imageUrls = [];
      for (let file of files) {
        let formData = new FormData();
        formData.append("image", file);
        let res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
          method: "POST",
          body: formData
        });
        let data = await res.json();
        imageUrls.push(data.data.url);
      }

      // Save to Firestore (status=Pending)
      await db.collection("vehicles").add({
        category: document.getElementById("category").value,
        subcategory: document.getElementById("subcategory").value,
        brand: document.getElementById("brand").value,
        model: document.getElementById("model").value,
        year: document.getElementById("year").value,
        condition: document.getElementById("condition").value,
        price: document.getElementById("price").value,
        location: document.getElementById("location").value,
        contact: document.getElementById("contact").value,
        images: imageUrls,
        user: user.email,
        status: "Pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("Posted Successfully! Wait for Admin Approval.");
      postForm.reset();
      postModal.classList.add("hidden");
    };

    // ðŸ”¹ Load Vehicles (Approved Only for public)
    db.collection("vehicles").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      vehicleList.innerHTML = "";
      snapshot.forEach(doc => {
        let v = doc.data();
        if (v.status === "Approved") {
          let card = `
            <div class="bg-white rounded-lg shadow p-3">
              <img src="${v.images[0]}" class="w-full h-40 object-cover rounded">
              <h3 class="font-bold mt-2">${v.brand} ${v.model}</h3>
              <p class="text-sm">${v.year} â€¢ ${v.condition}</p>
              <p class="text-green-600 font-bold">â‚¹${v.price}</p>
              <p class="text-sm text-gray-600">${v.location}</p>
              <p class="text-sm">ðŸ“ž ${v.contact}</p>
            </div>
          `;
          vehicleList.innerHTML += card;
        }
      });
    });
  </script>
</body>
</html>
