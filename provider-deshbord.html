<!DOCTYPE html>
<html>
<head>
  <title>üß∞ ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
    .card {
      background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 16px; margin-bottom: 15px; transition: transform 0.3s;
    }
    .card:hover { transform: scale(1.02); }
    .btn {
      padding: 10px 16px; margin-top: 10px;
      background: #007bff; color: #fff; border: none; border-radius: 6px;
      cursor: pointer; transition: background 0.3s;
    }
    .btn:hover { background: #0056b3; }
    .approved { background: #28a745; color: white; padding: 4px 8px; border-radius: 5px; display: inline-block; }
    #wallet { font-weight: bold; margin-bottom: 15px; }
    .whatsapp { margin-top: 10px; display: inline-block; background: #25D366; color: white; padding: 8px 12px; border-radius: 5px; text-decoration: none; }
  </style>
</head>
<body>
  <h2>üß∞ Poster Dashboard</h2>
  <div id="wallet">Wallet: ‚Çπ0</div>
  <div id="jobs">Loading jobs...</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSy...yourkey...",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "869...",
      appId: "1:869...:web:..."
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUserId = "";

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        loadPosterData(user.uid);
        loadJobs();
        dailyDeduct();
      } else {
        alert("Please login first."); window.location.href = "index.html";
      }
    });

    function loadPosterData(uid) {
      db.ref("posters/" + uid).once("value", snap => {
        if (snap.exists()) {
          document.getElementById("wallet").innerText = "Wallet: ‚Çπ" + (snap.val().wallet || 0);
        }
      });
    }

    function loadJobs() {
      db.ref("requests").once("value", snapshot => {
        document.getElementById("jobs").innerHTML = "";
        snapshot.forEach(userNode => {
          userNode.forEach(job => {
            const data = job.val();
            const jobId = job.key;
            const fullPath = "requests/" + userNode.key + "/" + jobId;

            db.ref("posters/" + currentUserId).once("value", posterSnap => {
              const myCategory = posterSnap.val().category;
              const wallet = posterSnap.val().wallet || 0;

              const alreadyAccepted = (data.acceptedBy && data.acceptedBy[currentUserId]);

              if (data.category === myCategory) {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `
                  <b>${data.name}</b> | ${data.category} <br>
                  üìç ${data.address}<br>
                  üõ†Ô∏è ${data.problem}<br>
                  ${alreadyAccepted ? `<div class='approved'>Approved</div>` : `<button class="btn" onclick="acceptJob('${fullPath}', '${data.whatsapp}')">Accept</button>`}
                  ${alreadyAccepted ? `<br><a class="whatsapp" href="https://wa.me/${data.whatsapp}" target="_blank">üì± WhatsApp</a>` : ""}
                `;
                document.getElementById("jobs").appendChild(div);
              }
            });
          });
        });
      });
    }

    function acceptJob(path, whatsapp) {
      db.ref("posters/" + currentUserId).once("value", snap => {
        const wallet = snap.val().wallet || 0;
        if (wallet < 20) return alert("Low wallet balance. Please recharge.");

        // Deduct ‚Çπ20
        db.ref("posters/" + currentUserId).update({ wallet: wallet - 20 });

        // Mark accepted
        db.ref(path + "/acceptedBy/" + currentUserId).set(true);

        // Reload jobs
        setTimeout(loadJobs, 800);
      });
    }

    function dailyDeduct() {
      const today = new Date().toLocaleDateString("en-CA"); // yyyy-mm-dd
      db.ref("dailyDeduct/" + currentUserId + "/" + today).once("value", snap => {
        if (!snap.exists()) {
          db.ref("posters/" + currentUserId).once("value", userSnap => {
            const wallet = userSnap.val().wallet || 0;
            if (wallet >= 3) {
              db.ref("posters/" + currentUserId).update({ wallet: wallet - 3 });
              db.ref("dailyDeduct/" + currentUserId + "/" + today).set(true);
              loadPosterData(currentUserId);
            }
          });
        }
      });
    }
  </script>
</body>
</html>
