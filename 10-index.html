<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZaraFix — Service Providers</title>
  <style>
    :root{
      --bg:#071428; --card:#0b2a3a; --accent:#06b6d4; --glass: rgba(255,255,255,0.03);
      --btn-shadow: 0 8px 20px rgba(2,6,23,0.6);
      --radius:16px;
      color-scheme: dark;
    }
    html,body{margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#071428 0%, #0b2030 100%);color:#e6eef8;min-height:100vh}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{
      background:linear-gradient(145deg,#0ea5e9,#0369a1);border:none;padding:10px 14px;border-radius:12px;color:white;font-weight:700;cursor:pointer;box-shadow:var(--btn-shadow);
      transform:translateZ(0);transition:transform .12s ease, box-shadow .12s;
    }
    .btn:active{transform:translateY(2px) scale(.995)}
    .btn-secondary{background:linear-gradient(145deg,#f97316,#ef4444)}
    .search-row{display:flex;gap:8px;margin-top:14px;align-items:center}
    input[type=text],textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:inherit;outline:none}
    input[type=file]{color:inherit}
    /* grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:18px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px;border-radius:var(--radius);box-shadow:var(--btn-shadow);cursor:pointer;overflow:hidden;transition:transform .18s, box-shadow .18s;
      display:flex;flex-direction:column;gap:8px;
    }
    .card:hover{transform:translateY(-6px)}
    .thumb{
      width:100%;height:180px;border-radius:12px;object-fit:cover;background:#123;flex-shrink:0;
    }
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .title{font-weight:700;font-size:16px}
    .small{font-size:13px;opacity:.85}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:13px}
    /* expanded detail */
    .expanded-area{display:none;flex-direction:column;gap:10px;margin-top:6px}
    .card.expanded{grid-column:1/-1;transform:scale(1.02)}
    .gallery{display:flex;gap:8px;overflow:auto;padding-bottom:8px}
    .gallery img{height:220px;border-radius:10px;object-fit:contain}
    .details{display:flex;flex-direction:column;gap:6px}
    .muted{opacity:.85;font-size:13px}
    .whatsapp{background:linear-gradient(45deg,#10b981,#059669);padding:10px;border-radius:12px;color:white;border:none;cursor:pointer;font-weight:700}
    .admin-controls{display:flex;gap:8px;flex-wrap:wrap}
    /* form */
    .form-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:14px;box-shadow:var(--btn-shadow);margin-top:12px}
    label{display:block;margin-top:8px;font-size:13px}
    .img-preview{display:flex;gap:8px;overflow:auto;margin-top:8px}
    .img-preview img{width:110px;height:70px;object-fit:cover;border-radius:8px}
    /* small */
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:13px}
    /* responsive tweak */
    @media (max-width:720px){ .gallery img{height:160px} .thumb{height:140px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ZaraFix — Service Providers</h1>
        <div class="muted">Register, Upload profile, Admin approve, Wallet & WhatsApp logic</div>
      </div>
      <div class="controls">
        <div id="walletBadge" class="chip" style="display:none">Wallet: ₹0</div>
        <button id="signInBtn" class="btn">Sign in with Google</button>
        <button id="signOutBtn" class="btn" style="display:none">Logout</button>
      </div>
    </header>

    <div class="search-row">
      <input id="searchBox" type="text" placeholder="Search by name / category / address" style="flex:1"/>
      <div id="loginStatus" class="chip">Not signed</div>
    </div>

    <!-- Post form (visible only when logged-in) -->
    <section id="postSection" style="display:none">
      <form id="providerForm" class="form-card">
        <h3>Post your Service (Providers)</h3>
        <label>Full name <input id="name" type="text" required/></label>
        <label>Mobile number <input id="phone" type="text" required/></label>
        <label>WhatsApp number <input id="whatsapp" type="text" required/></label>
        <label>Email <input id="email" type="email"/></label>
        <label>Business/Service name <input id="businessName" type="text"/></label>
        <label>Category (free text) <input id="category" type="text" placeholder="Electrician, Plumber, Hospital..." /></label>
        <label>Address <textarea id="address"></textarea></label>
        <label>Service hours <input id="hours" type="text" placeholder="09:00 - 20:00"/></label>
        <label>Upload Images (multiple) <input id="images" type="file" accept="image/*" multiple/></label>
        <div id="imgPreview" class="img-preview"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="submitBtn" class="btn">Submit Post</button>
          <button id="myDashboardBtn" type="button" class="btn-secondary">My Dashboard</button>
        </div>
        <div class="muted" style="margin-top:8px">Admin approval required before visible to public. Rejected posts visible only to you & admin.</div>
      </form>
    </section>

    <!-- Dashboard (provider's own) -->
    <section id="dashboardSection" style="display:none;margin-top:12px">
      <div class="form-card">
        <h3>My Dashboard</h3>
        <div id="myInfo" class="muted">Loading...</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="requestRechargeBtn" class="btn">Request Recharge ₹100</button>
          <button id="closeDashboard" class="btn-secondary">Close</button>
        </div>
      </div>
    </section>

    <!-- Listings -->
    <section id="listings" style="margin-top:18px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0;font-size:18px">Provider Listings</h2>
        <div class="muted">Public listings are visible only after admin approval</div>
      </div>
      <div id="cardsGrid" class="grid"></div>
    </section>
  </div>

  <!-- firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
  /********** CONFIG **********/
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ImgBB key (from your message)
  const imgbbKey = 'cad1f0dbfbd25346460789376cc2d7d5';

  // Admin email
  const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

  /********** UI Refs **********/
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const loginStatus = document.getElementById('loginStatus');
  const postSection = document.getElementById('postSection');
  const providerForm = document.getElementById('providerForm');
  const imagesInput = document.getElementById('images');
  const imgPreview = document.getElementById('imgPreview');
  const cardsGrid = document.getElementById('cardsGrid');
  const searchBox = document.getElementById('searchBox');
  const walletBadge = document.getElementById('walletBadge');
  const myDashboardBtn = document.getElementById('myDashboardBtn');
  const dashboardSection = document.getElementById('dashboardSection');
  const myInfo = document.getElementById('myInfo');
  const requestRechargeBtn = document.getElementById('requestRechargeBtn');
  const closeDashboard = document.getElementById('closeDashboard');

  let currentUser = null;         // firebase user
  let providersCache = {};        // keep providers snapshot
  let myProviderId = null;        // if current user has a provider entry

  /********** Auth **********/
  signInBtn.addEventListener('click', async ()=>{
    const p = new firebase.auth.GoogleAuthProvider();
    try{ await auth.signInWithPopup(p); } catch(e){ alert(e.message) }
  });
  signOutBtn.addEventListener('click', ()=>auth.signOut());

  auth.onAuthStateChanged(async user=>{
    currentUser = user;
    if(user){
      signInBtn.style.display='none'; signOutBtn.style.display='inline-block';
      loginStatus.textContent = `${user.email}` + (user.email===ADMIN_EMAIL ? ' (Admin)' : '');
      postSection.style.display = 'block';
      // find if this user already has a provider entry
      const snap = await db.ref('providers').orderByChild('uid').equalTo(user.uid).once('value');
      if(snap.exists()){
        const obj = snap.val();
        myProviderId = Object.keys(obj)[0];
        const p = obj[myProviderId];
        walletBadge.style.display='inline-block';
        walletBadge.textContent = `Wallet: ₹${p.wallet||0}`;
      } else {
        myProviderId = null;
        walletBadge.style.display='none';
      }
    } else {
      signInBtn.style.display='inline-block'; signOutBtn.style.display='none';
      loginStatus.textContent = 'Not signed'; postSection.style.display='none';
      walletBadge.style.display='none';
      myProviderId = null;
    }
  });

  /********** Image preview & upload helper **********/
  imagesInput.addEventListener('change', ()=>{
    imgPreview.innerHTML='';
    const files = [...imagesInput.files].slice(0,6);
    for(const f of files){
      const img = document.createElement('img'); img.src = URL.createObjectURL(f);
      imgPreview.appendChild(img);
    }
  });

  async function uploadToImgBB(file){
    const fd = new FormData();
    fd.append('image', file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {method:'POST', body:fd});
    const data = await res.json();
    if(data && data.success) return data.data.url;
    throw new Error('ImgBB upload failed');
  }

  /********** Submit provider post **********/
  providerForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentUser){ alert('Please sign-in with Google to post'); return; }

    // collect fields
    const payload = {
      uid: currentUser.uid,
      name: document.getElementById('name').value || currentUser.displayName || '',
      phone: document.getElementById('phone').value || '',
      whatsapp: document.getElementById('whatsapp').value || '',
      email: document.getElementById('email').value || currentUser.email || '',
      businessName: document.getElementById('businessName').value || '',
      category: document.getElementById('category').value || '',
      address: document.getElementById('address').value || '',
      hours: document.getElementById('hours').value || '',
      createdAt: Date.now(),
      status: 'pending', // pending | approved | rejected
      wallet: 0,
      images: [],
      ratings: {},
      colorSeed: Math.floor(Math.random()*360)
    };

    // upload images
    const files = [...imagesInput.files].slice(0,8);
    if(files.length){
      for(const f of files){
        try{
          const url = await uploadToImgBB(f);
          payload.images.push(url);
        }catch(err){
          console.warn('image upload failed', err);
        }
      }
    }

    const newRef = db.ref('providers').push();
    await newRef.set(payload);
    alert('Post submitted. Awaiting admin approval.');
    providerForm.reset(); imgPreview.innerHTML='';
  });

  /********** Listen providers realtime **********/
  db.ref('providers').on('value', snap=>{
    providersCache = snap.val() || {};
    renderListings();
  });

  /********** Search filter **********/
  searchBox.addEventListener('input', renderListings);

  /********** Render Listings **********/
  function renderListings(){
    const q = (searchBox.value||'').toLowerCase().trim();
    cardsGrid.innerHTML = '';
    // convert to array with id
    const arr = Object.entries(providersCache).map(([id,p]) => ({id, ...p}));
    // sort recent first
    arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    arr.forEach(p => {
      // visibility: show if approved (public). If not approved/rejected, show only to owner and admin.
      const isOwner = currentUser && currentUser.uid===p.uid;
      const isAdmin = currentUser && currentUser.email===ADMIN_EMAIL;
      const isPublic = p.status === 'approved';
      if(!(isPublic || isOwner || isAdmin)) return;

      // basic card
      const card = document.createElement('div'); card.className='card';
      if(p.status==='rejected'){ card.style.border = '2px solid rgba(240,52,52,0.12)'; card.style.background = 'linear-gradient(180deg, rgba(55,10,10,0.04), rgba(0,0,0,0.02))'; }
      else card.style.background = `linear-gradient(135deg, hsla(${p.colorSeed||0}deg 70% 60% / 0.05), hsla(${((p.colorSeed||0)+40)%360}deg 70% 50% / 0.03))`;

      // thumbnail (first image or placeholder)
      const img = document.createElement('img'); img.className='thumb';
      img.src = (p.images && p.images[0]) ? p.images[0] : 'https://via.placeholder.com/800x450?text=No+Image';
      card.appendChild(img);

      // meta row
      const meta = document.createElement('div'); meta.className='meta';
      const left = document.createElement('div');
      const t = document.createElement('div'); t.className='title'; t.textContent = p.businessName || p.name || 'Service Provider';
      const small = document.createElement('div'); small.className='small'; small.textContent = p.category || '';
      left.appendChild(t); left.appendChild(small);
      meta.appendChild(left);
      // rating summary
      const right = document.createElement('div'); right.className='tags';
      const ratings = p.ratings || {};
      const vals = Object.values(ratings).map(r=>r.score||0);
      const avg = vals.length ? ( (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) ) : '—';
      const rv = document.createElement('div'); rv.className='tag'; rv.textContent = `⭐ ${avg} (${vals.length})`;
      right.appendChild(rv);
      // status tag
      const st = document.createElement('div'); st.className='tag'; st.textContent = p.status==='approved' ? 'Approved' : (p.status==='rejected' ? 'Rejected' : 'Pending');
      right.appendChild(st);
      meta.appendChild(right);

      card.appendChild(meta);

      // collapsed small info
      const short = document.createElement('div'); short.className='muted'; short.textContent = (p.address || '') + ' • ' + (p.hours||'');
      card.appendChild(short);

      // expanded area (hidden by default)
      const expanded = document.createElement('div'); expanded.className='expanded-area';

      // gallery (show all images without crop)
      const gallery = document.createElement('div'); gallery.className='gallery';
      if(p.images && p.images.length){
        p.images.forEach(src=>{
          const gi = document.createElement('img'); gi.src = src; gallery.appendChild(gi);
        });
      } else {
        const gi = document.createElement('img'); gi.src = 'https://via.placeholder.com/1200x700?text=No+Image'; gallery.appendChild(gi);
      }
      expanded.appendChild(gallery);

      // details
      const details = document.createElement('div'); details.className='details';
      const desc = document.createElement('div'); desc.innerHTML = `<b>Address:</b> ${p.address || 'N/A'}`;
      const hrs = document.createElement('div'); hrs.innerHTML = `<b>Hours:</b> ${p.hours || 'N/A'}`;
      details.appendChild(desc); details.appendChild(hrs);

      // WhatsApp button logic & address visibility rules:
      // Conditions to show whatsapp:
      //  - provider must be approved
      //  - provider.wallet >= 100 (poster wallet)
      //  - currentUser must be logged in and have wallet >= 20 (consumer wallet) OR if currentUser is owner or admin, show for testing (owner/admin can see)
      const waContainer = document.createElement('div');
      const showWhatsApp = (() => {
        if(p.status !== 'approved') return false;
        if((p.wallet||0) < 100) return false; // poster wallet check
        if(!currentUser) return false; // encourage login
        if(currentUser.email === ADMIN_EMAIL) return true; // admin can view
        if(currentUser.uid === p.uid) return true; // owner can view
        // check current user's wallet (if they are a provider entry)
        // find current user's provider record if any
        const userProv = Object.entries(providersCache || {}).find(([id,pr]) => pr.uid === currentUser.uid);
        if(!userProv) return false; // not a registered user/provider => require register
        const up = userProv[1];
        if((up.wallet||0) < 20) return false;
        return true;
      })();

      if(showWhatsApp){
        const waBtn = document.createElement('button'); waBtn.className='whatsapp'; waBtn.textContent='WhatsApp Now (₹20)';
        waBtn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          // Ensure logged in
          if(!currentUser){ alert('Login with Google to contact'); return; }
          // Find current user's provider record
          const userProvSnap = await db.ref('providers').orderByChild('uid').equalTo(currentUser.uid).once('value');
          if(!userProvSnap.exists() && !(currentUser.email===ADMIN_EMAIL || currentUser.uid === p.uid)){
            alert('To contact providers you must register (create a provider profile) and have wallet balance ₹20.');
            return;
          }
          let userProvKey = null, userProvData = null;
          if(userProvSnap.exists()){
            userProvKey = Object.keys(userProvSnap.val())[0];
            userProvData = userProvSnap.val()[userProvKey];
          }
          // Admin or owner bypass wallet deduction
          if(!(currentUser.email===ADMIN_EMAIL || currentUser.uid===p.uid)){
            if(!userProvData || (userProvData.wallet||0) < 20){
              alert('Your wallet has insufficient balance. Please request recharge.');
              return;
            }
            // deduct ₹20 from user's wallet atomically (simple set)
            await db.ref(`providers/${userProvKey}/wallet`).set((userProvData.wallet||0) - 20);
          }
          // open wa link
          const phone = p.whatsapp || p.phone || '';
          const text = encodeURIComponent(`Hi ${p.businessName||p.name}, I found you on ZaraFix. I'm contacting regarding your service.`);
          window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
        });
        waContainer.appendChild(waBtn);
      } else {
        // show message about why whatsapp hidden (only to owner/admin show reasons)
        const msg = document.createElement('div'); msg.className='muted';
        if(p.status!=='approved') msg.textContent = 'WhatsApp and address visible after admin approval.';
        else if((p.wallet||0) < 100) msg.textContent = 'WhatsApp hidden: provider wallet < ₹100.';
        else if(!currentUser) msg.textContent = 'Login required to view contact. (Wallet ₹20 required to contact)';
        else {
          // check current user's wallet presence
          const up = Object.entries(providersCache||{}).find(([id,pr])=> pr.uid === (currentUser? currentUser.uid : null));
          if(!up) msg.textContent = 'Register as provider (and have ₹20) to contact.';
          else if((up[1].wallet||0) < 20) msg.textContent = 'Your wallet < ₹20 — recharge to contact.';
          else msg.textContent = '';
        }
        waContainer.appendChild(msg);
      }

      details.appendChild(waContainer);

      // Ratings and review area (submit)
      const ratingArea = document.createElement('div');
      ratingArea.innerHTML = `<div style="margin-top:6px"><b>Leave a rating & review</b></div>`;
      const ratingSelect = document.createElement('select'); [5,4,3,2,1].forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; ratingSelect.appendChild(o); });
      const comment = document.createElement('textarea'); comment.rows=3; comment.style.width='100%'; comment.placeholder='Write feedback...';
      const submitRate = document.createElement('button'); submitRate.className='btn'; submitRate.textContent='Submit Review';
      submitRate.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        if(!currentUser){ alert('Login to submit review'); return; }
        // push rating
        await db.ref(`providers/${p.id}/ratings`).push({score: Number(ratingSelect.value), comment: comment.value||'', by: currentUser.uid, at: Date.now()});
        alert('Thanks for rating!');
        comment.value='';
      });
      ratingArea.appendChild(ratingSelect); ratingArea.appendChild(comment); ratingArea.appendChild(submitRate);
      details.appendChild(ratingArea);

      expanded.appendChild(details);

      // Admin controls (only visible to admin)
      if(currentUser && currentUser.email === ADMIN_EMAIL){
        const adminBox = document.createElement('div'); adminBox.className='admin-controls';
        const apprBtn = document.createElement('button'); apprBtn.className='btn'; apprBtn.textContent = p.status==='approved' ? 'Unapprove' : 'Approve';
        apprBtn.addEventListener('click', async (ev) => { ev.stopPropagation(); const newStatus = p.status==='approved' ? 'pending' : 'approved'; await db.ref(`providers/${p.id}/status`).set(newStatus); if(newStatus==='approved') await db.ref(`providers/${p.id}/approved`).set(true); });
        const rejBtn = document.createElement('button'); rejBtn.className='btn-secondary'; rejBtn.textContent='Reject'; rejBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); await db.ref(`providers/${p.id}/status`).set('rejected'); });
        const delBtn = document.createElement('button'); delBtn.className='btn-secondary'; delBtn.textContent='Delete'; delBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(confirm('Delete permanently?')) await db.ref(`providers/${p.id}`).remove(); });
        adminBox.appendChild(apprBtn); adminBox.appendChild(rejBtn); adminBox.appendChild(delBtn);

        // Show recharge requests for this provider (if any)
        if(p.rechargeRequests){
          Object.entries(p.rechargeRequests).forEach(([rk,rv])=>{
            const rdiv = document.createElement('div'); rdiv.className='tag'; rdiv.style.display='flex'; rdiv.style.alignItems='center'; rdiv.style.gap='8px';
            rdiv.textContent = `Recharge request: ₹${rv.amount} — ${rv.status || 'pending'}`;
            const openProof = document.createElement('button'); openProof.className='btn'; openProof.textContent='Open proof'; openProof.addEventListener('click',(ev)=>{ ev.stopPropagation(); window.open(rv.proofUrl,'_blank'); });
            const approveReq = document.createElement('button'); approveReq.className='btn'; approveReq.textContent='Approve Recharge'; approveReq.addEventListener('click', async (ev)=>{ ev.stopPropagation(); 
              // add amount to provider wallet
              const currentWallet = p.wallet || 0;
              await db.ref(`providers/${p.id}/wallet`).set(currentWallet + (rv.amount||100));
              await db.ref(`providers/${p.id}/rechargeRequests/${rk}/status`).set('approved');
            });
            adminBox.appendChild(rdiv); adminBox.appendChild(openProof); adminBox.appendChild(approveReq);
          });
        }

        expanded.appendChild(adminBox);
      }

      card.appendChild(expanded);

      // toggle expand on click
      card.addEventListener('click', (ev)=>{
        const currently = document.querySelector('.card.expanded');
        if(currently && currently !== card) currently.classList.remove('expanded');
        card.classList.toggle('expanded');
        const exp = card.querySelector('.expanded-area');
        if(card.classList.contains('expanded')) exp.style.display='flex'; else exp.style.display='none';
      });

      // attach to grid based on search filter
      const combined = `${p.businessName||''} ${p.name||''} ${p.category||''} ${p.address||''}`.toLowerCase();
      if(q && !combined.includes(q)) return;
      cardsGrid.appendChild(card);
    });
  }

  /********** Dashboard actions **********/
  myDashboardBtn.addEventListener('click', async ()=>{
    if(!currentUser){ alert('Sign-in to see your dashboard'); return; }
    // find provider entry
    const snap = await db.ref('providers').orderByChild('uid').equalTo(currentUser.uid).once('value');
    if(!snap.exists()){ alert('No provider profile found. Please create a post first.'); return; }
    const key = Object.keys(snap.val())[0];
    const p = snap.val()[key];
    myProviderId = key;
    dashboardSection.style.display='block';
    postSection.style.display='none';
    // show wallet & recent requests
    myInfo.innerHTML = `<div><b>${p.businessName||p.name}</b> — ${p.category||''}</div>
      <div>Wallet: <b>₹${p.wallet||0}</b></div>
      <div>Status: ${p.status || 'pending'}</div>
      <div style="margin-top:6px">Images: ${ (p.images||[]).length } | Created: ${ new Date(p.createdAt||Date.now()).toLocaleString() }</div>`;
  });

  closeDashboard.addEventListener('click', ()=>{ dashboardSection.style.display='none'; postSection.style.display='block'; });

  // Request recharge flow
  requestRechargeBtn.addEventListener('click', async ()=>{
    if(!currentUser){ alert('Login first'); return; }
    // ensure provider exists
    const snap = await db.ref('providers').orderByChild('uid').equalTo(currentUser.uid).once('value');
    if(!snap.exists()){ alert('Create a provider post first'); return; }
    const key = Object.keys(snap.val())[0];

    // pick proof image
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = async ()=> {
      const f = inp.files[0];
      if(!f) return;
      try{
        const url = await uploadToImgBB(f);
        // push recharge request
        await db.ref(`providers/${key}/rechargeRequests`).push({ requestedBy: currentUser.uid, proofUrl: url, amount: 100, status: 'pending', createdAt: Date.now() });
        alert('Recharge request submitted. Admin will review.');
      }catch(e){ alert('Upload failed') }
    };
    inp.click();
  });

  /********** Initial load fallback **********/
  // Keep providersCache up to date via listener (already set above)
  // nothing more required here.

  </script>
</body>
</html>
