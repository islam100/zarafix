<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZaraFix — Providers & Wallet</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#041123; --card:#071426; --muted:#aeb6c7;
      --accent1:#7c5cff; --accent2:#06b6d4; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#021027 0%, #061730 100%);color:#e6eef8}
    .wrap{max-width:1100px;margin:18px auto;padding:14px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
    .brand{font-weight:800;color:var(--accent1);font-size:20px}
    .search{flex:1;min-width:160px}
    input[type="search"], input[type="text"], input[type="tel"], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    button{cursor:pointer;border:none}
    .btn{border-radius:12px;padding:10px 14px;font-weight:700;box-shadow: 0 12px 30px rgba(0,0,0,0.6), inset 0 -3px 0 rgba(255,255,255,0.02)}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#051020}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn-warn{background:linear-gradient(90deg,#f59e0b,#ef4444);color:#2a0b0b}
    .container{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media(min-width:1000px){ .container{grid-template-columns:360px 1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    textarea{min-height:80px;resize:vertical}
    .file-row{display:flex;gap:8px;align-items:center}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    .list{display:grid;gap:14px}
    @media(min-width:700px){ .list{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));} }
    .provider-card{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);box-shadow: 0 12px 30px rgba(0,0,0,0.6)}
    .provider-img{width:100%;height:170px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
    .title-row{display:flex;justify-content:space-between;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .divider{height:1px;background:rgba(255,255,255,0.03);margin:10px 0;border-radius:2px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:13px;padding:6px 8px;border-radius:8px}
    /* color classes for variety */
    .bgA{background:linear-gradient(180deg,#071226,#08162b)} .bgB{background:linear-gradient(180deg,#1a0b14,#0b1220)} .bgC{background:linear-gradient(180deg,#081420,#08202a)} .bgD{background:linear-gradient(180deg,#102015,#071218)}
    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;padding:18px}
    .modal{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;max-width:960px;width:100%;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,0.04)}
    .carousel{position:relative;overflow:hidden;border-radius:10px}
    .carousel img{width:100%;height:360px;object-fit:contain;background:#081226}
    .carousel .nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);cursor:pointer}
    .nav.left{left:10px} .nav.right{right:10px}
    /* 3D button active */
    .btn-3d:active{transform:translateY(2px);box-shadow:0 6px 12px rgba(0,0,0,0.6)}
    /* thumbs */
    .thumbs{display:flex;gap:8px;margin-top:8px;overflow:auto}
    .thumbs img{width:72px;height:56px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.04)}
    /* responsive small images inside card */
    @media(max-width:680px){ .carousel img{height:220px} .provider-img{height:140px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card row">
      <div class="brand">ZaraFix</div>

      <div class="search"><input id="searchInput" type="search" placeholder="Search by name / address / category"></div>

      <div class="chip">Wallet: ₹<span id="walletAmount">0</span></div>

      <button id="rechargeBtn" class="btn btn-ghost small">Request Recharge ₹100</button>
      <button id="loginBtn" class="btn btn-primary btn-3d small">Login with Google</button>
      <button id="logoutBtn" class="btn btn-warn btn-3d small" style="display:none">Logout</button>
    </header>

    <div class="container">
      <!-- Left: Post form + Admin panel -->
      <div>
        <section id="postSection" class="card" style="display:none">
          <h3 style="margin:0 0 8px 0">नई Listing पोस्ट करें</h3>
          <div class="muted">Admin approval के बाद public में दिखेगा।</div>
          <div class="divider"></div>

          <form id="postForm">
            <label>Provider Full Name</label>
            <input id="pf_ownername" type="text" required />

            <label>Mobile Number</label>
            <input id="pf_contact" type="tel" required />

            <label>WhatsApp Number</label>
            <input id="pf_whatsapp" type="tel" required />

            <label>Email (optional)</label>
            <input id="pf_email" type="text" />

            <label>Service / Business Name</label>
            <input id="pf_name" required />

            <label>Category (e.g. Electrician, Doctor — text input)</label>
            <input id="pf_category" placeholder="Doctor, Ambulance, Electrician..." required />

            <label>Address (visible after wallet unlock)</label>
            <textarea id="pf_address" required></textarea>

            <label>Service Hours</label>
            <input id="pf_hours" placeholder="e.g. 9AM - 10PM" />

            <label>Map Location (optional - copy paste lat,lng)</label>
            <input id="pf_map" placeholder="lat,lng (optional)" />

            <label>Upload Images (multiple allowed)</label>
            <div class="file-row">
              <input id="pf_images" type="file" accept="image/*" multiple required />
              <button id="submitBtn" class="btn btn-primary btn-3d" type="submit">Post</button>
            </div>
            <div id="postMsg" class="note"></div>
          </form>
        </section>

        <section id="adminPanel" class="card" style="display:none;margin-top:12px">
          <h3 style="margin:0 0 8px 0">Admin Panel</h3>
          <div class="muted">Recharge Requests & Pending Listings</div>
          <div class="divider"></div>
          <div id="rechargeRequestsList"></div>
          <div id="pendingListings" style="margin-top:12px"></div>
        </section>
      </div>

      <!-- Right: Listings -->
      <div>
        <section class="card">
          <h3 style="margin:0 0 8px 0">Service Providers</h3>
          <div class="muted">Approved listings visible to everyone. WhatsApp/address visible after wallet unlock (₹20).</div>
          <div class="divider"></div>
          <div id="list" class="list"></div>
          <div id="emptyMsg" class="muted" style="margin-top:10px"></div>
        </section>
      </div>
    </div>
  </div>

  <div id="modalRoot"></div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, update, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ----------------- CONFIG -----------------
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    const ADMIN_EMAIL = "zarasamajiksevasanstha@gmail.com";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ----------------- UI refs -----------------
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const postSection = document.getElementById('postSection');
    const postForm = document.getElementById('postForm');
    const postMsg = document.getElementById('postMsg');
    const listEl = document.getElementById('list');
    const emptyMsg = document.getElementById('emptyMsg');
    const walletAmount = document.getElementById('walletAmount');
    const rechargeBtn = document.getElementById('rechargeBtn');
    const searchInput = document.getElementById('searchInput');
    const adminPanel = document.getElementById('adminPanel');
    const rechargeRequestsList = document.getElementById('rechargeRequestsList');
    const pendingListings = document.getElementById('pendingListings');
    const modalRoot = document.getElementById('modalRoot');

    let currentUser = null;
    let isAdmin = false;
    let allListings = [];
    let userUnlocks = {};
    let walletBalance = 0;

    // ----------------- AUTH -----------------
    loginBtn.addEventListener('click', async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){ alert('Login failed: '+ e.message); }
    });
    logoutBtn.addEventListener('click', ()=> signOut(auth));

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      isAdmin = !!(user && user.email === ADMIN_EMAIL);

      loginBtn.style.display = user ? 'none' : '';
      logoutBtn.style.display = user ? '' : 'none';
      postSection.style.display = user ? '' : 'none';
      adminPanel.style.display = (user && isAdmin) ? '' : 'none';

      if (user){
        // ensure wallet exists
        await runTransaction(ref(db, 'wallets/'+user.uid+'/balance'), cur => cur ?? 0);
        onValue(ref(db, 'wallets/'+user.uid+'/balance'), snap => {
          walletBalance = snap.val() ?? 0;
          walletAmount.textContent = walletBalance;
        });
        onValue(ref(db, 'unlocks/'+user.uid), snap => {
          userUnlocks = snap.val() || {};
          render();
        });
      } else {
        walletAmount.textContent = '0';
        userUnlocks = {};
        walletBalance = 0;
      }

      if (isAdmin) loadAdminSections();
      render();
    });

    // ----------------- Post (multi-image) -----------------
    postForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!currentUser) return alert('Login required to post listing');

      try{
        postMsg.textContent = 'Uploading images...';
        const files = Array.from(document.getElementById('pf_images').files || []);
        if (files.length === 0) throw new Error('Please select at least one image');

        const imageUrls = [];
        for (const file of files){
          const path = `listingImages/${currentUser.uid}/${Date.now()}_${file.name}`;
          const sr = sRef(storage, path);
          await uploadBytes(sr, file);
          const url = await getDownloadURL(sr);
          imageUrls.push(url);
        }

        postMsg.textContent = 'Saving listing...';
        const listingRef = push(ref(db, 'listings'));
        const data = {
          id: listingRef.key,
          ownerUid: currentUser.uid,
          ownerName: document.getElementById('pf_ownername').value.trim() || currentUser.displayName || '',
          shopName: document.getElementById('pf_name').value.trim(),
          category: document.getElementById('pf_category').value.trim(),
          address: document.getElementById('pf_address').value.trim(),
          contact: document.getElementById('pf_contact').value.trim(),
          whatsapp: document.getElementById('pf_whatsapp').value.trim(),
          hours: document.getElementById('pf_hours').value.trim(),
          images: imageUrls,
          map: document.getElementById('pf_map').value.trim() || '',
          status: 'waiting',
          createdAt: Date.now()
        };
        await set(listingRef, data);
        postMsg.textContent = 'Submitted! Waiting for admin approval.';
        postForm.reset();
        setTimeout(()=> postMsg.textContent = '', 2500);
      }catch(err){
        console.error(err);
        postMsg.textContent = 'Error: ' + err.message;
        setTimeout(()=> postMsg.textContent = '', 3000);
      }
    });

    // ----------------- Recharge request -----------------
    rechargeBtn.addEventListener('click', async ()=>{
      if (!currentUser) return alert('Login required to request recharge');
      const reqRef = ref(db, 'rechargeRequests/'+currentUser.uid);
      const snap = await get(reqRef);
      if (snap.exists() && snap.val().status === 'pending') return alert('Recharge already requested (pending).');
      await set(reqRef, { amount:100, status:'pending', ts: Date.now(), email: currentUser.email || null });
      alert('Recharge request sent (₹100). Admin will approve.');
    });

    // ----------------- Load listings live -----------------
    onValue(ref(db, 'listings'), snap=>{
      const data = snap.val() || {};
      allListings = Object.values(data).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      render();
    });

    // ----------------- Helpers -----------------
    function matchesSearch(item){
      const q = (searchInput.value||'').toLowerCase().trim();
      if (!q) return true;
      const hay = [item.shopName, item.address, item.category].join(' ').toLowerCase();
      return hay.includes(q);
    }
    function colorClass(i){ return ['bgA','bgB','bgC','bgD'][i%4]; }

    async function handleApprove(id, status){
      await update(ref(db, 'listings/'+id), { status });
    }
    async function handleDelete(id){
      if (!confirm('Delete this listing permanently?')) return;
      await set(ref(db, 'listings/'+id), null);
    }

    async function handleUnlockWhatsApp(listing){
      if (!currentUser) return alert('Login required');
      if (userUnlocks[listing.id]) return openWhatsApp(listing.whatsapp);

      const balRef = ref(db, 'wallets/'+currentUser.uid+'/balance');
      let ok = false;
      await runTransaction(balRef, (cur)=>{
        const balance = cur ?? 0;
        if (balance >= 20) { ok = true; return balance - 20; }
        return cur;
      });
      if (!ok) { alert('Wallet में पर्याप्त राशि नहीं है (₹20 चाहिए)।'); return; }
      await set(ref(db, 'unlocks/'+currentUser.uid+'/'+listing.id), true);
      alert('₹20 कटा और WhatsApp खुल गया।');
      openWhatsApp(listing.whatsapp);
    }
    function openWhatsApp(num){
      const clean = (num||'').replace(/[^0-9+]/g,'').replace(/^\+?0+/, '');
      const url = `https://wa.me/${clean}`;
      window.open(url, '_blank');
    }

    async function submitRating(listingId, stars, text){
      if (!currentUser) return alert('Login required to rate');
      const rRef = ref(db, `ratings/${listingId}/${currentUser.uid}`);
      await set(rRef, { stars, text, ts: Date.now(), user: currentUser.email || currentUser.uid });
    }
    async function getAvgRating(listingId){
      const snap = await get(ref(db, 'ratings/'+listingId));
      if (!snap.exists()) return {avg:0,count:0};
      const vals = Object.values(snap.val());
      const count = vals.length;
      const avg = vals.reduce((a,b)=> a + Number(b.stars||0), 0)/count;
      return {avg, count};
    }

    async function loadAdminSections(){
      onValue(ref(db, 'rechargeRequests'), snap=>{
        rechargeRequestsList.innerHTML = '';
        const data = snap.val() || {};
        const entries = Object.entries(data);
        if (entries.length === 0) rechargeRequestsList.innerHTML = '<div class="muted">No recharge requests</div>';
        for (const [uid, val] of entries){
          const d = document.createElement('div'); d.className='provider-card'; d.style.marginBottom='8px';
          d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>${val.email||uid}</strong><div class="muted">Requested ₹${val.amount} • ${val.status}</div></div>
                        <div class="row"></div></div>`;
          const row = d.querySelector('.row');
          if (val.status === 'pending'){
            const accept = document.createElement('button'); accept.className='btn btn-primary small btn-3d'; accept.textContent='Accept';
            accept.addEventListener('click', ()=> acceptRechargeFor(uid));
            row.appendChild(accept);
          }
          rechargeRequestsList.appendChild(d);
        }
      });

      onValue(ref(db, 'listings'), snap=>{
        pendingListings.innerHTML = '';
        const data = snap.val() || {};
        Object.values(data).filter(it=> it.status === 'waiting' || it.status === 'rejected').forEach(it=>{
          const d = document.createElement('div'); d.className='provider-card'; d.style.marginBottom='8px';
          d.innerHTML = `<strong>${it.shopName}</strong><div class="muted">${it.category} • ${it.status}</div>
            <div class="row" style="margin-top:8px">
              <button class="btn btn-primary small btn-3d">Approve</button>
              <button class="btn btn-warn small btn-3d">Reject</button>
              <button class="btn btn-ghost small btn-3d">Delete</button>
            </div>`;
          d.querySelector('.btn.btn-primary').addEventListener('click', ()=> handleApprove(it.id,'approved'));
          d.querySelector('.btn.btn-warn').addEventListener('click', ()=> handleApprove(it.id,'rejected'));
          d.querySelector('.btn.btn-ghost').addEventListener('click', ()=> handleDelete(it.id));
          pendingListings.appendChild(d);
        });
      });
    }

    async function acceptRechargeFor(uid){
      if(!isAdmin) return;
      const reqRef = ref(db, 'rechargeRequests/'+uid);
      const snap = await get(reqRef);
      if(!snap.exists() || snap.val().status !== 'pending') return alert('No pending');
      await runTransaction(ref(db, 'wallets/'+uid+'/balance'), cur => (cur||0)+100);
      await update(reqRef, { status:'approved', approvedAt: Date.now(), admin: currentUser.email });
      alert('Recharge approved (₹100 added).');
    }

    // ----------------- RENDER -----------------
    async function render(){
      listEl.innerHTML = '';
      const items = allListings.filter(item => {
        if (!matchesSearch(item)) return false;
        if (isAdmin) return true;
        return item.status === 'approved';
      });

      if (items.length === 0) { emptyMsg.textContent = 'कोई listing नहीं मिली।'; return; } else emptyMsg.textContent='';

      for (let i=0;i<items.length;i++){
        const it = items[i];
        const card = document.createElement('div'); card.className = 'provider-card ' + colorClass(i);
        card.style.cursor = 'pointer';

        const {avg, count} = await getAvgRating(it.id);
        const showSensitive = (currentUser && (userUnlocks[it.id] || isAdmin));
        const addrText = showSensitive ? it.address : 'Address hidden (wallet ₹20 required)';
        const waLabel = showSensitive ? `WhatsApp: ${it.whatsapp}` : 'WhatsApp hidden (₹20)';

        const firstImage = (it.images && it.images[0]) ? it.images[0] : '';

        card.innerHTML = `
          <div class="carousel"><img src="${firstImage}" class="provider-img"></div>
          <div class="title-row" style="margin-top:8px">
            <div><h4 style="margin:0">${it.shopName}</h4><div class="muted" style="margin-top:4px">${it.category} • ${it.hours || '—'}</div></div>
            <div class="muted small">${it.status}</div>
          </div>
          <div class="divider"></div>
          <div class="muted">${addrText}</div>
          <div class="muted" style="margin-top:6px">Contact: ${it.contact}</div>
          <div class="muted" style="margin-top:6px">${waLabel}</div>

          <div class="row" style="margin-top:10px">
            <button class="btn btn-3d small callBtn">Call Now</button>
            <button class="btn btn-primary btn-3d small waBtn">WhatsApp Now</button>
            <button class="btn btn-ghost small btn-3d viewBtn">View</button>
          </div>

          <div class="divider"></div>
          <div class="row" style="align-items:center">
            <div class="muted">⭐ ${avg.toFixed(1)} (${count})</div>
            <input class="rateInput small" type="number" min="1" max="5" placeholder="1-5" style="width:70px">
            <input class="rateText" placeholder="Feedback (optional)" style="flex:1;padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
            <button class="btn btn-ghost btn-3d small rateBtn">Rate</button>
          </div>
        `;

        // admin controls on card
        if (isAdmin){
          const adminBar = document.createElement('div'); adminBar.className='row'; adminBar.style.marginTop='8px';
          adminBar.innerHTML = `<button class="btn btn-primary small btn-3d">Approve</button>
                                <button class="btn btn-warn small btn-3d">Reject</button>
                                <button class="btn btn-ghost small btn-3d">Delete</button>`;
          adminBar.querySelector('.btn.btn-primary').addEventListener('click', (ev)=>{ ev.stopPropagation(); handleApprove(it.id,'approved'); });
          adminBar.querySelector('.btn.btn-warn').addEventListener('click', (ev)=>{ ev.stopPropagation(); handleApprove(it.id,'rejected'); });
          adminBar.querySelector('.btn.btn-ghost').addEventListener('click', (ev)=>{ ev.stopPropagation(); handleDelete(it.id); });
          card.appendChild(adminBar);
        }

        // button handlers
        card.querySelector('.callBtn').addEventListener('click', (ev)=>{ ev.stopPropagation(); window.location.href = `tel:${it.contact}`; });
        card.querySelector('.waBtn').addEventListener('click', (ev)=>{ ev.stopPropagation(); if (isAdmin) openWhatsApp(it.whatsapp); else handleUnlockWhatsApp(it); });
        card.querySelector('.rateBtn').addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          const n = Number(card.querySelector('.rateInput').value||0);
          const tx = card.querySelector('.rateText').value||'';
          if (n < 1 || n > 5) return alert('Stars must be 1-5');
          await submitRating(it.id, n, tx);
          alert('Thanks for feedback!');
          render();
        });

        // view button opens modal with carousel of all images
        card.querySelector('.viewBtn').addEventListener('click', (ev)=>{ ev.stopPropagation(); openCardModal(it); });

        // also click on card opens modal
        card.addEventListener('click', (e)=>{ if (e.target.closest('button') || e.target.closest('input')) return; openCardModal(it); });

        listEl.appendChild(card);
      }
    }

    // ----------------- Modal / Carousel -----------------
    function openCardModal(it){
      const overlay = document.createElement('div'); overlay.className='overlay';
      const modal = document.createElement('div'); modal.className='modal';
      let current = 0;
      const images = it.images || [];

      function build(){
        modal.innerHTML = '';
        const closeBtn = document.createElement('button'); closeBtn.className='close btn btn-ghost'; closeBtn.textContent='Close';
        closeBtn.addEventListener('click', ()=> document.body.removeChild(overlay));

        const carousel = document.createElement('div'); carousel.className='carousel';
        const img = document.createElement('img'); img.src = images[current] || '';
        carousel.appendChild(img);

        if (images.length > 1){
          const left = document.createElement('div'); left.className='nav left'; left.innerHTML='◀';
          const right = document.createElement('div'); right.className='nav right'; right.innerHTML='▶';
          left.addEventListener('click', ()=> { current = (current-1+images.length)%images.length; img.src = images[current]; updateThumbs();});
          right.addEventListener('click', ()=> { current = (current+1)%images.length; img.src = images[current]; updateThumbs();});
          carousel.appendChild(left); carousel.appendChild(right);
        }

        const title = document.createElement('h2'); title.textContent = it.shopName;
        const cat = document.createElement('div'); cat.className='muted'; cat.textContent = `${it.category} • ${it.hours || ''}`;
        const divider = document.createElement('div'); divider.className='divider';
        const addr = document.createElement('div'); addr.innerHTML = `<strong>Address:</strong> <span class="muted">${it.address}</span>`;
        const contact = document.createElement('div'); contact.innerHTML = `<strong>Contact:</strong> <span class="muted">${it.contact}</span>`;
        const whatsapp = document.createElement('div'); whatsapp.innerHTML = `<strong>WhatsApp:</strong> <span class="muted">${it.whatsapp}</span>`;

        const thumbs = document.createElement('div'); thumbs.className='thumbs';
        function updateThumbs(){
          thumbs.innerHTML=''; images.forEach((u,idx)=>{
            const t = document.createElement('img'); t.src = u; t.addEventListener('click', ()=>{ current = idx; img.src = images[current]; });
            thumbs.appendChild(t);
          });
        }
        updateThumbs();

        modal.appendChild(closeBtn);
        modal.appendChild(carousel);
        modal.appendChild(title);
        modal.appendChild(cat);
        modal.appendChild(divider);
        modal.appendChild(addr);
        modal.appendChild(contact);
        modal.appendChild(whatsapp);
        modal.appendChild(thumbs);

        // admin actions in modal too
        if (isAdmin){
          const adminRow = document.createElement('div'); adminRow.className='row'; adminRow.style.marginTop='8px';
          const ap = document.createElement('button'); ap.className='btn btn-primary small btn-3d'; ap.textContent='Approve';
          const rj = document.createElement('button'); rj.className='btn btn-warn small btn-3d'; rj.textContent='Reject';
          const dl = document.createElement('button'); dl.className='btn btn-ghost small btn-3d'; dl.textContent='Delete';
          ap.addEventListener('click', ()=> handleApprove(it.id,'approved'));
          rj.addEventListener('click', ()=> handleApprove(it.id,'rejected'));
          dl.addEventListener('click', ()=> handleDelete(it.id));
          adminRow.appendChild(ap); adminRow.appendChild(rj); adminRow.appendChild(dl);
          modal.appendChild(adminRow);
        }
      }

      build();

      overlay.appendChild(modal);
      overlay.addEventListener('click', (e)=>{ if (e.target === overlay) document.body.removeChild(overlay); });
      document.body.appendChild(overlay);
    }

    // ----------------- search handler -----------------
    searchInput.addEventListener('input', ()=> render());

    // ----------------- Done -----------------
  </script>
</body>
</html>
