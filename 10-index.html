<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZaraFix - Service Provider Portal</title>
  <style>
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    body{margin:0;background:linear-gradient(135deg,#f7f8fc,#eef6ff);min-height:100vh;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(45deg,#ff9a9e,#fad0c4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn-3d{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 8px 0 rgba(0,0,0,.12);transform:translateY(0);transition:all .12s ease;font-weight:700}
    .btn-3d:active{transform:translateY(6px);box-shadow:0 2px 0 rgba(0,0,0,.08)}
    .btn-primary{background:linear-gradient(135deg,#6dd3ff,#6d9bff);color:#03204c}
    .btn-success{background:linear-gradient(135deg,#7ef7a0,#34d399);color:#04321a}
    .btn-danger{background:linear-gradient(135deg,#ff9a9e,#ff7b7b);color:#3b0000}
    main{margin-top:16px;display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr} .side{order:2}}
    .panel{background:#fff;padding:14px;border-radius:14px;box-shadow:0 12px 40px rgba(20,30,60,.06)}
    form .row{display:flex;gap:8px;margin-bottom:8px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text], input[type=email], input[type=tel], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef7}
    input[type=file]{padding:6px}
    textarea{min-height:70px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,#ffffff,#fbfdff);padding:12px;border-radius:16px;position:relative;overflow:hidden;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease}
    .card:active{transform:translateY(6px)}
    .card.expanded{grid-column:1/-1;transform:scale(1.02);box-shadow:0 30px 60px rgba(10,20,50,.12)}
    .top{display:flex;gap:12px;align-items:flex-start}
    .avatar{width:110px;height:110px;border-radius:12px;overflow:hidden;flex:0 0 110px}
    .avatar img{width:100%;height:100%;object-fit:contain}
    .info{flex:1}
    .name{font-weight:800;font-size:16px;margin-bottom:6px}
    .meta{font-size:13px;color:#556}
    .images{display:flex;gap:8px;margin-top:10px}
    .images img{width:80px;height:80px;border-radius:10px;object-fit:contain}
    .admin-controls{position:absolute;top:10px;right:10px;display:flex;gap:6px}
    .wallet{background:linear-gradient(135deg,#fff7cc,#fff1d6);padding:10px;border-radius:12px}
    .search{display:flex;gap:8px;margin-bottom:10px}
    .search input{flex:1;padding:10px;border-radius:12px;border:1px solid #e6eef7}
    .reviews{margin-top:8px}
    .review{background:#fbfbff;padding:8px;border-radius:8px;margin-bottom:6px}
    @media(max-width:520px){.avatar{width:88px;height:88px;flex:0 0 88px}.images img{width:60px;height:60px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ZF</div>
      <div>
        <h1>ZaraFix - Service Providers</h1>
        <div style="font-size:13px;color:#556">Mobile-first • 3D buttons • Direct image upload</div>
      </div>
    </div>

    <div class="controls">
      <button id="btn-login" class="btn-3d btn-primary">Google Login</button>
      <button id="btn-logout" class="btn-3d btn-danger" style="display:none">Logout</button>
      <button id="showForm" class="btn-3d btn-success" style="display:none">Post Service</button>
      <button id="showList" class="btn-3d" style="background:linear-gradient(135deg,#ffd6a5,#ffc6ff)">View Listings</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="search">
        <input id="searchBox" placeholder="Search name, category, address... (no dropdown)" />
        <button id="clearSearch" class="btn-3d">Clear</button>
      </div>

      <div id="cards" class="cards"></div>
    </section>

    <aside class="side panel">
      <div id="authInfo">Not logged in</div>

      <div id="formWrap" style="margin-top:12px;display:none">
        <h3>Create / Update Provider</h3>
        <form id="providerForm">
          <div class="row"><div style="flex:1"><label>Full Name</label><input id="p_name" type="text" required></div></div>
          <div class="row"><div style="flex:1"><label>Mobile (for contact)</label><input id="p_mobile" type="tel" required></div></div>
          <div class="row"><div style="flex:1"><label>WhatsApp Number</label><input id="p_whatsapp" type="tel"></div></div>
          <div class="row"><div style="flex:1"><label>Email</label><input id="p_email" type="email"></div></div>

          <div class="row"><div style="flex:1"><label>Service / Business Name</label><input id="p_service" type="text" required></div></div>
          <div class="row"><div style="flex:1"><label>Category / Services (no dropdown)</label><input id="p_category" type="text" placeholder="eg: Plumber, Electrician, Ambulance"></div></div>

          <div class="row"><div style="flex:1"><label>Address</label><input id="p_address" type="text"></div></div>
          <div class="row"><div style="flex:1"><label>Map Location (optional)</label><input id="p_map" type="text" placeholder="Lat,Lng or leave to auto-detect"></div></div>
          <div class="row"><div style="flex:1"><label>Service Hours</label><input id="p_hours" type="text" placeholder="eg: 09:00 - 21:00"></div></div>

          <div class="row"><div style="flex:1"><label>Upload Shop Photos (multiple) — images will be uploaded (not URL)</label><input id="p_images" type="file" accept="image/*" multiple></div></div>

          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-3d btn-primary">Save</button>
            <button id="btn-geoloc" type="button" class="btn-3d">Auto-detect Location</button>
          </div>
        </form>

        <div style="margin-top:10px;font-size:13px;color:#556">Admin ( <strong>zarasamajiksevasanstha@gmail.com</strong> ) will approve listings.</div>
      </div>

      <!-- Wallet: will be shown only when user is logged in (controlled via JS) -->
      <div id="walletBox" style="margin-top:12px;display:none">
        <h3>Wallet</h3>
        <div class="wallet">Balance: <span id="walletAmt">0</span> ₹</div>
        <div style="margin-top:10px"><button id="reqRecharge" class="btn-3d">Request ₹100 Recharge</button></div>
      </div>

      <div id="adminPanel" style="margin-top:18px;display:none">
        <h3>Admin Panel</h3>
        <div id="rechargeRequests"></div>
      </div>
    </aside>
  </main>

  <footer style="margin-top:14px"><small>Built for ZaraFix — Replace API keys before public deployment.</small></footer>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };

    const IMGBB_KEY = 'cad1f0dbfbd25346460789376cc2d7d5';
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    // Elements
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const authInfo = document.getElementById('authInfo');
    const showForm = document.getElementById('showForm');
    const formWrap = document.getElementById('formWrap');
    const providerForm = document.getElementById('providerForm');
    const cardsWrap = document.getElementById('cards');
    const walletBox = document.getElementById('walletBox');
    const walletAmt = document.getElementById('walletAmt');
    const reqRecharge = document.getElementById('reqRecharge');
    const adminPanel = document.getElementById('adminPanel');
    const rechargeRequests = document.getElementById('rechargeRequests');
    const searchBox = document.getElementById('searchBox');
    const clearSearch = document.getElementById('clearSearch');

    let currentUser = null;
    let myProviderRecord = null;

    // Login/Logout
    btnLogin.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); } catch (e) { alert(e.message); }
    });
    btnLogout.addEventListener('click', () => auth.signOut());

    // Show form toggle (needs login)
    showForm.addEventListener('click', () => {
      if (!currentUser) { alert('Please login first'); return; }
      formWrap.style.display = formWrap.style.display === 'none' ? 'block' : 'none';
    });

    // Geolocation helper
    document.getElementById('btn-geoloc').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(p => {
          document.getElementById('p_map').value = p.coords.latitude.toFixed(6) + ',' + p.coords.longitude.toFixed(6);
        }, () => alert('Could not get location'));
      } else alert('Geolocation not supported');
    });

    // Auth state: show/hide wallet and admin panel based on login
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        authInfo.innerHTML = `<strong>${user.displayName}</strong><div style="font-size:13px;color:#556">${user.email}</div>`;
        btnLogin.style.display = 'none'; btnLogout.style.display = 'inline-block'; showForm.style.display = 'inline-block';
        document.getElementById('p_email').value = user.email;

        // load provider record (if exists) to get wallet
        const snap = await db.ref('providers').orderByChild('ownerUid').equalTo(user.uid).once('value');
        myProviderRecord = null;
        snap.forEach(c => { myProviderRecord = { key: c.key, ...c.val() }; });
        walletAmt.textContent = (myProviderRecord && myProviderRecord.wallet) ? myProviderRecord.wallet : 0;

        // show wallet only when logged in
        walletBox.style.display = 'block';

        // admin panel?
        adminPanel.style.display = (user.email === ADMIN_EMAIL) ? 'block' : 'none';
      } else {
        authInfo.innerText = 'Not logged in';
        btnLogin.style.display = 'inline-block'; btnLogout.style.display = 'none'; showForm.style.display = 'none';
        walletBox.style.display = 'none'; // hide wallet when not logged in
        adminPanel.style.display = 'none';
        walletAmt.textContent = '0';
        myProviderRecord = null;
      }

      // re-render providers to reflect visibility (owner/admin)
      renderProviders(searchBox.value);
    });

    // Save provider (create listing)
    providerForm.addEventListener('submit', async e => {
      e.preventDefault();
      if (!currentUser) { alert('Login first'); return; }

      const data = {
        ownerUid: currentUser.uid,
        ownerName: document.getElementById('p_name').value.trim(),
        mobile: document.getElementById('p_mobile').value.trim(),
        whatsapp: document.getElementById('p_whatsapp').value.trim(),
        email: document.getElementById('p_email').value.trim() || currentUser.email,
        service: document.getElementById('p_service').value.trim(),
        category: document.getElementById('p_category').value.trim(),
        address: document.getElementById('p_address').value.trim(),
        map: document.getElementById('p_map') ? document.getElementById('p_map').value.trim() : '',
        hours: document.getElementById('p_hours').value.trim(),
        approved: false,
        rejected: false,
        wallet: 0,
        createdAt: Date.now()
      };

      // upload images to ImgBB
      const files = document.getElementById('p_images').files;
      const urls = [];
      if (files && files.length) {
        for (let i = 0; i < files.length; i++) {
          const fd = new FormData(); fd.append('image', files[i]);
          try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
            const j = await res.json();
            if (j && j.data && j.data.url) urls.push(j.data.url);
          } catch (err) { console.warn('imgbb fail', err); }
        }
      }
      if (urls.length) { data.images = urls; data.avatar = urls[0]; }

      const newRef = db.ref('providers').push();
      await newRef.set(data);
      alert('Submitted for admin approval');
      providerForm.reset();
    });

    // Recharge request
    reqRecharge.addEventListener('click', async () => {
      if (!currentUser) { alert('Login first'); return; }
      const snap = await db.ref('providers').orderByChild('ownerUid').equalTo(currentUser.uid).once('value');
      let key = null; snap.forEach(c => { key = c.key; });
      if (!key) { alert('You must create a provider listing first to request recharge'); return; }

      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
      input.onchange = async () => {
        const file = input.files[0]; if (!file) return;
        const fd = new FormData(); fd.append('image', file);
        try {
          const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
          const j = await res.json(); const img = j.data && j.data.url ? j.data.url : '';
          const reqRef = db.ref('rechargeRequests').push();
          await reqRef.set({ ownerUid: currentUser.uid, providerKey: key, screenshot: img || '', status: 'pending', requestedAt: Date.now() });
          alert('Recharge request sent to admin');
        } catch (e) { alert('Upload failed'); }
      };
      input.click();
    });

    // Admin listens for rechargeRequests
    db.ref('rechargeRequests').on('value', snap => {
      rechargeRequests.innerHTML = '';
      snap.forEach(c => {
        const r = c.val(); const k = c.key;
        const div = document.createElement('div'); div.className = 'panel'; div.style.marginBottom = '8px';
        div.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div><strong>Recharge</strong><div style='font-size:13px;color:#556'>by ${r.ownerUid}</div></div>
            <div style='display:flex;gap:8px'>
              <button class='btn-3d btn-success' data-accept='${k}'>Accept ₹100</button>
              <button class='btn-3d btn-danger' data-reject='${k}'>Reject</button>
            </div>
          </div>
          <div style='margin-top:8px'>Screenshot: ${r.screenshot ? `<img src="${r.screenshot}" style='width:100%;border-radius:8px'/>` : 'No image'}</div>
        `;
        rechargeRequests.appendChild(div);
      });
    });

    // Admin actions for recharge requests
    rechargeRequests.addEventListener('click', async e => {
      const acc = e.target.dataset.accept; const rej = e.target.dataset.reject;
      if (acc) {
        const k = acc; const rSnap = await db.ref('rechargeRequests/' + k).once('value'); const r = rSnap.val();
        if (!r) return; const providerKey = r.providerKey; const pSnap = await db.ref('providers/' + providerKey).once('value'); if (!pSnap.exists()) return alert('provider not found');
        const p = pSnap.val(); const newAmt = (p.wallet || 0) + 100; await db.ref('providers/' + providerKey + '/wallet').set(newAmt);
        await db.ref('rechargeRequests/' + k + '/status').set('accepted'); alert('Recharged ₹100');
      }
      if (rej) {
        const k = rej; await db.ref('rechargeRequests/' + k + '/status').set('rejected'); alert('Marked rejected');
      }
    });

    // Render providers with visibility rules
    function renderProviders(filterText = '') {
      db.ref('providers').on('value', snap => {
        cardsWrap.innerHTML = '';
        const list = [];
        snap.forEach(c => { const d = c.val(); d._key = c.key; list.push(d); });
        const ft = filterText.trim().toLowerCase();

        list.sort((a, b) => b.createdAt - a.createdAt).forEach(p => {
          const amIadmin = currentUser && currentUser.email === ADMIN_EMAIL;
          const amIowner = currentUser && currentUser.uid === p.ownerUid;
          // public should see only approved
          if (!p.approved && !amIadmin && !amIowner) return;
          if (p.rejected && !amIadmin && !amIowner) return;
          // filter text
          if (ft) {
            const hay = ((p.service || '') + ' ' + (p.category || '') + ' ' + (p.address || '') + ' ' + (p.ownerName || '')).toLowerCase();
            if (!hay.includes(ft)) return;
          }

          const card = document.createElement('div'); card.className = 'card';
          if (p.rejected) card.style.background = 'linear-gradient(90deg,#fff0f0,#fff5f5)';

          const adminButtons = (currentUser && currentUser.email === ADMIN_EMAIL) ? `
            <div class='admin-controls'>
              <button class='btn-3d btn-success' data-approve='${p._key}'>Approve</button>
              <button class='btn-3d btn-danger' data-reject='${p._key}'>Reject</button>
              <button class='btn-3d' data-delete='${p._key}'>Delete</button>
            </div>` : '';

          const viewerIsOwnerOrAdmin = currentUser && (currentUser.uid === p.ownerUid || currentUser.email === ADMIN_EMAIL);

          let contactHtml = '';
          if (viewerIsOwnerOrAdmin) {
            contactHtml = `<button class='btn-3d' data-wa='${p._key}'>WhatsApp Now</button>
                           <a class='btn-3d' href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address || '')}' target='_blank'>Address</a>`;
          } else if (p.approved) {
            // For public/by other providers: show locked message (actual clicking will check caller's wallet)
            contactHtml = `<div class='chip'>WhatsApp locked (login & have ₹20 wallet to contact)</div>`;
          } else {
            contactHtml = `<div class='chip'>Listing not public yet</div>`;
          }

          card.innerHTML = `
            ${adminButtons}
            <div class="top">
              <div class='avatar'><img src='${(p.avatar || 'https://via.placeholder.com/110')}' alt='shop photo'/></div>
              <div class='info'>
                <div class='name'>${escapeHtml(p.service)} <span style='font-size:12px;color:#777'>(${escapeHtml(p.ownerName || '')})</span></div>
                <div class='meta'><strong>Category:</strong> ${escapeHtml(p.category || '')} • <strong>Hours:</strong> ${escapeHtml(p.hours || '')}</div>
                <div class='meta' style='margin-top:6px'><strong>Status:</strong> ${p.approved ? '<span style="color:green">Approved</span>' : p.rejected ? '<span style="color:crimson">Rejected</span>' : 'Pending'}</div>
                <div style='margin-top:8px'>${escapeHtml(p.address || '')}</div>
                <div style='margin-top:8px'>${contactHtml}</div>
              </div>
            </div>
            <div class='images'>${(p.images || []).map(u => `<img src='${u}' alt='photo'/>`).join('')}</div>
            <div class='actions'><button class='btn-3d' data-rate='${p._key}'>Rate</button></div>
            <div class='reviews' id='reviews_${p._key}'></div>
          `;

          // Expand on card click (ignore clicks on inner buttons)
          card.addEventListener('click', (ev) => {
            if (ev.target.closest('[data-approve],[data-reject],[data-delete],[data-wa],[data-rate]')) return;
            card.classList.toggle('expanded');
          });

          // Admin buttons
          card.querySelectorAll('[data-approve]').forEach(b => b.addEventListener('click', async (ev) => {
            ev.stopPropagation(); const k = b.dataset.approve; await db.ref('providers/' + k + '/approved').set(true); await db.ref('providers/' + k + '/rejected').set(false);
          }));
          card.querySelectorAll('[data-reject]').forEach(b => b.addEventListener('click', async (ev) => {
            ev.stopPropagation(); const k = b.dataset.reject; await db.ref('providers/' + k + '/rejected').set(true); await db.ref('providers/' + k + '/approved').set(false);
          }));
          card.querySelectorAll('[data-delete]').forEach(b => b.addEventListener('click', async (ev) => {
            ev.stopPropagation(); if (confirm('Delete permanently?')) { const k = b.dataset.delete; await db.ref('providers/' + k).remove(); }
          }));

          // WhatsApp contact: clicking user must have wallet >=20 (we deduct ₹20)
          card.querySelectorAll('[data-wa]').forEach(b => b.addEventListener('click', async (ev) => {
            ev.stopPropagation(); const k = b.dataset.wa; const pSnap = await db.ref('providers/' + k).once('value'); const pdata = pSnap.val();
            if (!currentUser) { alert('Login to contact'); return; }

            // get caller's provider record
            const mySnap = await db.ref('providers').orderByChild('ownerUid').equalTo(currentUser.uid).once('value');
            let myKey = null, myData = null; mySnap.forEach(c => { myKey = c.key; myData = c.val(); });
            if (!myKey) { alert('You need a provider account to contact. Create listing & wallet first.'); return; }
            if ((myData.wallet || 0) < 20) { alert('Wallet low — please request recharge ₹100'); return; }

            // deduct ₹20
            const newAmt = (myData.wallet || 0) - 20; await db.ref('providers/' + myKey + '/wallet').set(newAmt);

            const wa = pdata.whatsapp || pdata.mobile || '';
            const num = wa.replace(/\D/g, '');
            const text = encodeURIComponent('Hello, I saw your listing on ZaraFix');
            window.open(`https://wa.me/${num}?text=${text}`, '_blank');
          }));

          // Rating
          card.querySelectorAll('[data-rate]').forEach(b => b.addEventListener('click', async (ev) => {
            ev.stopPropagation(); const k = b.dataset.rate; const score = prompt('Rate 1-5 (stars)'); const note = prompt('Feedback (optional)'); const s = parseInt(score || '0');
            if (!s || s < 1 || s > 5) return alert('Invalid rating'); const rRef = db.ref('providers/' + k + '/reviews').push(); await rRef.set({ score: s, note: note || '', by: currentUser ? currentUser.uid : 'guest', at: Date.now() }); alert('Thanks for rating');
          }));

          // Watch reviews
          const rv = card.querySelector('#reviews_' + p._key);
          db.ref('providers/' + p._key + '/reviews').on('value', s => {
            rv.innerHTML = '';
            s.forEach(r => {
              const v = r.val(); const div = document.createElement('div'); div.className = 'review';
              div.innerHTML = `<div><strong>${'⭐'.repeat(v.score || 0)}</strong></div><div style='font-size:13px;color:#334'>${escapeHtml(v.note || '')}</div>`;
              rv.appendChild(div);
            });
          });

          cardsWrap.appendChild(card);
        });
      });
    }

    // initial render + search handlers
    renderProviders();
    searchBox.addEventListener('input', () => { renderProviders(searchBox.value); });
    clearSearch.addEventListener('click', () => { searchBox.value = ''; renderProviders(); });

    // escape helper
    function escapeHtml(s) { if (!s) return ''; return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
  </script>
</body>
</html>
