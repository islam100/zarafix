<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZaraFix | Service Providers + Wallet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 3D buttons + card colors */
    .btn-3d{box-shadow:0 6px 0 rgba(0,0,0,.18);transform:translateY(-2px);transition:all .12s}
    .btn-3d:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(0,0,0,.12)}
    .card-3d{box-shadow:0 10px 20px rgba(0,0,0,.08);border-radius:16px;padding:12px}
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">ZaraFix | Service Providers</h1>
      <div class="space-x-2">
        <button id="btn-login" class="px-4 py-2 bg-blue-500 text-white rounded btn-3d">Login with Google</button>
        <button id="btn-logout" class="px-4 py-2 bg-red-500 text-white rounded btn-3d hidden">Logout</button>
      </div>
    </header>

    <!-- Notices -->
    <div id="admin-panel" class="mb-4 p-3 bg-white rounded shadow hidden">
      <h2 class="font-semibold">Admin Panel (zarasamajiksevasanstha@gmail.com)</h2>
      <div class="mt-2 space-y-2">
        <div id="recharge-requests"></div>
        <div id="provider-approvals"></div>
      </div>
    </div>

    <!-- Post form (visible when logged in) -->
    <div id="post-form" class="mb-6 p-4 bg-white rounded shadow hidden">
      <h2 class="font-semibold mb-2">Post Service Provider</h2>
      <form id="providerForm" class="space-y-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="name" placeholder="Full Name" class="p-2 border rounded" />
          <input required name="mobile" placeholder="Mobile Number" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="business" placeholder="Service/Business Name" class="p-2 border rounded" />
          <input required name="email" placeholder="Email" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="category" placeholder="Category (Doctor, Hospital, Electrician...)" class="p-2 border rounded" />
          <input required name="whatsapp" placeholder="WhatsApp Number" class="p-2 border rounded" />
        </div>
        <input required name="address" placeholder="Address" class="w-full p-2 border rounded" />
        <input name="serviceHours" placeholder="Service Hours (eg. 09:00 - 22:00)" class="w-full p-2 border rounded" />
        <div>
          <label class="block text-sm">Upload Image (Profile / Shop)</label>
          <input type="file" id="imageFile" accept="image/*" class="mt-1" />
        </div>
        <div class="flex items-center space-x-2">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded btn-3d">Submit</button>
          <span id="form-msg" class="text-sm text-gray-600"></span>
        </div>
      </form>
    </div>

    <!-- Wallet / Recharge -->
    <div id="wallet-area" class="mb-6 p-4 bg-white rounded shadow hidden">
      <div class="flex items-center justify-between">
        <div>Wallet Balance: <span id="wallet-balance">₹0</span></div>
        <div>
          <button id="btn-request-recharge" class="px-3 py-1 bg-yellow-500 rounded btn-3d">Request Recharge (₹100)</button>
        </div>
      </div>
    </div>

    <!-- Listings & Search -->
    <div class="mb-4 p-4 bg-white rounded shadow">
      <div class="flex items-center gap-2 mb-3">
        <input id="searchBox" placeholder="Search by name or city" class="p-2 border rounded flex-1" />
        <select id="filterCat" class="p-2 border rounded hidden">
          <option value="">All</option>
        </select>
      </div>
      <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <footer class="text-center text-sm text-gray-500 mt-6">Built for ZaraFix • Mobile friendly • 3D buttons</footer>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // *** Paste user's firebaseConfig here (from your message) ***
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Admin email
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    // UI refs
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const postFormWrap = document.getElementById('post-form');
    const providerForm = document.getElementById('providerForm');
    const formMsg = document.getElementById('form-msg');
    const cards = document.getElementById('cards');
    const walletArea = document.getElementById('wallet-area');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const btnRequestRecharge = document.getElementById('btn-request-recharge');
    const adminPanel = document.getElementById('admin-panel');
    const rechargeRequestsEl = document.getElementById('recharge-requests');
    const providerApprovalsEl = document.getElementById('provider-approvals');
    const searchBox = document.getElementById('searchBox');

    let currentUser = null;

    // Auth
    btnLogin.addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{ await auth.signInWithPopup(provider);}catch(e){alert('Login failed: '+e.message)}
    });
    btnLogout.addEventListener('click', ()=>auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      if(user){
        btnLogin.classList.add('hidden'); btnLogout.classList.remove('hidden');
        postFormWrap.classList.remove('hidden'); walletArea.classList.remove('hidden');
        loadWallet(user.uid);
        if(user.email===ADMIN_EMAIL) adminPanel.classList.remove('hidden'); else adminPanel.classList.add('hidden');
      }else{
        btnLogin.classList.remove('hidden'); btnLogout.classList.add('hidden');
        postFormWrap.classList.add('hidden'); walletArea.classList.add('hidden'); adminPanel.classList.add('hidden');
      }
    });

    // Provider form submit
    providerForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); formMsg.textContent='Submitting...';
      const fd = new FormData(providerForm);
      const data = { name: fd.get('name'), mobile: fd.get('mobile'), business: fd.get('business'), email: fd.get('email'), category: fd.get('category'), whatsapp: fd.get('whatsapp'), address: fd.get('address'), serviceHours: fd.get('serviceHours') || '', status: 'waiting', createdAt: Date.now() };

      // image upload
      const fileEl = document.getElementById('imageFile');
      if(fileEl.files.length){
        const f = fileEl.files[0];
        const path = `provider_images/${Date.now()}_${f.name}`;
        const snap = await storage.ref(path).put(f);
        const url = await snap.ref.getDownloadURL();
        data.image = url;
      }

      const newRef = db.ref('providers').push();
      await newRef.set(data);
      formMsg.textContent='Submitted — Waiting for admin approval';
      providerForm.reset();
      setTimeout(()=>formMsg.textContent='','3000');
    });

    // Load and render listings
    async function loadListings(){
      const snap = await db.ref('providers').once('value');
      const obj = snap.val() || {};
      const q = searchBox.value.trim().toLowerCase();
      cards.innerHTML='';
      Object.keys(obj).reverse().forEach(key=>{
        const p = obj[key];
        // Show all listings to everyone but only APPROVED are public
        // As per spec: "sabh ko dikhe login ki jarurat nahi" -> show all cards but only show contact/address/whatsapp when approved and wallet conditions met
        const isApproved = p.status === 'approved';
        // search filter
        if(q){
          const combined = ((p.business||'')+' '+(p.address||'')+' '+(p.category||'')+' '+(p.name||'')).toLowerCase();
          if(!combined.includes(q)) return;
        }
        const card = document.createElement('div');
        card.className = 'card-3d bg-white p-3 rounded';
        card.style.borderLeft = `6px solid ${randomColorFromKey(key)}`;
        card.innerHTML = `
          <div class="flex gap-3">
            <div class="w-24 h-24 bg-gray-100 rounded overflow-hidden flex-shrink-0">
              <img src="${p.image||'https://picsum.photos/200?random='+Math.floor(Math.random()*1000)}" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-semibold text-lg">${escapeHtml(p.business||p.name||'—')}</div>
                  <div class="text-sm text-gray-600">${escapeHtml(p.category||'—')}</div>
                </div>
                <div class="text-sm">${isApproved?'<span class="text-green-600 font-semibold">Approved</span>':'<span class="text-orange-600">Waiting</span>'}</div>
              </div>
              <div class="mt-2 text-sm text-gray-700">${isApproved?escapeHtml(p.address||'—'):'Address hidden until approval'}</div>
              <div class="mt-2 flex gap-2">
                <button class="call-btn px-3 py-1 rounded btn-3d bg-indigo-500 text-white">Call Now</button>
                <button class="whatsapp-btn px-3 py-1 rounded btn-3d bg-green-600 text-white">WhatsApp Now</button>
              </div>
            </div>
          </div>
        `;

        // Event listeners
        const callBtn = card.querySelector('.call-btn');
        const waBtn = card.querySelector('.whatsapp-btn');
        callBtn.addEventListener('click', ()=>{
          if(!isApproved){ alert('This provider not approved yet.'); return; }
          window.open(`tel:${p.mobile || p.whatsapp || ''}`,'_self');
        });
        waBtn.addEventListener('click', async ()=>{
          if(!isApproved){ alert('This provider not approved yet.'); return; }
          if(!currentUser){ alert('Please login to use WhatsApp contact'); return; }
          const userSnap = await db.ref('wallets/'+currentUser.uid).once('value');
          const wallet = userSnap.val() || {balance:0};
          if(wallet.balance >= 20){
            // Deduct 20
            const newBal = wallet.balance - 20;
            await db.ref('wallets/'+currentUser.uid).set({balance:newBal});
            loadWallet(currentUser.uid);
            // open whatsapp
            const waNumber = p.whatsapp || p.mobile || '';
            window.open('https://wa.me/'+waNumber.replace(/[\s+\-()]/g,'')+'?text='+encodeURIComponent('Hello, I need your service'), '_blank');
            alert('₹20 deducted from wallet. Address & WhatsApp opened.');
          }else{
            alert('Wallet me paise kam hain. Please recharge.');
          }
        });

        // Admin controls inside each card (if admin)
        if(currentUser && currentUser.email===ADMIN_EMAIL){
          const adminControls = document.createElement('div');
          adminControls.className='mt-3 flex gap-2';
          const btnApprove = document.createElement('button'); btnApprove.textContent='Approve'; btnApprove.className='px-3 py-1 bg-green-600 text-white rounded btn-3d';
          const btnReject = document.createElement('button'); btnReject.textContent='Reject'; btnReject.className='px-3 py-1 bg-yellow-500 text-white rounded btn-3d';
          const btnDelete = document.createElement('button'); btnDelete.textContent='Delete'; btnDelete.className='px-3 py-1 bg-red-600 text-white rounded btn-3d';
          adminControls.append(btnApprove, btnReject, btnDelete);
          card.appendChild(adminControls);

          btnApprove.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('approved'); loadListings(); renderAdminApprovals(); });
          btnReject.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('rejected'); loadListings(); renderAdminApprovals(); });
          btnDelete.addEventListener('click', async ()=>{ if(confirm('Delete permanently?')){ await db.ref('providers/'+key).remove(); loadListings(); renderAdminApprovals(); } });
        }

        cards.appendChild(card);
      });
    }

    // Random color generator from key
    function randomColorFromKey(k){
      let h=0; for(let i=0;i<k.length;i++) h = (h<<5)-h + k.charCodeAt(i);
      const c = Math.abs(h)%360; return `hsl(${c} 70% 45%)`;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }[c]||c)); }

    // Wallet
    async function loadWallet(uid){
      const snap = await db.ref('wallets/'+uid).once('value');
      const w = snap.val() || {balance:0};
      walletBalanceEl.textContent = '₹'+(w.balance||0);
    }

    btnRequestRecharge.addEventListener('click', async ()=>{
      if(!currentUser){ alert('Please login to request recharge'); return; }
      const reqRef = db.ref('recharge_requests').push();
      await reqRef.set({ userId: currentUser.uid, email: currentUser.email || '', amount: 100, status: 'pending', createdAt: Date.now() });
      alert('Recharge request sent to admin.');
      renderAdminRechargeRequests();
    });

    // Admin: render recharge requests and provider approvals
    async function renderAdminRechargeRequests(){
      const snap = await db.ref('recharge_requests').orderByChild('status').equalTo('pending').once('value');
      const obj = snap.val() || {};
      rechargeRequestsEl.innerHTML = '<h3 class="font-medium">Recharge Requests</h3>';
      Object.keys(obj).forEach(key=>{
        const r = obj[key];
        const div = document.createElement('div');
        div.className='p-2 bg-gray-50 rounded my-2 flex items-center justify-between';
        div.innerHTML = `<div>${r.email} • ₹${r.amount}</div>`;
        const ap = document.createElement('button'); ap.textContent='Approve +₹100'; ap.className='px-3 py-1 bg-green-600 text-white rounded btn-3d';
        ap.addEventListener('click', async ()=>{
          // credit wallet 100
          const wSnap = await db.ref('wallets/'+r.userId).once('value');
          const w = wSnap.val()||{balance:0};
          const newBal = (w.balance||0) + 100;
          await db.ref('wallets/'+r.userId).set({balance:newBal});
          await db.ref('recharge_requests/'+key+'/status').set('approved');
          alert('Recharge successful (₹100 added)');
          renderAdminRechargeRequests(); loadListings();
        });
        const rej = document.createElement('button'); rej.textContent='Reject'; rej.className='px-3 py-1 bg-yellow-500 text-white rounded btn-3d ml-2';
        rej.addEventListener('click', async ()=>{ await db.ref('recharge_requests/'+key+'/status').set('rejected'); renderAdminRechargeRequests(); });
        div.appendChild(ap); div.appendChild(rej);
        rechargeRequestsEl.appendChild(div);
      });
    }

    async function renderAdminApprovals(){
      const snap = await db.ref('providers').orderByChild('status').once('value');
      const obj = snap.val()||{};
      providerApprovalsEl.innerHTML = '<h3 class="font-medium">Provider Approvals</h3>';
      Object.keys(obj).forEach(key=>{
        const p = obj[key];
        const div = document.createElement('div');
        div.className='p-2 bg-gray-50 rounded my-2 flex items-center justify-between';
        div.innerHTML = `<div>${p.business||p.name} • ${p.status}</div>`;
        const ap = document.createElement('button'); ap.textContent='Approve'; ap.className='px-3 py-1 bg-green-600 text-white rounded btn-3d';
        ap.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('approved'); renderAdminApprovals(); loadListings(); });
        const rej = document.createElement('button'); rej.textContent='Reject'; rej.className='px-3 py-1 bg-yellow-500 text-white rounded btn-3d ml-2';
        rej.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('rejected'); renderAdminApprovals(); loadListings(); });
        div.appendChild(ap); div.appendChild(rej);
        providerApprovalsEl.appendChild(div);
      });
    }

    // Live listeners
    db.ref('providers').on('value', ()=>loadListings());
    db.ref('recharge_requests').on('value', ()=>{ if(currentUser && currentUser.email===ADMIN_EMAIL) renderAdminRechargeRequests(); });

    // Helpers
    searchBox.addEventListener('input', ()=>loadListings());

    // when auth changes, re-render admin lists
    auth.onAuthStateChanged(user=>{ if(user && user.email===ADMIN_EMAIL){ renderAdminRechargeRequests(); renderAdminApprovals(); } else { providerApprovalsEl.innerHTML=''; rechargeRequestsEl.innerHTML=''; } loadListings(); });

    // initial
    loadListings();

  </script>

</body>
</html>
