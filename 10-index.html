<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZaraFix | Service Providers + Wallet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 3D buttons */
    .btn-3d{position:relative;border-radius:12px;padding:10px 14px;font-weight:600;box-shadow:0 10px 0 rgba(0,0,0,0.15);transition:transform .12s}
    .btn-3d:active{transform:translateY(6px);box-shadow:0 4px 0 rgba(0,0,0,0.08)}
    .card-3d{border-radius:16px;padding:14px;box-shadow:0 18px 30px rgba(7,10,25,0.06);transition:transform .12s}
    .card-3d:hover{transform:translateY(-6px)}
    .img-box{width:96px;height:96px;border-radius:12px;overflow:hidden;flex-shrink:0}
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="max-w-6xl mx-auto p-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <button id="homeBtn" class="btn-3d bg-white">Home</button>
        <h1 class="text-2xl font-bold">ZaraFix</h1>
      </div>
      <div class="space-x-2">
        <button id="btn-login" class="btn-3d bg-blue-600 text-white">Login with Google</button>
        <button id="btn-logout" class="btn-3d bg-red-500 text-white hidden">Logout</button>
      </div>
    </header>

    <!-- Admin Panel -->
    <div id="admin-panel" class="mb-4 p-3 bg-white rounded hidden">
      <h2 class="font-semibold">Admin Panel (zarasamajiksevasanstha@gmail.com)</h2>
      <div class="mt-2 space-y-3">
        <div id="recharge-requests"></div>
        <div id="provider-approvals"></div>
      </div>
    </div>

    <!-- Post Form -->
    <div id="post-form" class="mb-6 p-4 bg-white rounded shadow hidden">
      <h2 class="font-semibold mb-2">Post Service Provider</h2>
      <form id="providerForm" class="space-y-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="name" placeholder="Full Name" class="p-2 border rounded" />
          <input required name="mobile" placeholder="Mobile Number" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="business" placeholder="Service/Business Name" class="p-2 border rounded" />
          <input required name="email" placeholder="Email" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="category" placeholder="Category (Doctor, Hospital, Electrician...)" class="p-2 border rounded" />
          <input required name="whatsapp" placeholder="WhatsApp Number" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input required name="address" placeholder="Address" class="p-2 border rounded" />
          <input name="serviceHours" placeholder="Service Hours (eg. 09:00 - 22:00)" class="p-2 border rounded" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input name="latitude" placeholder="Map Latitude (optional)" class="p-2 border rounded" />
          <input name="longitude" placeholder="Map Longitude (optional)" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">Upload Image (Profile / Shop) — direct upload</label>
          <input type="file" id="imageFile" accept="image/*" class="mt-1" />
        </div>
        <div class="flex items-center space-x-2">
          <button type="submit" class="btn-3d bg-green-600 text-white">Submit</button>
          <span id="form-msg" class="text-sm text-gray-600"></span>
        </div>
      </form>
    </div>

    <!-- Wallet Area -->
    <div id="wallet-area" class="mb-6 p-4 bg-white rounded shadow hidden">
      <div class="flex items-center justify-between">
        <div>Wallet Balance: <span id="wallet-balance">₹0</span></div>
        <div>
          <button id="btn-request-recharge" class="btn-3d bg-yellow-500">Request Recharge (₹100)</button>
        </div>
      </div>
    </div>

    <!-- Search box + cards -->
    <div class="mb-4 p-4 bg-white rounded shadow">
      <div class="flex items-center gap-2 mb-3">
        <input id="searchBox" placeholder="Search by name / city / category" class="p-2 border rounded flex-1" />
        <div class="text-sm text-gray-500">(No dropdown — simple search)</div>
      </div>
      <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <footer class="text-center text-sm text-gray-500 mt-6">Built for ZaraFix • Mobile friendly • 3D buttons</footer>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ========== CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    // UI refs
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const postFormWrap = document.getElementById('post-form');
    const providerForm = document.getElementById('providerForm');
    const formMsg = document.getElementById('form-msg');
    const cards = document.getElementById('cards');
    const walletArea = document.getElementById('wallet-area');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const btnRequestRecharge = document.getElementById('btn-request-recharge');
    const adminPanel = document.getElementById('admin-panel');
    const rechargeRequestsEl = document.getElementById('recharge-requests');
    const providerApprovalsEl = document.getElementById('provider-approvals');
    const searchBox = document.getElementById('searchBox');
    const homeBtn = document.getElementById('homeBtn');

    let currentUser = null;

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]||c)); }
    function uidShort(u){ return (u||'').slice(0,6); }
    function randomColorFromKey(k){ let h=0; for(let i=0;i<k.length;i++) h = (h<<5)-h + k.charCodeAt(i); const c = Math.abs(h)%360; return `hsl(${c} 70% 45%)`; }

    // Auth
    btnLogin.addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{ await auth.signInWithPopup(provider);}catch(e){alert('Login failed: '+e.message)}
    });
    btnLogout.addEventListener('click', ()=>auth.signOut());
    homeBtn.addEventListener('click', ()=>{ window.scrollTo({top:0,behavior:'smooth'}); });

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      if(user){
        btnLogin.classList.add('hidden'); btnLogout.classList.remove('hidden');
        postFormWrap.classList.remove('hidden'); walletArea.classList.remove('hidden');
        loadWallet(user.uid);
        if(user.email===ADMIN_EMAIL) adminPanel.classList.remove('hidden'); else adminPanel.classList.add('hidden');
        renderAdminListsIfNeeded();
      }else{
        btnLogin.classList.remove('hidden'); btnLogout.classList.add('hidden');
        postFormWrap.classList.add('hidden'); walletArea.classList.add('hidden'); adminPanel.classList.add('hidden');
      }
      loadListings();
    });

    // Submit provider
    providerForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); formMsg.textContent='Submitting...';
      const fd = new FormData(providerForm);
      const data = {
        name: fd.get('name'),
        mobile: fd.get('mobile'),
        business: fd.get('business'),
        email: fd.get('email'),
        category: fd.get('category'),
        whatsapp: fd.get('whatsapp'),
        address: fd.get('address'),
        serviceHours: fd.get('serviceHours') || '',
        latitude: fd.get('latitude')||'', longitude: fd.get('longitude')||'',
        status: 'waiting', // waiting | approved | rejected
        posterUid: currentUser ? currentUser.uid : 'anonymous_'+Date.now(),
        createdAt: Date.now()
      };

      // image upload to Firebase Storage (direct)
      const fileEl = document.getElementById('imageFile');
      if(fileEl.files.length){
        const f = fileEl.files[0];
        const path = `provider_images/${Date.now()}_${f.name}`;
        const snap = await storage.ref(path).put(f);
        const url = await snap.ref.getDownloadURL();
        data.image = url;
      }

      const newRef = db.ref('providers').push();
      await newRef.set(data);
      formMsg.textContent='Submitted — Waiting for admin approval';
      providerForm.reset();
      setTimeout(()=>formMsg.textContent='','3000');
    });

    // Load listings
    async function loadListings(){
      const snap = await db.ref('providers').once('value');
      const obj = snap.val() || {};
      const q = searchBox.value.trim().toLowerCase();
      cards.innerHTML='';
      const keys = Object.keys(obj).sort((a,b)=> (obj[b].createdAt||0)-(obj[a].createdAt||0));
      for(const key of keys){
        const p = obj[key];
        const isApproved = p.status === 'approved';
        const isPoster = currentUser && currentUser.uid === p.posterUid;
        // visibility rule
        if(!isApproved && !isPoster && !(currentUser && currentUser.email===ADMIN_EMAIL)) continue;
        if(q){ const combined = ((p.business||'')+' '+(p.address||'')+' '+(p.category||'')+' '+(p.name||'')).toLowerCase(); if(!combined.includes(q)) continue; }

        const color = randomColorFromKey(key);
        const card = document.createElement('div');
        card.className = 'card-3d bg-white p-3 rounded';
        card.style.borderLeft = `8px solid ${color}`;

        const waitingVisibleToPoster = !isApproved && isPoster;

        card.innerHTML = `
          <div class="flex gap-3">
            <div class="img-box bg-gray-100">
              <img src="${p.image||'https://picsum.photos/200?random='+Math.floor(Math.random()*1000)}" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-semibold text-lg">${escapeHtml(p.business||p.name||'—')}</div>
                  <div class="text-sm text-gray-600">${escapeHtml(p.category||'—')}</div>
                </div>
                <div class="text-sm">${isApproved?'<span class="text-green-600 font-semibold">Approved</span>':(p.status==='rejected'?'<span class="text-yellow-600 font-semibold">Rejected</span>':'<span class="text-orange-600">Waiting</span>')}</div>
              </div>
              <div class="mt-2 text-sm text-gray-700" id="addr-${key}">${isApproved ? escapeHtml(p.address||'—') : (waitingVisibleToPoster ? 'Wait for Approval' : '—')}</div>

              <div class="mt-3 flex gap-2 items-center" id="actions-${key}">
                <button class="btn-3d call-btn px-3 py-1 bg-indigo-500 text-white">Call Now</button>
                <button class="btn-3d whatsapp-btn px-3 py-1 bg-green-600 text-white">WhatsApp Now</button>
                <button class="btn-3d rate-btn px-3 py-1 bg-gray-200 text-black">Rate ★</button>
                <span class="text-sm text-gray-500 ml-2">Posted by: ${escapeHtml(p.name||uidShort(p.posterUid))}</span>
              </div>

              <div class="mt-2" id="rating-${key}"></div>
            </div>
          </div>
        `;

        if(!isApproved && isPoster){ card.style.background = '#f8fafc'; card.style.opacity = '0.95'; }

        const callBtn = card.querySelector('.call-btn');
        const waBtn = card.querySelector('.whatsapp-btn');
        const rateBtn = card.querySelector('.rate-btn');

        callBtn.addEventListener('click', ()=>{
          if(!isApproved){ alert('This provider is not approved yet.'); return; }
          const tel = p.mobile || p.whatsapp || '';
          if(!tel){ alert('Number not available'); return; }
          window.open(`tel:${tel}`,'_self');
        });

        waBtn.addEventListener('click', async ()=>{
          if(!isApproved){ alert('This provider is not approved yet.'); return; }
          if(!currentUser){ alert('Please login to use WhatsApp contact'); return; }
          const wSnap = await db.ref('wallets/'+currentUser.uid).once('value');
          const wallet = wSnap.val() || {balance:0};
          if(wallet.balance >= 20){
            const newBal = wallet.balance - 20;
            await db.ref('wallets/'+currentUser.uid).set({balance:newBal});
            await db.ref(`accesses/${key}/${currentUser.uid}`).set({granted:true, at:Date.now()});
            loadWallet(currentUser.uid);
            const waNumber = p.whatsapp || p.mobile || '';
            window.open('https://wa.me/'+waNumber.replace(/[\s+\-()]/g,'')+'?text='+encodeURIComponent('Hello, I need your service'), '_blank');
            alert('₹20 deducted from wallet. Address & WhatsApp opened.');
            const addrEl = document.getElementById('addr-'+key);
            if(addrEl) addrEl.textContent = p.address || '—';
          }else{
            alert('Wallet me paise kam hain. Please request recharge.');
          }
        });

        rateBtn.addEventListener('click', ()=>{
          const stars = prompt('Give rating 1-5 (integer):');
          const r = parseInt(stars||0);
          if(!r || r<1 || r>5){ alert('Invalid rating'); return; }
          db.ref('ratings/'+key).push({user: currentUser?currentUser.uid:'anon', rating:r, at:Date.now()});
          alert('Thank you for rating!');
          renderRatings(key);
        });

        // Admin controls per card
        if(currentUser && currentUser.email===ADMIN_EMAIL){
          const adminControls = document.createElement('div');
          adminControls.className='mt-3 flex gap-2';
          const btnApprove = document.createElement('button'); btnApprove.textContent='Approve'; btnApprove.className='btn-3d px-3 py-1 bg-green-600 text-white';
          const btnReject = document.createElement('button'); btnReject.textContent='Reject'; btnReject.className='btn-3d px-3 py-1 bg-yellow-500 text-white';
          const btnDelete = document.createElement('button'); btnDelete.textContent='Delete'; btnDelete.className='btn-3d px-3 py-1 bg-red-600 text-white';
          adminControls.append(btnApprove, btnReject, btnDelete);
          card.appendChild(adminControls);

          btnApprove.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('approved'); loadListings(); renderAdminListsIfNeeded(); });
          btnReject.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('rejected'); loadListings(); renderAdminListsIfNeeded(); });
          btnDelete.addEventListener('click', async ()=>{ if(confirm('Delete permanently?')){ await db.ref('providers/'+key).remove(); loadListings(); renderAdminListsIfNeeded(); } });
        }

        cards.appendChild(card);
        renderRatings(key);
      }
    }

    // Ratings
    async function renderRatings(key){
      const snap = await db.ref('ratings/'+key).once('value');
      const div = document.getElementById('rating-'+key);
      if(!div) return;
      const obj = snap.val()||{}; const vals = Object.values(obj).map(x=>x.rating||0); const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : '—';
      div.innerHTML = `<div class="text-sm">Rating: ${avg} ${vals.length?('('+vals.length+' reviews)'):''}</div>`;
    }

    // Wallet
    async function loadWallet(uid){
      const snap = await db.ref('wallets/'+uid).once('value');
      const w = snap.val() || {balance:0};
      walletBalanceEl.textContent = '₹'+(w.balance||0);
    }

    btnRequestRecharge.addEventListener('click', async ()=>{
      if(!currentUser){ alert('Please login to request recharge'); return; }
      const reqRef = db.ref('recharge_requests').push();
      await reqRef.set({ userId: currentUser.uid, email: currentUser.email || '', amount: 100, status: 'pending', createdAt: Date.now() });
      alert('Recharge request sent to admin.');
      renderAdminListsIfNeeded();
    });

    // Admin lists
    async function renderAdminListsIfNeeded(){
      if(!(currentUser && currentUser.email===ADMIN_EMAIL)) return;
      const rSnap = await db.ref('recharge_requests').orderByChild('status').equalTo('pending').once('value');
      const rObj = rSnap.val() || {};
      rechargeRequestsEl.innerHTML = '<h3 class="font-medium">Recharge Requests</h3>';
      Object.keys(rObj).forEach(key=>{
        const r = rObj[key];
        const div = document.createElement('div');
        div.className='p-2 bg-gray-50 rounded my-2 flex items-center justify-between';
        div.innerHTML = `<div>${escapeHtml(r.email)} • ₹${r.amount}</div>`;
        const ap = document.createElement('button'); ap.textContent='Approve +₹100'; ap.className='btn-3d px-3 py-1 bg-green-600 text-white';
        ap.addEventListener('click', async ()=>{
          const wSnap = await db.ref('wallets/'+r.userId).once('value');
          const w = wSnap.val()||{balance:0};
          const newBal = (w.balance||0) + 100;
          await db.ref('wallets/'+r.userId).set({balance:newBal});
          await db.ref('recharge_requests/'+key+'/status').set('approved');
          alert('Recharge successful (₹100 added)');
          renderAdminListsIfNeeded();
        });
        const rej = document.createElement('button'); rej.textContent='Reject'; rej.className='btn-3d px-3 py-1 bg-yellow-500 text-white ml-2';
        rej.addEventListener('click', async ()=>{ await db.ref('recharge_requests/'+key+'/status').set('rejected'); renderAdminListsIfNeeded(); });
        div.appendChild(ap); div.appendChild(rej);
        rechargeRequestsEl.appendChild(div);
      });

      // provider approvals
      const pSnap = await db.ref('providers').once('value');
      const pObj = pSnap.val()||{};
      providerApprovalsEl.innerHTML = '<h3 class="font-medium">Provider Approvals</h3>';
      Object.keys(pObj).forEach(key=>{
        const p = pObj[key];
        const div = document.createElement('div');
        div.className='p-2 bg-gray-50 rounded my-2 flex items-center justify-between';
        div.innerHTML = '<div>'+escapeHtml(p.business||p.name)+" • "+p.status+'</div>';
        const ap = document.createElement('button'); ap.textContent='Approve'; ap.className='btn-3d px-3 py-1 bg-green-600 text-white';
        ap.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('approved'); renderAdminListsIfNeeded(); loadListings(); });
        const rej = document.createElement('button'); rej.textContent='Reject'; rej.className='btn-3d px-3 py-1 bg-yellow-500 text-white ml-2';
        rej.addEventListener('click', async ()=>{ await db.ref('providers/'+key+'/status').set('rejected'); renderAdminListsIfNeeded(); loadListings(); });
        div.appendChild(ap); div.appendChild(rej);
        providerApprovalsEl.appendChild(div);
      });
    }

    // Listeners
    db.ref('providers').on('value', ()=>loadListings());
    db.ref('recharge_requests').on('value', ()=>{ renderAdminListsIfNeeded(); });
    searchBox.addEventListener('input', ()=>loadListings());
    loadListings();
  </script>
</body>
</html>
