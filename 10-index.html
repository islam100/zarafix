<!-- Save as zara-fix-plain.html and open in browser -->
<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZaraFix — Service Providers (Plain HTML)</title>
  <!-- Tailwind CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom styles for 3D buttons, gradients & modal */
    .btn-3d { box-shadow: 0 8px 0 rgba(0,0,0,0.22); transform: translateY(0); transition: transform .12s, box-shadow .12s; }
    .btn-3d:active { transform: translateY(4px); box-shadow: 0 4px 0 rgba(0,0,0,0.16); }
    .card-3d { transition: transform .12s; }
    .card-3d:hover { transform: translateY(-6px); }
    .img-fit { width:100%; height:160px; object-fit: contain; background:#fff; }
    .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    /* gradients pool */
    .g1{background:linear-gradient(135deg,#ff7eb3,#ffb199);} .g2{background:linear-gradient(135deg,#8affc1,#6ee7ff);}
    .g3{background:linear-gradient(135deg,#9b8cff,#ff9a9e);} .g4{background:linear-gradient(135deg,#86efac,#60a5fa);}
    .g5{background:linear-gradient(135deg,#ffd86b,#ff8b8b);} .g6{background:linear-gradient(135deg,#c4f0ff,#d6bbff);}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center gap-4">
      <h1 class="text-2xl font-extrabold">ZaraFix — Service Providers</h1>
      <div class="flex-1">
        <input id="search" placeholder="Search: Hospital, Ambulance, Doctor, Electrician..." class="w-full rounded-xl border px-4 py-2" />
      </div>
      <div id="auth-area" class="flex items-center gap-2">
        <button id="loginBtn" class="btn-3d rounded-2xl bg-emerald-600 text-white px-4 py-2 flex items-center gap-2"><span>Login with Google</span></button>
      </div>
    </header>

    <main class="mt-6 grid md:grid-cols-3 gap-4">
      <!-- Left column: Post form & My listings & Admin recharge -->
      <section class="md:col-span-1">
        <div id="postBox" class="rounded-3xl p-4 bg-white shadow hidden">
          <h2 class="font-bold mb-2">Create / Update Listing</h2>
          <form id="postForm" class="space-y-2">
            <input id="personName" placeholder="Your Name" required class="w-full rounded-xl border px-3 py-2" />
            <div class="grid grid-cols-2 gap-2">
              <input id="phone" placeholder="Mobile" required class="rounded-xl border px-3 py-2" />
              <input id="whatsapp" placeholder="WhatsApp (optional)" class="rounded-xl border px-3 py-2" />
            </div>
            <input id="email" placeholder="Email (optional)" class="w-full rounded-xl border px-3 py-2" />
            <input id="serviceName" placeholder="Service / Business Name" required class="w-full rounded-xl border px-3 py-2" />
            <input id="category" placeholder="Category (free text)" class="w-full rounded-xl border px-3 py-2" />
            <textarea id="address" placeholder="Address" class="w-full rounded-xl border px-3 py-2"></textarea>
            <div class="grid grid-cols-2 gap-2">
              <input id="lat" placeholder="Latitude (opt)" class="rounded-xl border px-3 py-2" />
              <input id="lng" placeholder="Longitude (opt)" class="rounded-xl border px-3 py-2" />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="hoursFrom" placeholder="From (e.g., 09:00)" class="rounded-xl border px-3 py-2" />
              <input id="hoursTo" placeholder="To (e.g., 18:00)" class="rounded-xl border px-3 py-2" />
            </div>
            <div>
              <label class="text-sm font-semibold">Upload Images (multiple)</label>
              <input id="images" type="file" accept="image/*" multiple class="block w-full rounded-xl mt-1" />
              <div id="selectedCount" class="text-xs text-gray-600 mt-1"></div>
            </div>
            <button class="btn-3d bg-indigo-700 text-white w-full rounded-2xl py-2" type="submit">Submit for Approval</button>
          </form>

          <div class="mt-4">
            <h3 class="font-bold">My Listings</h3>
            <div id="myListings" class="space-y-2 mt-2"></div>
          </div>

          <div id="rechargeBox" class="mt-4">
            <h3 class="font-bold">Wallet</h3>
            <div class="flex items-center gap-2 mt-2">
              <div id="balance" class="font-semibold bg-white px-3 py-1 rounded-xl shadow">₹0</div>
              <button id="reqRecharge" class="btn-3d bg-amber-500 px-3 py-1 rounded-2xl">Request ₹100 Recharge</button>
            </div>
            <div id="rechargeMsg" class="text-xs text-gray-600 mt-2"></div>
          </div>

          <div id="adminRechargeRequests" class="mt-4 hidden">
            <h3 class="font-bold">Recharge Requests (Admin)</h3>
            <div id="rechargeList" class="space-y-2 mt-2"></div>
          </div>
        </div>
      </section>

      <!-- Right: Listings grid -->
      <section class="md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <button id="zoomOut" class="btn-3d bg-sky-600 text-white px-3 py-1 rounded-2xl">-</button>
            <button id="zoomIn" class="btn-3d bg-sky-600 text-white px-3 py-1 rounded-2xl">+</button>
            <div class="text-sm text-gray-600 ml-2">Zoom</div>
          </div>
        </div>

        <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </main>
  </div>

  <!-- Preview Modal -->
  <div id="modal" class="fixed inset-0 hidden modal-bg z-50 grid place-items-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-3xl overflow-auto">
      <div class="p-4 border-b flex items-start justify-between">
        <div>
          <h3 id="modalTitle" class="text-xl font-black"></h3>
          <p id="modalCat" class="text-xs text-gray-600"></p>
        </div>
        <button id="closeModal" class="p-2">✕</button>
      </div>
      <div class="p-4" id="modalBody"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
  /*************** CONFIG - replace if needed (you provided these) ***************/
  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
  };
  // imgbb key you showed earlier:
  const IMGBB_KEY = "cad1f0dbfbd25346460789376cc2d7d5";
  /***************************************************************************/

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // constants
  const ADMIN_EMAIL = "zarasamajiksevasanstha@gmail.com";
  let currentUser = null;
  let zoom = 1;

  // helpers
  const $ = id => document.getElementById(id);
  const setText = (id, t) => { const el = $(id); if(el) el.textContent = t; };

  // UI elements
  const loginBtn = $("loginBtn");
  const authArea = $("auth-area");
  const postBox = $("postBox");
  const postForm = $("postForm");
  const imagesInput = $("images");
  const selectedCount = $("selectedCount");
  const myListings = $("myListings");
  const grid = $("grid");
  const modal = $("modal");
  const modalTitle = $("modalTitle");
  const modalCat = $("modalCat");
  const modalBody = $("modalBody");
  const closeModal = $("closeModal");
  const balanceDiv = $("balance");
  const reqRecharge = $("reqRecharge");
  const rechargeList = $("rechargeList");
  const adminRechargeRequests = $("adminRechargeRequests");

  // search & zoom
  const searchBox = $("search");
  $("zoomIn").addEventListener("click", ()=> { zoom = Math.min(1.4, zoom+0.1); grid.style.transform = `scale(${zoom})`; });
  $("zoomOut").addEventListener("click", ()=> { zoom = Math.max(0.8, zoom-0.1); grid.style.transform = `scale(${zoom})`; });

  // Login flow
  loginBtn.addEventListener("click", async () => {
    if (!currentUser) {
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); } catch(e){ alert('Login failed: '+e.message); }
    } else {
      auth.signOut();
    }
  });

  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    if (user) {
      loginBtn.innerHTML = `<img src="${user.photoURL||''}" class="w-6 h-6 rounded-full"> Logout`;
      postBox.classList.remove("hidden");
      // ensure user node
      const uRef = db.ref('users/'+user.uid);
      const snap = await uRef.once('value');
      if (!snap.exists()) {
        await uRef.set({ uid: user.uid, name: user.displayName||'', email: user.email||'', wallet: 0, createdAt: Date.now() });
      }
      // show my listings
      listenMyListings();
      listenBalance();
      // if admin, show recharge requests
      if (user.email === ADMIN_EMAIL) adminRechargeRequests.classList.remove('hidden'); else adminRechargeRequests.classList.add('hidden');
    } else {
      loginBtn.innerHTML = 'Login with Google';
      postBox.classList.add("hidden");
      myListings.innerHTML = '';
      balanceDiv.textContent = '₹0';
    }
  });

  // Upload images to imgbb (returns array of urls)
  async function uploadToImgbb(files) {
    const urls = [];
    for (const f of files) {
      const fd = new FormData();
      fd.append('image', await toBase64File(f));
      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method:'POST', body: fd });
        const j = await res.json();
        if (j && j.data && j.data.url) urls.push(j.data.url);
      } catch (e) { console.error('imgbb fail', e); }
    }
    return urls;
  }
  // helper to convert file -> base64 string (imgbb wants base64 without data: prefix)
  function toBase64File(file) {
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => {
        // remove prefix data:*/*;base64,
        const s = r.result.split(',')[1];
        res(s);
      };
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // Post form submit
  postForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) return alert('Login required to post.');
    const data = {
      ownerUid: currentUser.uid,
      personName: $('personName').value.trim(),
      phone: $('phone').value.trim(),
      whatsapp: $('whatsapp').value.trim(),
      email: $('email').value.trim() || currentUser.email,
      serviceName: $('serviceName').value.trim(),
      category: $('category').value.trim(),
      address: $('address').value.trim(),
      lat: $('lat').value.trim(),
      lng: $('lng').value.trim(),
      hoursFrom: $('hoursFrom').value.trim(),
      hoursTo: $('hoursTo').value.trim(),
      status: 'pending',
      createdAt: Date.now()
    };
    const files = Array.from(imagesInput.files || []);
    if (files.length) {
      const urls = await uploadToImgbb(files);
      data.photos = urls;
    } else data.photos = [];
    // push to /providers
    const ref = db.ref('providers').push();
    await ref.set(data);
    alert('Profile submitted — admin approval pending.');
    postForm.reset();
    selectedCount.textContent = '';
  });

  imagesInput.addEventListener('change', ()=> {
    selectedCount.textContent = imagesInput.files.length ? `${imagesInput.files.length} file(s) selected` : '';
  });

  // Listen and render public approved providers
  function listenPublicProviders() {
    const ref = db.ref('providers');
    ref.on('value', (snap) => {
      const obj = snap.val() || {};
      const arr = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
      // show only approved for public
      const approved = arr.filter(a => a.status === 'approved');
      renderGrid(approved);
    });
  }
  listenPublicProviders();

  // render grid
  function renderGrid(list) {
    const q = searchBox.value.trim().toLowerCase();
    const filtered = !q ? list : list.filter(p => {
      return [p.serviceName, p.category, p.address, p.personName].join(' ').toLowerCase().includes(q);
    });
    grid.innerHTML = '';
    filtered.forEach((p, i) => {
      const card = document.createElement('div');
      card.className = `card-3d rounded-3xl p-3 ${['g1','g2','g3','g4','g5','g6'][i%6]} shadow`;
      card.innerHTML = `
        <div class="rounded-2xl p-3 bg-white/80">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-bold">${escapeHtml(p.serviceName||'Untitled')}</div>
              <div class="text-xs opacity-80">${escapeHtml(p.category||'')}</div>
            </div>
            <div class="text-xs font-semibold uppercase ${p.status==='approved'?'text-green-700':'text-amber-700'}">${p.status||'pending'}</div>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            ${(p.photos||[]).slice(0,2).map(u=>`<img src="${u}" class="img-fit rounded-xl" />`).join('')}
            ${!(p.photos||[]).length ? `<div class="img-fit rounded-xl flex items-center justify-center text-xs text-gray-500">No image</div>` : ''}
          </div>
          <div class="mt-3 text-sm">
            <div>Hours: ${escapeHtml(p.hoursFrom||'--')} - ${escapeHtml(p.hoursTo||'--')}</div>
            <div class="mt-2" id="sensitive-${p.id}"></div>
          </div>
          <div class="mt-3 flex gap-2">
            <button data-id="${p.id}" class="btn-3d contactBtn bg-emerald-600 text-white px-3 py-1 rounded-2xl">WhatsApp Now</button>
            <button data-id="${p.id}" class="btn-3d viewBtn bg-indigo-600 text-white px-3 py-1 rounded-2xl">Open</button>
            <div class="ml-auto"></div>
          </div>
        </div>
      `;
      // show/hide address & whatsapp based on wallet & login
      const sensitiveArea = card.querySelector(`#sensitive-${p.id}`);
      const canSee = currentUser && userHasSufficientBalanceSync(20) && p.status==='approved';
      if (canSee) {
        sensitiveArea.innerHTML = `<div class="text-xs"><strong>Address:</strong> ${escapeHtml(p.address||'')}</div>
                                   <div class="text-xs">WhatsApp: ${escapeHtml(p.whatsapp||p.phone||'')}</div>`;
      } else {
        sensitiveArea.innerHTML = `<div class="italic text-xs text-gray-600">Recharge wallet to view address & contact.</div>`;
      }

      // admin inline controls if admin user
      if (currentUser && currentUser.email === ADMIN_EMAIL) {
        const adminBtns = document.createElement('div');
        adminBtns.className = 'flex gap-2 ml-auto';
        adminBtns.innerHTML = `
          <button data-id="${p.id}" class="btn-3d approveBtn bg-green-600 text-white px-3 py-1 rounded-2xl">Approve</button>
          <button data-id="${p.id}" class="btn-3d rejectBtn bg-amber-600 text-white px-3 py-1 rounded-2xl">Reject</button>
          <button data-id="${p.id}" class="btn-3d deleteBtn bg-rose-600 text-white px-3 py-1 rounded-2xl">Delete</button>
        `;
        card.querySelector('.mt-3 .ml-auto').appendChild(adminBtns);
      }

      grid.appendChild(card);
    });
    // attach events
    grid.querySelectorAll('.viewBtn').forEach(b => b.onclick = () => openModalById(b.dataset.id));
    grid.querySelectorAll('.contactBtn').forEach(b => b.onclick = () => handleWhatsAppClick(b.dataset.id));
    grid.querySelectorAll('.approveBtn').forEach(b => b.onclick = () => adminApprove(b.dataset.id));
    grid.querySelectorAll('.rejectBtn').forEach(b => b.onclick = () => adminReject(b.dataset.id));
    grid.querySelectorAll('.deleteBtn').forEach(b => b.onclick = () => adminDelete(b.dataset.id));
  }

  // utility: escape HTML
  function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  // open modal for id
  async function openModalById(id) {
    const snap = await db.ref('providers/'+id).once('value');
    const p = snap.val();
    if (!p) return alert('Listing not found');
    modalTitle.textContent = p.serviceName || 'Untitled';
    modalCat.textContent = p.category || '';
    let html = `
      <div class="grid gap-3">
        <div class="grid grid-cols-2 gap-2">
          ${(p.photos||[]).map(u=>`<img src="${u}" class="img-fit rounded-xl" />`).join('')}
        </div>
        <div><strong>Contact Person:</strong> ${escapeHtml(p.personName)}</div>
        <div><strong>Hours:</strong> ${escapeHtml(p.hoursFrom||'--')} - ${escapeHtml(p.hoursTo||'--')}</div>
        <div><strong>Address:</strong> ${currentUser && userHasSufficientBalanceSync(20) && p.status==='approved' ? escapeHtml(p.address) : '<em>Recharge to view</em>'}</div>
        <div class="flex gap-2 mt-2">
          ${currentUser && userHasSufficientBalanceSync(20) && p.status==='approved' ? `<button id="modalWa" class="btn-3d bg-emerald-600 text-white px-3 py-1 rounded-2xl">WhatsApp Now</button>` : `<button id="modalReq" class="btn-3d bg-indigo-600 text-white px-3 py-1 rounded-2xl">Recharge to Contact</button>`}
        </div>
      </div>
    `;
    // reviews stub
    html += `<div class="mt-4"><h4 class="font-bold">Ratings & Reviews</h4><div id="reviewsArea"></div>
      <div class="mt-2"><textarea id="reviewText" class="w-full rounded-xl border px-3 py-2" placeholder="Write feedback..."></textarea>
      <div class="flex gap-2 mt-2"><select id="reviewRating" class="rounded-xl border px-3 py-2"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select>
      <button id="submitReview" class="btn-3d bg-indigo-700 text-white px-3 py-1 rounded-2xl">Submit Review</button></div></div></div>`;
    modalBody.innerHTML = html;
    modal.classList.remove('hidden');

    // attach modal actions
    if ($('modalWa')) $('modalWa').onclick = () => { handleWhatsAppClick(id); };
    if ($('modalReq')) $('modalReq').onclick = () => { requestRechargeAction(); };
    $('submitReview').onclick = async () => {
      if (!currentUser) return alert('Login to review');
      const rating = parseInt($('reviewRating').value,10);
      const text = $('reviewText').value.trim();
      await db.ref(`providers/${id}/reviews`).push({ uid: currentUser.uid, rating, text, createdAt: Date.now() });
      alert('Review submitted');
      $('reviewText').value=''; $('reviewRating').value='5';
      loadReviews(id);
    };
    loadReviews(id);
  }
  closeModal.onclick = ()=> modal.classList.add('hidden');

  async function loadReviews(providerId) {
    const snap = await db.ref(`providers/${providerId}/reviews`).once('value');
    const obj = snap.val()||{};
    const arr = Object.values(obj);
    const area = $('reviewsArea');
    if (!area) return;
    if (!arr.length) area.innerHTML = '<div class="text-sm text-gray-600">No reviews yet.</div>';
    else area.innerHTML = arr.map(r=>`<div class="rounded-xl border p-2"><div class="text-amber-500">${'★'.repeat(r.rating||0)}</div><div class="text-sm">${escapeHtml(r.text||'')}</div></div>`).join('');
  }

  // My Listings (owner sees their pending/rejected too)
  function listenMyListings() {
    if (!currentUser) return;
    const ref = db.ref('providers').orderByChild('ownerUid').equalTo(currentUser.uid);
    ref.on('value', (snap) => {
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({id,...v}));
      myListings.innerHTML = arr.map(p=>`<div class="rounded-xl p-3 ${p.status==='rejected'?'bg-rose-50':p.status==='pending'?'bg-amber-50':'bg-emerald-50'}">
        <div class="flex items-center justify-between"><div><div class="font-semibold">${escapeHtml(p.serviceName)}</div><div class="text-xs">Status: ${p.status}</div></div><button data-id="${p.id}" class="openMineBtn text-xs underline">Open</button></div></div>`).join('');
      myListings.querySelectorAll('.openMineBtn').forEach(b => b.onclick = ()=> openModalById(b.dataset.id));
    });
  }

  // Balance listener
  function listenBalance(){
    if (!currentUser) return;
    db.ref('users/'+currentUser.uid+'/wallet').on('value', snap => {
      const val = snap.val()||0;
      balanceDiv.textContent = `₹${val}`;
    });
  }

  // helper synchronous-ish check for balance (uses cached DOM value)
  function userHasSufficientBalanceSync(amount) {
    const t = balanceDiv.textContent.replace('₹','')||'0';
    return parseInt(t,10) >= amount;
  }

  // Request Recharge
  reqRecharge.onclick = () => requestRechargeAction();
  function requestRechargeAction() {
    if (!currentUser) return alert('Login required');
    const ref = db.ref('rechargeRequests').push();
    ref.set({ uid: currentUser.uid, amount: 100, status: 'pending', createdAt: Date.now() });
    $('rechargeMsg').textContent = 'Recharge requested — admin will approve.';
  }

  // Admin: listen recharge requests
  function listenRechargeRequests(){
    db.ref('rechargeRequests').on('value', snap => {
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({id,...v})).sort((a,b)=>b.createdAt-a.createdAt);
      rechargeList.innerHTML = arr.map(r => `<div class="rounded-xl p-3 ${r.status==='approved'?'bg-emerald-50':'bg-amber-50'}">
        <div class="text-sm font-semibold">UID: ${r.uid}</div><div class="text-xs">Amount: ₹${r.amount} | Status: ${r.status}</div>
        ${r.status!=='approved'?`<div class="mt-2"><button data-id="${r.id}" data-uid="${r.uid}" class="approveReq btn-3d bg-green-600 text-white px-3 py-1 rounded-2xl">Accept Recharge</button></div>`:''}
      </div>`).join('');
      rechargeList.querySelectorAll('.approveReq').forEach(b=> b.onclick = () => adminApproveRecharge(b.dataset.id, b.dataset.uid));
    });
  }
  listenRechargeRequests();

  // admin approves recharge: add ₹100 to user's wallet, mark request approved
  async function adminApproveRecharge(reqId, uid){
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admin only');
    const userRef = db.ref('users/'+uid);
    await userRef.transaction(u => {
      if (u) { u.wallet = (u.wallet||0) + 100; return u; }
      return u;
    });
    await db.ref('rechargeRequests/'+reqId).update({ status:'approved' });
    alert('Recharge successful');
  }

  // Admin listing actions
  async function adminApprove(id){
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admin only');
    await db.ref('providers/'+id).update({ status:'approved' });
  }
  async function adminReject(id){
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admin only');
    await db.ref('providers/'+id).update({ status:'rejected' });
  }
  async function adminDelete(id){
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admin only');
    if (!confirm('Delete permanently?')) return;
    await db.ref('providers/'+id).remove();
  }

  // WhatsApp click: deduct ₹20 then open wa.me
  async function handleWhatsAppClick(providerId){
    if (!currentUser) return alert('Login to contact');
    // get provider
    const snap = await db.ref('providers/'+providerId).once('value');
    const p = snap.val();
    if (!p) return alert('Provider not found');
    // transaction on user's wallet
    const userRef = db.ref('users/'+currentUser.uid+'/wallet');
    try {
      await userRef.transaction(function(current) {
        if ((current || 0) < 20) { return; } // abort
        return (current || 0) - 20;
      }, async function(error, committed, snapshot) {
        if (error) { alert('Transaction failed: '+error); }
        else if (!committed) { alert('Insufficient balance. Recharge to contact.'); }
        else {
          // log contact
          db.ref('contactLogs').push({ uid: currentUser.uid, providerId, cost:20, createdAt: Date.now() });
          // open whatsapp
          const num = (p.whatsapp || p.phone || '').replace(/\D/g,'');
          if (!num) return alert('No WhatsApp number available');
          window.open('https://wa.me/'+num, '_blank');
        }
      });
    } catch(e){ console.error(e); alert('Could not process contact: '+e.message); }
  }

  // search box
  searchBox.addEventListener('input', ()=> {
    // re-render by reading current public providers snapshot (force)
    // easier: call listenPublicProviders again? we already have listener; just trigger rerender by re-reading full list from DB
    db.ref('providers').once('value').then(snap => {
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({id,...v}));
      const approved = arr.filter(a => a.status === 'approved');
      renderGrid(approved);
    });
  });

  // load admin recharge list if admin
  auth.onAuthStateChanged(user => {
    if (user && user.email === ADMIN_EMAIL) {
      listenRechargeRequests();
    }
  });

  // initial public provider render already attached. For admin page to work, make sure to show admin panel when admin logged
  // ensure realtime update for public approvals changes
  db.ref('providers').on('child_changed', snap => {
    // rerender public
    db.ref('providers').once('value').then(snap=> {
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({id,...v}));
      renderGrid(arr.filter(a=>a.status==='approved'));
    });
  });
  db.ref('providers').on('child_removed', snap => {
    db.ref('providers').once('value').then(snap=> {
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({id,...v}));
      renderGrid(arr.filter(a=>a.status==='approved'));
    });
  });

  // show admin recharge UI when admin logged
  auth.onAuthStateChanged(u => {
    if (u && u.email === ADMIN_EMAIL) {
      adminRechargeRequests.classList.remove('hidden');
      // ensure rechargeList populated
      db.ref('rechargeRequests').once('value').then(()=> listenRechargeRequests());
    } else {
      adminRechargeRequests.classList.add('hidden');
    }
  });

  // start - ensure public grid renders live (approved)
  (async function initial() {
    const snap = await db.ref('providers').once('value');
    const obj = snap.val()||{};
    const arr = Object.entries(obj).map(([id,v])=>({id,...v}));
    renderGrid(arr.filter(a=>a.status==='approved'));
  })();

  // small escape helper done; end of script
  </script>
</body>
</html>
