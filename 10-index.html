<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZaraFix - Service Provider Portal</title>
  <style>
    /* Simple 3D style theme, mobile-first */
    :root{
      --bg:#0f172a;
      --card:#0b1220;
      --accent1:#06b6d4;
      --accent2:#f472b6;
      --accent3:#f59e0b;
      --glass: rgba(255,255,255,0.03);
      --muted: #94a3b8;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#071021);color:#e6eef8;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;background:linear-gradient(135deg,var(--accent1),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 8px 18px rgba(2,6,23,.6);}
    .top-actions{display:flex;gap:10px}
    .btn3d{background:var(--glass);border-radius:14px;padding:10px 14px;border:none;color:inherit;cursor:pointer;backdrop-filter:blur(6px);box-shadow:0 8px 0 rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);transform:translateY(0);transition:transform .12s ease, box-shadow .12s ease}
    .btn3d:active{transform:translateY(4px);box-shadow:0 4px 0 rgba(0,0,0,0.6)}
    .container{padding:14px;max-width:1100px;margin:0 auto}
    .layout{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.6)}
    .form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
    label{font-size:13px;color:var(--muted)}
    input,textarea,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .small{font-size:13px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .list{display:grid;gap:12px}
    .provider-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px}
    .avatar{width:68px;height:68px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent3));display:flex;align-items:center;justify-content:center;font-weight:700}
    .meta{flex:1}
    .meta h3{margin:0 0 4px 0}
    .meta p{margin:0;color:var(--muted)}
    .card-actions{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
    .search{display:flex;gap:8px}
    .search input{flex:1}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;padding:10px 14px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.7)}
    @media(min-width:900px){.layout{grid-template-columns:360px 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ZF</div>
      <div>
        <div style="font-weight:700">ZaraFix</div>
        <div style="font-size:12px;color:var(--muted)">Service Providers & Repairs</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="btnToggleForm" class="btn3d">Post Service (Login required)</button>
      <button id="btnLogin" class="btn3d">Login / Register</button>
      <button id="btnLogout" class="btn3d" style="display:none">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="layout">
      <!-- left: forms & filters -->
      <div class="card" id="leftPane">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Search & Filters</div>
          <div class="small">Login: <span id="userEmail">—</span></div>
        </div>

        <div class="search">
          <input id="searchBox" placeholder="Search by name, city, category..." />
          <button id="btnSearch" class="btn3d">Search</button>
        </div>

        <hr style="opacity:.06;margin:12px 0" />

        <div id="authCard" class="card" style="padding:8px">
          <div style="font-weight:700;margin-bottom:8px">Login / Register</div>
          <div class="form-row"><input id="regName" placeholder="Full name" /></div>
          <div class="grid2">
            <input id="regMobile" placeholder="Mobile number" />
            <input id="regWhats" placeholder="WhatsApp number" />
          </div>
          <div class="form-row"><input id="regEmail" placeholder="Email (for login)" /></div>
          <div class="form-row"><input id="regPassword" type="password" placeholder="Password (min 6)" /></div>
          <div style="display:flex;gap:8px">
            <button id="btnRegister" class="btn3d">Register</button>
            <button id="btnLoginEmail" class="btn3d">Login (Email)</button>
            <button id="btnGoogle" class="btn3d">Sign in with Google</button>
          </div>
        </div>

        <hr style="opacity:.06;margin:12px 0" />

        <div id="walletCard" class="card" style="padding:10px">
          <div style="font-weight:700">Wallet</div>
          <div class="small">Balance: ₹<span id="walletBal">0</span></div>
          <div style="margin-top:8px">
            <input id="upiname" placeholder="UPI (admin) - shown to user on recharge" value="Admin UPI: 918806940156@upi" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="rechargeScreenshot" type="file" accept="image/*" />
              <button id="btnRechargeRequest" class="btn3d">Request ₹100 Recharge</button>
            </div>
            <div class="small" style="margin-top:6px">Recharge requests shown to admin. Admin approves to add ₹100.</div>
          </div>
        </div>

        <!-- provider post form (hidden until login) -->
        <div id="providerFormCard" class="card" style="margin-top:12px;display:none">
          <div style="font-weight:700;margin-bottom:8px">Provider Profile</div>
          <div class="form-row"><input id="serviceName" placeholder="Service / Shop Name" /></div>
          <div class="form-row"><input id="serviceCategory" placeholder="Category (e.g. Ambulance, Electrician) - type here" /></div>
          <div class="grid2">
            <input id="city" placeholder="City" />
            <input id="serviceHours" placeholder="Service Hours (e.g. 9AM - 10PM)" />
          </div>
          <div class="form-row"><input id="address" placeholder="Address (visible after wallet check)" /></div>
          <div class="form-row"><input id="profileImage" type="file" accept="image/*" /></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnSubmitProvider" class="btn3d">Submit for Approval</button>
            <div class="small">Status: <span id="postStatus">Not submitted</span></div>
          </div>
        </div>

        <!-- admin panel quick actions visible only to admin -->
        <div id="adminCard" class="card" style="margin-top:12px;display:none">
          <div style="font-weight:700">Admin Panel</div>
          <div class="small">Logged in as admin can approve/reject listings and process recharges.</div>
          <div style="margin-top:8px">
            <button id="btnViewPending" class="btn3d">View Pending Listings</button>
            <button id="btnViewRecharges" class="btn3d">View Recharge Requests</button>
          </div>
        </div>

      </div>

      <!-- right: listing -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:700">Service Listings</div>
          <div class="small">All approved providers shown. Click WhatsApp to reveal (₹20 deduction).</div>
        </div>

        <div id="listArea" class="list"></div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none">Message</div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // === CONFIG (user provided) ===
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // Admin email
    const ADMIN_EMAIL = 'zarasamajiksevasanstha@gmail.com';

    // imgbb key string shown in user's message
    const IMGBB_KEY = 'cad1f0dbfbd25346460789376cc2d7d5';

    // UI references
    const toast = id('toast');
    const btnLogin = id('btnLogin');
    const btnLogout = id('btnLogout');
    const btnGoogle = id('btnGoogle');
    const btnRegister = id('btnRegister');
    const btnLoginEmail = id('btnLoginEmail');
    const userEmailSpan = id('userEmail');
    const providerFormCard = id('providerFormCard');
    const adminCard = id('adminCard');
    const postStatus = id('postStatus');
    const walletBalSpan = id('walletBal');
    const btnToggleForm = id('btnToggleForm');

    let currentUser = null;

    // utilities
    function id(i){return document.getElementById(i)}
    function showToast(msg){toast.style.display='block';toast.textContent=msg;setTimeout(()=>toast.style.display='none',3500)}

    // auth actions
    btnRegister.addEventListener('click', async ()=>{
      const name = id('regName').value.trim();
      const email = id('regEmail').value.trim();
      const pass = id('regPassword').value;
      const mobile = id('regMobile').value.trim();
      const whats = id('regWhats').value.trim();
      if(!name||!email||pass.length<6){return showToast('Name, email and password(min 6) required')}
      try{
        const res = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = res.user.uid;
        await db.ref('users/'+uid).set({name,email,mobile,whats,wallet:0,role:'provider',createdAt:Date.now(),lastDeduction:Date.now()});
        showToast('Registered! Please complete profile.')
      }catch(e){showToast(e.message)}
    })

    btnLoginEmail.addEventListener('click', async ()=>{
      const email = id('regEmail').value.trim();
      const pass = id('regPassword').value;
      try{await auth.signInWithEmailAndPassword(email,pass)}catch(e){showToast(e.message)}
    })

    btnGoogle.addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{await auth.signInWithPopup(provider)}catch(e){showToast(e.message)}
    })

    btnLogout.addEventListener('click', ()=>auth.signOut());

    // toggle post form visibility
    btnToggleForm.addEventListener('click', ()=>{
      if(!currentUser) return showToast('Please login to post');
      providerFormCard.style.display = providerFormCard.style.display==='none'?'block':'none';
    })

    // submit provider profile
    id('btnSubmitProvider').addEventListener('click', async ()=>{
      if(!currentUser) return showToast('Login first');
      const uid = currentUser.uid;
      const name = id('serviceName').value.trim();
      const category = id('serviceCategory').value.trim();
      const city = id('city').value.trim();
      const hours = id('serviceHours').value.trim();
      const address = id('address').value.trim();
      const file = id('profileImage').files[0];
      if(!name||!category){return showToast('Name and category required')}
      postStatus.textContent='Uploading image...';
      let imageUrl = '';
      if(file){
        try{imageUrl = await uploadImageToImgbb(file)}catch(e){showToast('Image upload failed');return}
      }
      const postKey = db.ref('providers').push().key;
      const payload = {uid,name,category,city,hours,address,imageUrl,status:'waiting',createdAt:Date.now(),postKey};
      await db.ref('providers/'+postKey).set(payload);
      postStatus.textContent='Submitted (waiting approval)';
      showToast('Submitted for admin approval')
    })

    // image upload helper
    async function uploadImageToImgbb(file){
      const fd = new FormData();
      fd.append('image', await fileToBase64(file).then(s=>s.split(',')[1]));
      const res = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_KEY,{method:'POST',body:fd});
      const j = await res.json();
      if(!j.success) throw new Error('imgbb failed');
      return j.data.url;
    }
    function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=err=>rej(err);r.readAsDataURL(file)})}

    // recharge request
    id('btnRechargeRequest').addEventListener('click', async ()=>{
      if(!currentUser) return showToast('Login required');
      const file = id('rechargeScreenshot').files[0];
      if(!file) return showToast('Attach screenshot');
      showToast('Uploading receipt...');
      try{
        const url = await uploadImageToImgbb(file);
        const reqKey = db.ref('recharges').push().key;
        await db.ref('recharges/'+reqKey).set({uid:currentUser.uid,screenshot:url,requestedAt:Date.now(),status:'pending'});
        showToast('Recharge request sent to admin');
      }catch(e){showToast('Recharge upload failed')}
    })

    // listing and search
    id('btnSearch').addEventListener('click', loadListings);
    id('searchBox').addEventListener('keydown', (e)=>{if(e.key==='Enter') loadListings()});

    async function loadListings(){
      const q = id('searchBox').value.trim().toLowerCase();
      const snap = await db.ref('providers').orderByChild('createdAt').once('value');
      const data = snap.val()||{};
      const arr = Object.values(data).filter(p=>p.status==='approved');
      const filtered = arr.filter(p=>{
        if(!q) return true;
        return (p.name||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q) || (p.city||'').toLowerCase().includes(q);
      });
      renderList(filtered.reverse());
    }

    function renderList(list){
      const area = id('listArea'); area.innerHTML='';
      if(list.length===0) return area.innerHTML='<div class="card small">No providers found</div>';
      list.forEach(p=>{
        const isAdmin = currentUser && currentUser.email===ADMIN_EMAIL && currentUser.providerData && currentUser.providerData.some(x=>x.providerId==='google.com');
        const div = document.createElement('div');div.className='provider-card card';
        div.innerHTML = `
          <div class="avatar">${(p.name||'--').slice(0,2).toUpperCase()}</div>
          <div class="meta">
            <h3>${escapeHtml(p.name)}</h3>
            <p class="small">${escapeHtml(p.category)} • ${escapeHtml(p.city||'')}</p>
            <p class="small">Hours: ${escapeHtml(p.hours||'')}</p>
            <p class="small">Status: <span style="text-transform:capitalize">${escapeHtml(p.status||'waiting')}</span></p>
          </div>
          <div class="card-actions">
            <button data-key="${p.postKey}" class="btn3d btnCall">Call Now</button>
            <button data-key="${p.postKey}" class="btn3d btnWhats">WhatsApp</button>
            <button data-key="${p.postKey}" class="btn3d btnView">Details</button>
            ${isAdmin?`<div style="display:flex;flex-direction:column;gap:8px;margin-left:8px">
              <button data-key="${p.postKey}" class="btn3d btnApprove">Approve</button>
              <button data-key="${p.postKey}" class="btn3d btnReject">Reject</button>
              <button data-key="${p.postKey}" class="btn3d btnDelete">Delete</button>
            </div>`:''}
          </div>`;
        area.appendChild(div);
      });
      // wire up actions
      document.querySelectorAll('.btnWhats').forEach(b=>b.addEventListener('click', onWhatsClick));
      document.querySelectorAll('.btnCall').forEach(b=>b.addEventListener('click', onCallClick));
      document.querySelectorAll('.btnView').forEach(b=>b.addEventListener('click', onViewClick));
      // admin actions
      document.querySelectorAll('.btnApprove').forEach(b=>b.addEventListener('click', async (e)=>{
        const key = e.currentTarget.dataset.key; await db.ref('providers/'+key+'/status').set('approved'); showToast('Listing approved'); loadListings();
      }));
      document.querySelectorAll('.btnReject').forEach(b=>b.addEventListener('click', async (e)=>{
        const key = e.currentTarget.dataset.key; await db.ref('providers/'+key+'/status').set('rejected'); showToast('Listing rejected (can be approved later)'); loadListings();
      }));
      document.querySelectorAll('.btnDelete').forEach(b=>b.addEventListener('click', async (e)=>{
        const key = e.currentTarget.dataset.key; if(!confirm('Delete this listing permanently?')) return; await db.ref('providers/'+key).remove(); showToast('Listing deleted'); loadListings();
      }));
    }
    }

    async function onViewClick(e){
      const key = e.currentTarget.dataset.key;
      const snap = await db.ref('providers/'+key).once('value');
      const p = snap.val();
      if(!p) return showToast('Not found');
      showModalProvider(p);
    }

    function showModalProvider(p){
      const html = `\n        Name: ${escapeHtml(p.name)}\n        Category: ${escapeHtml(p.category)}\n        City: ${escapeHtml(p.city)}\n        Hours: ${escapeHtml(p.hours)}\n        Address: ${escapeHtml(p.address||'(hidden)')}\n        WhatsApp: ${escapeHtml(p.whats||'(hidden)')}\n      `;
      alert(html);
    }

    async function onCallClick(e){
      const key = e.currentTarget.dataset.key;
      const snap = await db.ref('providers/'+key).once('value');
      const p = snap.val();
      if(!p) return showToast('Not found');
      // show phone if exists
      if(p.whats) window.open('tel:'+p.whats,'_blank');
      else showToast('Phone not provided');
    }

    async function onWhatsClick(e){
      if(!currentUser) return showToast('Login required to reveal contact and pay ₹20');
      const key = e.currentTarget.dataset.key;
      const snap = await db.ref('providers/'+key).once('value');
      const p = snap.val();
      if(!p) return showToast('Not found');
      // check admin approved and provider visible
      if(p.status!=='approved') return showToast('Provider not approved yet');
      // check current user's wallet
      const uSnap = await db.ref('users/'+currentUser.uid).once('value');
      const u = uSnap.val()||{wallet:0};
      // apply pending daily deductions if any
      await applyDailyDeductions(currentUser.uid,u);
      const wallet = (u.wallet||0);
      if(wallet<20) return showToast('Wallet low. Please recharge');
      // deduct 20 atomically using transaction
      const userRef = db.ref('users/'+currentUser.uid+'/wallet');
      await userRef.transaction(curr=>{if(curr===null) curr=0; if(curr>=20) return curr-20; return;});
      // after deduction, open wa link
      const waNumber = p.whats||p.mobile||'';
      if(!waNumber) return showToast('WhatsApp number not available');
      window.open('https://wa.me/'+waNumber.replace(/[^0-9]/g,''),'_blank');
      showToast('₹20 deducted from wallet and WhatsApp opened');
    }

    // rating system
    async function submitRating(providerKey, rating, comment){
      const key = db.ref('ratings').push().key;
      await db.ref('ratings/'+key).set({providerKey,rating,comment,user:currentUser?currentUser.uid:null,at:Date.now()});
      showToast('Thanks for your feedback')
    }

    // admin view pending
    id('btnViewPending').addEventListener('click', async ()=>{
      const snap = await db.ref('providers').orderByChild('createdAt').once('value');
      const data = snap.val()||{}; const arr = Object.values(data);
      const pending = arr.filter(p=>p.status==='waiting');
      if(pending.length===0) return showToast('No pending listings');
      const choice = confirm('Approve all pending? OK = approve all (for demo). Cancel = open console to manually approve individual posts.');
      if(choice){
        pending.forEach(pp=>db.ref('providers/'+pp.postKey+'/status').set('approved'));
        showToast('All pending approved');
        loadListings();
      }else{console.log('pending:',pending);alert('Pending list printed to console for manual approval')}
    })

    id('btnViewRecharges').addEventListener('click', async ()=>{
      const snap = await db.ref('recharges').orderByChild('requestedAt').once('value');
      const data = snap.val()||{}; const arr = Object.entries(data);
      if(arr.length===0) return showToast('No recharge requests');
      // simple flow: admin clicks OK to approve all
      const ok = confirm('Approve all recharge requests? OK=approve all');
      if(ok){
        for(const [k,v] of arr){
          await db.ref('recharges/'+k+'/status').set('approved');
          // credit wallet +100
          const uid = v.uid;
          await db.ref('users/'+uid+'/wallet').transaction(curr=> (curr||0)+100 );
        }
        showToast('All recharges approved and credited')
      }else{console.log(arr);alert('Recharge list printed to console for manual approval')}
    })

    // on auth change
    auth.onAuthStateChanged(async user=>{
      currentUser = user;
      const isGoogle = user && user.providerData && user.providerData.some(p=>p.providerId==='google.com');
      // UI behavior: provider features (Provider Profile, Wallet, Admin Panel) only visible after Google sign-in
      if(user){
        id('userEmail').textContent = user.email;
        btnLogin.style.display='none'; btnLogout.style.display='inline-block';

        // load/create user record if missing
        const uRef = db.ref('users/'+user.uid);
        const s = await uRef.once('value');
        if(!s.exists()){
          await uRef.set({name:user.displayName||'',email:user.email,wallet:0,role:'customer',createdAt:Date.now(),lastDeduction:Date.now(),authProvider:(user.providerData[0]&&user.providerData[0].providerId)||''});
        }
        const u = (await uRef.once('value')).val();
        walletBalSpan.textContent = (u.wallet||0);

        // show provider form and wallet only if signed in with Google
        if(isGoogle){
          providerFormCard.style.display='block';
          walletCard.style.display='block';
        }else{
          providerFormCard.style.display='none';
          walletCard.style.display='none';
        }

        // admin card only if admin email AND signed-in with Google
        if(user.email===ADMIN_EMAIL && isGoogle) adminCard.style.display='block'; else adminCard.style.display='none';

        // attempt to apply daily deductions when logging in
        await applyDailyDeductions(user.uid,(await db.ref('users/'+user.uid).once('value')).val());
        loadListings();
      }else{
        // not logged in: show auth card so user can sign-in (Google recommended)
        id('userEmail').textContent = '—'; btnLogin.style.display='inline-block'; btnLogout.style.display='none'; providerFormCard.style.display='none'; adminCard.style.display='none'; walletCard.style.display='none'; walletBalSpan.textContent='0'; loadListings();
      }
    });
        }
        const u = (await uRef.once('value')).val();
        walletBalSpan.textContent = (u.wallet||0);
        // if admin
        if(user.email===ADMIN_EMAIL) adminCard.style.display='block'; else adminCard.style.display='none';
        // show provider form only for providers (role=provider) - but allow any registered user to post as provider
        providerFormCard.style.display='block';
        // attempt to apply daily deductions when logging in
        await applyDailyDeductions(user.uid,(await db.ref('users/'+user.uid).once('value')).val());
        loadListings();
      }else{
        id('userEmail').textContent = '—'; btnLogin.style.display='inline-block'; btnLogout.style.display='none'; providerFormCard.style.display='none'; adminCard.style.display='none'; walletBalSpan.textContent='0'; loadListings();
      }
    })

    // apply daily deduction logic on login
    async function applyDailyDeductions(uid,userObj){
      try{
        const now = Date.now();
        const last = userObj.lastDeduction||userObj.createdAt||now;
        const days = Math.floor((now - last)/(1000*60*60*24));
        if(days>0){
          const total = days*3;
          await db.ref('users/'+uid+'/wallet').transaction(curr=>{if(curr===null) curr=0; return Math.max(0,curr-total)});
          await db.ref('users/'+uid+'/lastDeduction').set(now);
          showToast(`₹${total} deducted for ${days} day(s) inactivity`);
        }
      }catch(e){console.error(e)}
    }

    // small helpers
    function escapeHtml(s){if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // initial load
    loadListings();

  </script>
</body>
</html>
