<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 10px; margin: 0; }
    .card {
      background: white; border-radius: 20px; padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 20px;
    }
    button {
      background: linear-gradient(to right, #00c6ff, #0072ff);
      border: none; padding: 12px 20px; color: white;
      border-radius: 12px; font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 10px;
    }
    input, select {
      width: 100%; padding: 10px; margin: 8px 0;
      border-radius: 10px; border: 1px solid #ccc;
    }
    .hidden { display: none; }
    .wallet { font-weight: bold; color: green; }
  </style>
</head>
<body>

<div id="content">
  <center><h2>üõ†Ô∏è ZaraFix - Service Provider</h2></center>

  <!-- Registration Form -->
  <div id="registrationForm" class="card hidden">
    <h3>üìã Register as Service Provider</h3>
    <input type="text" id="name" placeholder="Your Name">
    <input type="text" id="shop" placeholder="Shop Name">
    <select id="category">
      <option value="">Select Category</option>
      <option>AC Mechanic</option>
      <option>Car Mechanic</option>
      <option>Electrician</option>
      <option>Plumber</option>
    </select>
    <input type="text" id="whatsapp" placeholder="WhatsApp Number">
    <button onclick="submitRegistration()">Submit</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="card hidden">
    <div id="walletInfo"></div>
    <h3>üìã Matching Service Requests</h3>
    <div id="requestsList"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getDatabase, ref, set, get, child, onValue, update
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
    authDomain: "zara-fix-2e35a.firebaseapp.com",
    projectId: "zara-fix-2e35a",
    storageBucket: "zara-fix-2e35a.appspot.com",
    messagingSenderId: "636550144008",
    appId: "1:636550144008:web:a849496ad1d1557d7ab1bd",
    databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  let currentUser;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("loginBtn")?.remove();

      const posterRef = ref(db, 'posters/' + user.uid);
      const snapshot = await get(posterRef);

      if (snapshot.exists()) {
        showDashboard(snapshot.val());
      } else {
        document.getElementById("registrationForm").classList.remove("hidden");
      }
    } else {
      const btn = document.createElement("button");
      btn.id = "loginBtn";
      btn.innerText = "üîê Login with Google";
      btn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
      document.getElementById("content").prepend(btn);
    }
  });

  async function submitRegistration() {
    const name = document.getElementById("name").value.trim();
    const shop = document.getElementById("shop").value.trim();
    const category = document.getElementById("category").value;
    const whatsapp = document.getElementById("whatsapp").value.trim();

    if (!name || !shop || !category || !whatsapp) return alert("All fields required!");

    const userRef = ref(db, 'posters/' + currentUser.uid);
    await set(userRef, {
      name, shop, category, whatsapp, wallet: 100
    });

    document.getElementById("registrationForm").classList.add("hidden");
    showDashboard({ name, shop, category, whatsapp, wallet: 100 });
  }

  function showDashboard(userData) {
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("walletInfo").innerHTML = `üí∞ Wallet: ‚Çπ<span class="wallet">${userData.wallet}</span>`;
    loadMatchingRequests(userData.category);
  }

  function loadMatchingRequests(category) {
    const reqRef = ref(db, 'requests/');
    onValue(reqRef, (snap) => {
      const container = document.getElementById("requestsList");
      container.innerHTML = "";
      const data = snap.val();
      if (!data) return container.innerHTML = "‚ùå No requests found.";

      for (const userId in data) {
        for (const reqId in data[userId]) {
          const req = data[userId][reqId];
          if (req.category === category) {
            const accepted = req.acceptedBy && req.acceptedBy[currentUser.uid];
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <b>üßë Name:</b> ${req.name}<br>
              <b>üìç Address:</b> ${req.address}<br>
              <b>‚öôÔ∏è Problem:</b> ${req.problem}<br>
              <b>üìû WhatsApp:</b> ${accepted ? `<a href="https://wa.me/${req.whatsapp}" target="_blank">${req.whatsapp}</a>` : "Hidden"}<br>
              ${accepted ? "‚úÖ Accepted" : `<button onclick="acceptRequest('${userId}', '${reqId}')">Accept</button>`}
            `;
            container.appendChild(card);
          }
        }
      }
    });
  }

  async function acceptRequest(userId, reqId) {
    const ref1 = ref(db, `requests/${userId}/${reqId}/acceptedBy/${currentUser.uid}`);
    const posterSnap = await get(ref(db, 'posters/' + currentUser.uid));
    const wallet = posterSnap.val().wallet || 0;

    if (wallet < 20) return alert("‚ùå Not enough balance. Please recharge.");

    // Deduct ‚Çπ20
    await update(ref(db, 'posters/' + currentUser.uid), {
      wallet: wallet - 20
    });

    // Save acceptance
    await set(ref1, {
      name: posterSnap.val().name,
      whatsapp: posterSnap.val().whatsapp,
      timestamp: Date.now()
    });
  }
</script>

</body>
</html>
