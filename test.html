<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Service Provider Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f0f8ff; padding: 10px; text-align: center; }
    .btn {
      padding: 10px 20px; margin: 10px; border: none;
      border-radius: 12px; background: #007bff; color: white;
      font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      cursor: pointer; transition: 0.3s; font-size: 18px;
    }
    .btn:hover { background: #0056b3; }

    .card {
      background: #fff; padding: 15px; margin: 10px auto;
      border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: left; max-width: 500px;
    }

    .led {
      width: 20px; height: 20px; border-radius: 50%;
      display: inline-block; margin-top: 10px;
    }

    .blink {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% { opacity: 0.1; }
    }
  </style>
</head>
<body>
  <h2>üõ†Ô∏è ZaraFix - Service Provider Panel</h2>
  <div id="loginDiv">
    <button class="btn" onclick="googleLogin()">üîê Login with Google</button>
  </div>
  <div id="panel" style="display:none">
    <div id="ledBox"></div>
    <h3>üìã Matching Service Requests</h3>
    <h4 id="wallet">üí∞ Wallet: ‚Çπ0</h4>
    <div id="requestList"></div>
  </div>
  <div id="registerForm" style="display:none">
    <h3>üîß Register as Poster</h3>
    <input id="name" placeholder="Name" /><br><br>
    <input id="shop" placeholder="Shop Name" /><br><br>
    <select id="category">
      <option value="">Select Category</option>
      <option>AC Mechanic</option>
      <option>Car Mechanic</option>
      <option>Plumber</option>
      <option>Electrician</option>
    </select><br><br>
    <input id="whatsapp" placeholder="WhatsApp Number" /><br><br>
    <button class="btn" onclick="submitRegister()">‚úÖ Submit</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let userId = null;
    let acceptedWork = false;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        userId = user.uid;
        document.getElementById("loginDiv").style.display = "none";
        checkIfRegistered();
      }
    });

    function googleLogin() {
      firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }

    function checkIfRegistered() {
      db.ref("posters/" + userId).once("value").then(snapshot => {
        if (snapshot.exists()) {
          document.getElementById("registerForm").style.display = "none";
          showPanel(snapshot.val());
        } else {
          document.getElementById("registerForm").style.display = "block";
        }
      });
    }

    function submitRegister() {
      const name = document.getElementById("name").value;
      const shop = document.getElementById("shop").value;
      const category = document.getElementById("category").value;
      const whatsapp = document.getElementById("whatsapp").value;
      if (!name || !shop || !category || !whatsapp) return alert("Fill all fields");

      db.ref("posters/" + userId).set({ name, shop, category, whatsapp, wallet: 100 });
      document.getElementById("registerForm").style.display = "none";
      showPanel({ name, shop, category, whatsapp, wallet: 100 });
    }

    function showPanel(poster) {
      document.getElementById("panel").style.display = "block";
      document.getElementById("wallet").innerText = "üí∞ Wallet: ‚Çπ" + poster.wallet;
      db.ref("requests").once("value").then(snapshot => {
        const list = document.getElementById("requestList");
        list.innerHTML = "";
        let matchFound = false;
        snapshot.forEach(userSnap => {
          userSnap.forEach(reqSnap => {
            const req = reqSnap.val();
            const reqKey = reqSnap.key;
            if (req.category === poster.category) {
              matchFound = true;
              const card = document.createElement("div");
              card.className = "card";
              card.innerHTML = `
                <b>Name:</b> ${req.name}<br>
                <b>Problem:</b> ${req.problem}<br>
                <b>Address:</b> ${req.address}<br>
                <b>Status:</b> ${req.status}<br>
                <button class="btn" onclick="acceptJob('${userSnap.key}', '${reqKey}')">‚úÖ Accept</button>
              `;
              list.appendChild(card);
            }

            if (req.acceptedBy && req.acceptedBy[userId]) {
              acceptedWork = true;
            }
          });
        });

        showLED(matchFound, acceptedWork);
        if (!matchFound) {
          list.innerHTML = "<p>‚è≥ Wait for work...</p>";
        }
      });
    }

    function acceptJob(userKey, reqKey) {
      db.ref(`requests/${userKey}/${reqKey}/acceptedBy/${userId}`).set({
        name: currentUser.displayName,
        whatsapp: db.ref("posters/" + userId + "/whatsapp"),
        timestamp: Date.now()
      });
      alert("Accepted ‚úÖ");
    }

    function showLED(matched, accepted) {
      const box = document.getElementById("ledBox");
      if (accepted) {
        box.innerHTML = `<div class="led blink" style="background: blue;"></div> <b>Accepted Work</b>`;
      } else if (matched) {
        box.innerHTML = `<div class="led blink" style="background: yellow;"></div> <b>Work Available</b>`;
      } else {
        box.innerHTML = `<div class="led blink" style="background: green;"></div> <b>No Work Yet</b>`;
      }
    }
  </script>
</body>
</html>
