<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin:0; background:#f9f9f9; text-align:center; }
    .hidden { display: none; }
    .btn {
      padding: 12px 24px; margin: 10px;
      border: none; border-radius: 12px;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      color: white; font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    .btn:hover { transform: scale(1.05); }
    .card {
      background: white; padding: 20px; margin: 10px auto;
      max-width: 400px; border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: left;
    }
    input, select {
      width: 90%; padding: 10px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 8px;
    }
  </style>
</head>
<body>

  <h2>üß∞ ZaraFix - Service Provider Panel</h2>

  <div id="loginSection">
    <button class="btn" onclick="googleLogin()">Login with Google</button>
  </div>

  <div id="registrationSection" class="hidden">
    <h3>Register as Service Provider</h3>
    <input id="name" placeholder="Your Name" />
    <input id="shop" placeholder="Shop Name" />
    <select id="category">
      <option value="">Select Category</option>
      <option>AC Mechanic</option>
      <option>Electrician</option>
      <option>Plumber</option>
      <option>Car Mechanic</option>
      <option>Mobile Repair</option>
      <option>Painter</option>
    </select>
    <input id="whatsapp" placeholder="WhatsApp Number" />
    <button class="btn" onclick="submitRegistration()">Submit Registration</button>
  </div>

  <div id="approvalSection" class="hidden">
    <p>‚è≥ Waiting for Admin Approval...</p>
  </div>

  <div id="dashboardSection" class="hidden">
    <h3>üìã Matching Service Requests</h3>
    <p id="walletBalance"></p>
    <div id="requestsList"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      databaseURL: "https://zara-fix-2e35a-default-rtdb.firebaseio.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("loginSection").style.display = "none";
        checkPosterRegistration(user.uid);
      } else {
        document.getElementById("loginSection").style.display = "block";
      }
    });

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    async function checkPosterRegistration(uid) {
      const snap = await db.ref("posters/" + uid).get();
      if (!snap.exists()) {
        document.getElementById("registrationSection").classList.remove("hidden");
      } else {
        const poster = snap.val();
        if (poster.approved === true) {
          showDashboard(poster);
        } else {
          document.getElementById("approvalSection").classList.remove("hidden");
        }
      }
    }

    async function submitRegistration() {
      const name = document.getElementById("name").value.trim();
      const shop = document.getElementById("shop").value.trim();
      const category = document.getElementById("category").value;
      const whatsapp = document.getElementById("whatsapp").value.trim();
      if (!name || !shop || !category || !whatsapp) return alert("Fill all fields");

      await db.ref("posters/" + currentUser.uid).set({
        name, shop, category, whatsapp, wallet: 100, approved: false
      });

      document.getElementById("registrationSection").classList.add("hidden");
      document.getElementById("approvalSection").classList.remove("hidden");
    }

    async function showDashboard(poster) {
      document.getElementById("dashboardSection").classList.remove("hidden");
      document.getElementById("walletBalance").innerText = "üí∞ Wallet: ‚Çπ" + poster.wallet;
      const allRequestsSnap = await db.ref("requests").get();
      const list = document.getElementById("requestsList");
      list.innerHTML = '';

      allRequestsSnap.forEach(userSnap => {
        const userId = userSnap.key;
        const requests = userSnap.val();
        for (const reqId in requests) {
          const req = requests[reqId];
          if (req.category === poster.category) {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <b>${req.name}</b> - ${req.problem}<br>
              üìç ${req.address}<br>
              üìû ${req.whatsapp}<br>
              <button class="btn" onclick="acceptRequest('${userId}', '${reqId}')">Accept</button>
            `;
            list.appendChild(card);
          }
        }
      });
    }

    async function acceptRequest(userId, reqId) {
      const posterSnap = await db.ref("posters/" + currentUser.uid).get();
      const poster = posterSnap.val();
      if (poster.wallet < 20) return alert("Low balance. Please recharge.");

      const timestamp = Date.now();
      await db.ref(`requests/${userId}/${reqId}/acceptedBy/${currentUser.uid}`).set({
        name: poster.name,
        whatsapp: poster.whatsapp,
        timestamp
      });

      await db.ref("posters/" + currentUser.uid + "/wallet").set(poster.wallet - 20);
      alert("Accepted! ‚Çπ20 deducted.");
      location.reload();
    }
  </script>

</body>
</html>
