<!DOCTYPE html>
<html>
<head>
  <title>üõ†Ô∏è Admin - All Service Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 10px; }
    .card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin: 20px 0;
      transition: 0.3s;
      border-left: 6px solid #2196F3;
    }
    .card h3 { margin: 5px 0; }
    .btn {
      background: linear-gradient(145deg, #00c6ff, #0072ff);
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    .btn:active {
      transform: scale(0.97);
    }
    .led {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: gray;
      display: inline-block;
      margin-left: 10px;
    }
    .led.blink {
      background-color: yellow;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { background-color: yellow; }
      50% { background-color: transparent; }
    }
    .accepted-box {
      margin-top: 10px;
      background: #e3f2fd;
      padding: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>üõ†Ô∏è Admin - All Service Requests</h2>
  <div id="requests"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZqL-PVuFdd8rMVIyW7CgHQjPRGHD2h8",
      authDomain: "zara-fix-2e35a.firebaseapp.com",
      projectId: "zara-fix-2e35a",
      storageBucket: "zara-fix-2e35a.appspot.com",
      messagingSenderId: "636550144008",
      appId: "1:636550144008:web:a849496ad1d1557d7ab1bd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const requestsDiv = document.getElementById('requests');

    function renderRequests() {
      db.ref("requests").once('value', (snapshot) => {
        requestsDiv.innerHTML = '';
        const data = snapshot.val();
        if (!data) {
          requestsDiv.innerHTML = "<p>No service requests found.</p>";
          return;
        }

        Object.entries(data).forEach(([userId, userRequests]) => {
          Object.entries(userRequests).forEach(([reqId, req]) => {
            const card = document.createElement('div');
            card.className = "card";

            let approved = req.status === "approved";
            let acceptedBy = req.acceptedBy || {};

            let acceptInfo = '';
            if (Object.keys(acceptedBy).length > 0) {
              acceptInfo += `<div class="accepted-box"><strong>‚úÖ Accepted By:</strong>`;
              Object.entries(acceptedBy).forEach(([uid, info]) => {
                acceptInfo += `<p>Name: ${info.name}<br>
                               WhatsApp: <a href="https://wa.me/${info.whatsapp}" target="_blank">${info.whatsapp}</a><br>
                               </p>`;
              });
              acceptInfo += `</div>`;
            } else {
              acceptInfo += `<p>‚è≥ <strong>Wait for Accept</strong></p>`;
            }

            card.innerHTML = `
              <h3>üë§ ${req.name}</h3>
              <p>üìû ${req.whatsapp}</p>
              <p>üõ†Ô∏è ${req.category}</p>
              <p>üìç ${req.address}</p>
              <p>‚ùì ${req.problem}</p>
              ${acceptInfo}
              <button class="btn" onclick="approveRequest('${userId}', '${reqId}', this)">Approve <span class="led ${approved ? 'blink' : ''}"></span></button>
              <button class="btn" style="background:#f44336" onclick="deleteRequest('${userId}', '${reqId}')">üóëÔ∏è Delete</button>
            `;

            requestsDiv.appendChild(card);
          });
        });
      });
    }

    function approveRequest(userId, reqId, btn) {
      db.ref(`requests/${userId}/${reqId}`).update({
        status: "approved"
      }).then(() => {
        const led = btn.querySelector('.led');
        led.classList.add('blink');
      });
    }

    function deleteRequest(userId, reqId) {
      if (confirm("Delete this request?")) {
        db.ref(`requests/${userId}/${reqId}`).remove().then(() => {
          renderRequests();
        });
      }
    }

    renderRequests();
  </script>
</body>
</html>
