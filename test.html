<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f2f2f2;
      margin: 0;
      padding: 10px;
    }
    .card {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .btn3d {
      background: linear-gradient(to bottom, #4CAF50, #2e7d32);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      margin-top: 10px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px #1b5e20;
    }
    .wallet-led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: red;
      animation: blink 1s infinite;
      margin-left: 8px;
    }
    @keyframes blink {
      0% { background-color: red; }
      50% { background-color: limegreen; }
      100% { background-color: red; }
    }
  </style>
</head>
<body>
  <h2>üéâ Welcome to Your Poster Dashboard</h2>
  <div id="walletDisplay">Wallet: ‚Çπ0 <span class="wallet-led"></span></div>
  <div id="data"></div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    let currentUser, posterData;

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "index.html";
      currentUser = user;
      db.ref("posters/" + user.uid).once("value", snap => {
        if (!snap.exists()) return alert("You are not registered as service provider.");
        posterData = snap.val();
        showWallet();
        loadJobs();
      });
    });

    function showWallet() {
      db.ref("posters/" + currentUser.uid + "/wallet").on("value", snap => {
        document.getElementById("walletDisplay").innerHTML = 
          `Wallet: ‚Çπ${snap.val()} <span class="wallet-led"></span>`;
      });
    }

    function loadJobs() {
      db.ref("requests").once("value", snap => {
        let html = "";
        snap.forEach(userSnap => {
          userSnap.forEach(jobSnap => {
            const job = jobSnap.val();
            const jobId = jobSnap.key;
            if (job.category !== posterData.category) return;

            const accepted = job.acceptedBy?.[currentUser.uid];
            const acceptCount = job.acceptedBy ? Object.keys(job.acceptedBy).length : 0;

            html += `<div class="card">
              <b>Customer:</b> ${job.name}<br>
              <b>Problem:</b> ${job.problem}<br>
              <b>Address:</b> ${job.address}<br>
              <b>Category:</b> ${job.category}<br>`;

            if (accepted) {
              html += `
                <b>WhatsApp:</b> <a href="https://wa.me/${job.whatsapp}" target="_blank">${job.whatsapp}</a><br>
                ${job.lat ? `<b>Location:</b> <a href="https://www.google.com/maps?q=${job.lat},${job.lng}" target="_blank">üìç View Map</a><br>` : ""}
              `;
            } else {
              html += `<button class="btn3d" onclick="acceptJob('${userSnap.key}','${jobId}')">Accept Job (‚Çπ20)</button>`;
            }

            html += `<br><b>Accepted by:</b> ${acceptCount}</div>`;
          });
        });
        document.getElementById("data").innerHTML = html || "No matching jobs.";
      });
    }

    function acceptJob(userId, jobId) {
      const walletRef = db.ref("posters/" + currentUser.uid + "/wallet");
      walletRef.once("value", snap => {
        let wallet = snap.val() || 0;
        if (wallet < 20) return alert("Insufficient wallet balance.");

        walletRef.set(wallet - 20);
        db.ref(`requests/${userId}/${jobId}/acceptedBy/${currentUser.uid}`).set({
          name: posterData.name,
          shop: posterData.shop,
          address: posterData.address,
          whatsapp: posterData.whatsapp,
          category: posterData.category
        }, () => {
          alert("‚úÖ Job accepted! WhatsApp and location unlocked.");
          loadJobs();
        });
      });
    }
  </script>
</body>
</html>
