<!DOCTYPE html>
<html>
<head>
  <title>üîß Admin - All Service Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial;
      background: #f2f2f2;
      padding: 10px;
    }
    .card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: yellow;
      position: absolute;
      top: 15px;
      right: 15px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }
    button {
      background-color: red;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>üîß Admin - All Service Requests</h2>
  <div id="requests"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://zarafix-default-rtdb.firebaseio.com/",
      apiKey: "AIzaSyDYKFtPxxeCek20oipnB_YeUeUlJEYo5aA",
      authDomain: "zarafix.firebaseapp.com",
      projectId: "zarafix",
      storageBucket: "zarafix.appspot.com",
      messagingSenderId: "74034720063",
      appId: "1:74034720063:web:8dd2b3c1908583b3a23e7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const requestsRef = ref(db, 'requests');
    const requestsDiv = document.getElementById("requests");

    onValue(requestsRef, snapshot => {
      requestsDiv.innerHTML = '';
      if (!snapshot.exists()) {
        requestsDiv.innerHTML = '<p>No service requests found.</p>';
        return;
      }
      const requests = snapshot.val();
      Object.keys(requests).forEach(userId => {
        const userRequests = requests[userId];
        Object.keys(userRequests).forEach(requestId => {
          const r = userRequests[requestId];

          let acceptedHTML = "<p>‚úÖ Accepted By:<br>Name: N/A<br>WhatsApp: N/A<br>Shop: N/A<br>Category: N/A</p>";
          let led = '';

          if (r.acceptedBy) {
            const acceptedList = Object.values(r.acceptedBy).map(poster => {
              return `<p>‚úÖ Accepted By:<br>
              Name: ${poster.name}<br>
              WhatsApp: <a href='https://wa.me/91${poster.whatsapp}' target='_blank'>${poster.whatsapp}</a><br>
              Shop: ${poster.shop}<br>
              Category: ${poster.category}</p>`;
            }).join('<hr>');
            acceptedHTML = acceptedList;
            led = '<div class="led"></div>';
          }

          requestsDiv.innerHTML += `
            <div class="card">
              ${led}
              <p>üë§ <b>${r.name}</b></p>
              <p>üìû ${r.whatsapp}</p>
              <p>üîß ${r.category}</p>
              <p>üìç ${r.address}</p>
              <p>‚ùì ${r.problem}</p>
              ${acceptedHTML}
              <button onclick="deleteRequest('${userId}', '${requestId}')">Delete</button>
            </div>
          `;
        });
      });
    });

    window.deleteRequest = function(userId, requestId) {
      if (confirm("Are you sure to delete this request?")) {
        const reqRef = ref(db, `requests/${userId}/${requestId}`);
        remove(reqRef);
      }
    }
  </script>
</body>
</html>
