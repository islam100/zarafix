<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zara Shop Approval</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    #form, #dashboard, #waiting { display: none; }
    input, select, button { display: block; margin: 10px 0; padding: 10px; width: 100%; max-width: 400px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2 id="status">Zara Shop Form</h2>

  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn" class="hidden">Logout</button>

  <div id="form">
    <input type="text" id="shopName" placeholder="Shop Name" required />
    <input type="text" id="address" placeholder="Full Address" required />
    <input type="text" id="pincode" placeholder="Pincode" required />
    <select id="category">
      <option value="">Select Category</option>
      <option value="electrician">Electrician</option>
      <option value="plumber">Plumber</option>
      <option value="technician">Technician</option>
    </select>
    <select id="subcategory">
      <option value="">Select Subcategory</option>
      <option value="ac">AC Repair</option>
      <option value="fan">Fan Repair</option>
      <option value="light">Light Install</option>
    </select>
    <button id="submitForm">Submit</button>
    <p id="errorMsg" style="color:red;"></p>
  </div>

  <div id="waiting">
    <p>⏳ Waiting for approval...</p>
  </div>

  <div id="dashboard">
    <h3>✅ Approved Dashboard</h3>
    <p><b>Wallet Balance:</b> ₹<span id="wallet">0</span></p>
    <div id="taskView"></div>
    <p><button id="acceptBtn">Accept Work (-₹20)</button></p>
    <a id="whatsappBtn" href="#" class="hidden">Chat on WhatsApp</a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "730768653800",
      appId: "1:730768653800:web:e46e3b95db077cc9d319fb",
      measurementId: "G-N0BQ5ZW9NV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").classList.remove("hidden");
        checkUserStatus();
      }
    });

    document.getElementById("loginBtn").onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    document.getElementById("logoutBtn").onclick = () => {
      auth.signOut();
      location.reload();
    };

    function checkUserStatus() {
      db.ref("users/" + currentUser.uid).once("value", snap => {
        if (snap.exists()) {
          const data = snap.val();
          if (data.status === "approved") showDashboard(data);
          else document.getElementById("waiting").style.display = "block";
        } else {
          document.getElementById("form").style.display = "block";
        }
      });
    }

    document.getElementById("submitForm").onclick = () => {
      const shopName = document.getElementById("shopName").value.trim();
      const address = document.getElementById("address").value.trim();
      const pincode = document.getElementById("pincode").value.trim();
      const category = document.getElementById("category").value;
      const subcategory = document.getElementById("subcategory").value;
      const error = document.getElementById("errorMsg");

      if (!shopName || !address || !pincode || !category || !subcategory) {
        error.innerText = "गलत है - कृपया सभी जानकारी सही भरें";
        return;
      }

      db.ref("users/" + currentUser.uid).set({
        shopName, address, pincode, category, subcategory,
        wallet: 100, status: "pending", uid: currentUser.uid
      }, () => {
        document.getElementById("form").style.display = "none";
        document.getElementById("waiting").style.display = "block";
      });
    };

    function showDashboard(data) {
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("wallet").innerText = data.wallet;
      document.getElementById("taskView").innerHTML = `<p><b>Category:</b> ${data.category} / ${data.subcategory}</p>`;

      const acceptBtn = document.getElementById("acceptBtn");
      const whatsappBtn = document.getElementById("whatsappBtn");

      acceptBtn.onclick = () => {
        if (data.wallet >= 20) {
          const newBalance = data.wallet - 20;
          db.ref("users/" + currentUser.uid + "/wallet").set(newBalance);
          document.getElementById("wallet").innerText = newBalance;
          whatsappBtn.classList.remove("hidden");
          whatsappBtn.href = `https://wa.me/91XXXXXXXXXX`;
        } else {
          alert("पैसे कम हैं Wallet में!");
        }
      };
    }
  </script>
</body>
</html>
