<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 10px; margin:0; }
    .container {
      max-width: 600px; margin:auto;
      background: #fff; padding:20px;
      border-radius:15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2 { text-align:center; color:#333; }
    .input3d input, .input3d select {
      width:100%; padding:12px; margin:10px 0; border:none;
      border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .btn3d {
      display:block; width:100%; padding:12px; margin:10px 0;
      font-size:16px; color:white; border:none;
      border-radius:12px;
      background:linear-gradient(to right,#2196F3,#21CBF3);
      box-shadow:0 6px 16px rgba(0,0,0,0.3);
      cursor:pointer;
      text-align:center;
      text-decoration:none;
    }
    .card {
      background:#fefefe; padding:15px; margin:10px 0;
      border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,0.1);
    }
    .wallet { font-weight:bold; color:green; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <h2>ZaraFix - Poster Dashboard</h2>

  <div id="authSection">
    <button class="btn3d" onclick="login()">🔐 Login with Google</button>
  </div>

  <div id="posterDashboard" class="hidden">
    <p class="wallet">Wallet: ₹<span id="walletAmt">0</span></p>
    <button class="btn3d" onclick="logout()">🚪 Logout</button>
    <div id="jobList"></div>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
  authDomain: "zara-fix.firebaseapp.com",
  databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
  projectId: "zara-fix",
  storageBucket: "zara-fix.appspot.com",
  messagingSenderId: "476473209200",
  appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
};
firebase.initializeApp(firebaseConfig);

let currentUser;
firebase.auth().onAuthStateChanged(user => {
  if (!user) return;
  currentUser = user;
  document.getElementById("authSection").classList.add("hidden");
  document.getElementById("posterDashboard").classList.remove("hidden");
  loadDashboard();
});

function login() {
  firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout() {
  firebase.auth().signOut().then(() => location.reload());
}

function loadDashboard() {
  const jobList = document.getElementById("jobList");
  const walletSpan = document.getElementById("walletAmt");
  const uid = currentUser.uid;

  firebase.database().ref("posters/" + uid).once("value").then(snap => {
    const data = snap.val();
    const wallet = data.wallet || 0;
    walletSpan.textContent = wallet;

    firebase.database().ref("requests").once("value").then(snapshot => {
      jobList.innerHTML = "";
      snapshot.forEach(child => {
        child.forEach(grand => {
          const job = grand.val();
          const key = grand.key;
          const acceptedBy = job.acceptedBy || {};

          if (acceptedBy[uid]) {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <b>${job.name}</b><br>
              🏠 ${job.address}, ${job.pincode}<br>
              💬 ${job.issue}<br>
              📞 ${job.whatsapp}<br>
              <a class="btn3d" href="https://wa.me/${job.whatsapp}" target="_blank">💬 WhatsApp</a>
              <button class="btn3d" onclick="rejectJob('${child.key}', '${key}')">❌ Reject</button>
            `;
            jobList.appendChild(card);
          }
        });
      });
    });
  });
}

function rejectJob(userId, requestId) {
  if (!confirm("Are you sure to reject this job?")) return;
  const path = `requests/${userId}/${requestId}/acceptedBy/${currentUser.uid}`;
  firebase.database().ref(path).remove().then(() => {
    alert("❌ Job Rejected.");
    loadDashboard();
  });
}
</script>
</body>
</html>
