<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 10px; margin:0; }
    .container {
      max-width: 600px; margin:auto;
      background: #fff; padding:20px;
      border-radius:15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2 { text-align:center; color:#333; }
    .input3d input, .input3d select {
      width:100%; padding:12px; margin:10px 0; border:none;
      border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .btn3d {
      display:block; width:100%; padding:12px; margin:10px 0;
      font-size:16px; color:white; border:none;
      border-radius:12px;
      background:linear-gradient(to right,#2196F3,#21CBF3);
      box-shadow:0 6px 16px rgba(0,0,0,0.3);
      cursor:pointer;
    }
    .card {
      background:#fefefe; padding:15px; margin:10px 0;
      border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,0.1);
    }
    .wallet { font-weight:bold; color:green; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <h2>ZaraFix - Poster Dashboard</h2>

  <div id="authSection">
    <button class="btn3d" onclick="login()">üîê Login with Google</button>
  </div>

  <div id="registerForm" class="hidden">
    <h3>üìù Poster Registration</h3>
    <div class="input3d"><input type="text" id="posterName" placeholder="Your Name"></div>
    <div class="input3d"><input type="text" id="shopName" placeholder="Shop Name"></div>
    <div class="input3d"><input type="text" id="address" placeholder="Address"></div>
    <div class="input3d">
      <select id="category">
        <option value="">-- Select Category --</option>
        <option>AC Repair</option>
        <option>Washing Machine Repair</option>
        <option>TV Repair</option>
        <option>Refrigerator Repair</option>
        <option>Electrician</option>
        <option>Plumbing</option>
        <option>Carpenter</option>
        <option>Others</option>
      </select>
    </div>
    <div class="input3d"><input type="text" id="whatsapp" placeholder="WhatsApp Number"></div>
    <div class="wallet">Wallet: ‚Çπ<span id="walletAmt">0</span></div>
    <button class="btn3d" onclick="submitPoster()">üì© Submit</button>
    <p id="regMsg" style="color:red;"></p>
  </div>

  <div id="posterDashboard" class="hidden">
    <p class="wallet">Wallet: ‚Çπ<span id="walletAmt2">0</span></p>
    <div id="jobList"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
  authDomain: "zara-fix.firebaseapp.com",
  databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
  projectId: "zara-fix",
  storageBucket: "zara-fix.appspot.com",
  messagingSenderId: "476473209200",
  appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
};
firebase.initializeApp(firebaseConfig);

let currentUser, posterRef;

firebase.auth().onAuthStateChanged(user => {
  currentUser = user;
  if (!user) return document.getElementById("authSection").classList.remove("hidden");
  document.getElementById("authSection").classList.add("hidden");

  posterRef = firebase.database().ref("posters/" + user.uid);
  posterRef.once("value", snap => {
    const data = snap.val();
    if (data && data.userId === user.uid) {
      if (data.wallet >= 100) {
        document.getElementById("posterDashboard").classList.remove("hidden");
        document.getElementById("walletAmt2").textContent = data.wallet;
        deductDailyCharge();
        loadJobs(data.category);
      } else {
        document.getElementById("registerForm").classList.remove("hidden");
        document.getElementById("walletAmt").textContent = data.wallet;
        document.getElementById("regMsg").textContent = "‚ùå Please recharge your wallet.";
      }
    } else {
      document.getElementById("registerForm").classList.remove("hidden");
      document.getElementById("walletAmt").textContent = 0;
    }
  });
});

function login() {
  firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function submitPoster() {
  const name = document.getElementById("posterName").value.trim();
  const shop = document.getElementById("shopName").value.trim();
  const addr = document.getElementById("address").value.trim();
  const cat = document.getElementById("category").value;
  const wa = document.getElementById("whatsapp").value.trim();
  if (!name || !shop || !addr || !cat || !wa) return alert("All fields required!");

  const data = { name, shop, address: addr, category: cat, whatsapp: wa, wallet: 0, userId: currentUser.uid };
  posterRef.set(data).then(() => location.reload());
}

function deductDailyCharge() {
  const today = new Date().toISOString().split("T")[0];
  const dailyRef = firebase.database().ref("dailyDeduction/" + currentUser.uid + "/" + today);
  const walletRef = firebase.database().ref("posters/" + currentUser.uid + "/wallet");

  dailyRef.once("value", snap => {
    if (!snap.exists()) {
      walletRef.once("value", s => {
        let w = s.val() || 0;
        if (w >= 3) {
          walletRef.set(w - 3);
          dailyRef.set(true);
        }
      });
    }
  });
}

function loadJobs(category) {
  const jobList = document.getElementById("jobList");
  jobList.innerHTML = "Loading...";

  firebase.database().ref("requests").on("value", snap => {
    jobList.innerHTML = "";
    snap.forEach(child => {
      const job = child.val(), key = child.key;
      if (job.category === category) {
        const accepted = job.acceptedBy && job.acceptedBy[currentUser.uid];
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <b>${job.name}</b> | ${job.city}<br>
          üè† ${job.address}, ${job.pincode}<br>
          üì¶ ${job.category}<br>
          üí¨ ${job.issue}<br>
          <small>${job.timestamp || ""}</small><br><br>
          ${accepted ? `‚úÖ Accepted<br><a class="btn3d" href="https://wa.me/${job.whatsapp}" target="_blank">WhatsApp</a>` :
            `<button class="btn3d" onclick="acceptJob('${key}')">‚úÖ Accept</button>`}
        `;
        jobList.appendChild(card);
      }
    });
  });
}

function acceptJob(key) {
  const walletRef = firebase.database().ref("posters/" + currentUser.uid + "/wallet");
  walletRef.once("value", snap => {
    let w = snap.val() || 0;
    if (w < 20) return alert("‚ùå Insufficient balance!");

    const acceptRef = firebase.database().ref("requests/" + key + "/acceptedBy/" + currentUser.uid);
    acceptRef.set(true).then(() => {
      walletRef.set(w - 20);
      alert("‚úÖ Job Accepted! ‚Çπ20 deducted.");
      location.reload();
    });
  });
}
</script>
</body>
</html>
