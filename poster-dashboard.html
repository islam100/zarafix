<!DOCTYPE html>
<html>
<head>
  <title>Provider Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .card {
      background: white;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    .btn-3d {
      background: linear-gradient(#28a745, #218838);
      color: white;
      border: none;
      padding: 10px 20px;
      font-weight: bold;
      box-shadow: 0 4px #1c7430;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-3d:active {
      box-shadow: 0 2px #1c7430;
      transform: translateY(2px);
    }
    .wallet {
      margin: 10px 0;
      padding: 10px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 6px;
    }
    .whatsapp {
      margin-top: 10px;
      display: inline-block;
      background: #25d366;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h2>Provider Dashboard</h2>
  <div id="wallet" class="wallet">Wallet: ₹<span id="walletAmount">0</span></div>
  <div id="requests"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUser = null;
    let currentProvider = null;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        firebase.database().ref('providers/' + user.uid).once('value', snap => {
          currentProvider = snap.val();
          loadWallet();
          loadRequests();
        });
      } else {
        firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }
    });

    function loadWallet() {
      firebase.database().ref('wallets/' + currentUser.uid).on('value', snap => {
        document.getElementById("walletAmount").innerText = snap.val() || 0;
      });
    }

    function loadRequests() {
      firebase.database().ref('requests').on('value', snap => {
        const container = document.getElementById("requests");
        container.innerHTML = '';
        snap.forEach(req => {
          const data = req.val();
          const id = req.key;

          if (data.category === currentProvider.category && data.subcategory === currentProvider.subcategory) {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <b>${data.name}</b><br>
              Address: ${data.address}<br>
              Shop: ${data.shop}<br>
              ${data.acceptedBy && data.acceptedBy.includes(currentUser.uid) ? `<a class="whatsapp" href="https://wa.me/${data.phone}" target="_blank">WhatsApp</a>` : `<button class="btn-3d" onclick="acceptRequest('${id}')">Accept</button>`}
            `;
            container.appendChild(card);
          }
        });
      });
    }

    function acceptRequest(requestId) {
      const walletRef = firebase.database().ref('wallets/' + currentUser.uid);
      walletRef.once('value').then(snapshot => {
        let balance = snapshot.val() || 0;
        if (balance < 100) {
          alert("Please recharge. Minimum wallet balance required is ₹100");
          return;
        }

        firebase.database().ref('requests/' + requestId).once('value').then(snap => {
          let data = snap.val();
          if (!data.acceptedBy) data.acceptedBy = [];
          if (!data.acceptedBy.includes(currentUser.uid)) {
            data.acceptedBy.push(currentUser.uid);
          }
          firebase.database().ref('requests/' + requestId).update({
            acceptedBy: data.acceptedBy
          });

          // ₹20 कटे
          walletRef.set(balance - 20);
        });
      });
    }
  </script>
</body>
</html>
