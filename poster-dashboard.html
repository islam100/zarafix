<!DOCTYPE html>
<html>
<head>
  <title>ZaraFix - Poster Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 10px; margin:0; }
    .container {
      max-width: 600px; margin:auto;
      background: #fff; padding:20px;
      border-radius:15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2 { text-align:center; color:#333; }
    .input3d input, .input3d select {
      width:100%; padding:12px;
      margin:10px 0; border:none;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:0.2s;
    }
    .input3d input:focus, .input3d select:focus {
      outline:none;
      box-shadow:0 0 0 3px #90caf9;
      transform:scale(1.02);
    }
    .btn3d {
      display:block; width:100%;
      padding:12px; margin:15px 0;
      font-size:18px;
      color:white; border:none;
      border-radius:12px;
      background:linear-gradient(to right,#2196F3,#21CBF3);
      box-shadow:0 6px 16px rgba(0,0,0,0.3);
      cursor:pointer; transition:0.2s;
    }
    .btn3d:hover { transform:scale(1.05); }
    .card {
      background:#fefefe; padding:15px;
      margin:10px 0; border-radius:12px;
      box-shadow:0 8px 16px rgba(0,0,0,0.1);
      transition:0.2s;
    }
    .card:hover { transform:scale(1.01); }
    @media screen and (max-width:600px) {
      .btn3d { font-size:16px; padding:10px; }
      .input3d input, .input3d select { padding:10px; }
    }
    .wallet { font-weight:bold; color:green; margin:10px 0; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <h2>ZaraFix - Poster Dashboard</h2>

  <div id="authSection">
    <button class="btn3d" onclick="login()">üîê Login with Google</button>
  </div>

  <div id="registerForm" class="hidden">
    <h3>üìù Poster Registration</h3>
    <div class="input3d"><input type="text" id="posterName" placeholder="Your Name"></div>
    <div class="input3d"><input type="text" id="shopName" placeholder="Shop Name"></div>
    <div class="input3d"><input type="text" id="address" placeholder="Address"></div>
    <div class="input3d">
      <select id="category">
        <option value="">-- Select Category --</option>
        <option>AC Repair</option><option>Washing Machine Repair</option>
        <option>Refrigerator Repair</option><option>TV Repair</option>
        <option>Plumbing</option><option>Electrician</option>
        <option>Carpenter</option><option>Others</option>
      </select>
    </div>
    <div class="input3d"><input type="text" id="whatsapp" placeholder="WhatsApp Number"></div>
    <div class="wallet">Wallet Balance: ‚Çπ<span id="walletAmt">0</span></div>
    <button class="btn3d" onclick="submitPoster()">üì© Submit</button>
    <p id="regMsg" style="color:red;"></p>
  </div>

  <div id="posterDashboard" class="hidden">
    <p class="wallet">Wallet: ‚Çπ<span id="walletAmt2">0</span></p>
    <div id="jobList"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = { /* same config */ };
firebase.initializeApp(firebaseConfig);
let currentUser, posterRef;

firebase.auth().onAuthStateChanged(user => {
  currentUser = user;
  if (!user) { document.getElementById("authSection").classList.remove("hidden"); return; }
  document.getElementById("authSection").classList.add("hidden");
  posterRef = firebase.database().ref("posters/" + user.uid);
  posterRef.once("value", snap => {
    const data = snap.val();
    if (data && data.userId === user.uid) {
      const w = data.wallet || 0;
      if (w >= 100) {
        document.getElementById("walletAmt2").textContent = w;
        document.getElementById("posterDashboard").classList.remove("hidden");
        deductDailyCharge(); loadJobs();
      } else {
        document.getElementById("registerForm").classList.remove("hidden");
        document.getElementById("walletAmt").textContent = w;
        document.getElementById("regMsg").textContent = "‚ùå Please recharge your wallet.";
      }
    } else {
      document.getElementById("registerForm").classList.remove("hidden");
      document.getElementById("walletAmt").textContent = 100;
    }
  });
});

function login() {
  firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function submitPoster() {
  const name = document.getElementById("posterName").value.trim();
  const shop = document.getElementById("shopName").value.trim();
  const addr = document.getElementById("address").value.trim();
  const cat = document.getElementById("category").value;
  const wa = document.getElementById("whatsapp").value.trim();
  if (!name||!shop||!addr||!cat||!wa) return alert("All fields required!");

  const upload = {
    name, shop, address:addr, category:cat, whatsapp:wa,
    wallet: 100, userId:currentUser.uid
  };
  posterRef.set(upload).then(()=>location.reload());
}

function deductDailyCharge() {
  const day = new Date().toISOString().split("T")[0];
  const dref = firebase.database().ref(`dailyDeduction/${currentUser.uid}/${day}`);
  const wref = firebase.database().ref(`posters/${currentUser.uid}/wallet`);
  dref.once("value", snap => {
    if (!snap.exists()) {
      wref.once("value", s => {
        let w = s.val()||0;
        if (w >= 3) {
          wref.set(w - 3);
          dref.set(true);
        }
      });
    }
  });
}

function loadJobs() {
  const list = document.getElementById("jobList");
  list.innerHTML = "Loading jobs...";
  firebase.database().ref("requests").on("value", snap => {
    list.innerHTML = "";
    snap.forEach(c => {
      const req = c.val(), key=c.key;
      posterRef.once("value", p => {
        const post = p.val();
        if (post.category === req.category) {
          const card = document.createElement("div"); card.className="card";
          const accepted = req.acceptedBy && req.acceptedBy[currentUser.uid];
          card.innerHTML = `
            <b>${req.name}</b> | ${req.city}<br>
            üè† ${req.address}, ${req.pincode}<br>
            üì¶ ${req.category}<br>
            üí¨ ${req.issue}<br>
            <small>${req.timestamp}</small><br><br>
            ${accepted ? `‚úÖ Accepted<br><a href="https://wa.me/${req.whatsapp}" target="_blank" class="btn3d">WhatsApp</a>`:
              `<button class="btn3d" onclick="acceptJob('${key}')">‚úÖ Accept</button>`
            }
            <button class="btn3d" onclick="deleteJob('${key}')">üóë Delete</button>
          `;
          list.appendChild(card);
        }
      });
    });
  });
}

function acceptJob(id) {
  const wref = firebase.database().ref(`posters/${currentUser.uid}/wallet`);
  wref.once("value", s => {
    let w=s.val()||0;
    if (w<20) return alert("Low balance!");
    firebase.database().ref(`requests/${id}/acceptedBy/${currentUser.uid}`).set(true)
    .then(()=>wref.set(w-20).then(()=>loadJobs()));
  });
}

function deleteJob(id) {
  if(confirm("Delete?")) firebase.database().ref("requests/"+id).remove();
}
</script>
</body>
</html>
