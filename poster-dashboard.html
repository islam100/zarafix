<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poster Registration</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    form, #dashboard {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 12px;
      background: teal;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #004d4d;
    }
    .hidden {
      display: none;
    }
    @media(max-width: 600px) {
      form, #dashboard { width: 95%; }
    }
  </style>
</head>
<body>

<h2 style="text-align:center;">Poster Registration</h2>

<div id="loginBox" style="text-align: center; margin-bottom: 20px;">
  <button onclick="loginWithGoogle()">Login with Google</button>
</div>

<div id="logoutBox" class="hidden" style="text-align: center; margin-bottom: 20px;">
  <p id="userName"></p>
  <button onclick="logout()">Logout</button>
</div>

<form id="posterForm" class="hidden">
  <input type="text" id="name" placeholder="Your Name" required />
  <input type="tel" id="phone" placeholder="Phone Number" required />
  <input type="text" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required />

  <select id="category" required>
    <option value="">Select Category</option>
    <option value="Electrician">Electrician</option>
    <option value="Plumber">Plumber</option>
    <option value="Salon">Salon</option>
  </select>

  <select id="subcategory" required>
    <option value="">Select Subcategory</option>
  </select>

  <input type="text" id="location" placeholder="Shop Full Address" required />
  <button type="submit">Submit</button>
</form>

<div id="dashboard" class="hidden">
  <h3>🧾 Poster Dashboard</h3>
  <p>✅ Your poster has been submitted. <strong>Wait for approval.</strong></p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
    authDomain: "zara-fix.firebaseapp.com",
    databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
    projectId: "zara-fix",
    storageBucket: "zara-fix.appspot.com",
    messagingSenderId: "5010031414",
    appId: "1:5010031414:web:7c7ddc8b2e9187db6b7a88"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  const form = document.getElementById("posterForm");
  const dashboard = document.getElementById("dashboard");
  const loginBox = document.getElementById("loginBox");
  const logoutBox = document.getElementById("logoutBox");
  const userName = document.getElementById("userName");
  const categoryDropdown = document.getElementById("category");
  const subcategoryDropdown = document.getElementById("subcategory");

  const subcategories = {
    Electrician: ["Fan Repair", "Switch Fitting", "New Wiring"],
    Plumber: ["Tap Leak", "Pipeline Setup", "Bathroom Fitting"],
    Salon: ["Haircut", "Facial", "Threading"]
  };

  categoryDropdown.addEventListener("change", () => {
    const cat = categoryDropdown.value;
    subcategoryDropdown.innerHTML = `<option value="">Select Subcategory</option>`;
    if (subcategories[cat]) {
      subcategories[cat].forEach(sub => {
        let opt = document.createElement("option");
        opt.value = sub;
        opt.innerText = sub;
        subcategoryDropdown.appendChild(opt);
      });
    }
  });

  function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        const user = result.user;
        userName.textContent = `Welcome, ${user.displayName}`;
        loginBox.classList.add("hidden");
        logoutBox.classList.remove("hidden");
        checkFormStatus(user.uid);
      })
      .catch(err => alert("Login failed: " + err.message));
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  function checkFormStatus(uid) {
    db.ref("posterUsers/" + uid).once("value").then(snapshot => {
      if (snapshot.exists()) {
        form.classList.add("hidden");
        dashboard.classList.remove("hidden");
      } else {
        form.classList.remove("hidden");
        dashboard.classList.add("hidden");
      }
    });
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const pincode = document.getElementById("pincode").value.trim();
    const category = categoryDropdown.value;
    const subcategory = subcategoryDropdown.value;
    const location = document.getElementById("location").value.trim();

    if (!/^\d{6}$/.test(pincode)) {
      alert("❌ Invalid Pincode. Please enter a 6-digit number.");
      return;
    }

    const user = auth.currentUser;
    if (!user) return alert("Please login first");

    const uid = user.uid;
    const data = {
      name, phone, pincode, category, subcategory, location,
      email: user.email,
      timestamp: new Date().toISOString(),
      approved: false
    };

    db.ref("posterUsers/" + uid).set(data)
      .then(() => {
        form.classList.add("hidden");
        dashboard.classList.remove("hidden");
      })
      .catch(err => alert("Submit failed: " + err.message));
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      userName.textContent = `Welcome, ${user.displayName}`;
      loginBox.classList.add("hidden");
      logoutBox.classList.remove("hidden");
      checkFormStatus(user.uid);
    }
  });
</script>

</body>
</html>
