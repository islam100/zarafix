<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">ðŸ”§ Service Dashboard</span>
      <div id="user-info" class="text-white"></div>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container my-4">
    <div id="dashboard"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      storageBucket: "zara-fix.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        db.ref(`users/${uid}`).once("value").then(snapshot => {
          if (snapshot.exists()) {
            renderUserDashboard(snapshot.val(), uid);
          } else {
            db.ref(`providers/${uid}`).once("value").then(snap => {
              if (snap.exists()) {
                renderProviderDashboard(snap.val(), uid);
              } else {
                document.getElementById("dashboard").innerHTML = `<div class="alert alert-danger">User not found in database.</div>`;
              }
            });
          }
        });
        document.getElementById("user-info").innerHTML = `<small>${user.email}</small>`;
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    function renderUserDashboard(user, uid) {
      db.ref(`wallet/${uid}`).once("value").then(wSnap => {
        const wallet = wSnap.val();
        db.ref(`requests`).orderByChild("uid").equalTo(uid).once("value").then(rSnap => {
          const requests = rSnap.val();
          db.ref(`rechargeRequests`).orderByChild("uid").equalTo(uid).once("value").then(reSnap => {
            const recharges = reSnap.val();

            document.getElementById("dashboard").innerHTML = `
              <h3>ðŸ‘¤ User Dashboard</h3>
              <hr/>
              <p><strong>Name:</strong> ${user.name}</p>
              <p><strong>Phone:</strong> ${user.phone}</p>
              <p><strong>Wallet Balance:</strong> â‚¹${wallet?.balance || 0}</p>

              <h4>ðŸ§¾ My Requests</h4>
              ${requests ? Object.values(requests).map(r => `
                <div class="card mb-2">
                  <div class="card-body">
                    <strong>${r.category} - ${r.subcategory}</strong><br/>
                    ${r.description}<br/>
                    <span class="badge bg-warning">${r.status}</span>
                  </div>
                </div>
              `).join("") : "No requests found."}

              <h4>ðŸ’³ Recharge Requests</h4>
              ${recharges ? Object.values(recharges).map(rec => `
                <div class="border p-2 mb-2">
                  â‚¹${rec.amount} - <strong>${rec.status}</strong> (${rec.timestamp})
                </div>
              `).join("") : "No recharge requests found."}
            `;
          });
        });
      });
    }

    function renderProviderDashboard(provider, uid) {
      db.ref(`wallet/${uid}`).once("value").then(wSnap => {
        const wallet = wSnap.val();
        db.ref(`requests`).once("value").then(rSnap => {
          const allRequests = rSnap.val();

          document.getElementById("dashboard").innerHTML = `
            <h3>ðŸ”§ Provider Dashboard</h3>
            <hr/>
            <p><strong>Name:</strong> ${provider.name}</p>
            <p><strong>Category:</strong> ${provider.category} > ${provider.subcategory}</p>
            <p><strong>Status:</strong> ${provider.status}</p>
            <p><strong>Wallet Balance:</strong> â‚¹${wallet?.balance || 0}</p>

            <h4>ðŸ“‹ All Requests</h4>
            ${allRequests ? Object.values(allRequests).map(r => `
              <div class="card mb-2">
                <div class="card-body">
                  <strong>${r.name}</strong> (${r.category})<br/>
                  ${r.description}<br/>
                  <span class="badge bg-info">${r.status}</span>
                </div>
              </div>
            `).join("") : "No requests found."}
          `;
        });
      });
    }
  </script>
</body>
</html>
