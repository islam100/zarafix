<!DOCTYPE html>
<html>
<head>
  <title>üõ†Ô∏è ZaraFix Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 10px; margin: 0; }
    h2 { text-align: center; }
    .card {
      background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .btn {
      padding: 5px 10px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .approve { background: green; color: white; }
    .delete { background: red; color: white; }
    .led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }
    .green { background: green; }
    .red { background: red; }
    img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 5px; }
    @media (max-width: 600px) {
      .card { font-size: 15px; }
    }
  </style>
</head>
<body>
  <h2>üîß ZaraFix Admin Dashboard</h2>
  <div id="requests"></div>
  <h3>üí≥ Recharge Requests</h3>
  <div id="recharges"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCH17_8W_UPmPt4KqpCaV7BpN6KsA4a67E",
      authDomain: "zara-fix.firebaseapp.com",
      databaseURL: "https://zara-fix-default-rtdb.firebaseio.com",
      projectId: "zara-fix",
      appId: "1:476473209200:web:9f6efe6c32fd4248949fb5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;
        onValue(ref(db, 'admins/' + uid), (snap) => {
          if (!snap.exists()) {
            alert("Access Denied: Admins only.");
            window.location.href = "index.html";
          }
        });
      } else {
        alert("Please login first.");
        window.location.href = "index.html";
      }
    });

    // Service Requests & Posters Info
    const requestsDiv = document.getElementById('requests');
    onValue(ref(db), (snapshot) => {
      const data = snapshot.val();
      requestsDiv.innerHTML = "<h3>üìã Service Requests</h3>";

      for (let userId in data.requests) {
        for (let reqId in data.requests[userId]) {
          const req = data.requests[userId][reqId];
          const acceptedList = req.acceptedBy || {};

          let acceptedStr = "";
          for (let posterId in acceptedList) {
            const poster = data.posters?.[posterId] || {};
            acceptedStr += `
              <div class="card">
                <b>‚úÖ Accepted By:</b><br>
                <b>Name:</b> ${poster.name || ''} <br>
                <b>Shop:</b> ${poster.shop || ''} <br>
                <b>Category:</b> ${poster.category || ''} <br>
                <b>WhatsApp:</b> ${poster.whatsapp || ''} <br>
                <b>Wallet:</b> ‚Çπ${poster.wallet || 0} <br>
                <b>Address:</b> ${poster.address || 'N/A'}
              </div>`;
          }

          requestsDiv.innerHTML += `
            <div class="card">
              <b>üßæ User ID:</b> ${userId} <br>
              <b>Category:</b> ${req.category} <br>
              <b>Description:</b> ${req.description} <br>
              <b>Location:</b> ${req.location || 'N/A'} <br>
              ${acceptedStr || '‚ùå Not yet accepted'}
            </div>`;
        }
      }

      // Recharge requests
      const rechargeDiv = document.getElementById("recharges");
      rechargeDiv.innerHTML = "";
      const recharges = data.recharges || {};
      for (let posterId in recharges) {
        for (let rechargeId in recharges[posterId]) {
          const recharge = recharges[posterId][rechargeId];
          const approved = recharge.approved;
          const screenshot = recharge.screenshotUrl;
          const ledClass = approved ? "green" : "red";

          rechargeDiv.innerHTML += `
            <div class="card">
              <b>Poster ID:</b> ${posterId} <br>
              <b>Recharge ID:</b> ${rechargeId} <br>
              <b>Approved:</b> ${approved} 
              <span class="led ${ledClass}"></span><br>
              <img src="${screenshot}" alt="screenshot">
              <button class="btn approve" onclick="approveRecharge('${posterId}','${rechargeId}')">‚úÖ Approve</button>
              <button class="btn delete" onclick="deleteRecharge('${posterId}','${rechargeId}')">üóëÔ∏è Delete</button>
            </div>`;
        }
      }
    });

    // Approve and Delete functions
    window.approveRecharge = function(posterId, rechargeId) {
      update(ref(db, `recharges/${posterId}/${rechargeId}`), { approved: true });
      alert("Recharge approved.");
    }

    window.deleteRecharge = function(posterId, rechargeId) {
      remove(ref(db, `recharges/${posterId}/${rechargeId}`));
      alert("Recharge deleted.");
    }
  </script>
</body>
</html>
